<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <title>Edge Admin</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%230d1117'/%3E%3Ctext x='50' y='70' font-size='60' text-anchor='middle' fill='%2358a6ff' font-family='Arial' font-weight='bold'%3EE%3C/text%3E%3C/svg%3E">

  </head>
    
  <body>
  <!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <title>Last ENDB_Ready to work</title>
    

  </head>
    
  <body>
  <!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <title>CodePen - A Pen by Fuad Al taher</title>
    

  </head>
    
  <body>
  <!DOCTYPE html>
<!-- saved from url=(0062)file:///Users/fuadtaher/Desktop/untitled%20folder%202/QQQ.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>ENBD Performance Tracker — Single File</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%230d1117'/%3E%3Ctext x='50' y='68' font-size='50' text-anchor='middle' fill='%2358a6ff' font-family='Arial,sans-serif' font-weight='bold'%3EE%3C/text%3E%3C/svg%3E">
<!-- Local file:// stylesheet commented out to avoid invalid URL warnings in other environments -->
<!-- <link href="file:///Users/fuadtaher/Desktop/New%20Tracker/NEWENDBTRACKER_files/css2" rel="stylesheet"> -->
<style>
/* === CSS Variables === */
:root{
    --bg:#0d1117;      /* professional dark blue-gray */
    --card:#161b22;    /* darker card background */
    --muted:#8b949e;   /* muted gray labels */
    --text:#f0f6fc;    /* light text */
    --accent:#58a6ff;  /* professional blue accent */
  --danger:#f85149;  /* red for negatives */
  --gold:#d29922;    /* gold */
  --accent-amber: #ffb84d; /* distinct amber for scenario helper notes */
  --kpi-name: #9ACEBC; /* slightly brighter green-gray for KPI names */
    --line:rgba(255,255,255,0.1);
  --kpi-mo-needed-offset: -3.88cm; /* tweak this to nudge Mo. Needed horizontally */
  /* Page vertical offset. Reduced by 4mm total to lift the page up 4mm while leaving fixed side elements (logo / owner card) unaffected. To revert, set back to 6mm. */
  --page-offset: 2mm; /* was 6mm then 4mm then 3mm */
  }
  .light-theme {
    --bg:#f6f8fa;      /* light gray background */
    --card:#ffffff;    /* white cards */
    --muted:#656d76;   /* dark muted */
    --text:#24292f;    /* dark text */
    --accent:#0969da;  /* blue accent */
    --danger:#da3633;  /* red danger */
    --gold:#bf8700;    /* gold */
    --line:rgba(0,0,0,0.15);
  }
  /* === Base Styles === */
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    color:var(--text);
    background: var(--bg);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    font-size:14px;
    line-height:1.5;
  }
  /* === Layout === */
  .wrap{
    max-width:1100px;
  margin:0 auto;
  padding:24px 20px 36px;
  }
  /* Title centered */
  .titlebar{
    position:sticky; top:0; z-index:50;
    background:transparent; 
    border-bottom:1px solid rgba(255,255,255,0.03);
  }
  .titlebar-inner{
    display:grid; grid-template-columns:auto auto; align-items:center;
    gap:12px; padding:12px 20px;
  }
  h1{margin:0; text-align:center; font-weight:600; letter-spacing:.1px; font-size:16px;}
    /* Preset A: modern sans styling for primary UI elements */
    .ui-sans{ font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; font-weight:600; letter-spacing:.2px; }
    .card header, .kpi h3, .btn, .pill, .owner-year select, h1 { font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial; font-weight:600; letter-spacing:.2px; }
  .toolbar-right{justify-self:end; display:flex; gap:8px; align-items:center;}
  /* shrink toolbar controls by 5% for a slightly smaller appearance */
  .titlebar-inner .toolbar-right,
  .titlebar-inner .toolbar-right .btn { transform-origin: top right; transform: scale(0.95); }
  /* === Components === */
  .btn{
    display:inline-flex; align-items:center; gap:6.3px;
    border:1px solid rgba(255,140,0,0.35); background: linear-gradient(135deg, rgba(15,23,48,0.85), rgba(255,255,255,0.03));
  color:#5c9090; border-radius:10.5px; padding:6.3px 8.4px; cursor:pointer;
    font-weight:600; font-size:13.65px; box-shadow: 0 1px 6px rgba(0,0,0,0.08); transition: all 0.18s ease;
  -webkit-backdrop-filter: blur(3px); backdrop-filter: blur(3px);
  }
  .btn:hover{border-color:rgba(255,255,255,0.18); background: linear-gradient(135deg, rgba(18,29,58,0.9), rgba(255,255,255,0.04)); box-shadow: 0 3px 10px rgba(0,0,0,0.12);}
  .btn.round{border-radius:999px; padding:8.4px 10.5px;}
  /* Force button-like text color to KPI name color (overrides inline styles) */
  button, .btn, .sbtn, .iconbtn, input[type="button"], input[type="submit"],
  .right-icon-set .btn .label, .sharegrid .sbtn, .pop footer .btn, .close, .primary {
  color: #5c9090 !important;
  }
  /* compact toolbar utility: apply .toolbar-compact on .titlebar-inner to shrink spacing further */
  .toolbar-compact .toolbar-right{gap:6px}
  .toolbar-compact .btn{padding:5px 7px; font-size:12px; gap:6px}
  .btn .ico{font-size:16.8px}
  .grid{display:grid; gap:20px}
  /* reduce vertical gap between table and the area below it for a tighter layout */
  .grid.row2{ gap:8px }
  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:8px;
    padding:16px;
  }
  /* month index circle used in month table */
  .month-index{
    display:inline-flex;
    width:26px; height:26px; min-width:26px;
    align-items:center; justify-content:center;
    border-radius:50%; background:#33cccc; color:#032027; /* dark number on light cyan */
    font-weight:700; font-size:12px; margin-right:8px; box-shadow: 0 1px 3px rgba(0,0,0,0.12);
  }
  /* ensure month cell content stays on one line: index circle + month label */
  td.month-cell{ white-space:nowrap; vertical-align:middle; }
  td.month-cell .month-label{ font-weight:700; color:var(--text); font-family:inherit; font-size:13px; }
  /* preserve original green color for month names in the table */
  table#monthTable tbody td.month-cell .month-label{ color: #4caf50 !important; font-weight:700; }
  .owner-card {
    background: linear-gradient(135deg, var(--card) 0%, rgba(106, 163, 163, 0.05) 100%);
    border: 2px solid rgba(106, 163, 163, 0.2);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    position: relative;
  }
  .owner-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--line);
  }
  .owner-avatar{ width:28px; height:28px; border-radius:50%; object-fit:cover; margin-right:8px; vertical-align:middle; }
  .lock-icon {
    font-size: 18px;
    opacity: 0.8;
  }
  .row2{grid-template-columns:1fr 1fr}
  .row3{grid-template-columns:repeat(3,1fr)}
  .muted{color:var(--muted)}
  .gold{color:var(--gold)}
  /* Emphasize the Year Data label with a brighter gold */
  #yearDataLabel{ margin-left:0; display:inline-block; text-align:center; width:100%; position:relative; top:0; left:0; }
  /* three-line Year Data label: first two lines (owner & year) share owner color, third line (full label) is muted */
  #yearDataLabel .yline{ display:block; width:100%; text-align:center; }
  #yearDataLabel .y-owner{ font-size:18px; font-weight:700; color: #33cccc; }
  #yearDataLabel .y-year{ font-size:14px; font-weight:600; margin-top:2px; }
  #yearDataLabel .y-full{ font-size:12px; font-weight:600; margin-top:4px; color:#666666; }
  /* subtle owner/year select styling */
  .owner-year{ display:flex; gap:8px; align-items:center; justify-content:center; }
  .owner-year select{ -webkit-appearance:none; -moz-appearance:none; appearance:none; padding:4px 28px 4px 8px; border-radius:6px; border:1px solid rgba(255,255,255,0.06); background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02)); color:var(--text); font-size:11px; min-width:80px; height:26px; }
  .owner-year select::-ms-expand{ display:none; }
  /* add a small chevron on the right using an inline SVG background */
  /* keep them subtle but still keyboard/touch accessible */
  /* Highlight owner dropdown when focused/clicked so the list items are clearer */
  .owner-year select:focus, .owner-year select:active {
    outline: none !important;
    border-color: var(--accent);
    background: linear-gradient(180deg, rgba(88,166,255,0.14), rgba(10,24,40,0.06));
    color: var(--text);
    box-shadow: 0 6px 18px rgba(88,166,255,0.08);
  }
  /* For browsers that support it, improve option contrast */
  .owner-year select option{ background: var(--card); color: var(--text); }
  .owner-year select:focus option:hover, .owner-year select option:hover { background: rgba(88,166,255,0.12); color: var(--text); }
  .owner-year select:focus{ outline:2px solid rgba(123,217,159,0.12); box-shadow:0 0 0 3px rgba(123,217,159,0.06); opacity:1; }
  /* Make the owner/year label text black so it blends into a dark card; hide the select text separately so background/chevron stay visible */
  .owner-year label{ color:#000000 !important; }
  /* hide the visible text of the select but keep background image/chevron visible by using color:transparent and a small text-indent fallback */
  .owner-year select{ color: transparent !important; text-indent: 0.01px; }
  .owner-year select::-ms-value { color: transparent; }
  /* Keep the chevron visible by re-coloring the SVG background to a faint gray */
  .owner-year select.custom-chevron{ background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="6" height="4" viewBox="0 0 6 4"><path fill="%23AAAAAA" d="M3 4L0 0h6z"/></svg>'); background-repeat:no-repeat; background-position:calc(100% - 6px) center; background-size:6px 4px; }
  .owner-year select.custom-chevron{ background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="6" height="4" viewBox="0 0 6 4"><path fill="%23CCCCCC" d="M3 4L0 0h6z"/></svg>'); background-repeat:no-repeat; background-position:calc(100% - 6px) center; background-size:6px 4px; }
  .kpis{display:grid; grid-template-columns:repeat(4,1fr); gap:10px}
  /* use 3 columns for KPI tiles to match requested layout */
  .kpis{display:grid; grid-template-columns:repeat(3,1fr); gap:16px}
  /* compact muted KPI cards */
  .kpi{background: linear-gradient(135deg, var(--card), rgba(255,255,255,0.02)); color:var(--text); border:1px solid var(--line); border-radius:12px; padding:6px; display:flex; flex-direction:column; justify-content:center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: box-shadow 0.2s ease;}
  .kpi:hover{box-shadow: 0 4px 12px rgba(0,0,0,0.15);}
  /* allow a KPI to span the full width of the KPI grid */
  .kpi.full{grid-column:1 / -1; padding:12px 14px; font-size:16px}
  .kpi .months-visual{display:flex; flex-direction:column; align-items:center; justify-content:center; margin-left:12px}
  .kpi .months-big{font-size:28px; font-weight:800; color:var(--accent); line-height:1}
  .kpi .months-label{font-size:12px; color:var(--muted)}
  .kpi h3{margin:0 0 6px; font-size:12px; font-weight:600; color:var(--kpi-name) !important; letter-spacing:.3px; text-transform:none}
  .kpi .val{font-size:calc(14px * 1.06 * 1.03); font-weight:700; text-align:center; color:var(--text)}
  /* Slightly reduce values in the 3rd row of KPI grid to balance with upper rows */
  .kpis .kpi:nth-child(n+7) .val{ font-size:calc(14px * 0.92); }
  .kpi.small-note{padding:6px}
  .kpi .val.positive{color:#7bd99f}
  .kpi .val.negative{color:var(--danger)}
  /* Neutral/unbiased color for Total Target KPI (gold to draw attention) */
  .kpi .val.neutral-muted { color: #C9A24A !important }
  /* Attention color for Mo. Needed KPI (softened) */
  .kpi .val.attention { color: #FFB28A !important }

  /* Forecasted Year-End in cyan/teal per user request */
  #kpiForecastYearEnd { color: #33cccc !important; }

  /* Shift the Mo. Needed number slightly left and color it orange */
  #kpiMoNeeded {
    display:inline-block;
  transform: translateX(calc(var(--kpi-mo-needed-offset) + 2mm));
    color: #FF8C42 !important;
  }
  /* Make Avg. Mo. Target KPI yellow */
  #kpiAvgMoTarget { color: #F5D547 !important; text-shadow: 0 1px 0 rgba(0,0,0,0.15); }
  /* YTD Inflow in cyan/teal */
  #kpiInflow { color: #33cccc !important; }
  .small{font-size:12px}
  label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
  /* subtle inline hint text used near compact controls */
  .fineTextInline{ font-size:11px; color:var(--muted); margin-left:8px; white-space:nowrap }
  .password-toolbar{ display:flex; gap:6px; align-items:center; }
  .password-input{ padding:4px; font-size:11px; width:68px; border-radius:6px; background:var(--accent); color:#ffffff; display:block; }
  .password-input::placeholder{ color:rgba(255,255,255,0.85); text-transform:lowercase; }
  .password-button{ padding:4px; font-size:12px; width:36px; height:28px; display:flex; align-items:center; justify-content:center; }
  .password-notice{ margin-top:6px; color:var(--danger); }
  .disabled-password{ opacity:0.6; cursor:not-allowed; pointer-events:none; }
  select,input[type="number"],input[type="text"]{
    width:100%; background:transparent; color:var(--text); border:1px solid rgba(255,255,255,0.04);
    border-radius:6px; padding:6px 8px; outline:none;
    font-size:14px;
  }
  /* remove native number input spinner arrows for better manual entry */
  /* Chrome, Edge, Safari */
  input[type=number]::-webkit-outer-spin-button,
  input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
  /* Normalize number input appearance across browsers */
  input[type=number] { -moz-appearance: textfield; -webkit-appearance: none; appearance: textfield; }
  table{width:100%; border-collapse:collapse; table-layout:fixed}
  th,td{border:1px solid rgba(255,255,255,0.12); padding:10px; font-size:14px}
  td{ text-align:left }
  /* Month column: header stays centered, body cells left-aligned for readability */
  /* Left-align Month and Day headers for clarity */
  table#monthTable thead th:first-child,
  table#monthTable thead th:nth-child(2) { text-align:left }
  table#monthTable tbody td:first-child { text-align:left; font-weight:700; font-family: 'Georgia', serif; }
  /* Increase Day (first) column width by ~10% and enlarge its text by ~5% */
  /* The multiplier was previously ~1.155 — applying an additional ~10% -> ~1.27 total */
  table#monthTable thead th:first-child { width: calc(7.7% * 1.27) !important; }
  table#monthTable tbody td:first-child { width: calc(7.7% * 1.27) !important; }
  /* Increase font size of inputs inside the Day column by ~5% over previous value */
  table#monthTable tbody td:first-child input { font-size: calc(9px * 1.19) !important; }
  /* More specific target for the Day input fields (legacy inline styles overridden) */
  input[id^="month-day-"] { font-size: calc(9px * 1.19) !important; }
  /* Visual indicator for multi-day entries: small tick at the right of the input */
  input[id^="month-day-"].multi-day {
    background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='%2358a6ff' d='M9.2 16.2l-4.2-4.2L3.6 13.6 9.2 19.2 20.4 8 18.8 6.4z'/></svg>");
    background-repeat: no-repeat;
    background-position: right 8px center;
    background-size: 14px 14px;
    padding-right: 22px !important;
  }
  th{background:#262628; color:#5c9090; position:static; z-index:1; text-align:center}
  /* Center numeric/accounting columns: Target (3), Bank Inflow (5), Variance (6), Balance (7) */
  table#monthTable td:nth-child(3),
  table#monthTable td:nth-child(5),
  table#monthTable td:nth-child(6),
  table#monthTable td:nth-child(7) { text-align:center }
  /* Center the input text inside Target and Bank Inflow cells for easier data entry */
  table#monthTable td:nth-child(3) input,
  table#monthTable td:nth-child(5) input { text-align:center }
  /* color balances green/red depending on sign */
  table#monthTable td:nth-child(7).positive { color: #7bd99f }
  table#monthTable td:nth-child(7).negative { color: var(--danger) }
  /* Variance (col 6) green/red depending on sign (body only) */
  table#monthTable tbody td:nth-child(6).positive { color: #7bd99f }
  table#monthTable tbody td:nth-child(6).negative { color: var(--danger) }
  /* Target (col 3) body cells: orange identity (do NOT color the header) */
  table#monthTable tbody td:nth-child(3) { color: #f39c12; font-weight:700 }
  table#monthTable tbody td:nth-child(3) input { color: #f39c12; }
  /* Bank Inflow (col 5) body cells: gold identity */
  table#monthTable tbody td:nth-child(5) { color: var(--gold); font-weight:700 }
  table#monthTable tbody td:nth-child(5) input { color: var(--gold); }
  /* Month (col 2) body cells: grass green identity (do NOT color the header) */
  table#monthTable tbody td:nth-child(2) { color: #4caf50; font-weight:700 }
  table#monthTable tbody td:nth-child(2) input { color: #4caf50; }
  /* Day (first column) body cells: use accent blue (do NOT color the header) */
  table#monthTable tbody td:first-child { color: var(--accent); font-weight:700 }
  table#monthTable tbody td:first-child input { color: var(--accent); }
  /* Keep inner lines subtle so outer border stands out - prevents 'leak' */
  .tableCard{border:1px solid var(--line); border-radius:14px; overflow:hidden; grid-column: 1 / -1}
  .tableCard table th,.tableCard table td{border:1px solid rgba(255,255,255,0.12) !important}
  .tableCard .note{padding:10px; color:var(--muted); font-size:12px}
  /* Chart container should span full width under the table to avoid an empty column */
  .chartCard{grid-column:1 / -1}
  .pill{
    display:inline-flex; align-items:center; gap:8px; padding:4px 8px; background:transparent; border:1px solid rgba(255,255,255,0.04); border-radius:999px; font-size:12px;
  }
  .owner-year{display:flex; flex-direction:column; gap:10px; align-items:stretch; position:relative}
  /* Make owner/year controls less prominent (privacy) */
  .owner-year select{background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.03); color:var(--gold); opacity:1; font-size:15.6px}
  .owner-year select:focus{outline:2px solid rgba(106,163,163,0.14); color:var(--text); opacity:1}
  /* visually hide the Owner/Year label text (keeps label in DOM for screen readers) */
  .owner-year label{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0 0 0 0); white-space:nowrap; border:0}
  .year-data{margin-top:6px; font-weight:700}
  .sidebar{
  position:fixed; left:0; top:calc(80px + 2cm + var(--page-offset)); width:233px; height:calc(100vh - 80px - 2cm); overflow-y:auto; background:var(--card); border-right:1px solid var(--line); z-index:10;
  }
  .wrap{
    margin-left:233px;
    margin-top: var(--page-offset);
  }
  /* Reminders */
  .rem-row{
    display:grid; grid-template-columns:auto auto 1fr auto; gap:12px; align-items:center;
    padding:12px 10px; border-bottom:1px dashed rgba(255,255,255,0.04);
  }
  .rem-row:last-child{border-bottom:none}
  .tiny{
    width:14px; height:14px; accent-color:var(--danger);
  }
  .date-amount{white-space:nowrap}
  /* softer badge for reminders */
  #remBadge{ -webkit-backdrop-filter:blur(6px); backdrop-filter:blur(6px); background:#000000; color:#33cccc; padding:2px 6px; border-radius:12px; font-weight:700; font-size:14px; min-width:28px; text-align:center; border:1px solid rgba(51,204,204,0.3); box-shadow:0 2px 8px rgba(0,0,0,0.5), 0 0 12px rgba(51,204,204,0.2); display:inline-flex; align-items:center; justify-content:center }
  /* larger, clearer badge when showing a check */
  #remBadge.check { background: #000000; color: #28a745; border:1px solid rgba(40,167,69,0.5); box-shadow: 0 4px 8px rgba(0,0,0,0.5), 0 0 16px rgba(40,167,69,0.3); }
  #remList .rem-row{padding:10px 6px; align-items:center}
  .rem-actions .iconbtn{background:#2a3a5a; border:1px solid #3a4a6a; color:#5c9090; padding:6px 8px; font-size:12px; border-radius:6px}
  .rem-label{font-size:13px}
  .rem-row .date-amount{font-weight:600; color:var(--muted)}
  .rem-row .rem-label{color:var(--text); font-size:13px}
  #btnToggleRem{min-width:86px}
  .date-amount.strike{
    text-decoration:line-through;
    text-decoration-thickness:2px;
    text-decoration-color:#ff3030;
    color:#ff6b6b;
  }
  .rem-label{color:var(--text)}
  .rem-label.faded{opacity:.45}
  .surplus-text{font-size:0.6em; display:inline-block; line-height:1.2; font-weight:700; color:inherit}
  .rem-pill .surplus-text{font-weight:600}
  .rem-actions{display:flex; gap:4px}
  .iconbtn{border:none; background:#17171a; border:1px solid #2a2a30; color:#5c9090; padding:6px 8px; border-radius:10px; cursor:pointer; font-size:12px}
  .iconbtn:hover{background:#1f1f22}
  .danger{color:#5c9090 !important;border-color:#3a1f25;background:#1a0f12}
  /* Share Monthly Plan popup */
  .overlay{position:fixed; inset:0; background:rgba(27,27,31,0.62); display:none; align-items:center; justify-content:center; z-index:120}
  .overlay.show{display:flex}
  .pop{
    width:min(1000px,98vw); max-height:95vh; overflow:auto; background:#1b1b1f; border:1px solid #2a2a30; border-radius:18px; box-shadow:0 20px 60px rgba(0,0,0,.5);
  }
  .pop header{display:flex; align-items:center; justify-content:space-between; padding:14px 18px; border-bottom:1px solid #2a2a30}
  .pop header h3{margin:0; font-size:20px; color: #33cccc; font-weight:700}

  /* Specific larger title for the Deposit Req. share popup */
  #shareTitle { font-size:24px !important; font-weight:800; color: #33cccc; }
  .pop .content{ padding:18px; font-size:15px; }
  /* Required field label styling (less harsh than red) */
  .required-label{ color:#666666; font-weight:600 }
  /* Highlight share recipient placeholder in red to draw attention */
  #shareRecipient::placeholder{ color:#666666; font-weight:700; opacity:1 }
  .sharegrid{display:grid; grid-template-columns:repeat(4,1fr); gap:8px; margin-top:10px}
  .sharegrid .sbtn{border:1px solid #2a2a30; background:#17171a; padding:10.5px; border-radius:12.6px; font-size:12.6px; font-weight:700; text-align:center; cursor:pointer}
  .sharegrid .sbtn:hover{background:#1f1f22}
  .textarea{
    width:100%; background:#141416; border:1px solid #2a2a30; color:var(--text); border-radius:10px; padding:10px; min-height:200px; resize:vertical; line-height:1.6;
  }
  .pop footer{display:flex; justify-content:flex-end; gap:8px; padding:14px 18px; border-top:1px solid #2a2a30}
  .close{background:#1c1c20; border:1px solid #2a2a30}
  .hidden{display:none}
  .hint{font-size:13px; color:#a4b7cf}

  /* Notes drawer (slide-out) */
  .notes-drawer{ position:fixed; left:-680px; top:calc(8mm + var(--page-offset)); width:640px; height:75vh; background:#1b1b1f; border:1px solid rgba(255,255,255,0.02); border-radius:12px; box-shadow:0 30px 60px rgba(0,0,0,0.6); transition:left 260ms ease-in-out; z-index:135; overflow:auto; }
  .notes-drawer.open{ left:calc(240px - 7mm); }
  .notes-drawer-inner{ padding:16px; font-size:13px }
  /* Make the notes textarea occupy most of the drawer height */
  #notesArea{ min-height: calc(75vh - 160px); max-height: calc(75vh - 120px); height: calc(75vh - 160px); resize:vertical; }
  #btnToggleNotes{ margin-left:0; }
  /* Visual highlight for reminders to make them easy to see */
  .reminders-highlight{ border:1px solid rgba(255,140,66,0.04); box-shadow:0 4px 10px rgba(0,0,0,0.04); border-radius:10px }
  /* Slide-out reminders drawer */
  .rem-drawer h3{ color:#33cccc; /* cyan/teal for reminder headers */ }
  .rem-drawer{ position:fixed; right:-520px; top:calc(60px + var(--page-offset)); width:520px; max-width:calc(100vw - 40px); height:72vh; min-height:360px; background:#1b1b1f; border:1px solid rgba(255,255,255,0.02); border-radius:12px; box-shadow:0 40px 80px rgba(0,0,0,0.6); transition: right 220ms cubic-bezier(.2,.9,.3,1), transform 220ms ease; z-index:13000; overflow:auto }
  .rem-drawer.open{ right:18px; transform:translateX(0); }
  .rem-drawer-inner{ padding:18px; font-size:13px }
  @media (max-width:720px){
    .rem-drawer{
      width:92vw;
      max-width:92vw;
      height:78vh;
      top:60px;
      left:4vw;
      right:auto;
      transform:translateX(calc(100% + 24px));
      opacity:0;
      visibility:hidden;
      pointer-events:none;
      transition:transform 220ms cubic-bezier(.2,.9,.3,1), opacity 160ms ease-in-out, visibility 0s linear 160ms;
    }
    .rem-drawer.open{
      transform:translateX(0);
      opacity:1;
      visibility:visible;
      pointer-events:auto;
      right:auto;
      transition:transform 220ms cubic-bezier(.2,.9,.3,1), opacity 160ms ease-in-out;
    }
  }
  #btnOpenRem{ font-weight:700 }

  /* Ultra-sleek glassmorphism reminder floating pill — minimal and elegant */
  .rem-pill{ position:fixed; right:calc(18px - 3mm); bottom:calc(150px + 2mm + 1.2cm + var(--page-offset)); z-index:140; background:linear-gradient(135deg, rgba(255,187,140,0.06), rgba(255,170,120,0.04)); -webkit-backdrop-filter:blur(6px); backdrop-filter:blur(6px); color:#5c9090; border:1px solid rgba(255,160,110,0.08); box-shadow:0 1px 6px rgba(0,0,0,0.04); font-size:12px; padding:2px 6px; border-radius:9px; display:inline-flex; align-items:center; gap:6px; transition:transform 150ms ease, box-shadow 150ms ease, background 150ms ease; transform: translateX(4mm); }
  .rem-pill .rem-label{ color: #5c9090 !important; }
  /* make the small icon inside the pill more visible */
  .rem-icon{ font-size:18px; line-height:1; display:inline-block; margin-right:6px }
  .rem-pill .rem-label{ font-size:14px; font-weight:500; opacity:0.9 }
  .rem-pill:focus{ outline:1px solid rgba(192,192,192,0.4); outline-offset:1px; background:linear-gradient(135deg, rgba(192,192,192,0.2), rgba(160,160,160,0.2)); }
  .rem-pill:hover{ background:linear-gradient(135deg, rgba(255,200,150,0.12), rgba(255,180,120,0.08)); box-shadow:0 2px 10px rgba(0,0,0,0.06); transform: translateX(4mm) scale(1.02); }
  @media (max-width:420px){ .rem-pill .rem-label{ display:none } }
  .mo-needed-ribbon{ display:grid; grid-template-columns:1fr 1fr 1fr; align-items:center; position:relative; gap:12px; }
  .mo-needed-left{ grid-column:1; justify-self:start; display:flex; align-items:center; gap:8px; text-align:left; z-index:1; }
  .mo-needed-spacer{ grid-column:2; justify-self:center; }
  .mo-needed-right{ grid-column:3; justify-self:center; display:flex; align-items:center; justify-content:center; gap:8px; z-index:1; }

  /* urgency states */
  .rem-pill.state-normal{ background:linear-gradient(135deg, rgba(255,187,140,0.06), rgba(255,170,120,0.04)); color:#5c9090 !important; }
  .rem-pill.state-soon{ background:linear-gradient(135deg, rgba(255,220,140,0.12), rgba(255,200,120,0.08)); color:#5c9090 !important; box-shadow:0 6px 18px rgba(255,140,66,0.06); }
  .rem-pill.state-urgent{ background:linear-gradient(135deg, rgba(255,120,120,0.12), rgba(255,90,90,0.06)); color:#5c9090 !important; box-shadow:0 8px 22px rgba(255,80,80,0.10); transform:scale(1.04); }
  @keyframes remPulse{ 0%{ box-shadow:0 0 0 0 rgba(255,80,80,0.0); } 70%{ box-shadow:0 0 0 8px rgba(255,80,80,0.06);} 100%{ box-shadow:0 0 0 0 rgba(255,80,80,0.0);} }
  .rem-pill.pulse{ animation: remPulse 1.6s infinite ease-out; }
  #remBadge.state-normal{ background:#000000; color:#33cccc; border:1px solid rgba(51,204,204,0.3); }
  #remBadge.state-soon{ background:#000000; color:#ffb04d; border:1px solid rgba(255,176,77,0.5); }
  #remBadge.state-urgent{ background:#000000; color:#ff4d4d; border:1px solid rgba(255,77,77,0.5); }

  /* Variant when the reminder pill is placed inside a card (non-fixed) */
  .rem-pill--inside{ position:static; transform:none; display:inline-flex; margin-left:6px; background:transparent; border:1px dashed rgba(255,160,110,0.06); padding:4px 8px; border-radius:8px; font-size:13px; color:#5c9090; vertical-align:middle; align-items:center; }
  .rem-pill--inside .rem-label{ color:#5c9090 !important; font-size:13px; display:inline-block }
  /* Totals row styling */
  table#monthTable .totals-row td:first-child {
    color: var(--accent);
  }
  /* Right-align numeric totals in the totals row for clarity */
  table#monthTable .totals-row td {
    text-align: right;
    font-weight:700;
    /* remove fine vertical separators between cells in the totals row */
    border-left: none !important;
    border-right: none !important;
    background: transparent;
  }
  table#monthTable .totals-row td:nth-child(3) {
    color: var(--danger);
  }
  table#monthTable .totals-row td:nth-child(5) {
    color: var(--positive);
  }
  table#monthTable .totals-row td:nth-child(7) {
    color: var(--positive);
  }

  @media print {
    /* ===== HIDE EVERYTHING EXCEPT DATA ===== */
    body > *:not(.wrap),
    .overlay, .right-icon-wrap, .sidebar, .toolbar-right, .btn, .iconbtn, 
    button, .toast, .chartCard, canvas, .owner-year, .titlebar-inner,
    input, select, .grid.row2, .grid.row3, .Monthly, 
    .monthlyOverview, #monthlyChart, .chart, svg, .rem-card,
    .owner-logo, .owner-card, .theme-toggle, tfoot, .fineTextInline,
    #privacyUnderTotal, #passwordStorageNotice, #monthDebug,
    .left-panel, .nav, header nav, aside, footer,
    [class*="sidebar"], [class*="menu"], [class*="nav"] { 
      display: none !important;
      visibility: hidden !important;
      width: 0 !important;
      height: 0 !important;
      overflow: hidden !important;
    }
    
    /* FORCE WHITE BACKGROUND EVERYWHERE */
    html, body, div, section, article, main, .wrap, .card, .kpi, .kpis, table, th, td {
      background: white !important;
      background-color: white !important;
      color: black !important;
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
    }
    
    /* SCALE UP EVERYTHING */
    html {
      font-size: 24px !important;
    }
    
    body { 
      margin: 0 !important;
      padding: 10mm !important;
      width: 100% !important;
      min-height: 100% !important;
    }
    
    /* Reset ALL positioning */
    * {
      position: static !important;
      float: none !important;
      transform: none !important;
      box-shadow: none !important;
      text-shadow: none !important;
      opacity: 1 !important;
    }
    
    .wrap {
      max-width: 100% !important;
      width: 100% !important;
      padding: 0 !important;
      margin: 0 auto !important;
      display: block !important;
    }
    
    /* ===== TITLE - BIG ===== */
    .titlebar { 
      display: block !important;
      padding: 5mm 0 !important;
      margin-bottom: 8mm !important;
      border-bottom: 3px solid black !important;
      text-align: center !important;
    }
    
    h1 {
      font-size: 32pt !important;
      font-weight: 900 !important;
      text-align: center !important;
      margin: 0 !important;
      color: black !important;
    }
    
    /* ===== KPIs - GIANT NUMBERS ===== */
    .kpis, .grid.row1 { 
      display: flex !important;
      flex-wrap: wrap !important;
      gap: 5mm !important;
      margin-bottom: 10mm !important;
      justify-content: center !important;
    }
    
    .kpi {
      flex: 0 0 45% !important;
      padding: 8mm !important;
      border: 3px solid black !important;
      text-align: center !important;
      page-break-inside: avoid !important;
      margin-bottom: 5mm !important;
    }
    
    .kpi h3 {
      font-size: 14pt !important;
      font-weight: 800 !important;
      text-transform: uppercase !important;
      margin: 0 0 4mm 0 !important;
      color: black !important;
    }
    
    .kpi .val {
      font-size: 36pt !important; 
      font-weight: 900 !important;
      line-height: 1.2 !important;
      color: black !important;
    }
    
    /* ===== TABLE - LARGE & CLEAR ===== */
    .tableCard, .card {
      margin-top: 8mm !important;
      border: none !important;
      padding: 0 !important;
    }
    
    table { 
      width: 100% !important;
      border-collapse: collapse !important;
      margin: 5mm 0 !important;
    }
    
    table th, table td { 
      padding: 4mm 6mm !important; 
      font-size: 14pt !important;
      font-weight: 600 !important;
      border: 2px solid black !important;
      text-align: center !important;
      color: black !important;
    }
    
    table th {
      background: #ddd !important;
      font-weight: 900 !important;
      font-size: 12pt !important;
    }
    
    /* Number cells even bigger */
    table td {
      font-size: 16pt !important;
      font-weight: 700 !important;
    }
    
    .grid { display: block !important; }
    
    h2 { font-size: 24pt !important; font-weight: 900 !important; margin: 8mm 0 5mm !important; color: black !important; }
    
    @page { 
      margin: 8mm;
      size: A4 portrait;
    }
  }
</style>
<style>
  /* Toast notification styles */
  .toast {
    position: fixed;
    bottom: 20px;
    right: 20px;
  /* Toast notification styles */
  .toast {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: var(--accent);
    color: #111111;
    padding: 10px 16px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.3s ease, transform 0.3s ease;
    z-index: 1000;
    pointer-events: none;
  }
  .toast.show {
    opacity: 1;
    transform: translateY(0);
  }
</style>
<style>
  .titlebar .owner-year {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    padding: 8px 12px;
    margin-right: 16px;
    display: flex;
    gap: 12px;
    align-items: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  .titlebar .owner-year div {
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .owner-year label {
    font-size: 16px;
    color: var(--text);
    font-weight: 700;
    display: block;
  }
  .owner-year select {
  background: #171719;
    color: var(--gold);
    border: none;
    border-radius: 20px;
    padding: 8px 36px 8px 14px;
    font-size: 16px;
    min-width: 140px;
    cursor: pointer;
    transition: background-color 0.2s;
    appearance: none;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'%3e%3ccircle cx='10' cy='10' r='1.5' fill='%23cccccc'/%3e%3c/svg%3e");
    background-position: right 8px center;
    background-repeat: no-repeat;
    background-size: 16px;
    font-weight: 700;
  }
  /* Compact chevron variant for the small titlebar selects: tiny chevron and minimal right padding */
  .titlebar .owner-year select {
    /* reduce the right padding so the select occupies less horizontal space */
    padding-right: 8px; /* keep very small room for the chevron */
    min-width: 72px;    /* allow the compact dropdown to be very small */
    font-size: 13px;
    border-radius: 12px;
    /* tiny chevron (4x3) with minimal position */
    background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='4' height='3' viewBox='0 0 4 3'><path fill='%23CCCCCC' d='M2 3L0 0h4z'/></svg>");
    background-position: right 4px center;
    background-size: 4px 3px;
    background-repeat: no-repeat;
  }
  .owner-year select:hover {
  background: #1b1b1f;
  }
  .owner-year select:focus {
    outline: none;
  background: #1b1b1f;
  }
  /* Specific colors for Owner and Year selects */
  #owner { color: #ff9933; } /* Warmer orange for Owner */
  #year { color: #33cccc; } /* Bright cyan/teal for Year */
  @media (max-width: 768px) {
    body { font-size: 13px; }
    .wrap { padding: 12px 10px 64px; margin-left: 0; }
    .sidebar { display: none; }
    .titlebar { position: static; padding: 6px 0; background: var(--bg); }
    .titlebar-inner { grid-template-columns: 1fr; gap: 10px; text-align: center; padding: 12px 16px; justify-items: center; }
    .titlebar .owner-year { flex-wrap: wrap; justify-content: center; margin-right: 0; width: 100%; }
    .titlebar .owner-year div { width: 100%; justify-content: center; }
    .titlebar .owner-year select { width: 100%; }
    .toolbar-right { justify-self: center; flex-wrap: wrap; gap: 8px; width: 100%; justify-content: center; }
    .toolbar-right .btn,
    .toolbar-right .iconbtn,
    .toolbar-right button { flex: 1 1 calc(50% - 8px); min-width: 120px; justify-content: center; }
    .grid { gap: 16px; }
    .grid.row2 { grid-template-columns: 1fr; gap: 14px; }
    .grid.row3 { grid-template-columns: 1fr; gap: 14px; }
    .kpis { grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px; }
    .kpi { min-height: 94px; }
    .card { padding: 10px; }
    .tableCard { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .tableCard table { min-width: 720px; }
    .tableCard table th, .tableCard table td { padding: 6px; font-size: 12px; }
    .btn { padding: 6px 12px; font-size: 12px; }
    h1 { font-size: 15px; }
    .pill { font-size: 11px; padding: 4px 7px; }
  .sharegrid { grid-template-columns: repeat(2, minmax(140px, 1fr)); }
  .notes-drawer { width: 94vw; }
  .notes-drawer.open { left: 3vw; }
  .rem-drawer { width: 320px; }
  .rem-drawer.open { right: 12px; }
    .pop { width: 96vw; }
  }
  @media (max-width: 600px) {
    .toolbar-right .btn,
    .toolbar-right .iconbtn,
    .toolbar-right button { flex: 1 1 100%; }
  .sharegrid { grid-template-columns: 1fr; }
  .titlebar-inner { padding: 12px; }
  .notes-drawer { width: 96vw; }
  .notes-drawer.open { left: 2vw; }
  .rem-drawer { width: 92vw; }
  .rem-drawer.open { right: 4vw; }
  }
  @media (max-width: 480px) {
    .wrap { padding-bottom: 72px; }
    .kpis { grid-template-columns: 1fr; }
    .kpi { min-height: 0; }
    .owner-year { flex-direction: column; align-items: stretch; gap: 10px; }
    .owner-year select { font-size: 14px; }
    .titlebar .owner-year div { gap: 8px; }
    .chartCard canvas { width: 100% !important; height: 160px !important; }
    .tableCard table { min-width: 640px; }
    .month-index { width: 24px; height: 24px; font-size: 11px; }
    .btn { font-size: 11.5px; }
  }
</style>
<!-- Essential Libraries - Direct Import for Local File Support -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js" crossorigin="anonymous"></script>
<script>
  (function initXLSXLoader(){
    const sources = [
      'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.20.3/xlsx.full.min.js',
      'https://cdn.jsdelivr.net/npm/xlsx@0.20.3/dist/xlsx.full.min.js',
      'https://unpkg.com/xlsx@0.20.3/dist/xlsx.full.min.js'
    ];

    const state = {
      loaded: typeof XLSX !== 'undefined',
      index: 0,
      loading: null,
      failed: false
    };

    const markFailure = () => {
      if(state.failed) return;
      state.failed = true;
      const importBtn = document.getElementById('btnImport');
      const exportBtn = document.getElementById('btnExport');
      if(importBtn) importBtn.title = 'Excel features unavailable - XLSX library failed to load';
      if(exportBtn) exportBtn.title = 'Excel features unavailable - XLSX library failed to load';
      if(typeof showToast === 'function'){
        showToast('XLSX library failed to load. Try again later or use CSV export.', 'error');
      }
    };

    const loadViaTag = (src) => new Promise((resolve, reject) => {
      const script = document.createElement('script');
      let settled = false;
      const timer = setTimeout(() => {
        if(!settled){
          settled = true;
          console.warn('Timed out waiting for XLSX from', src);
          script.onerror?.(new Error('timeout'));
        }
      }, 8000);

      script.src = src;
      script.crossOrigin = 'anonymous';
      script.onload = () => {
        if(settled) return;
        settled = true;
        clearTimeout(timer);
        resolve();
      };
      script.onerror = (err) => {
        if(settled) return;
        settled = true;
        clearTimeout(timer);
        reject(err || new Error('Failed to load script'));
      };
      document.head.appendChild(script);
    });

    const loadViaFetch = async (src) => {
      try {
        const res = await fetch(src, { mode: 'cors' });
        if(!res.ok){
          throw new Error(`HTTP ${res.status}`);
        }
        const code = await res.text();
        const factory = Function(`${code}\n//# sourceURL=${src}`);
        factory();
      } catch(err){
        console.warn('Fetch/eval fallback failed for', src, err);
        throw err;
      }
    };

    const loadNext = () => {
      if(state.loaded || typeof XLSX !== 'undefined'){
        state.loaded = true;
        return Promise.resolve();
      }
      if(state.index >= sources.length){
        markFailure();
        return Promise.reject(new Error('All XLSX sources failed'));
      }

      const src = sources[state.index++];
      return loadViaTag(src)
        .catch(err => {
          console.warn('Tag load failed for', src, err);
          return loadViaFetch(src);
        })
        .then(() => {
          if(typeof XLSX !== 'undefined'){
            state.loaded = true;
            console.log('XLSX loaded from', src, '(mode:', (state.index <= sources.length ? 'script/fetch' : 'unknown'), ')');
          } else {
            console.warn('XLSX content loaded but global missing, trying next source');
            return loadNext();
          }
        })
        .catch(err => {
          console.warn('Failed to acquire XLSX from', src, err);
          return loadNext();
        });
    };

    const ensureXLSX = () => {
      if(state.loaded || typeof XLSX !== 'undefined'){
        state.loaded = true;
        return Promise.resolve();
      }
      if(state.loading){
        return state.loading;
      }
      state.loading = loadNext()
        .catch(err => {
          console.error('XLSX loader exhausted sources', err);
          markFailure();
          throw err;
        })
        .finally(() => {
          state.loading = null;
        });
      return state.loading;
    };

    window.ensureXLSX = ensureXLSX;

    if(!state.loaded){
      ensureXLSX().catch(() => {});
    }

    window.addEventListener('load', () => {
      ensureXLSX().catch(() => {});
    });
  })();
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" crossorigin="anonymous"></script>

<script>
  // Backup dynamic loading for libraries (with better error handling)
  (function(){
    console.log('Library check:', {
      emailjs: typeof emailjs !== 'undefined',
      XLSX: typeof XLSX !== 'undefined', 
      Chart: typeof Chart !== 'undefined',
      html2canvas: typeof html2canvas !== 'undefined',
      jsPDF: typeof window.jsPDF !== 'undefined' || typeof window.jspdf !== 'undefined'
    });
  })();
</script>
<style id="fuad-remarks-and-notes-css">
  /* Ensure toolbar (right icon set) accepts clicks */
  .right-icon-set{ pointer-events:auto !important; }

  /* Note column: 2-line dark grey/orange */
  #monthTable td:nth-child(4){ vertical-align: top !important; }
  input[id^="month-note-"],
  textarea.note2 {
    background: #121212 !important;
    color: #888 !important;
    border: 1px solid rgba(255,140,0,0.35) !important;
    caret-color: #888;
  }
  input[id^="month-note-"]::placeholder,
  textarea.note2::placeholder { color: rgba(255,140,0,0.6) !important; }
  textarea.note2 {
    border-radius: 18px !important;
    width: 100% !important;
    min-height: 3.2em !important; /* ~2 lines */
    line-height: 1.25 !important;
    padding: 8px 12px !important;
    box-sizing: border-box !important;
    resize: none !important;
  }
  input[id^="month-note-"].note-hidden {
    position: absolute !important; left: -9999px !important;
    width: 1px !important; height: 1px !important; opacity: 0 !important;
    pointer-events: none !important;
  }

  /* Yearly Remarks popup */
  #yearlyRemarksOverlayLite[aria-hidden="true"]{ display:none !important; }
  #yearlyRemarksOverlayLite[aria-hidden="false"]{
    display:flex !important; position:fixed; inset:0;
    background: rgba(0,0,0,.5); z-index: 10040;
    align-items:center; justify-content:center; pointer-events:auto;
  }
  #yearlyRemarksOverlayLite .pop{
    max-width: 1200px; width: 96vw; max-height: 85vh; overflow:auto;
  background: #181818; color:var(--kpi-name);
  border:1px solid rgba(154,206,188,0.18); border-radius:16px;
  }
  #yearlyRemarksOverlayLite header, #yearlyRemarksOverlayLite footer{
    display:flex; align-items:center; justify-content:space-between;
    padding: 10px 12px; border-bottom:1px solid rgba(255,140,0,.2);
  }
  #yearlyRemarksOverlayLite footer{ border-top:1px solid rgba(255,140,0,.2); border-bottom:none; }
  #yearlyRemarksOverlayLite .content{ padding:12px; }
  #yearlyRemarksOverlayLite .btn{ background:transparent; color:#5c9090; border:1px solid rgba(154,206,188,0.18); }
  .calendar-remarks-lite{
    display:grid; grid-template-columns: repeat(4, minmax(220px,1fr)); gap:12px;
  }
  @media (max-width: 1200px){ .calendar-remarks-lite{ grid-template-columns: repeat(3, minmax(220px,1fr)); } }
  @media (max-width: 900px){ .calendar-remarks-lite{ grid-template-columns: repeat(2, minmax(220px,1fr)); } }
  @media (max-width: 600px){ .calendar-remarks-lite{ grid-template-columns: 1fr; } }
  .month-card-lite{ background:#121212; border:1px solid rgba(154,206,188,0.12); border-radius:14px; padding:10px; }
  /* allow month-specific classes to set header color */
  .month-card-lite h4{ margin:0 0 6px 0; font-size:14px; font-weight:700; color:inherit; }
  .month-card-lite textarea{
    width:100%; min-height:3.6em; resize:vertical; border-radius:14px;
    border:1px solid rgba(255,140,0,.35); padding:8px 10px;
    background:#121212; color:#888; box-sizing:border-box; line-height:1.25;
  }
  .month-card-lite textarea::placeholder{ color: rgba(255,140,0,.6); }

  /* Diversify colors in yearly remarks popup */
  #yearlyRemarksOverlayLite header h3 { color: #33cccc; } /* Title in cyan/teal */
  #yearlyRemarksOverlayLite header .btn { color: #dc3545; } /* Close button in red */
  /* removed grouped nth-child color rules so each month class controls its color */

  /* Change months text to orange */
  #kpiTitleMonths { color: orange !important; }

  /* Make deposit reminder text orange */
  .rem-pill--inside .rem-label { color: orange !important; font-size: 15px; }

  /* Calendar remarks button now uses standard .btn styles */

  /* Recolor textareas scrollbars to black track and yellow thumb */
  textarea::-webkit-scrollbar {
    width: 8px;
  }
  textarea::-webkit-scrollbar-track {
    background: #000;
  }
  textarea::-webkit-scrollbar-thumb {
    background: #ffff00;
  }
  textarea {
    scrollbar-width: thin;
    scrollbar-color: #ffff00 #000;
  }
</style>
<style>
/* === Injected: Minimal-footprint chevrons for Owner/Year selects === */
.titlebar .owner-year select,
.owner-year select{
  background-image: none !important;   /* remove built-in chevron */
  padding-right: 4px !important;       /* stop reserving space */
}
.owner-year .select-wrap{ position: relative; display: inline-block; }
.owner-year .select-wrap select{ background: #171719; }
.owner-year .select-wrap .chev{
  position: absolute;
  right: 2px;
  top: 50%;
  transform: translateY(-50%) scale(0.72);
  font-size: 8px;
  line-height: 1;
  opacity: .6;
  pointer-events: none;
  height: 0;              /* no layout impact */
  width: auto;
}
</style><style>
/* === Injected: ultra-compact width for Owner/Year selects === */
.owner-year { gap: 4px !important; } /* tighter spacing between fields */

/* Make selects auto-size to content with no forced min-width */
.titlebar .owner-year select,
.owner-year select {
  min-width: 0 !important;
  width: auto !important;
  padding-left: 4px !important;
  padding-right: 4px !important; /* chevron is absolute, so keep tiny */
  font-size: 10px !important;     /* small title for narrow width */
  letter-spacing: -0.2px;
  transform: scale(0.90);          /* visually tighter without shrinking click box */
  transform-origin: right center;
}

/* Field-specific hard caps (you can tweak these numbers) */
#owner { max-width: 88px !important; }
#year  { max-width: 56px !important; }

/* Ensure the wrapper itself doesn't add width */
.owner-year .select-wrap {
  display: inline-block;
  max-width: 100%;
}

/* Keep the tiny absolute chevron tight */
.owner-year .select-wrap .chev {
  right: 1px;
  transform: translateY(-50%) scale(0.64);
  font-size: 7px;
}
</style><style>
/* === Injected v2: ultra-narrow titles + larger dropdown content === */
.owner-year { gap: 3px !important; }

/* Closed (title) appearance: even smaller & tighter */
.titlebar .owner-year select,
.owner-year select {
  min-width: 0 !important;
  width: auto !important;
  max-width: none !important;
  padding-left: 2px !important;
  padding-right: 3px !important;
  font-size: 8px !important;      /* shrink title */
  letter-spacing: -0.2px;
  transform: scale(0.82);          /* compress visually */
  transform-origin: right center;
}

/* Hard caps for extra narrow look */
#owner { max-width: 72px !important; }  /* was 88 */
#year  { max-width: 44px !important; }  /* was 56 */

/* Keep chevron as tiny as possible */
.owner-year .select-wrap .chev {
  right: 0px;
  transform: translateY(-50%) scale(0.58);
  font-size: 6px;
  opacity: .55;
}

/* Opened dropdown (option list) content: larger & comfy */
.owner-year select option,
.owner-year select optgroup {
  font-size: 17px !important;     /* enlarge dropdown content */
  line-height: 1.65 !important;
}
</style><style>
/* === Injected v3: a little more narrow + bigger Year dropdown === */
.owner-year { gap: 2px !important; }

/* Closed (title) — slightly more compact */
.titlebar .owner-year select,
.owner-year select {
  padding-left: 1px !important;
  padding-right: 3px !important;
  font-size: 7px !important;
  transform: scale(0.78);              /* a bit more compression */
  transform-origin: right center;
}

/* Tighter caps */
#owner { max-width: 68px !important; } /* was 72 */
#year  { max-width: 40px !important; } /* was 44 */

/* Keep chevron ultra tiny */
.owner-year .select-wrap .chev {
  right: 0px;
  transform: translateY(-50%) scale(0.54);
  font-size: 6px;
  opacity: .55;
}

/* Enlarge Year dropdown content specifically */
#year option, #year optgroup {
  font-size: 19px !important;          /* bigger menu for Year */
  line-height: 1.7 !important;
}
</style><style>
/* === Injected v4: extend Year dropdown width (closed) === */
#year { 
  max-width: 72px !important;   /* extended from 40px -> 72px */
  padding-left: 2px !important; /* tiny breathing room */
  padding-right: 4px !important;
}
</style><style id="monthNoteOverlayStyles">    #monthNoteOverlay.overlay{ position:fixed; inset:0; background:rgba(0,0,0,0.28); display:flex; align-items:center; justify-content:center; z-index:1200; }    #monthNoteOverlay.hidden{ display:none; }    /* Use page card background for visual consistency */  #monthNoteOverlay .overlay-panel{ background: #000000; padding:14px; border-radius:10px; width:360px; box-shadow:0 12px 40px rgba(0,0,0,0.6); font-family:inherit; border:1px solid rgba(255,255,255,0.06); color: #ffffff; position:relative; }  /* subtle left accent using main accent color if available */  #monthNoteOverlay .overlay-panel::before{ content:''; position:absolute; left:0; top:0; bottom:0; width:6px; border-top-left-radius:10px; border-bottom-left-radius:10px; background: linear-gradient(180deg, var(--accent,#0b7a8a), var(--accent-amber,#ffb84d)); box-shadow:inset 0 0 8px rgba(0,0,0,0.03); }
  #monthNoteOverlay .overlay-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }  #monthNoteOverlay .overlay-body{ font-size:12px; color: #ffffff; }  #monthNoteOverlay .btn.small{ font-size:12px; padding:6px 10px; margin-left:8px; background: transparent; color: #ff8c00; border: none; border-radius: 4px; }  #monthNoteOverlay .btn.primary.small{ background: transparent; color: #ff8c00; border: none; border-radius: 4px; }  #monthNoteOverlay .btn.primary.small:hover{ background: rgba(255,140,0,0.06); }  #monthNoteOverlay .btn.small:hover{ background: rgba(255,255,255,0.03); }  #monthNoteOverlay label{ color: #ffffff; font-weight:600; font-size:12px; }  #monthNoteOverlay input[type=date], #monthNoteOverlay textarea{ border:1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.06); color: #ffffff; padding:6px; border-radius:4px; }  #monthNoteOverlay textarea::-webkit-scrollbar { display: none; }  #monthNoteOverlay textarea { scrollbar-width: none; }    /* Make the note button icon red to improve visibility */    .note-btn{ background:transparent;border:1px solid rgba(197,48,48,0.12); border-radius:4px; color:#c53030; }    .note-btn:hover{ background:rgba(197,48,48,0.04); }
  </style>
  <style>
    /* Hide static forecast hint as user requested removal */
    #kpiForecastYearEndHint{ display:none !important; }
  </style>
<!-- Libraries loaded dynamically via CDN in JavaScript --></head>
<body style="margin-top: -9mm;">
<div class="titlebar">
<div class="titlebar-inner">
<!-- Inline SVG sprite for KPI icons -->
<svg aria-hidden="true" style="display:none">
<symbol id="icon-check" viewBox="0 0 24 24">
<path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4z" fill="currentColor"></path>
</symbol>
<symbol id="icon-alert" viewBox="0 0 24 24">
<path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z" fill="currentColor"></path>
</symbol>
<symbol id="icon-clock" viewBox="0 0 24 24">
<path d="M12 1a11 11 0 1 0 11 11A11 11 0 0 0 12 1zm1 12.59V7h-2v6l5 3 .93-1.54z" fill="currentColor"></path>
</symbol>
</svg>
<div class="toolbar-right">
<!-- Toolbar actions moved to right-edge icon set per user request -->
<div style="width:1px; height:1px; opacity:0; pointer-events:none"></div>
</div>
</div>
</div>
<!-- Storage Diagnostics Overlay -->
<input accept=".xlsx,.xls,.json,.csv" aria-label="Import data file" id="importFile" style="display:none" title="Import data file (.xlsx, .xls, .csv, or .json)" type="file">
<!-- Right-edge icon set containing primary actions (keeps original IDs & handlers) -->
<style>
  /* KPI icon styles */
  .kpi-icon { display:inline-block; width:20px; height:20px; vertical-align:middle; margin-left:8px; }
  .kpi-icon svg { width:100%; height:100%; display:block; }
  .kpi-icon.comfort { color: #3bbf7d; }
  .kpi-icon.warning { color: #f5a623; }
  .kpi-icon.high { color: #f04f4f; }
  .kpi-icon.extreme { color: #b00020; }
  .kpi-icon.hidden { display:none; }
  .right-icon-wrap{ position:fixed; right:calc(12px + 3mm); top:calc(60px + 2cm + 2mm); transform:none; z-index:12000; display:flex; flex-direction:column; align-items:flex-end; gap:8px; }
  .right-icon-set{ display:flex; flex-direction:column; gap:8px; background:transparent; padding:6px; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,0.35); transform-origin:right center; transition:transform .18s ease, opacity .18s ease; opacity:0; transform:translateX(8px) scale(.98) translateY(-2cm); pointer-events:none; }
  .right-icon-set.open{ opacity:1; transform:translateX(0) scale(1) translateY(-2cm); pointer-events:auto; }
  .right-icon-set .btn{ display:flex; align-items:center; justify-content:center; gap:0; width:120px; height:32px; padding:4px 8px; border-radius:6px; font-size:12px; }
  .right-icon-set .btn .label{ display:none; white-space:nowrap; font-size:12px; color:#5c9090; background:transparent; padding:0; border-radius:0; }
  .right-icon-set.open .btn .label{ display:inline-block; }
  .right-icon-set .btn.round{ width:120px; border-radius:6px; }
  .right-icon-toggle{ width:40px; height:40px; border-radius:8px; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 6px 14px rgba(0,0,0,0.25); background:var(--card); font-size:18px; transform: translateY(-2cm); }
    @media (max-width:768px){ .right-icon-wrap{ right:8px; } }
  /* Move all buttons 4mm to the right (horizontal only, no vertical shift) */
  button, .btn, .sbtn, .iconbtn, input[type="button"], input[type="submit"] {
    transform: translateX(4mm) !important;
  }
  </style>
<div class="right-icon-wrap" id="rightIconWrap">
<!-- Ayat text logo in place of image -->
<div id="ayatTextLogo" style="width:60px; height:auto; border-radius:8px; display:block; margin-bottom:8px; box-shadow:0 8px 24px rgba(0,0,0,0.4), 0 0 20px rgba(123,217,159,0.3); cursor:pointer; transform: translateY(-2.7cm); transition: transform 0.3s ease, box-shadow 0.3s ease; font-size:26px; font-weight:normal; color:var(--kpi-name); text-align:center; line-height:0.7; background: rgba(255,255,255,0.1);">
AYAT<br><small style="font-size:9px; font-weight:normal;">properties</small>
</div>
<div aria-expanded="true" class="right-icon-toggle" id="rightIconToggle" role="button" title="Show actions">⋯</div>
<div aria-hidden="false" class="right-icon-set open" id="rightIconSet"><button class="btn" data-wired="1" id="btnSavePDF" title="Save page as PDF" data-pdf-prewarmed="1" data-pdf-prewarmed2="1">Save PDF</button><button class="btn" id="btnPrint" title="Print the page">Print</button><button class="btn" id="btnScenario" title="Open Scenarios">Scenarios</button>
<button class="btn" id="btnReset" title="Reset all data for current Owner &amp; Year only (month data, opening balance, reminders, calendar remarks)"><span class="label">Reset</span></button>
<button class="btn" id="btnRefresh" title="Refresh Page"><span class="label">Refresh</span></button>
<button class="btn" id="btnAiAnalysis" title="AI Analysis"><span class="label">AI Analysis</span></button>
<button class="btn" id="btnOwnerReport" title="Owner Report"><span class="label">Owner Report</span></button>
<button class="btn" id="btnExport" title="Export monthly data to a simple Excel sheet (.xlsx)"><span class="label">Export</span></button>
<!-- Export One Sheet removed per request -->
<button class="btn" id="btnYearlyRemarksLite" title="Yearly Cal. Remarks"><span class="label">Cal. Remarks</span></button>
<button class="btn" id="btnImport" title="Import data from Excel (.xlsx), CSV (.csv), or JSON (.json) files"><span class="label">Import</span></button>
<!-- Theme toggle removed per user request -->
<button class="btn round" id="btnTopShare" title="Deposit Req."><span class="label">Deposit Req.</span></button>
<button class="btn" id="btnEmailSettings" title="Email Set"><span class="label">Email Set</span></button>
<button class="btn" id="btnToggleNotes" title="Hidden notes (per Owner &amp; Year)"><span class="label">Notes</span></button>
<button class="btn" id="btnLogout" title="Switch user"><span class="label">Log out</span></button>
</div>
<!-- duplicate logo removed -->
</div>
<script>
    (function(){
      const toggle = document.getElementById('rightIconToggle');
      const set = document.getElementById('rightIconSet');
      if(!toggle || !set) return;
      function open(){ set.classList.add('open'); set.setAttribute('aria-hidden','false'); toggle.setAttribute('aria-expanded','true'); }
      function close(){ set.classList.remove('open'); set.setAttribute('aria-hidden','true'); toggle.setAttribute('aria-expanded','false'); }
      let opened = true;
      toggle.addEventListener('click', ()=>{ opened = !opened; if(opened) open(); else close(); });
      // Start with buttons open
      open();
      // No outside click to close; buttons close only on toggle click
      // close on Escape
      document.addEventListener('keydown', (ev)=>{ if(ev.key === 'Escape' && opened){ opened = false; close(); } });
    })();

      // Storage Diagnostics wiring
      (function(){
        const btn = document.getElementById('btnStorageDiag');
        const overlay = document.getElementById('storageDiagOverlay');
        const closeBtns = [document.getElementById('btnStorageDiagClose'), document.getElementById('btnStorageDiagClose2')];
        const listEl = document.getElementById('sdList');
        const searchEl = document.getElementById('sdSearch');
        const refreshBtn = document.getElementById('sdRefresh');
        const clearAllBtn = document.getElementById('sdClearAll');

        if(!btn || !overlay || !listEl) return;
        function enumerate(filter){
          listEl.textContent = '';
          const found = [];
          for(let i=0;i<localStorage.length;i++){
            const k = localStorage.key(i);
            if(!k) continue;
            if(!k.endsWith(':monthData')) continue;
            const raw = localStorage.getItem(k)||'';
            const preview = raw.substring(0,300) + (raw.length>300? '...':'');
            if(filter){ const f = filter.toLowerCase(); if(!(k.toLowerCase().includes(f) || preview.toLowerCase().includes(f))) continue; }
            found.push({ key:k, raw, preview });
          }
          if(found.length===0){ listEl.innerHTML = '<div style="padding:8px;color:var(--muted)">No :monthData keys found.</div>'; return found; }
          // Build UI
          found.forEach(item=>{
            const wrap = document.createElement('div'); wrap.style.padding='8px'; wrap.style.borderBottom='1px solid rgba(255,255,255,0.03)';
            const keyEl = document.createElement('div'); keyEl.textContent = item.key; keyEl.style.fontWeight='700'; keyEl.style.marginBottom='6px';
            const pre = document.createElement('pre'); pre.style.whiteSpace='pre-wrap'; pre.style.margin='0 0 6px 0'; pre.textContent = item.preview;
            const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px';
            const btnView = document.createElement('button'); btnView.className='btn'; btnView.textContent='View full';
            const btnDelete = document.createElement('button'); btnDelete.className='btn danger'; btnDelete.textContent='Delete';
            btnView.addEventListener('click', ()=>{ try{ const full = item.raw || ''; const w = window.open('about:blank','_blank'); w.document.write('<pre style="white-space:pre-wrap;font-family:monospace;padding:10px">'+(full.replace(/</g,'&lt;'))+'</pre>'); w.document.close(); }catch(e){ alert('Open failed: '+e.message); } });
            btnDelete.addEventListener('click', ()=>{ if(!confirm('Delete key '+item.key+' ? This cannot be undone.')) return; try{ localStorage.removeItem(item.key); showToast('Deleted '+item.key); enumerate(searchEl.value); }catch(e){ alert('Delete failed: '+String(e)); } });
            actions.appendChild(btnView); actions.appendChild(btnDelete);
            wrap.appendChild(keyEl); wrap.appendChild(pre); wrap.appendChild(actions);
            listEl.appendChild(wrap);
          });
          return found;
        }

        btn.addEventListener('click', ()=>{ overlay.classList.add('show'); overlay.setAttribute('aria-hidden','false'); enumerate(''); try{ searchEl.focus(); }catch(e){} });
        closeBtns.forEach(c=>{ if(c) c.addEventListener('click', ()=>{ overlay.classList.remove('show'); overlay.setAttribute('aria-hidden','true'); }); });
        refreshBtn && refreshBtn.addEventListener('click', ()=> enumerate(searchEl.value));
        searchEl && searchEl.addEventListener('input', ()=> enumerate(searchEl.value));
        clearAllBtn && clearAllBtn.addEventListener('click', ()=>{
          if(!confirm('Delete ALL :monthData keys found? This will remove month data for all owners/years that match.')) return;
          const found = enumerate(searchEl.value);
          found.forEach(f=>{ try{ localStorage.removeItem(f.key); }catch(e){} });
          showToast('Deleted '+found.length+' keys');
          enumerate(searchEl.value);
        });
      })();
  </script>
<div class="wrap grid">
<!-- Main Title -->
<div class="card" style="text-align:center;">
<h1 style="margin:0; font-size:20px; color:var(--gold); font-family: &#39;Georgia&#39;, serif; font-weight: bold; letter-spacing: 1.5px;">ENBD Performance Tracker</h1>
<p style="margin:5px 0 0; font-size:14px; font-style:italic; color:#ADD8E6; font-family: &#39;Georgia&#39;, serif;">Created by Fuad Al-Taher</p>
</div>
<!-- Owner and Year Selectors -->
<div class="card" style="position:fixed; left:0; top:-5mm; width:233px; text-align:left; margin-bottom:12px; z-index:140; transform: scale(1.045); transform-origin: left top;">
<div class="owner-year" style="flex-direction: column; position:relative;">
<div id="userSessionChip" class="pill" style="display:none; position:absolute; top:6px; right:6px; gap:4px; align-items:center; padding:2px 6px; font-size:10px; background:rgba(255,255,255,0.12); border-radius:999px; border:1px solid rgba(255,255,255,0.18); text-transform:uppercase; letter-spacing:0.6px;"></div>
<div>
<label for="owner">Owner</label>
<div style="display:flex; gap:8px; align-items:center">
<span class="select-wrap"><select class="custom-chevron" id="owner" style="color: rgb(106, 141, 255);"><option value="SHTHA">SHTHA</option><option value="TAMADUR">TAMADUR</option><option value="Owner 1">Owner 1</option><option value="SHTHA_ENDB">SHTHA_ENDB</option><option value="Owner 3">Owner 3</option><option value="Owner 4">Owner 4</option><option value="Owner 5">Owner 5</option><option value="Owner 6">Owner 6</option><option value="Owner 7">Owner 7</option><option value="Owner 8">Owner 8</option><option value="Owner 9">Owner 9</option><option value="Owner 10">Owner 10</option></select><span class="chev">▾</span></span>
</div>
</div>
<!-- Hidden Notes Drawer (per Owner & Year) -->
<div aria-hidden="true" class="notes-drawer" id="notesDrawer">
<div class="notes-drawer-inner">
<div style="display:flex; justify-content:space-between; align-items:center; gap:8px; padding-bottom:6px; border-bottom:1px solid rgba(255,255,255,0.03);">
<h3 style="margin:0; font-size:13px; color:#33cccc">Notes</h3>
<div style="display:flex; gap:8px; align-items:center;">
<button class="btn" id="btnCloseNotes" style="font-size:12px; padding:6px 8px" title="Close notes">Close</button>
</div>
</div>
<!-- Make recipient visible at top of notes drawer for discoverability -->
<div style="margin-top:8px; padding-top:6px; border-bottom:1px solid rgba(255,255,255,0.03); display:flex; align-items:center; gap:8px;">
<label style="font-family: system-ui, -apple-system, &#39;Segoe UI&#39;, Roboto, &#39;Helvetica Neue&#39;, Arial, sans-serif; font-size:11px; margin:0; display:block;">Recipient name (required):</label>
<input id="noteShareRecipient" placeholder="e.g., John Doe" style="font-family: system-ui, -apple-system, &#39;Segoe UI&#39;, Roboto, &#39;Helvetica Neue&#39;, Arial, sans-serif; font-size:11px; width:160px; padding:6px; border-radius:6px; background:#18181b; border:1px solid #2a2a30; color:var(--text);" type="text">
</div>
<div style="padding-top:8px;">
<textarea class="textarea" id="notesArea" placeholder="Write private notes for this Owner &amp; Year..." style="min-height:180px; font-size:13px"></textarea>
<div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
<button class="btn" id="btnClearNotes" title="Clear notes">Clear</button>
<button class="btn" id="btnSaveNotes" title="Save notes">Save</button>
<!-- Added Close button under notes controls -->
<button class="btn" id="noteCloseBtn" style="font-size:12px; padding:6px 8px; margin-left:8px" title="Close notes">Close</button>
</div>
<!-- recipient field moved to the top of the drawer for better discoverability -->
<div style="display:flex; gap:8px; justify-content:flex-end; margin-top:10px;">
<div class="sbtn" id="noteWhatsApp" style="cursor:pointer;">WhatsApp</div>
<div class="sbtn" id="noteEmail" style="cursor:pointer;">Email</div>
<div class="sbtn" id="noteCopy" style="cursor:pointer;">Copy</div>
<div class="sbtn" id="notePrint" style="cursor:pointer;">Print</div>
</div>
</div>
</div>
</div>
<div>
<label for="year">Year</label>
<span class="select-wrap"><select class="custom-chevron" id="year">
<!-- options populated dynamically -->
</select><span class="chev">▾</span></span>
</div>
<span id="yearDataLabel" style="text-align: center; display: inline-block; position: relative; left: 0px; color: rgb(106, 141, 255);">
<span class="owner-avatar" id="ownerLogo" style="font-size:28px;">👤</span>
<span class="yline y-owner" style="color: rgb(106, 141, 255);">TAMADUR</span>
<span class="yline y-year" style="color: rgb(106, 141, 255);">2025</span>
<span class="yline y-full" style="color: rgb(106, 141, 255);">TAMADUR Year Data: 2025</span>
</span>
<div id="noOwnerAccessNotice" style="display:none; margin-top:10px; padding:8px; border-radius:8px; font-size:12px; color:#ffb84d; background:rgba(255,184,77,0.08); border:1px solid rgba(255,184,77,0.16); text-align:left;">
  No owners are assigned to this user yet. Please ask an admin to grant access.
</div>
</div>
</div>
<!-- Cheque Deposit Reminders (moved up for visibility) -->
<!-- Floating reminders drawer trigger (visible) -->
<div class="rem-drawer" id="reminderDrawer">
<div class="rem-drawer-inner">
<div style="display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:4px">
<div style="display:flex; align-items:center; gap:10px;">
<h3 style="margin:0; font-size:10px;">Cheque Deposit Reminders</h3>
</div>
<div style="display:flex; gap:4px; align-items:center;">
<button class="btn" id="btnAddCustom" style="font-size:10px;" title="Add reminder">Add</button>
<button class="btn" id="btnCloseRemDrawer" style="font-size:10px;" title="Close">Close</button>
</div>
</div>
<div id="remList" style="min-height: 80px; display: block;"></div>
<div id="remDebug" style="font-size:11px; color:var(--muted); margin-top:6px">load:enbd:TAMADUR:reminders (0)</div>
</div>
</div>
<!-- Floating pill to open reminders drawer (moved into Mo. Needed card) -->
<!-- original floating location removed; button reinserted inside #moNeededCard so handlers remain attached -->
<!-- Owners Editor Overlay -->
<div aria-hidden="true" class="overlay" id="ownersOverlay">
<div aria-labelledby="ownersTitle" aria-modal="true" class="pop" role="dialog">
<header>
<h3 id="ownersTitle">Manage Owners</h3>
<button class="btn close" id="btnOwnersClose">Close</button>
</header>
<div class="content">
<div style="margin-bottom:8px">Edit the owner list below. Add new owners or remove entries you no longer need.</div>
<div id="ownersList" style="display:flex; flex-direction:column; gap:8px; margin-bottom:10px"></div>
<div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
<button class="btn" id="btnAddOwner" type="button">Add Owner</button>
<button class="btn" id="btnSaveOwners" type="button">Save</button>
</div>
</div>
<footer>
<button class="btn close" id="btnOwnersClose2">Close</button>
</footer>
</div>
</div>
<!-- Years Editor Overlay -->
<div aria-hidden="true" class="overlay" id="yearsOverlay">
<div aria-labelledby="yearsTitle" aria-modal="true" class="pop" role="dialog">
<header>
<h3 id="yearsTitle">Manage Years</h3>
<button class="btn close" id="btnYearsClose">Close</button>
</header>
<div class="content">
<div style="margin-bottom:8px">Edit year entries below. Add or remove years as needed; changes apply to the Year dropdown for all owners.</div>
<div id="yearsList" style="display:flex; flex-direction:column; gap:8px; margin-bottom:10px"></div>
<div style="display:flex; gap:8px">
<button class="btn" id="btnAddYear">Add Year</button>
<button class="btn" id="btnSaveYears">Save</button>
</div>
</div>
<footer>
<button class="btn close" id="btnYearsClose2">Close</button>
</footer>
</div>
</div>
<!-- KPIs -->
<div class="card">
<div class="kpis">
<div class="kpi">
<h3>📊 Total Target</h3>
<div class="val neutral-muted" id="kpiTotalTarget"><span style="font-size:10px; opacity:0.85; vertical-align:baseline; font-weight:600">AED</span>&nbsp;<span class="kpi-amount">0</span></div>
</div>
<div class="kpi">
<h3>💰 YTD Inflow</h3>
<div class="val" id="kpiInflow"><span style="font-size:10px; opacity:0.85; vertical-align:baseline; font-weight:600">AED</span>&nbsp;<span class="kpi-amount">0</span></div>
</div>
<div class="kpi">
<h3>⚖️ Remaining to Active Target</h3>
<div class="val" id="kpiBalance"><span style="font-size:10px; opacity:0.85; vertical-align:baseline; font-weight:600">AED</span>&nbsp;<span class="kpi-amount">0</span></div>
</div>
<div class="kpi">
<h3>🏦 Opening Balance</h3>
<div class="val" id="kpiOpeningBalance" style="color: rgb(0, 0, 255);">Nil</div>
</div>
<div class="kpi">
<h3>📈 Avg. Mo. Target</h3>
<div class="val" id="kpiAvgMoTarget"><span style="font-size:10px; opacity:0.85; vertical-align:baseline; font-weight:600">AED</span>&nbsp;<span class="kpi-amount">0</span></div>
</div>
<div class="kpi">
<h3>📊 Avg. Mo. Inflow</h3>
<div class="val" id="kpiAvgMonthly"><span style="font-size:10px; opacity:0.85; vertical-align:baseline; font-weight:600">AED</span>&nbsp;<span class="kpi-amount">0</span></div>
</div>
<div class="kpi">
<h3>📉 Mo. Variance</h3>
<div class="val" id="kpiMoVariance"><span style="font-size:10px; opacity:0.85; vertical-align:baseline; font-weight:600">AED</span>&nbsp;<span class="kpi-amount">0</span></div>
</div>
<div class="kpi">
<h3>📊 Total Deviation</h3>
<div class="val" id="kpiTotalDeviation" style="color: rgb(106, 141, 255);"><span style="font-size:10px; opacity:0.85; vertical-align:baseline; font-weight:600">AED</span>&nbsp;<span class="kpi-amount">0</span></div>
</div>
<div class="kpi">
<h3>🔮 Forecasted Year-End</h3>
<div class="val" id="kpiForecastYearEnd"><span style="font-size:10px; opacity:0.85; vertical-align:baseline; font-weight:600">AED</span>&nbsp;<span class="kpi-amount">0</span><div id="kpiForecastYearEndHint" class="small" style="font-size: 8px; font-weight: lighter; color: var(--muted); margin-top: 6px;"></div></div>
</div>
<!-- Mo. Needed tile moved below the KPI grid to sit clearly under the upper KPI numbers -->
</div>
</div>
<!-- Prominent Mo. Needed card (full-width beneath KPIs) - toned down visuals -->
<div class="card" id="moNeededCard" style="margin-top:-2mm; text-align:center; transform:scaleY(0.72); transform-origin:top center;">
<div class="mo-needed-ribbon">
<!-- Forecast text moved into the Forecast KPI tile to simplify layout -->
<!-- absolutely-centered number (relative to this wrapper) -->
<div class="val" data-avg="0" data-gross="0" data-net="0" id="kpiMoNeeded" style="position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); font-size:20px; font-weight:700; z-index:2; pointer-events:none;" title="Gross: AED 5 (before expected inflows). Net/mo: AED 5. Avg. Mo. Inflow: AED 0">—</div>
<!-- Left: title -->
<div class="mo-needed-left" style="min-width:233px;">
<h3 style="margin:0; font-weight:700; font-size:14px; color:#33cccc">📊 Mo. Inflow Needed YE <span id="kpiTitleMonths" style="font-weight:400; color:orange !important; margin-left:8px; font-size:14px">2.97 months</span><span class="kpi-icon warning" id="kpiTitleMonthsIcon" title="Risk: 33/100 — Warning"><svg aria-hidden="true"><use xlink:href="#icon-clock"></use></svg></span></h3>
</div>
<div class="mo-needed-spacer" aria-hidden="true"></div>
<!-- Right: reminder pill stays on the right without affecting center alignment -->
<div class="mo-needed-right">
<button aria-label="Open reminders" class="rem-pill rem-pill--inside state-normal" id="btnOpenRem" title="No upcoming reminders"><span class="rem-icon">🎉</span> <span class="rem-label">Target achieved 🎉</span> <span aria-hidden="true" class="state-normal" id="remBadge">0</span></button>
</div>
</div>
<div class="small" id="kpiMoNeededMeta" style="margin-top: 52px; color: rgb(106, 141, 255); font-size: 12px; text-align: center;">Gross/mo: AED 0 · Expected remaining inflow: AED 0</div></div>
<!-- Standalone chart card (under KPIs) -->
<div class="card" id="chartCard" style="margin-top:-12mm; position:relative;">
  <h3 style="margin:0 0 8px 0; font-size:14px; color:#5c9090">Monthly Overview</h3>
<!-- Inline mini-legend placed above/right of the chart -->
<div id="miniLegend" style="position:absolute; right:12px; top:28px; display:flex; gap:12px; align-items:center; background:rgba(255,255,255,0.02); padding:6px 8px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); z-index:5;">
<div style="display:flex; gap:6px; align-items:center; font-size:13px; color:var(--muted);">
<span style="display:inline-block; width:18px; height:10px; border:2px solid #7bd99f; background:transparent; border-radius:2px;"></span>
<span style="color:#7bd99f;">Balance</span>
</div>
<div style="display:flex; gap:6px; align-items:center; font-size:13px; color:var(--muted);">
<span style="display:inline-block; width:18px; height:10px; border:2px dashed #ff0000; background:transparent; border-radius:2px;"></span>
<span style="color:#ff0000;">Target</span>
</div>
<div style="display:flex; gap:6px; align-items:center; font-size:13px; color:var(--muted);">
<span style="display:inline-block; width:18px; height:10px; border:2px solid #66a6ff; background:transparent; border-radius:2px;"></span>
<span style="color:#66a6ff;">Bank Inflow</span>
</div>
</div>
<div style="height:180px;">
<canvas aria-label="Monthly balances chart" height="360" id="miniChart" role="img" style="width: 1026px; height: 180px; display: block; box-sizing: border-box;" width="2052"></canvas>
</div>
</div>
<!-- Monthly table + chart -->
<div class="grid row2">
<div class="tableCard card">
<div class="note" style="display:grid; grid-template-columns:7% 8% 12% 41% 12% 10% 10%; gap:8px; align-items:center;">
<div style="grid-column:1 / 5; font-size:13px;">Edit amounts and they are saved <b>per Owner &amp; Year</b>. Chart and KPIs update automatically.</div>
<div style="grid-column:5 / 8; display:flex; justify-content:flex-end; align-items:center; gap:8px; transform: translateX(-1.5cm);">
<label style="font-size:13px; white-space:nowrap">Opening Balance:</label>
<input id="openingBalance" style="width: 140px; text-align: right; padding: 4px 6px; border-radius: 6px; color: blue;" type="text" value="0">
</div>
</div>
<table id="monthTable">
<thead>
<tr>
<th style="width:7.7%">Day</th>
<th style="width:8%">Month</th>
<th style="width:12%">Target</th>
<th style="width:41%">Note</th>
<th style="width:12%">Bank Inflow</th>
<th style="width:10%">Variance</th>
<th style="width:10%">Balance</th>
</tr>
</thead>
<tbody><tr><td><input type="text" id="month-day-0" aria-label="Day for Jan" style="font-size: calc(10.89px);"></td><td class="month-cell"><span class="month-index">1</span><span class="month-label">Jan</span></td><td><input type="text" id="month-target-0" aria-label="Target for Jan"></td><td><input type="text" id="month-note-0" placeholder="Note" aria-label="Note for Jan"></td><td><input type="text" id="month-inflow-0" aria-label="Bank inflow for Jan"></td><td>0</td><td>0</td></tr><tr><td><input type="text" id="month-day-1" aria-label="Day for Feb" style="font-size: calc(10.89px);"></td><td class="month-cell"><span class="month-index">2</span><span class="month-label">Feb</span></td><td><input type="text" id="month-target-1" aria-label="Target for Feb"></td><td><input type="text" id="month-note-1" placeholder="Note" aria-label="Note for Feb"></td><td><input type="text" id="month-inflow-1" aria-label="Bank inflow for Feb"></td><td>0</td><td>0</td></tr><tr><td><input type="text" id="month-day-2" aria-label="Day for Mar" style="font-size: calc(10.89px);"></td><td class="month-cell"><span class="month-index">3</span><span class="month-label">Mar</span></td><td><input type="text" id="month-target-2" aria-label="Target for Mar"></td><td><input type="text" id="month-note-2" placeholder="Note" aria-label="Note for Mar"></td><td><input type="text" id="month-inflow-2" aria-label="Bank inflow for Mar"></td><td>0</td><td>0</td></tr><tr><td><input type="text" id="month-day-3" aria-label="Day for Apr" style="font-size: calc(10.89px);"></td><td class="month-cell"><span class="month-index">4</span><span class="month-label">Apr</span></td><td><input type="text" id="month-target-3" aria-label="Target for Apr"></td><td><input type="text" id="month-note-3" placeholder="Note" aria-label="Note for Apr"></td><td><input type="text" id="month-inflow-3" aria-label="Bank inflow for Apr"></td><td>0</td><td>0</td></tr><tr><td><input type="text" id="month-day-4" aria-label="Day for May" style="font-size: calc(10.89px);"></td><td class="month-cell"><span class="month-index">5</span><span class="month-label">May</span></td><td><input type="text" id="month-target-4" aria-label="Target for May"></td><td><input type="text" id="month-note-4" placeholder="Note" aria-label="Note for May"></td><td><input type="text" id="month-inflow-4" aria-label="Bank inflow for May"></td><td>0</td><td>0</td></tr><tr><td><input type="text" id="month-day-5" aria-label="Day for Jun" style="font-size: calc(10.89px);"></td><td class="month-cell"><span class="month-index">6</span><span class="month-label">Jun</span></td><td><input type="text" id="month-target-5" aria-label="Target for Jun"></td><td><input type="text" id="month-note-5" placeholder="Note" aria-label="Note for Jun"></td><td><input type="text" id="month-inflow-5" aria-label="Bank inflow for Jun"></td><td>0</td><td>0</td></tr><tr><td><input type="text" id="month-day-6" aria-label="Day for Jul" style="font-size: calc(10.89px);"></td><td class="month-cell"><span class="month-index">7</span><span class="month-label">Jul</span></td><td><input type="text" id="month-target-6" aria-label="Target for Jul"></td><td><input type="text" id="month-note-6" placeholder="Note" aria-label="Note for Jul"></td><td><input type="text" id="month-inflow-6" aria-label="Bank inflow for Jul"></td><td>0</td><td>0</td></tr><tr><td><input type="text" id="month-day-7" aria-label="Day for Aug" style="font-size: calc(10.89px);"></td><td class="month-cell"><span class="month-index">8</span><span class="month-label">Aug</span></td><td><input type="text" id="month-target-7" aria-label="Target for Aug"></td><td><input type="text" id="month-note-7" placeholder="Note" aria-label="Note for Aug"></td><td><input type="text" id="month-inflow-7" aria-label="Bank inflow for Aug"></td><td>0</td><td>0</td></tr><tr><td><input type="text" id="month-day-8" aria-label="Day for Sep" style="font-size: calc(10.89px);"></td><td class="month-cell"><span class="month-index">9</span><span class="month-label">Sep</span></td><td><input type="text" id="month-target-8" aria-label="Target for Sep"></td><td><input type="text" id="month-note-8" placeholder="Note" aria-label="Note for Sep"></td><td><input type="text" id="month-inflow-8" aria-label="Bank inflow for Sep"></td><td>0</td><td>0</td></tr><tr><td><input type="text" id="month-day-9" aria-label="Day for Oct" style="font-size: calc(10.89px);"></td><td class="month-cell"><span class="month-index">10</span><span class="month-label">Oct</span></td><td><input type="text" id="month-target-9" aria-label="Target for Oct"></td><td><input type="text" id="month-note-9" placeholder="Note" aria-label="Note for Oct"></td><td><input type="text" id="month-inflow-9" aria-label="Bank inflow for Oct"></td><td>0</td><td>0</td></tr><tr><td><input type="text" id="month-day-10" aria-label="Day for Nov" style="font-size: calc(10.89px);"></td><td class="month-cell"><span class="month-index">11</span><span class="month-label">Nov</span></td><td><input type="text" id="month-target-10" aria-label="Target for Nov"></td><td><input type="text" id="month-note-10" placeholder="Note" aria-label="Note for Nov"></td><td><input type="text" id="month-inflow-10" aria-label="Bank inflow for Nov"></td><td>0</td><td>0</td></tr><tr><td><input type="text" id="month-day-11" aria-label="Day for Dec" style="font-size: calc(10.89px);"></td><td class="month-cell"><span class="month-index">12</span><span class="month-label">Dec</span></td><td><input type="text" id="month-target-11" aria-label="Target for Dec"></td><td><input type="text" id="month-note-11" placeholder="Note" aria-label="Note for Dec"></td><td><input type="text" id="month-inflow-11" aria-label="Bank inflow for Dec"></td><td>0</td><td>0</td></tr></tbody>
<tfoot>
<tr class="totals-row" style="font-weight:700;">
<td colspan="2" style="color:#58a6ff; text-align:center; vertical-align:middle;">Total</td>
<td id="totTarget" style="color:#f85149">0</td>
<td></td>
<td id="totInflow" style="color:#7bd99f">0</td>
<td id="totVariance" style="color: rgb(123, 217, 159);">0</td>
<td id="totBalance" style="color: rgb(123, 217, 159);">0</td>
</tr>
<tr>
<td style="padding:6px; vertical-align:top;">
<div id="privacyUnderTotal" style="display:flex; gap:6px; align-items:center;">
<input id="currentPassword" type="hidden">
<input id="newPassword" type="hidden">
<button class="btn" id="btnSavePassword" style="display:none;">🔒</button>
<button class="btn" id="btnRemovePassword" style="display:none;">🗑️</button>
<button class="btn" id="btnEditOwners" style="padding:6px 8px; font-size:12px" title="Manage owners">👥</button>
<button class="btn" id="btnEditYears" style="padding:6px 8px; font-size:12px" title="Manage years">📅</button>
<button class="btn" id="btnManageUsers" style="padding:6px 8px; font-size:12px; display:none" title="Assign owners to team members">👤</button>
<button class="btn" id="btnDuplicateOwner" style="padding:6px 8px; font-size:12px" title="Duplicate owner data">📋</button>
<span class="fineTextInline">Renaming owners migrates data for the selected year.</span>
</div>
<div class="small" id="passwordStorageNotice" style="display:none; margin-top:6px; color: var(--danger);"></div>
</td>
<td colspan="6"></td>
</tr>
</tfoot>
</table>
<!-- compact ribbon removed (owner photo and duplicates) -->
<div id="monthDebug" style="font-size:11px; color:var(--muted); margin-top:6px; white-space:pre-wrap; max-height:120px; overflow:auto"></div>
</div>
</div>
<!-- remindersCard moved to top for visibility -->
</div>
<!-- Share Monthly Plan Popup -->
<div aria-hidden="true" class="overlay" id="shareOverlay">
<div aria-labelledby="shareTitle" aria-modal="true" class="pop" role="dialog">
<header>
<h3 id="shareTitle" style="font-family: system-ui, -apple-system, &#39;Segoe UI&#39;, Roboto, &#39;Helvetica Neue&#39;, Arial, sans-serif; font-weight:600; font-size:10px">Deposit Req.</h3>
<button class="btn close" id="btnShareClose">Close</button>
</header>
<div class="content">
<label class="required-label" for="shareRecipient" style="font-size:10px; margin-bottom:6px; display:block; font-family: system-ui, -apple-system, &#39;Segoe UI&#39;, Roboto, &#39;Helvetica Neue&#39;, Arial, sans-serif">Recipient name required</label>
<input id="shareRecipient" placeholder="Recipient Name" style="width:100%; padding:8px; margin-bottom:8px; border-radius:8px; background:#18181b; border:1px solid #2a2a30; color:var(--text); font-family: system-ui, -apple-system, &#39;Segoe UI&#39;, Roboto, &#39;Helvetica Neue&#39;, Arial, sans-serif; font-size:10px" type="text">
<!-- Flag checkboxes: let the user include colored flags in the shared message -->
<div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
  <label style="display:inline-flex; align-items:center; gap:6px; font-size:13px;">
    <input type="checkbox" id="shareFlagGreen"> <span style="color:#2ecc71; font-weight:700">🟢 Include Green</span>
  </label>
  <label style="display:inline-flex; align-items:center; gap:6px; font-size:13px;">
    <input type="checkbox" id="shareFlagYellow"> <span style="color:#f1c40f; font-weight:700">🟡 Include Yellow</span>
  </label>
  <label style="display:inline-flex; align-items:center; gap:6px; font-size:13px;">
    <input type="checkbox" id="shareFlagRed"> <span style="color:#e74c3c; font-weight:700">🔴 Include Red</span>
  </label>
</div>
<textarea class="textarea" id="shareText" spellcheck="false"></textarea>
<div class="sharegrid">
<div class="sbtn" id="sWhatsApp">WhatsApp</div>
<div class="sbtn" id="sEmail">Email</div>
<div class="sbtn" id="sCopy">Copy</div>
<div class="sbtn" id="sPrint">Print</div>
</div>
<div class="hint" style="margin-top:8px">Removed: Telegram, SMS (as requested). Footer signs “Thanks, Fuad Al‑Taher”.</div>
</div>
<footer>
<button class="btn close" id="btnShareClose2">Close</button>
</footer>
</div>
</div>
<!-- Password Overlay (disabled) -->
<div aria-hidden="true" class="overlay" id="passwordOverlay" style="display:none !important;">
<div aria-labelledby="passwordTitle" aria-modal="true" class="pop" role="dialog">
<header>
<h3 id="passwordTitle">Enter Password</h3>
</header>
<div class="content">
<p>Data is protected. Enter password to access.</p>
<form id="passwordForm" onsubmit="return false;">
<input id="passwordInput" placeholder="Password" type="password">
<button id="btnEnterPassword" type="submit">Enter</button>
</form>
</div>
</div>
</div>
<!-- User Login Overlay -->
<div aria-hidden="true" class="overlay" id="userLoginOverlay">
<div aria-labelledby="userLoginTitle" aria-modal="true" class="pop" role="dialog">
<header>
<h3 id="userLoginTitle">Sign in to ENBD Tracker</h3>
</header>
<div class="content login-content">
<div class="login-role-toggle" aria-label="Choose sign-in role" role="tablist">
<button aria-selected="true" class="login-role active" data-role="team" id="loginRoleTeam" type="button">
<span class="login-role-title">Team Member</span>
<span class="login-role-sub">Use the username your admin assigned to you.</span>
</button>
<button aria-selected="false" class="login-role" data-role="admin" id="loginRoleAdmin" type="button">
<span class="login-role-title">Administrator</span>
<span class="login-role-sub">Full control over owners, years, and team access.</span>
</button>
</div>
<div class="login-role-description" data-role="team">
<p>Team members can reach their dashboards with the credentials shared by an administrator. Need access? Ask your admin to add you under <strong>Manage Team Access</strong>.</p>
</div>
<div class="login-role-description hidden" data-role="admin">
<p>Administrators unlock every owner, manage targets, and invite teammates. Use your personal admin credentials or the default pair below for first-time setup.</p>
<div class="login-admin-credentials">Default admin: <span>admin / Admin@123</span></div>
</div>
<div class="login-saved-cta hidden" id="loginSavedCta" role="status">
<div class="login-saved-text" id="loginSavedText"></div>
<button class="btn primary hidden" id="btnLoginSaved" type="button">Sign in now</button>
</div>
<form id="userLoginForm">
<div class="login-field">
<label for="loginUsername">Username</label>
<input autocomplete="username" id="loginUsername" placeholder="e.g., rania" required type="text">
</div>
<div class="login-field">
<label for="loginPassword">Password</label>
<input autocomplete="current-password" id="loginPassword" placeholder="Password" required type="password">
</div>
<label class="login-remember">
<input id="loginRemember" type="checkbox">
<span>Remember this device for quick admin/team sign-in (stores an encrypted token in this browser).</span>
</label>
<div class="login-error" id="loginError">Incorrect username or password.</div>
<div class="login-actions">
<button class="btn hidden" id="loginClearSaved" type="button">Forget saved login</button>
<button class="btn primary" id="btnSubmitLogin" type="submit">Sign In</button>
</div>
</form>
</div>
</div>
</div>
<!-- Team Administration Overlay -->
<div aria-hidden="true" class="overlay" id="userAdminOverlay">
<div aria-labelledby="userAdminTitle" aria-modal="true" class="pop" role="dialog">
<header>
<h3 id="userAdminTitle">Manage Team Access</h3>
<button class="btn close" id="btnCloseUserAdmin">Close</button>
</header>
<div class="content">
<div style="font-size:12px; color:var(--muted);">Assign owners to each employee. Saving updates their access immediately.</div>
<div id="userAdminList" style="display:flex; flex-direction:column; gap:12px;"></div>
<div class="user-admin-add">
<h4>Add Team Member</h4>
<div class="user-admin-grid">
<div>
<label for="newUserName">Username</label>
<input autocomplete="off" id="newUserName" placeholder="e.g., rania" type="text">
</div>
<div>
<label for="newUserPassword">Password</label>
<input autocomplete="new-password" id="newUserPassword" placeholder="Password" type="password">
</div>
<div>
<label for="newUserPasswordConfirm">Confirm Password</label>
<input autocomplete="new-password" id="newUserPasswordConfirm" placeholder="Repeat password" type="password">
</div>
</div>
<div>
<label style="font-size:12px; color:var(--muted); font-weight:600;">Assign owners</label>
<div class="user-owner-list" id="newUserOwners"></div>
</div>
<div class="user-card-actions" style="justify-content:flex-start;">
<button class="btn" id="btnCreateUser" type="button">Add Member</button>
</div>
</div>
</div>
<footer>
<button class="btn close" id="btnCloseUserAdminFooter">Close</button>
</footer>
</div>
</div>
<!-- AI Analysis Popup -->
<div aria-hidden="true" class="overlay" id="aiOverlay">
<div aria-labelledby="aiTitle" aria-modal="true" class="pop" role="dialog">
<header>
<h3 id="aiTitle">AI Analysis — Owner Situation</h3>
<button class="btn close" id="btnAiClose">Close</button>
</header>
<div class="content">
<div style="display:flex; gap:8px; margin-bottom:8px; align-items:center">
<button class="btn" id="btnRunAi">Run Analysis</button>
<button class="btn" id="btnToggleBreakdown" title="Show/hide per-month breakdown">Hide breakdown</button>
<div style="color:var(--muted); font-size:13px">Analysis is local and heuristic-based.</div>
</div>
<div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
<label style="display:flex; align-items:center; gap:8px; font-size:13px">Scenario:
            <select id="aiScenarioSelect" style="padding:6px; border-radius:6px; background:#18181b; border:1px solid #2a2a30; color:var(--text)">
<option value="All">All (Pessimistic / Conservative / Base / Optimistic)</option>
<option value="Pessimistic">Pessimistic</option>
<option value="Conservative">Conservative</option>
<option value="Base">Base</option>
<option value="Optimistic">Optimistic</option>
</select>
</label>
<label style="display:flex; align-items:center; gap:8px; font-size:13px">If deposit (AED):
            <input id="aiIfDeposit" placeholder="0" style="width:120px; padding:6px; border-radius:6px; background:#18181b; border:1px solid #2a2a30; color:var(--text)" type="number">
</label>
<button class="btn" id="btnApplyIf">Apply</button>
<button class="btn" id="btnSaveScenario" title="Save scenario settings">Save</button>
</div>
<div style="display:flex; gap:12px; align-items:center; margin-bottom:10px; flex-wrap:wrap;">
<label style="font-size:13px">Multipliers:</label>
<label style="display:flex; gap:6px; align-items:center; font-size:13px">Pessimistic <input id="mulPessimistic" step="0.01" style="width:80px; padding:6px; border-radius:6px; background:#18181b; border:1px solid #2a2a30; color:var(--text)" type="number" value="0.75"></label>
<label style="display:flex; gap:6px; align-items:center; font-size:13px">Conservative <input id="mulConservative" step="0.01" style="width:80px; padding:6px; border-radius:6px; background:#18181b; border:1px solid #2a2a30; color:var(--text)" type="number" value="0.92"></label>
<label style="display:flex; gap:6px; align-items:center; font-size:13px">Base <input id="mulBase" step="0.01" style="width:80px; padding:6px; border-radius:6px; background:#18181b; border:1px solid #2a2a30; color:var(--text)" type="number" value="1.0"></label>
<label style="display:flex; gap:6px; align-items:center; font-size:13px">Optimistic <input id="mulOptimistic" step="0.01" style="width:80px; padding:6px; border-radius:6px; background:#18181b; border:1px solid #2a2a30; color:var(--text)" type="number" value="1.18"></label>
</div>
<div style="margin-bottom:8px">Scenario comparison:</div>
<div style="background:#17171a; border:1px solid #2a2a30; border-radius:8px; padding:8px; margin-bottom:12px">
<div id="aiScenarioTable" style="font-size:13px; white-space:pre-wrap; font-family:monospace">Kind            | Avg/mo       | Exp Year-End   | Shortfall    
--------------------------------------------------------------
Pessimistic     |             0 |               0 |             0
Conservative    |             0 |               0 |             0
Base            |             0 |               0 |             0
Optimistic      |             0 |               0 |             0</div>
</div>
<label class="required-label" for="aiShareRecipient" style="font-size:10px; margin-bottom:6px; display:block; font-family: system-ui, -apple-system, BlinkMacSystemFont, &#39;Segoe UI&#39;, Roboto, sans-serif;">Recipient name required for sharing</label>
<input id="aiShareRecipient" placeholder="Recipient Name" style="width:100%; padding:8px; margin-bottom:8px; border-radius:8px; background:#18181b; border:1px solid #2a2a30; color:var(--text); font-family: system-ui, -apple-system, BlinkMacSystemFont, &#39;Segoe UI&#39;, Roboto, sans-serif; font-size:10px" type="text">
<div style="margin:8px 0; display:flex; gap:8px; align-items:center;">
<div class="sharegrid" style="grid-template-columns:repeat(4,1fr); width:100%;">
<div class="sbtn" id="sWhatsAppAi">WhatsApp</div>
<div class="sbtn" id="sEmailAi">Email</div>
<div class="sbtn" id="sCopyAi">Copy</div>
<div class="sbtn" id="sPrintAi">Print</div>
</div>
</div>
<textarea class="textarea" id="aiText" readonly="" spellcheck="false" style="min-height:320px"></textarea>
</div>
<footer>
<button class="btn close" id="btnAiClose2">Close</button>
</footer>
</div>
</div>
<style id="ownerReportOverlayStyles">
  #ownerReportOverlay[aria-hidden="true"]{ display:none !important; }
  #ownerReportOverlay[aria-hidden="false"]{
    display:flex !important;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.55);
    z-index:12050;
    align-items:center;
    justify-content:center;
    pointer-events:auto;
  }
  #ownerReportOverlay .pop{
    width:min(1100px, 98vw);
    max-height:94vh;
    display:flex;
    flex-direction:column;
    background:#101215;
    border:1px solid rgba(90,150,150,0.25);
    border-radius:16px;
    box-shadow:0 30px 70px rgba(0,0,0,0.65);
    overflow:hidden;
  }
  #ownerReportOverlay header,
  #ownerReportOverlay footer{
    padding:14px 22px;
    display:flex;
    align-items:center;
    gap:12px;
    background:rgba(12,15,20,0.6);
  }
  #ownerReportOverlay header{ justify-content:space-between; border-bottom:1px solid rgba(255,255,255,0.05); }
  #ownerReportOverlay footer{ justify-content:flex-end; border-top:1px solid rgba(255,255,255,0.05); border-bottom:none; }
  #ownerReportOverlay .content{ padding:18px 22px 22px; overflow:auto; }
  #ownerReportTitle{ margin:0; font-size:20px; color:#33cccc; letter-spacing:0.4px; font-weight:700; }
  .owner-report-grid{ display:flex; flex-direction:column; gap:18px; }
  .owner-report-summary{ display:flex; flex-wrap:wrap; gap:18px; justify-content:space-between; align-items:flex-start; }
  .owner-report-summary .meta{ font-size:13px; color:var(--muted); }
  .owner-report-chip{ display:inline-flex; align-items:center; gap:6px; padding:4px 12px; border-radius:999px; font-size:12px; font-weight:600; background:rgba(88,166,255,0.16); color:#58a6ff; }
  .owner-report-metrics{ display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:12px; }
  .owner-report-card{ background:linear-gradient(160deg, rgba(51,204,204,0.08), rgba(10,16,24,0.4)); border:1px solid rgba(255,255,255,0.08); border-radius:12px; padding:12px 14px; display:flex; flex-direction:column; gap:6px; }
  .owner-report-card .label{ font-size:11px; text-transform:uppercase; color:var(--muted); letter-spacing:0.6px; }
  .owner-report-card .value{ font-size:18px; font-weight:700; color:var(--text); }
  .owner-report-card .sub{ font-size:12px; color:var(--muted); }
  .owner-report-section{ background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.05); border-radius:14px; padding:16px 18px; display:flex; flex-direction:column; gap:10px; }
  .owner-report-section h4{ margin:0; font-size:15px; color:#58a6ff; font-weight:700; letter-spacing:0.3px; }
  .owner-report-section p{ margin:0; color:var(--text); font-size:13px; line-height:1.6; }
  .owner-report-section ul{ margin:0; padding-left:20px; color:var(--text); font-size:13px; line-height:1.55; }
  .owner-report-section ul li + li{ margin-top:6px; }
  .owner-report-table{ width:100%; border-collapse:collapse; font-size:12.5px; background:rgba(0,0,0,0.2); border-radius:12px; overflow:hidden; }
  .owner-report-table th,
  .owner-report-table td{ padding:8px 10px; border:1px solid rgba(255,255,255,0.04); text-align:left; }
  .owner-report-table th{ background:rgba(255,255,255,0.05); font-weight:600; color:#33cccc; text-transform:uppercase; letter-spacing:0.4px; font-size:11px; }
  .owner-report-table td.numeric{ text-align:right; font-family:'JetBrains Mono','Fira Code',monospace; }
  .owner-report-analysis{ background:rgba(8,12,18,0.7); border:1px solid rgba(255,255,255,0.05); border-radius:12px; padding:14px; font-size:12.5px; color:var(--muted); white-space:pre-wrap; line-height:1.6; font-family:'Fira Code','JetBrains Mono',Consolas,monospace; }
  .owner-report-share{ display:flex; flex-direction:column; gap:8px; margin-bottom:18px; }
  .owner-report-share label{ font-size:10px; margin-bottom:0; display:block; font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
  .owner-report-share-controls{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
  #ownerReportRecipient{ flex:1 1 220px; min-width:200px; padding:8px 10px; border-radius:10px; background:#18181b; border:1px solid rgba(255,255,255,0.08); color:var(--text); font-size:12px; }
  .owner-report-sharegrid{ flex:1 1 260px; margin-top:0; }
  .owner-report-sharegrid .sbtn{ padding:10px; border-radius:12px; font-size:12px; }
  #ownerReportOverlay .content::-webkit-scrollbar{ width:10px; }
  #ownerReportOverlay .content::-webkit-scrollbar-track{ background:#060708; }
  #ownerReportOverlay .content::-webkit-scrollbar-thumb{ background:rgba(88,166,255,0.35); border-radius:6px; }
  @media (max-width:720px){
    #ownerReportOverlay .pop{ width:96vw; }
    .owner-report-metrics{ grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); }
    .owner-report-summary{ flex-direction:column; align-items:flex-start; }
  }
</style>
<style id="userAccessStyles">
  #userSessionChip {
    pointer-events: none;
    color: #5c9090;
  }
  #userLoginOverlay[aria-hidden="true"],
  #userAdminOverlay[aria-hidden="true"] {
    display: none !important;
  }
  #userLoginOverlay[aria-hidden="false"],
  #userAdminOverlay[aria-hidden="false"] {
    display: flex !important;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.55);
    z-index: 16000;
    align-items: center;
    justify-content: center;
    pointer-events: auto;
  }
  #userLoginOverlay .pop {
    width: min(420px, 94vw);
    background: #101215;
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 16px;
    box-shadow: 0 30px 70px rgba(0, 0, 0, 0.65);
  }
  #userLoginOverlay .content form {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  #userLoginOverlay .content label {
    font-size: 12px;
    font-weight: 600;
    color: var(--muted);
  }
  #userLoginOverlay .content input {
    width: 100%;
    padding: 8px 10px;
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    background: #16181c;
    color: var(--text);
  }
  .login-content {
    display: flex;
    flex-direction: column;
    gap: 14px;
  }
  .login-role-toggle {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 10px;
  }
  .login-role {
    border: 1px solid rgba(255, 255, 255, 0.08);
    background: rgba(255, 255, 255, 0.02);
    border-radius: 10px;
    padding: 12px;
    text-align: left;
    color: var(--text);
    display: flex;
    flex-direction: column;
    gap: 4px;
    cursor: pointer;
    transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
  }
  .login-role:hover,
  .login-role:focus-visible {
    border-color: var(--accent);
    box-shadow: 0 3px 16px rgba(88, 166, 255, 0.12);
  }
  .login-role.active {
    border-color: var(--accent);
    background: linear-gradient(135deg, rgba(88, 166, 255, 0.18), rgba(10, 18, 30, 0.4));
    box-shadow: 0 6px 20px rgba(88, 166, 255, 0.18);
  }
  .login-role-title {
    font-size: 14px;
    font-weight: 700;
  }
  .login-role-sub {
    font-size: 11px;
    color: var(--muted);
    line-height: 1.35;
  }
  .login-role-description {
    font-size: 12px;
    color: var(--muted);
    line-height: 1.6;
  }
  .login-role-description p {
    margin: 0;
  }
  .login-admin-credentials {
    margin-top: 6px;
    font-size: 12px;
    font-weight: 600;
    color: var(--accent);
  }
  .login-admin-credentials span {
    color: #33cccc;
    font-weight: 700;
  }
  .login-field {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .login-remember {
    display: flex;
    gap: 8px;
    align-items: flex-start;
    font-size: 11.5px;
    color: var(--muted);
    line-height: 1.4;
  }
  .login-remember input {
    margin-top: 3px;
  }
  .login-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
    margin-top: 6px;
  }
  .login-actions .btn {
    flex: 0 0 auto;
  }
  .login-saved-cta {
    display: flex;
    flex-direction: column;
    gap: 8px;
    font-size: 11.5px;
    background: rgba(88, 166, 255, 0.14);
    border: 1px solid rgba(88, 166, 255, 0.38);
    color: #cfe4ff;
    border-radius: 8px;
    padding: 10px 12px;
    line-height: 1.5;
  }
  .login-saved-text {
    color: #e9f2ff;
  }
  .login-saved-cta .btn {
    align-self: flex-start;
  }
  .login-error {
    font-size: 12px;
    color: var(--danger);
    display: none;
  }
  .login-error.show {
    display: block;
  }
  #userAdminOverlay .pop {
    width: min(960px, 96vw);
    max-height: 90vh;
    overflow: hidden;
    background: #0f1216;
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 18px;
    box-shadow: 0 30px 80px rgba(0, 0, 0, 0.65);
    display: flex;
    flex-direction: column;
  }
  #userAdminOverlay .content {
    overflow: auto;
    padding: 18px 22px 22px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }
  .user-card {
    background: #161618;
    border: 1px solid rgba(255, 255, 255, 0.06);
    border-radius: 12px;
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  .user-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 14px;
    color: var(--text);
  }
  .role-badge {
    font-size: 11px;
    font-weight: 600;
    padding: 2px 8px;
    border-radius: 999px;
    background: rgba(88, 166, 255, 0.16);
    color: #58a6ff;
  }
  .user-owner-list {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 6px;
    font-size: 12px;
    color: var(--muted);
  }
  .user-owner-list label {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: rgba(255, 255, 255, 0.02);
    padding: 6px 8px;
    border-radius: 8px;
  }
  .user-card-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
  }
  .user-admin-add {
    margin-top: 8px;
    padding: 14px;
    border: 1px dashed rgba(255, 255, 255, 0.08);
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    background: rgba(255, 255, 255, 0.01);
  }
  .user-admin-add h4 {
    margin: 0;
    font-size: 15px;
    color: #33cccc;
  }
  .user-admin-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 12px;
  }
  .user-admin-grid label {
    font-size: 12px;
    color: var(--muted);
    font-weight: 600;
    display: block;
    margin-bottom: 4px;
  }
  .user-admin-grid input {
    width: 100%;
    padding: 8px 10px;
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    background: #16181c;
    color: var(--text);
  }
  @media (max-width: 640px) {
    .user-owner-list {
      grid-template-columns: 1fr;
    }
    .user-card {
      padding: 10px;
    }
  }
</style>
<!-- Owner Report Overlay -->
<div aria-hidden="true" class="overlay" id="ownerReportOverlay">
<div aria-labelledby="ownerReportTitle" aria-modal="true" class="pop" role="dialog">
<header>
<h3 id="ownerReportTitle">Owner Situation Report</h3>
<button class="btn close" id="btnOwnerReportClose" title="Close report">Close</button>
</header>
<div class="content">
<div class="owner-report-share">
<label class="required-label" for="ownerReportRecipient">Recipient name required</label>
<div class="owner-report-share-controls">
<input id="ownerReportRecipient" placeholder="Recipient Name" type="text">
<div class="sharegrid owner-report-sharegrid">
<div class="sbtn" id="ownerReportWhatsApp">WhatsApp</div>
<div class="sbtn" id="ownerReportEmail">Email</div>
<div class="sbtn" id="ownerReportCopy">Copy</div>
<div class="sbtn" id="ownerReportPrint">Print</div>
</div>
</div>
</div>
<div class="owner-report-grid" id="ownerReportContent"></div>
</div>
<footer>
<button class="btn close" id="btnOwnerReportClose2">Close</button>
</footer>
</div>
</div>
<!-- Scenario Overlay -->
<div aria-hidden="true" class="overlay" id="scenarioOverlay">
<div aria-labelledby="scenarioTitle" aria-modal="true" class="pop" role="dialog">
<header>
<h3 id="scenarioTitle">🎯 Scenarios</h3>
<button class="btn close" id="btnScenarioClose">Close</button>
</header>
<div class="content">
<div style="display:grid; grid-template-columns:repeat(2,1fr); gap:8px; margin-bottom:8px;">
<label>Monthly Increase (AED): <input id="scMonthlyIncrease" type="number" value="0"></label>
<label>One-off Inflow (AED): <input id="scOneOff" type="number" value="0"></label>
<label>New Target (AED, optional): <input id="scNewTarget" placeholder="(leave blank)" type="number"></label>
<label>Uplift % (Best): <input id="scBestPct" step="0.1" type="number" value="15"></label>
<label>Drop % (Worst): <input id="scWorstPct" step="0.1" type="number" value="15"></label>
<label>Growth Rate (% per month): <input id="scGrowthRate" step="0.1" type="number" value="0"></label>
<label>Months Ahead: <input id="scMonthsAhead" max="12" min="1" type="number" value="4"></label>
<label>Simulations (Monte Carlo): <input id="scSims" max="10000" min="100" type="number" value="1000"></label>
</div>
<div style="display:flex; gap:8px; margin-bottom:8px; align-items:center">
<button class="btn" id="btnRunScenario">Run Projection</button>
<button class="btn" id="btnResetScenario">Reset</button>
<button class="btn" id="btnScCopy">Copy</button>
<button class="btn" id="btnScWhatsApp">WhatsApp</button>
<button class="btn" id="btnScEmail">Email</button>
<button class="btn" id="btnScPrint">Print</button>
<div style="color:var(--accent-amber, #ffb84d); font-size:13px">Try changes and see projected year-end and action options.</div>
</div>
<div style="margin-top:8px; display:flex; gap:8px; align-items:center">
<label style="font-family: system-ui, -apple-system, BlinkMacSystemFont, &#39;Segoe UI&#39;, Roboto, sans-serif; font-size:10px; color:var(--accent-amber, #ffb84d)">Recipient optional: <input id="scShareRecipient" placeholder="e.g., John Doe" style="font-family: system-ui, -apple-system, BlinkMacSystemFont, &#39;Segoe UI&#39;, Roboto, sans-serif; font-size:10px;" type="text"></label>
</div>
<div style="background:#17171a; border:1px solid #2a2a30; border-radius:8px; padding:10px;">
<div style="display:flex; gap:8px; flex-direction:column;">
<div id="scCards" style="display:flex; gap:8px; margin-bottom:8px; flex-wrap:wrap;">
<div id="scCardBase" style="flex:1 1 220px; background:#161618; border:1px solid #2a2a30; border-radius:6px; padding:10px; position:relative; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.01);">
<div style="position:absolute; left:0; top:0; bottom:0; width:4px; border-top-left-radius:6px; border-bottom-left-radius:6px; background: linear-gradient(180deg, var(--accent-amber), rgba(255,255,255,0.0)); opacity:0.95"></div>
<div style="font-size:12px; color:var(--muted); letter-spacing:0.2px; text-transform:uppercase;">Baseline</div>
<div id="scBaseProjected" style="font-weight:700; font-size:18px; margin-top:8px">0</div>
<div id="scBaseNote" style="font-size:11px; color:var(--accent-amber, #ffb84d); margin-top:6px">Set a Total Target to enable comparisons</div>
</div>
<div id="scCardConservative" style="flex:1 1 220px; background:#161618; border:1px solid #2a2a30; border-radius:6px; padding:10px; position:relative; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.01);">
<div style="position:absolute; left:0; top:0; bottom:0; width:4px; border-top-left-radius:6px; border-bottom-left-radius:6px; background: linear-gradient(180deg, var(--accent-amber), rgba(255,255,255,0.0)); opacity:0.95"></div>
<div style="font-size:12px; color:var(--muted); letter-spacing:0.2px; text-transform:uppercase;">Conservative</div>
<div id="scConservativeProjected" style="font-weight:700; font-size:18px; margin-top:8px">0</div>
<div id="scConservativeNote" style="font-size:11px; color:var(--accent-amber, #ffb84d); margin-top:6px">Avg inflow ↓ 8% — Set a Total Target to enable comparisons</div>
</div>
<div id="scCardOptimistic" style="flex:1 1 220px; background:#161618; border:1px solid #2a2a30; border-radius:6px; padding:10px; position:relative; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.01);">
<div style="position:absolute; left:0; top:0; bottom:0; width:4px; border-top-left-radius:6px; border-bottom-left-radius:6px; background: linear-gradient(180deg, var(--accent-amber), rgba(255,255,255,0.0)); opacity:0.95"></div>
<div style="font-size:12px; color:var(--muted); letter-spacing:0.2px; text-transform:uppercase;">Optimistic</div>
<div id="scOptimisticProjected" style="font-weight:700; font-size:18px; margin-top:8px">0</div>
<div id="scOptimisticNote" style="font-size:11px; color:var(--accent-amber, #ffb84d); margin-top:6px">Avg inflow ↑ 18% — Set a Total Target to enable comparisons</div>
</div>
<div id="scCardPessimistic" style="flex:1 1 220px; background:#161618; border:1px solid #2a2a30; border-radius:6px; padding:10px; position:relative; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.01);">
<div style="position:absolute; left:0; top:0; bottom:0; width:4px; border-top-left-radius:6px; border-bottom-left-radius:6px; background: linear-gradient(180deg, var(--accent-amber), rgba(255,255,255,0.0)); opacity:0.95"></div>
<div style="font-size:12px; color:var(--muted); letter-spacing:0.2px; text-transform:uppercase;">Pessimistic</div>
<div id="scPessimisticProjected" style="font-weight:700; font-size:18px; margin-top:8px">0</div>
<div id="scPessimisticNote" style="font-size:11px; color:var(--accent-amber, #ffb84d); margin-top:6px">Avg inflow ↓ 25% — Set a Total Target to enable comparisons</div>
</div>
</div>
<pre id="scenarioOutput" style="white-space:pre-wrap; font-family:monospace; margin:0; font-size:13px; max-height:260px; overflow:auto"></pre>
</div>
</div>
<canvas id="scenarioChart" style="margin-top:10px; max-height:200px; width:100%;"></canvas>
<!-- Schedule preview: populated from selected action option -->
<div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
<label style="font-size:13px">Action options:</label>
<select id="scActionSelect" style="padding:6px; border-radius:6px; background:#18181b; border:1px solid #2a2a30; color:var(--text); min-width:320px">
<option value="">(Run projection to load actions)</option>
</select>
<button class="btn" id="btnPopulateSchedule">Populate schedule</button>
<button class="btn" id="btnCopySchedule">Copy schedule</button>
</div>
<div style="margin-top:10px; border:1px solid #2a2a30; border-radius:8px; padding:8px; background:#17171a;">
<table id="scScheduleTable" style="width:100%; border-collapse:collapse;">
<thead><tr style="background:#222224"><th style="padding:8px; text-align:left">Month</th><th style="padding:8px; text-align:right">Amount (AED)</th></tr></thead>
<tbody></tbody>
</table>
</div>
</div>
<footer>
<button class="btn close" id="btnScenarioClose2">Close</button>
</footer>
</div>
</div>
<!-- Email Sett Overlay -->
<div aria-hidden="true" class="overlay" id="emailOverlay">
<div aria-labelledby="emailTitle" aria-modal="true" class="pop" role="dialog">
<header>
<h3 id="emailTitle">Email Set (EmailJS)</h3>
<button class="btn close" id="btnEmailClose">Close</button>
</header>
<div class="content">
<p>Configure EmailJS to send reminder emails. Get these from your <a href="https://www.emailjs.com/" target="_blank">EmailJS dashboard</a>.</p>
<div style="display:flex; flex-direction:column; gap:8px;">
<label>Service ID: <input id="emailServiceId" placeholder="e.g., service_xxx" type="text"></label>
<label>Template ID: <input id="emailTemplateId" placeholder="e.g., template_xxx" type="text"></label>
<label>Public Key: <input id="emailPublicKey" placeholder="e.g., xxx" type="text"></label>
<label>Recipient Email: <input id="emailRecipient" placeholder="recipient@example.com" type="email"></label>
</div>
<div style="margin-top:12px; display:flex; gap:8px;">
<button class="btn" id="btnSaveEmailConfig">Save</button>
<button class="btn" id="btnTestEmail">Test Email</button>
</div>
</div>
<footer>
<button class="btn close" id="btnEmailClose2">Close</button>
</footer>
</div>
</div>
<!-- Duplicate Owner Overlay -->
<div aria-hidden="true" class="overlay" id="duplicateOwnerOverlay">
<div aria-labelledby="duplicateTitle" aria-modal="true" class="pop" role="dialog">
<header>
<h3 id="duplicateTitle">Duplicate Owner Data</h3>
<button class="btn close" id="btnDuplicateClose">Close</button>
</header>
<div class="content">
<p>Copy all data (month data, reminders, notes, opening balance, etc.) from one owner/year to another.</p>
<div style="display:flex; flex-direction:column; gap:8px;">
<label>Source Owner: <input id="sourceOwner" placeholder="e.g., Owner 1" type="text"></label>
<label>Source Year: <input id="sourceYear" placeholder="e.g., 2023" type="number"></label>
<label>Target Owner: <input id="targetOwner" placeholder="e.g., Owner 2" type="text"></label>
<label>Target Year: <input id="targetYear" placeholder="e.g., 2024" type="number"></label>
</div>
<div style="margin-top:12px; display:flex; gap:8px;">
<button class="btn" id="btnDuplicateData">Duplicate Data</button>
</div>
</div>
<footer>
<button class="btn close" id="btnDuplicateClose2">Close</button>
</footer>
</div>
</div>
<!-- Libraries loaded directly above -->
<script>
  // Simplified load check - libraries should already be loaded
  function loadScript(src) {
    return new Promise((resolve, reject) => {
      if (document.querySelector(`script[src="${src}"]`)) {
        resolve(); // already loaded
        return;
      }
      const script = document.createElement('script');
      script.src = src;
      script.crossOrigin = 'anonymous';
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }
  
  // Log library availability
  console.log('Direct library check:', {
    XLSX: typeof XLSX !== 'undefined',
    Chart: typeof Chart !== 'undefined',
    html2canvas: typeof html2canvas !== 'undefined',
    jsPDF: typeof window.jsPDF !== 'undefined' || typeof window.jspdf !== 'undefined',
    emailjs: typeof emailjs !== 'undefined'
  });
</script>
<script>
/* === JavaScript === */
window.addEventListener('DOMContentLoaded', async () => {
    // === Constants and Utilities ===
    const fmt = n => (Number(n||0)).toLocaleString('en-AE');
  // Robust numeric parser: accept numbers or formatted strings like "3,000", "AED 3,000", "(1,200)", "-1,200"
  function parseNum(n){
    if(n === null || n === undefined) return 0;
    if(typeof n === 'number') return isNaN(n) ? 0 : n;
    let s = String(n).trim();
    if(s === '') return 0;
    // detect parentheses for negative values or negative sign
    let negative = false;
    if(s.startsWith('(') && s.endsWith(')')){
      negative = true;
      s = s.slice(1, -1);
    } else if(s.startsWith('-')){
      negative = true;
      s = s.slice(1);
    }
  // remove currency letters/symbols (accept 'AED'), commas and any non-numeric characters except dot and minus
  s = s.replace(/AED\s*/i, '');
    s = s.replace(/[^0-9.-]/g, '');
    if(s === '' || s === '.' || s === '-' ) return 0;
    const val = Number(s);
    if(isNaN(val)) return 0;
    return negative ? -val : val;
  }
  // Accounting formatter: localized number with negative sign for negatives
  function fmtAcc(n){
    const v = parseNum(n || 0);
    const rounded = Math.round(v);
    const abs = Math.abs(rounded);
    const s = abs.toLocaleString('en-AE');
    return rounded < 0 ? `-${s}` : s;
  }
  // Small compatibility helper used by some UI update paths
  function format(n){
    // preserve existing behavior: return a localized integer string
    return fmtAcc(n);
  }

  const USERS_KEY = 'enbd:users:v1';
  const SESSION_KEY = 'enbd:sessionUser';
  const REMEMBER_KEY = 'enbd:rememberedLogin:v1';
  const STORAGE_STATUS = (() => {
    const testKey = `enbd:storage-test-${Date.now()}`;
    try{
      localStorage.setItem(testKey, '1');
      localStorage.removeItem(testKey);
      return { available: true, error: null };
    }catch(error){
      console.warn('Local storage unavailable — some features disabled.', error);
      return { available: false, error };
    }
  })();
  function storageAvailable(){ return STORAGE_STATUS.available; }
  let currentUser = null;
  let usersCache = [];

  async function hashPassword(password){
    if(!password) return '';
    try{
      if(window.crypto && window.crypto.subtle){
        const encoder = new TextEncoder();
        const data = encoder.encode(password);
        const hashBuffer = await window.crypto.subtle.digest('SHA-256', data);
        return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2,'0')).join('');
      }
    }catch(e){
      console.debug('hashPassword subtle digest failed', e);
    }
    try{
      return btoa(unescape(encodeURIComponent(password)));
    }catch(e){
      console.debug('hashPassword fallback failed', e);
      return String(password);
    }
  }

  function loadUsers(){
    try{
      const raw = JSON.parse(localStorage.getItem(USERS_KEY));
      if(Array.isArray(raw)) return raw;
    }catch(e){
      console.debug('loadUsers parse error', e);
    }
    return [];
  }

  function saveUsers(users){
    try{
      usersCache = Array.isArray(users) ? users.slice() : [];
      localStorage.setItem(USERS_KEY, JSON.stringify(usersCache));
    }catch(e){
      console.error('saveUsers failed', e);
    }
  }

  async function ensureUsersInitialized(){
    usersCache = loadUsers();
    let changed = false;
    if(!usersCache.some(u => u && u.role === 'admin')){
      const adminHash = await hashPassword('Admin@123');
      usersCache.push({
        username: 'admin',
        role: 'admin',
        passwordHash: adminHash,
        owners: '__all__'
      });
      changed = true;
    }
    if(changed){ saveUsers(usersCache); }
    return usersCache;
  }

  function refreshUsers(){
    usersCache = loadUsers();
    return usersCache;
  }

  function getSessionUser(){
    return localStorage.getItem(SESSION_KEY);
  }

  function setSessionUser(username){
    if(username) localStorage.setItem(SESSION_KEY, username);
    else localStorage.removeItem(SESSION_KEY);
  }

  function clearSessionUser(){
    localStorage.removeItem(SESSION_KEY);
  }

  function loadRememberedLogin(){
    try{
      const raw = localStorage.getItem(REMEMBER_KEY);
      if(!raw) return null;
      const parsed = JSON.parse(raw);
      if(parsed && typeof parsed === 'object' && parsed.username && parsed.passwordHash){
        return parsed;
      }
    }catch(e){
      console.debug('loadRememberedLogin failed', e);
    }
    return null;
  }

  function storeRememberedLogin(user){
    if(!user || !user.username || !user.passwordHash) return;
    try{
      const payload = {
        username: user.username,
        passwordHash: user.passwordHash,
        role: user.role || 'employee',
        savedAt: Date.now()
      };
      localStorage.setItem(REMEMBER_KEY, JSON.stringify(payload));
    }catch(e){
      console.error('storeRememberedLogin failed', e);
    }
  }

  function clearRememberedLogin(){
    try{ localStorage.removeItem(REMEMBER_KEY); }catch(e){ console.debug('clearRememberedLogin failed', e); }
  }

  function findUser(username){
    if(!username) return null;
    const target = String(username).toLowerCase();
    return (usersCache || []).find(u => String(u.username).toLowerCase() === target) || null;
  }

  async function verifyPassword(user, password){
    if(!user) return false;
    const expected = user.passwordHash || '';
    const provided = await hashPassword(password || '');
    return expected === provided;
  }

  function setCurrentUser(user){
    currentUser = user ? { ...user } : null;
    if(typeof applyUserPermissions === 'function'){
      applyUserPermissions();
    } else {
      updateUserBadge();
    }
  }

  function isAdmin(){
    return currentUser && currentUser.role === 'admin';
  }

  function userAllowsAllOwners(user){
    return user && (user.role === 'admin' || user.owners === '__all__');
  }

  function getUserAllowedOwners(allOwners){
    if(!Array.isArray(allOwners)) return [];
    if(!currentUser) return allOwners;
    if(userAllowsAllOwners(currentUser)) return allOwners;
    const assigned = Array.isArray(currentUser.owners) ? currentUser.owners : [];
    return allOwners.filter(name => assigned.includes(name));
  }

  function updateUserBadge(){
    const chip = dom('userSessionChip');
    if(!chip) return;
    if(!currentUser){
      chip.style.display = 'none';
      chip.textContent = '';
      return;
    }
    chip.style.display = 'inline-flex';
    chip.textContent = currentUser.role === 'admin' ? 'ADMIN' : String(currentUser.username || '').toUpperCase();
  }

  function showLoginOverlay(){
    const overlay = dom('userLoginOverlay');
    if(!overlay) return;
    overlay.classList.add('show');
    overlay.setAttribute('aria-hidden','false');
    const form = dom('userLoginForm');
    if(form){ form.reset(); }
    let remembered = null;
    try{ remembered = updateRememberedLoginUI(); }catch(_){ }
    try{ setLoginRole(remembered && remembered.role === 'admin' ? 'admin' : 'team'); }catch(_){ }
    if(remembered){
      const usernameInput = dom('loginUsername');
      if(usernameInput){ usernameInput.value = remembered.username || ''; }
    }
    const err = dom('loginError');
    if(err) err.classList.remove('show');
    setTimeout(()=> dom('loginUsername')?.focus(), 140);
  }

  function hideLoginOverlay(){
    const overlay = dom('userLoginOverlay');
    if(!overlay) return;
    overlay.classList.remove('show');
    overlay.setAttribute('aria-hidden','true');
  }

  function showNoOwnerMessage(show){
    const notice = dom('noOwnerAccessNotice');
    if(!notice) return;
    notice.style.display = show ? 'block' : 'none';
  }

  function getUserScopedKey(suffix){
    if(currentUser && currentUser.username){
      return `enbd:${currentUser.username}:${suffix}`;
    }
    return `enbd:${suffix}`;
  }

  async function completeLogin(user, options = {}){
    if(!user) return false;
    const message = typeof options.message === 'string' ? options.message : `Signed in as ${user.username}`;
    setSessionUser(user.username);
    setCurrentUser(user);
    const storedYear = localStorage.getItem(getUserScopedKey('lastYear')) || localStorage.getItem('enbd:lastYear');
    if(typeof populateYearSelect === 'function'){
      populateYearSelect(storedYear);
    }
    if(typeof persistContext === 'function'){
      persistContext();
    }
    if(typeof initAll === 'function'){
      await initAll();
    }
    hideLoginOverlay();
    const form = dom('userLoginForm');
    if(form) form.reset();
    const errorEl = dom('loginError');
    if(errorEl) errorEl.classList.remove('show');
    try{ updateRememberedLoginUI(); }catch(_){ }
    try{
      if(typeof showToast === 'function'){
        showToast(message);
      }
    }catch(_){ }
    return true;
  }

  async function handleLoginSubmit(event){
    if(event) event.preventDefault();
    const errorEl = dom('loginError');
    if(errorEl){
      errorEl.textContent = 'Incorrect username or password.';
      errorEl.classList.remove('show');
    }
    const usernameInput = dom('loginUsername');
    const passwordInput = dom('loginPassword');
    const username = String(usernameInput && usernameInput.value || '').trim();
    const password = String(passwordInput && passwordInput.value || '');
    if(!username || !password){
      if(errorEl){
        errorEl.textContent = 'Please enter both username and password.';
        errorEl.classList.add('show');
      }
      return;
    }
    try{
      await ensureUsersInitialized();
      refreshUsers();
      const user = findUser(username);
      const valid = await verifyPassword(user, password);
      if(!user || !valid){
        if(errorEl){
          errorEl.textContent = 'Incorrect username or password.';
          errorEl.classList.add('show');
        }
        return;
      }
      const rememberBox = dom('loginRemember');
      if(rememberBox?.checked){
        storeRememberedLogin(user);
      } else {
        clearRememberedLogin();
      }
      await completeLogin(user);
    }catch(e){
      console.error('Login failed', e);
      if(errorEl){
        errorEl.textContent = 'Login failed. Please try again.';
        errorEl.classList.add('show');
      }
    }
  }

  async function logoutUser(){
    clearSessionUser();
    setCurrentUser(null);
    const storedYear = localStorage.getItem(getUserScopedKey('lastYear')) || localStorage.getItem('enbd:lastYear');
    if(typeof populateYearSelect === 'function'){
      populateYearSelect(storedYear);
    }
    if(typeof persistContext === 'function'){
      persistContext();
    }
    if(typeof initAll === 'function'){
      try{ await initAll(); }catch(e){ console.error('logout initAll failed', e); }
    }
    const form = dom('userLoginForm');
    if(form) form.reset();
    const errorEl = dom('loginError');
    if(errorEl) errorEl.classList.remove('show');
    showLoginOverlay();
  }

  function populateOwnerChecklist(container, owners, selectedOwners, disabled){
    if(!container) return;
    container.innerHTML = '';
    const selected = new Set(Array.isArray(selectedOwners) ? selectedOwners.map(o => String(o)) : []);
    (Array.isArray(owners) ? owners : []).forEach(owner => {
      const label = document.createElement('label');
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.value = owner;
      checkbox.checked = selected.has(owner);
      if(disabled) checkbox.disabled = true;
      label.appendChild(checkbox);
      const text = document.createElement('span');
      text.textContent = owner;
      label.appendChild(text);
      container.appendChild(label);
    });
    if(!owners || owners.length === 0){
      const empty = document.createElement('div');
      empty.style.fontSize = '12px';
      empty.style.color = 'var(--muted)';
      empty.textContent = 'No owners available. Add owners first.';
      container.appendChild(empty);
    }
  }

  async function handleCreateUser(){
    const usernameField = dom('newUserName');
    const passwordField = dom('newUserPassword');
    const confirmField = dom('newUserPasswordConfirm');
    const ownersContainer = dom('newUserOwners');
    const username = String(usernameField && usernameField.value || '').trim();
    const password = String(passwordField && passwordField.value || '');
    const confirm = String(confirmField && confirmField.value || '');
    const owners = Array.from((ownersContainer || { querySelectorAll: ()=>[] }).querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
    await ensureUsersInitialized();
    const users = refreshUsers();
    if(!username){
      alert('Enter a username.');
      usernameField?.focus();
      return;
    }
    if(username.length < 3){
      alert('Username should be at least 3 characters.');
      usernameField?.focus();
      return;
    }
    if(users.some(u => u && String(u.username).toLowerCase() === username.toLowerCase())){
      alert('That username is already taken. Choose a different one.');
      usernameField?.focus();
      return;
    }
    if(!password){
      alert('Enter a password.');
      passwordField?.focus();
      return;
    }
    if(password.length < 6){
      alert('Password should be at least 6 characters.');
      passwordField?.focus();
      return;
    }
    if(password !== confirm){
      alert('Passwords do not match.');
      confirmField?.focus();
      return;
    }
    if(!owners.length){
      alert('Select at least one owner to assign.');
      ownersContainer?.focus();
      return;
    }
    const passwordHash = await hashPassword(password);
    users.push({
      username,
      role: 'employee',
      owners,
      passwordHash
    });
    saveUsers(users);
    renderUserAdmin();
    if(usernameField) usernameField.value = '';
    if(passwordField) passwordField.value = '';
    if(confirmField) confirmField.value = '';
    populateOwnerChecklist(ownersContainer, loadOwners(), [], false);
    try{
      if(typeof showToast === 'function'){
        showToast(`Added ${username}`);
      } else {
        alert(`Added ${username}`);
      }
    }catch(_){ }
  }

  function renderUserAdmin(){
    const list = dom('userAdminList');
    if(!list) return;
    const owners = loadOwners();
    const users = refreshUsers().slice().sort((a, b)=>{
      if(!a || !b) return 0;
      if(a.role === b.role) return String(a.username).localeCompare(String(b.username));
      return a.role === 'admin' ? -1 : 1;
    });
    list.innerHTML = '';
    if(!users.length){
      const empty = document.createElement('div');
      empty.style.fontSize = '12px';
      empty.style.color = 'var(--muted)';
      empty.textContent = 'No team members yet. Add one below.';
      list.appendChild(empty);
    }
    users.forEach(user => {
      if(!user) return;
      const card = document.createElement('div');
      card.className = 'user-card';

      const header = document.createElement('div');
      header.className = 'user-card-header';
      const name = document.createElement('div');
      name.textContent = user.username;
      const badge = document.createElement('span');
      badge.className = 'role-badge';
      badge.textContent = user.role === 'admin' ? 'Admin' : 'Employee';
      header.appendChild(name);
      header.appendChild(badge);
      card.appendChild(header);

      if(user.role === 'admin'){
        const details = document.createElement('div');
        details.style.fontSize = '12px';
        details.style.color = 'var(--muted)';
        details.textContent = 'Admins automatically have access to every owner.';
        card.appendChild(details);
        const actions = document.createElement('div');
        actions.className = 'user-card-actions';
        const resetBtn = document.createElement('button');
        resetBtn.type = 'button';
        resetBtn.className = 'btn';
        resetBtn.textContent = 'Change Password';
        resetBtn.addEventListener('click', async ()=>{
          const newPass = prompt('Enter a new password for admin');
          if(!newPass) return;
          if(newPass.length < 6){
            alert('Password should be at least 6 characters.');
            return;
          }
          const confirm = prompt('Re-enter the new password to confirm');
          if(confirm !== newPass){
            alert('Passwords do not match.');
            return;
          }
          user.passwordHash = await hashPassword(newPass);
          saveUsers(users);
          try{
            if(typeof showToast === 'function'){
              showToast('Admin password updated');
            } else {
              alert('Admin password updated');
            }
          }catch(_){ }
        });
        actions.appendChild(resetBtn);
        card.appendChild(actions);
      } else {
        const ownerList = document.createElement('div');
        ownerList.className = 'user-owner-list';
        populateOwnerChecklist(ownerList, owners, Array.isArray(user.owners) ? user.owners : [], false);
        card.appendChild(ownerList);
        const actions = document.createElement('div');
        actions.className = 'user-card-actions';

        const saveBtn = document.createElement('button');
        saveBtn.type = 'button';
        saveBtn.className = 'btn primary';
        saveBtn.textContent = 'Save Access';
        saveBtn.addEventListener('click', ()=>{
          const selected = Array.from(ownerList.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
          user.owners = selected;
          saveUsers(users);
          try{
            if(typeof showToast === 'function'){
              showToast(`Updated access for ${user.username}`);
            } else {
              alert(`Updated access for ${user.username}`);
            }
          }catch(_){ }
          refreshUsers();
          if(currentUser && currentUser.username && currentUser.username.toLowerCase() === String(user.username).toLowerCase()){
            setCurrentUser(user);
            const storedYear = localStorage.getItem(getUserScopedKey('lastYear')) || localStorage.getItem('enbd:lastYear');
            if(typeof populateYearSelect === 'function'){
              populateYearSelect(storedYear);
            }
            if(typeof persistContext === 'function'){
              persistContext();
            }
          }
          renderUserAdmin();
        });
        actions.appendChild(saveBtn);

        const resetBtn = document.createElement('button');
        resetBtn.type = 'button';
        resetBtn.className = 'btn';
        resetBtn.textContent = 'Reset Password';
        resetBtn.addEventListener('click', async ()=>{
          const newPass = prompt(`Enter a new password for ${user.username}`);
          if(!newPass) return;
          if(newPass.length < 6){
            alert('Password should be at least 6 characters.');
            return;
          }
          const confirm = prompt('Re-enter the new password to confirm');
          if(confirm !== newPass){
            alert('Passwords do not match.');
            return;
          }
          user.passwordHash = await hashPassword(newPass);
          saveUsers(users);
          try{
            if(typeof showToast === 'function'){
              showToast('Password updated');
            } else {
              alert('Password updated');
            }
          }catch(_){ }
        });
        actions.appendChild(resetBtn);

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn danger';
        removeBtn.textContent = 'Remove User';
        removeBtn.addEventListener('click', ()=>{
          if(!confirm(`Remove ${user.username}? They will lose access.`)) return;
          const idx = users.findIndex(u => u && String(u.username).toLowerCase() === String(user.username).toLowerCase());
          if(idx !== -1){
            users.splice(idx, 1);
            saveUsers(users);
            refreshUsers();
            try{
              if(typeof showToast === 'function'){
                showToast('User removed');
              } else {
                alert('User removed');
              }
            }catch(_){ }
            renderUserAdmin();
          }
        });
        actions.appendChild(removeBtn);
        card.appendChild(actions);
      }

      list.appendChild(card);
    });

    const newOwnersContainer = dom('newUserOwners');
    if(newOwnersContainer){
      populateOwnerChecklist(newOwnersContainer, owners, [], false);
    }
  }

  function openUserAdminOverlay(){
    if(!isAdmin()){
      alert('Only admins can manage team access.');
      return;
    }
    renderUserAdmin();
    const overlay = dom('userAdminOverlay');
    if(overlay){
      overlay.classList.add('show');
      overlay.setAttribute('aria-hidden','false');
      setTimeout(()=> dom('newUserName')?.focus(), 120);
    }
  }

  function closeUserAdminOverlay(){
    const overlay = dom('userAdminOverlay');
    if(overlay){
      overlay.classList.remove('show');
      overlay.setAttribute('aria-hidden','true');
    }
  }

  function syncUsersWithOwnerChanges(activeOwners, renames){
    const active = Array.isArray(activeOwners) ? activeOwners.slice() : [];
    const renameList = Array.isArray(renames) ? renames : [];
    const users = refreshUsers();
    let changed = false;
    users.forEach(user => {
      if(!user || user.role === 'admin') return;
      let assigned = Array.isArray(user.owners) ? user.owners.slice() : [];
      if(renameList.length){
        renameList.forEach(({ old, next }) => {
          const idx = assigned.indexOf(old);
          if(idx !== -1){
            assigned[idx] = next;
            changed = true;
          }
        });
      }
      const filtered = assigned.filter(o => active.includes(o));
      if(filtered.length !== assigned.length){
        assigned = filtered;
        changed = true;
      }
      user.owners = assigned;
    });
    if(changed){
      saveUsers(users);
      if(currentUser){
        const updated = findUser(currentUser.username);
        if(updated){
          setCurrentUser(updated);
        }
      }
    }
    return changed;
  }

  // Compute consolidated scenario results used by updateUI()
  function computeScenarios(){
    try{
      console.debug('computeScenarios: entered');
  let months = getMonthData();
      const vals = months.map(m=> Number(m.outflow||0));
  const targets = months.map(m=> Number(m.target||0));
  const storedTarget = Number(load('yearTarget', 0)) || 0;
  const totalTarget = storedTarget > 0 ? storedTarget : targets.reduce((a,b)=>a+b,0);
      const YTD = vals.slice(0, currentMonthIdx+1).reduce((a,b)=>a+b,0);
      const OB = parseNum(dom('openingBalance')?.value || 0);
  const base = computeScenarioProjection('Base', 0);
  const conservative = computeScenarioProjection('Conservative', 0);
  const optimistic = computeScenarioProjection('Optimistic', 0);
  const pessimistic = computeScenarioProjection('Pessimistic', 0);

      // moNeeded: distribute remaining target (if any) across remaining whole months
      const now = new Date();
      const endOfYear = new Date(Number(yearSel.value||now.getFullYear()), 11, 31, 23,59,59);
      const msInDay = 1000*60*60*24;
      const days_left = Math.max(0, Math.ceil((endOfYear - now)/msInDay));
      const months_left = Math.max(0.01, days_left / 30.44);
      const monthsToYearEnd = Math.max(1, Math.ceil(months_left));
      const remainingToTarget = totalTarget > 0 ? Math.max(0, totalTarget - YTD) : 0;
      const moNeeded = totalTarget > 0 ? Math.ceil(remainingToTarget / monthsToYearEnd) : 0;

      const result = {
        totalTarget,
        baseYE: base.expectedYearEnd,
        conservativeYE: conservative.expectedYearEnd,
        optimisticYE: optimistic.expectedYearEnd,
        pessimisticYE: pessimistic.expectedYearEnd,
        moNeeded,
        YTD,
        OB
      };
      console.debug('computeScenarios: result', result);
      return result;
  }catch(e){ console.debug('computeScenarios failed', e); return { totalTarget:0, baseYE:0, conservativeYE:0, optimisticYE:0, pessimisticYE:0, moNeeded:0, YTD:0, OB:0 }; }
  }
  // Helper to set KPI value text and positive/negative classes
  // Display uses English 'AED' in a very small font before the amount and
  // places the negative sign after the amount (e.g. "AED 1,234 -").
  function setKpi(id, num){
    const el = dom(id);
    if(!el) return;
    // If value is numeric, format with currency label; otherwise show as-is
    if(typeof num === 'number' || !isNaN(parseNum(num))){
      const v = parseNum(num || 0);
      const absText = fmtAcc(Math.abs(v));
      // Small AED label (very fine small font) followed by the localized amount
      const currencyLabel = `<span style="font-size:10px; opacity:0.85; vertical-align:baseline; font-weight:600">AED</span>&nbsp;`;
      const amountHtml = `<span class="kpi-amount">${absText}</span>`;
      if(v < 0){
        // Format negative as: ( AED - 1,234 )
        el.innerHTML = `<span class="kpi-neg-wrap">( ${currencyLabel}<span style="margin-right:4px">-</span>${amountHtml} )</span>`;
      } else {
        el.innerHTML = `${currencyLabel}${amountHtml}`;
      }
      el.classList.remove('positive','negative');
      if(v > 0) el.classList.add('positive');
      else if(v < 0) el.classList.add('negative');
    } else {
      el.textContent = String(num);
    }
  }
    const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    const shortMonth = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      try{
        const md = dom('monthDebug'); if(md){ md.textContent = localStorage.getItem(`${keyPrefix()}:monthData`) || 'no prefixed monthData'; }
      }catch(e){}
    const today = new Date();
    const currentMonthIdx = today.getMonth(); // 0-11
    const dom = id => document.getElementById(id);
    // Helper to load scripts dynamically
    function loadScript(src) {
      return new Promise((resolve, reject) => {
        if (document.querySelector(`script[src="${src}"]`)) {
          resolve(); // already loaded
          return;
        }
        const script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }
    // Save current document as PDF using html2canvas + jsPDF
    async function saveAsPDF(){
      try{
        // Libraries should already be loaded directly - check availability
        if (typeof html2canvas === 'undefined') {
          throw new Error('html2canvas library not loaded. Please check your internet connection.');
        }
        if (typeof window.jspdf === 'undefined' && typeof window.jsPDF === 'undefined') {
          throw new Error('jsPDF library not loaded. Please check your internet connection.');
        }

        // Prepare to replace external images/backgrounds so the canvas isn't tainted
        const replacedImgs = [];
        const replacedBgs = [];
        try{
          // Replace external <img> sources (non-data) with a 1x1 transparent PNG data URI
          const imgs = Array.from(document.querySelectorAll('img'));
          const transparent = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVQImWNgYAAAAAMAAWgmWQ0AAAAASUVORK5CYII=';
          imgs.forEach(img => {
            try{
              const src = img.src || '';
              if(!src) return;
              if(src.startsWith('data:')) return; // already safe
              replacedImgs.push({ el: img, src: src, cross: img.getAttribute('crossorigin') });
              // set to transparent pixel to avoid cross-origin pixel data
              img.setAttribute('data-enbd-orig-src', src);
              img.setAttribute('data-enbd-orig-cross', String(img.getAttribute('crossorigin')|| ''));
              img.removeAttribute('crossorigin');
              img.src = transparent;
            }catch(e){}
          });

          // Remove background images (inline CSS) which may reference external resources
          const all = Array.from(document.querySelectorAll('*'));
          all.forEach(el => {
            try{
              const bg = window.getComputedStyle(el).backgroundImage;
              if(bg && bg !== 'none' && bg.indexOf('url(') !== -1){
                replacedBgs.push({ el: el, bg: el.style.backgroundImage });
                el.style.backgroundImage = 'none';
              }
            }catch(e){}
          });
        }catch(e){ console.debug('saveAsPDF: image/bg replacement failed', e); }

        // Hide floating UI elements so they don't appear in the capture
        const floatingEls = [];
        try{
          const riToggle = document.getElementById('rightIconToggle'); if(riToggle){ floatingEls.push(riToggle); riToggle.style.visibility = 'hidden'; }
          const riSet = document.getElementById('rightIconSet'); if(riSet){ floatingEls.push(riSet); riSet.style.visibility = 'hidden'; }
          const toasts = document.querySelectorAll('.toast, .rem-row .rem-actions, .iconbtn'); if(toasts) toasts.forEach(t=>{ floatingEls.push(t); t.style.visibility = 'hidden'; });
        }catch(e){ console.debug('saveAsPDF: could not hide floating elements', e); }

        // Allow a slightly longer delay so the browser repaints with the replaced images/styles
        await new Promise(r => setTimeout(r, 250));

        // Capture
  if(typeof html2canvas === 'undefined') throw new Error('html2canvas not available after load attempt');
  const canvas = await html2canvas(document.body, { scale: 2, useCORS: false, logging: false });
        const imgData = canvas.toDataURL('image/png'); // should not throw when images/backgrounds replaced

        // Restore visibility and replaced content
        try{ floatingEls.forEach(el=>{ if(el && el.style) el.style.visibility = ''; }); }catch(e){}
        try{
          replacedImgs.forEach(o=>{
            try{
              if(o && o.el){
                if(o.src) o.el.src = o.src;
                if(o.cross) o.el.setAttribute('crossorigin', o.cross);
                o.el.removeAttribute('data-enbd-orig-src'); o.el.removeAttribute('data-enbd-orig-cross');
              }
            }catch(e){}
          });
          replacedBgs.forEach(o=>{ try{ if(o && o.el) o.el.style.backgroundImage = o.bg || ''; }catch(e){} });
        }catch(e){ console.debug('saveAsPDF: restore failed', e); }

        // Build PDF
        let JSPDF = null;
        if(window.jspdf && window.jspdf.jsPDF) JSPDF = window.jspdf.jsPDF;
        else if(window.jsPDF) JSPDF = window.jsPDF;
        else if(typeof jspdf !== 'undefined' && jspdf.jsPDF) JSPDF = jspdf.jsPDF;
  if(!JSPDF){ console.error('JSPDF constructor not found', window.jspdf, window.jsPDF, typeof jspdf); alert('Could not find jsPDF constructor — check console for details.'); return; }

        const pdf = new JSPDF({ unit: 'mm', format: 'a4' });
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();

        // compute image dimensions to fit page width while preserving aspect
        const canvasW = canvas.width;
        const canvasH = canvas.height;
        const imgWidthMm = pageWidth;
        const imgHeightMm = (canvasH * imgWidthMm) / canvasW;

        // Add first page
        let position = 0;
        pdf.addImage(imgData, 'PNG', 0, position, imgWidthMm, imgHeightMm);

        // Add extra pages if needed. We slice the image vertically by pageHeight.
        let heightLeft = imgHeightMm - pageHeight;
        while(heightLeft > -0.01){
          position = position - pageHeight;
          pdf.addPage();
          pdf.addImage(imgData, 'PNG', 0, position, imgWidthMm, imgHeightMm);
          heightLeft -= pageHeight;
        }

        pdf.save('ENBD_Performance_Tracker.pdf');
      }catch(err){
        console.error('saveAsPDF error', err);
        try{ const md = dom('monthDebug'); if(md) md.textContent += '\n[SaveAsPDF] ' + String(err); }catch(_){ }
        // Fallback: open a printable HTML snapshot so user can still save via browser Print->Save as PDF
        try{
          const snap = (document.querySelector('.wrap') || document.body).outerHTML;
          const w = window.open('', '_blank', 'width=900,height=700');
          if(w){
            w.document.write('<!doctype html><html><head><meta charset="utf-8"><title>ENBD Export — Snapshot</title>');
            // minimal embedded styles to keep it readable
            w.document.write('<style>body{font-family:system-ui,Segoe UI,Roboto,Arial;background:#fff;color:#111;padding:12px} pre{white-space:pre-wrap; font-family:monospace}</style>');
            w.document.write('</head><body>');
            w.document.write('<h2>ENBD Performance Tracker — Snapshot</h2>');
            w.document.write('<div>PDF libraries failed to load. Use your browser Print → Save as PDF to export this snapshot.</div>');
            w.document.write('<hr>');
            w.document.write(snap);
            w.document.write('<script>setTimeout(function(){ try{ window.focus(); window.print(); }catch(e){} }, 300);' + '</scr' + 'ipt>');
            w.document.write('</body></html>');
            w.document.close();
          } else {
            alert('Save as PDF failed and popup blocked. Open the browser console for details.');
          }
        }catch(fb){ console.error('saveAsPDF fallback failed', fb); }
        alert('Save as PDF failed: ' + String(err) + '\n\nA printable snapshot has been opened (if popups are allowed). Otherwise check the console for details.');
      }
    }
    function showPasswordOverlay() {
      // Password overlay disabled - always allow access
      return;
      dom('passwordInput').focus();
    }
    let isUnlocked = false; // track if password has been entered for data entry
    function showToast(message) {
      const toast = dom('toast');
      if (!toast) return;
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 2000);
    }
    function handleEnter(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        const allInputs = Array.from(document.querySelectorAll('#monthTable tbody input'));
        const currentIndex = allInputs.indexOf(e.target);
        if (currentIndex !== -1 && currentIndex < allInputs.length - 1) {
          allInputs[currentIndex + 1].focus();
        }
      }
    }
    // === Data Management ===
    function keyPrefix(){
      const owner = dom('owner').value.trim();
      const year = dom('year').value.trim();
      return `enbd:${owner}:${year}`;
    }
    function save(key, val){ localStorage.setItem(`${keyPrefix()}:${key}`, JSON.stringify(val)); }
    function load(key, def){ try{ const v = JSON.parse(localStorage.getItem(`${keyPrefix()}:${key}`)); return (v===null||v===undefined)?def:v; }catch(_){ return def; } }

    // Owner / Year UI wiring
    const ownerSel = dom('owner');
    const ownerAvatarSrc = 'file:///c:/Users/fuad/OneDrive%20-%20Ayat%20Group/Desktop/Ayat_colored.png';
    const yearSel = dom('year');
    const yearDataLabel = dom('yearDataLabel');

    const YEARS_KEY = 'enbd:years';
    const DEFAULT_YEARS = Array.from({ length: 8 }, (_, i) => String(2023 + i));

    function sanitizeYearValue(year){
      if(year === undefined || year === null) return null;
      const num = Number(String(year).trim());
      if(!Number.isFinite(num)) return null;
      const rounded = Math.round(num);
      if(rounded < 1900 || rounded > 2200) return null;
      return String(rounded);
    }
    function sanitizeYears(list){
      const seen = new Set();
      const result = [];
      (Array.isArray(list) ? list : [list]).forEach(entry => {
        const val = sanitizeYearValue(entry);
        if(!val) return;
        if(seen.has(val)) return;
        seen.add(val);
        result.push(val);
      });
      result.sort((a,b)=> Number(a) - Number(b));
      return result;
    }
    function saveYears(arr){
      let sanitized = sanitizeYears(arr);
      if(!sanitized.length){
        sanitized = sanitizeYears([new Date().getFullYear()]);
      }
      try{ localStorage.setItem(YEARS_KEY, JSON.stringify(sanitized)); }catch(_){}
      return sanitized;
    }
    function loadYears(){
      try{
        const raw = JSON.parse(localStorage.getItem(YEARS_KEY));
        const sanitized = sanitizeYears(raw);
        if(sanitized.length) return sanitized;
      }catch(_){ }
      return saveYears(DEFAULT_YEARS);
    }
    function populateYearSelect(preferredYear){
      if(!yearSel) return;
      let years = loadYears();
      if(!years.length){
        years = saveYears([new Date().getFullYear()]);
      }
      yearSel.innerHTML = '';
      years.forEach(year => {
        const opt = document.createElement('option');
        opt.value = year;
        opt.textContent = year;
        yearSel.appendChild(opt);
      });
      const candidates = [
        sanitizeYearValue(preferredYear),
        sanitizeYearValue(localStorage.getItem(getUserScopedKey('lastYear'))),
        sanitizeYearValue(localStorage.getItem('enbd:lastYear')),
        years[0]
      ];
      let target = candidates.find(y => y && years.includes(y));
      if(!target){
        target = years[0] || sanitizeYearValue(new Date().getFullYear());
      }
      if(target && years.includes(target)){
        yearSel.value = target;
        localStorage.setItem(getUserScopedKey('lastYear'), target);
        localStorage.setItem('enbd:lastYear', target);
      } else if(years.length){
        yearSel.value = years[0];
        localStorage.setItem(getUserScopedKey('lastYear'), years[0]);
        localStorage.setItem('enbd:lastYear', years[0]);
      }
      updateYearDataLabel(ownerSel && ownerSel.value, yearSel.value);
    }
    function ensureYearAvailable(year){
      const sanitized = sanitizeYearValue(year);
      if(!sanitized) return;
      let years = loadYears();
      if(!years.includes(sanitized)){
        years.push(sanitized);
        years = saveYears(years);
      }
      populateYearSelect(sanitized);
    }

    function persistContext(){
      if(ownerSel){
        localStorage.setItem(getUserScopedKey('lastOwner'), ownerSel.value);
        localStorage.setItem('enbd:lastOwner', ownerSel.value);
      }
      if(yearSel){
        localStorage.setItem(getUserScopedKey('lastYear'), yearSel.value);
        localStorage.setItem('enbd:lastYear', yearSel.value);
      }
    }

    if(ownerSel){
      ownerSel.addEventListener('change', async ()=>{
        try{ persistContext(); /* keep full init for other UI */ await initAll(); }catch(e){}
        try{ updateRemBadgeImmediate(); renderRems(); }catch(e){}
        try{ renderNotes(); }catch(e){}
        try{
          const color = ownerColor(ownerSel.value);
          ownerSel.style.color = color;
          if(yearDataLabel) yearDataLabel.style.color = color;
        }catch(e){}
      });
    }
    if(yearSel){
      yearSel.addEventListener('change', async ()=>{
        try{ persistContext(); await initAll(); }catch(e){}
        try{ updateRemBadgeImmediate(); renderRems(); }catch(e){}
        try{ renderNotes(); }catch(e){}
      });
    }

    // Owners list persistence and editor (global per-browser list)
    const OWNERS_KEY = 'enbd:owners';
    const OWNERS_VERSION_KEY = 'enbd:owners_version';
    const CURRENT_OWNERS_VERSION = '2025.09.27';
    
    function loadOwners(){ 
      // Check if we need to reset owners list due to version change
      const currentVersion = localStorage.getItem(OWNERS_VERSION_KEY);
      if(currentVersion !== CURRENT_OWNERS_VERSION) {
        // Reset owners list to new default
        const defs = ['SHTHA', 'TAMADUR', 'Owner 1', 'SHTHA_ENDB']; 
        for(let i=3;i<=10;i++) defs.push('Owner '+i); 
        localStorage.setItem(OWNERS_KEY, JSON.stringify(defs));
        localStorage.setItem(OWNERS_VERSION_KEY, CURRENT_OWNERS_VERSION);
        return defs;
      }
      
      try{ const v = JSON.parse(localStorage.getItem(OWNERS_KEY)); if(Array.isArray(v) && v.length) return v; }catch(e){}
      // default owners
      const defs = ['SHTHA', 'TAMADUR', 'Owner 1', 'SHTHA_ENDB']; 
      for(let i=3;i<=10;i++) defs.push('Owner '+i); 
      localStorage.setItem(OWNERS_KEY, JSON.stringify(defs)); 
      localStorage.setItem(OWNERS_VERSION_KEY, CURRENT_OWNERS_VERSION);
      return defs; }
    function saveOwners(arr){ try{ localStorage.setItem(OWNERS_KEY, JSON.stringify(arr||[])); }catch(e){} }
    // keys to migrate when an owner name changes (per-year keys)
    const PER_OWNER_KEYS = ['monthData','openingBalance','scenarioMultipliers','lastScenario','reminders'];
    function migrateOwnerData(oldName, newName, year){
      if(!oldName || !newName || oldName===newName) return;
      try{
        for(const k of PER_OWNER_KEYS){
          const oldKey = `enbd:${oldName}:${year}:${k}`;
          const newKey = `enbd:${newName}:${year}:${k}`;
          const v = localStorage.getItem(oldKey);
          if(v !== null && localStorage.getItem(newKey) === null){
            localStorage.setItem(newKey, v);
            localStorage.removeItem(oldKey);
          }
        }
      }catch(e){ /* ignore migration errors */ }
    }
    function populateOwnerSelect(){
      const list = loadOwners();
      if(!ownerSel) return;
      ownerSel.innerHTML = '';
      const allowed = getUserAllowedOwners(list);
      if(currentUser && !allowed.length){
        ownerSel.disabled = true;
        showNoOwnerMessage(true);
        return;
      }
      ownerSel.disabled = false;
      showNoOwnerMessage(false);
      const safeList = allowed.length ? allowed : list;
      safeList.forEach(o => {
        const opt = document.createElement('option');
        opt.textContent = o;
        opt.value = o;
        ownerSel.appendChild(opt);
      });
      const scopedLast = localStorage.getItem(getUserScopedKey('lastOwner'));
      const globalLast = localStorage.getItem('enbd:lastOwner');
      const preferred = [scopedLast, globalLast].find(v => v && safeList.includes(v));
      if(preferred){
        ownerSel.value = preferred;
      } else if(safeList.length){
        ownerSel.value = safeList[0];
      }
      try{
        const color = ownerColor(ownerSel.value);
        ownerSel.style.color = color;
        if(yearDataLabel) yearDataLabel.style.color = color;
      }catch(e){}
      try{
        const img = document.querySelector('#yearDataLabel .owner-avatar');
        if(img) img.src = ownerAvatarSrc;
      }catch(_){ }
    }

    // return a stable color for an owner name (based on index in the owner list)
    function ownerColor(name){
      // Modern non-traditional palette — each owner gets a distinct, contemporary color
      const ownerColors = {
        'SHTHA_ENDB': '#FF7A72', // coral
        'TAMADUR_ENBD': '#33cccc', // cyan/teal
        'Owner 3': '#4CC9F0',      // electric sky
        'Owner 4': '#FF7A72',      // coral
        'Owner 5': '#FFD166',      // mellow yellow
        'Owner 6': '#7AE582',      // spring green
        'Owner 7': '#FF6BDB',      // vibrant magenta
        'Owner 8': '#6A8DFF',      // periwinkle indigo
        'Owner 9': '#00C2A8',      // bright turquoise
        'Owner 10': '#FF9F4A'      // vivid orange
      };
      return ownerColors[name] || '#6A8DFF';
    }

    function applyUserPermissions(){
      try{ updateUserBadge(); }catch(e){}
      const manageBtn = dom('btnManageUsers');
      if(manageBtn) manageBtn.style.display = isAdmin() ? '' : 'none';
      const ownersBtn = dom('btnEditOwners');
      if(ownersBtn) ownersBtn.style.display = isAdmin() ? '' : 'none';
      const yearsBtn = dom('btnEditYears');
      if(yearsBtn) yearsBtn.style.display = isAdmin() ? '' : 'none';
      const logoutBtn = dom('btnLogout');
      if(logoutBtn) logoutBtn.style.display = currentUser ? '' : 'none';
      if(ownerSel){
        populateOwnerSelect();
      }
      if(!currentUser){
        showNoOwnerMessage(false);
      }
    }

    let activeLoginRole = 'team';
    const loginRoleButtons = Array.from(document.querySelectorAll('.login-role'));
    const loginRoleDescriptions = Array.from(document.querySelectorAll('.login-role-description'));
    const loginSavedCta = dom('loginSavedCta');
    const loginSavedText = dom('loginSavedText');
    const loginSavedButton = dom('btnLoginSaved');
    const loginClearButton = dom('loginClearSaved');

    function updateRememberedLoginUI(){
      const saved = loadRememberedLogin();
      if(!loginSavedCta || !loginSavedText || !loginSavedButton || !loginClearButton){
        return saved;
      }
      if(saved && saved.username && saved.passwordHash){
        const roleLabel = saved.role === 'admin' ? 'Administrator' : 'Team member';
        const savedDate = saved.savedAt ? new Date(saved.savedAt) : null;
        const validDate = savedDate && !Number.isNaN(savedDate.valueOf()) ? savedDate : null;
        const timestamp = validDate ? validDate.toLocaleString(undefined, { hour12: false }) : '';
        loginSavedText.textContent = `Quick sign-in ready for ${saved.username} (${roleLabel})${timestamp ? ` · saved ${timestamp}` : ''}.`;
        loginSavedButton.textContent = `Sign in as ${saved.username}`;
        loginSavedButton.classList.remove('hidden');
        loginSavedButton.disabled = false;
        loginSavedCta.classList.remove('hidden');
        loginClearButton.classList.remove('hidden');
        loginClearButton.disabled = false;
        const rememberBox = dom('loginRemember');
        if(rememberBox){ rememberBox.checked = true; }
      } else {
        loginSavedText.textContent = '';
        loginSavedButton.classList.add('hidden');
        loginSavedButton.disabled = true;
        loginSavedCta.classList.add('hidden');
        loginClearButton.classList.add('hidden');
        loginClearButton.disabled = true;
        const rememberBox = dom('loginRemember');
        if(rememberBox){ rememberBox.checked = false; }
      }
      return saved;
    }
    function setLoginRole(role){
      const nextRole = role === 'admin' ? 'admin' : 'team';
      activeLoginRole = nextRole;
      loginRoleButtons.forEach(btn => {
        const btnRole = btn?.dataset?.role === 'admin' ? 'admin' : 'team';
        const isActive = btnRole === nextRole;
        btn.classList.toggle('active', isActive);
        btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
      });
      loginRoleDescriptions.forEach(desc => {
        const descRole = desc?.dataset?.role === 'admin' ? 'admin' : 'team';
        desc.classList.toggle('hidden', descRole !== nextRole);
      });
      const usernameInput = dom('loginUsername');
      const passwordInput = dom('loginPassword');
      if(usernameInput){
        usernameInput.placeholder = nextRole === 'admin' ? 'admin' : 'e.g., rania';
        usernameInput.setAttribute('aria-label', nextRole === 'admin' ? 'Administrator username' : 'Team member username');
        if(nextRole === 'admin' && !usernameInput.value){
          usernameInput.value = 'admin';
        }
      }
      if(passwordInput){
        passwordInput.placeholder = nextRole === 'admin' ? 'Admin password' : 'Password';
        passwordInput.setAttribute('aria-label', nextRole === 'admin' ? 'Administrator password' : 'Team member password');
      }
    }
  loginRoleButtons.forEach(btn => btn.addEventListener('click', ()=> setLoginRole(btn?.dataset?.role === 'admin' ? 'admin' : 'team')));
  const rememberedProfile = updateRememberedLoginUI();
  setLoginRole(rememberedProfile && rememberedProfile.role === 'admin' ? 'admin' : 'team');

    const loginForm = dom('userLoginForm');
    if(loginForm){
      loginForm.addEventListener('submit', handleLoginSubmit);
    }
    const rememberToggle = dom('loginRemember');
    if(rememberToggle){
      rememberToggle.addEventListener('change', ()=>{
        if(!rememberToggle.checked){
          clearRememberedLogin();
          updateRememberedLoginUI();
        }
      });
    }
    if(loginSavedButton){
      loginSavedButton.addEventListener('click', async ()=>{
        try{
          const saved = loadRememberedLogin();
          if(!saved){ return; }
          await ensureUsersInitialized();
          refreshUsers();
          const user = findUser(saved.username);
          if(!user || user.passwordHash !== saved.passwordHash){
            clearRememberedLogin();
            updateRememberedLoginUI();
            const err = dom('loginError');
            if(err){
              err.textContent = 'Saved login expired. Please sign in again.';
              err.classList.add('show');
            }
            return;
          }
          await completeLogin(user, { message: `Signed in as ${user.username}` });
        }catch(e){
          console.error('Saved login failed', e);
          clearRememberedLogin();
          updateRememberedLoginUI();
        }
      });
    }
    if(loginClearButton){
      loginClearButton.addEventListener('click', ()=>{
        clearRememberedLogin();
        updateRememberedLoginUI();
        try{
          if(typeof showToast === 'function'){
            showToast('Saved login cleared');
          }
        }catch(_){ }
      });
    }
    ['loginUsername','loginPassword'].forEach(id => {
      const input = dom(id);
      if(input){
        input.addEventListener('input', ()=>{
          const errorEl = dom('loginError');
          if(errorEl) errorEl.classList.remove('show');
        });
      }
    });
    dom('btnLogout')?.addEventListener('click', async (evt)=>{
      evt?.preventDefault?.();
      await logoutUser();
    });
    dom('btnManageUsers')?.addEventListener('click', (evt)=>{
      evt?.preventDefault?.();
      openUserAdminOverlay();
    });
    dom('btnCloseUserAdmin')?.addEventListener('click', (evt)=>{
      evt?.preventDefault?.();
      closeUserAdminOverlay();
    });
    dom('btnCloseUserAdminFooter')?.addEventListener('click', (evt)=>{
      evt?.preventDefault?.();
      closeUserAdminOverlay();
    });
    (function(){
      const overlay = dom('userAdminOverlay');
      if(!overlay) return;
      overlay.addEventListener('click', (evt)=>{
        if(evt.target === overlay){
          closeUserAdminOverlay();
        }
      });
    })();
    const createUserBtn = dom('btnCreateUser');
    if(createUserBtn){
      createUserBtn.addEventListener('click', async ()=>{
        if(!isAdmin()){
          alert('Only admins can add team members.');
          return;
        }
        if(createUserBtn.disabled) return;
        createUserBtn.disabled = true;
        try{
          await handleCreateUser();
        }catch(e){
          console.error('Failed to create user', e);
          alert('Unable to add user right now. Please try again.');
        }finally{
          createUserBtn.disabled = false;
        }
      });
    }
    document.addEventListener('keydown', (evt)=>{
      if(evt.key === 'Escape' && dom('userAdminOverlay')?.classList.contains('show')){
        closeUserAdminOverlay();
      }
    });

    // Owners editor overlay wiring
    const ownersOverlay = dom('ownersOverlay');
    dom('btnEditOwners')?.addEventListener('click', ()=>{
      if(!isAdmin()){
        alert('Only admins can manage owners.');
        return;
      }
      renderOwnersEditor();
      ownersOverlay.classList.add('show');
      ownersOverlay.setAttribute('aria-hidden','false');
    });
    dom('btnOwnersClose')?.addEventListener('click', ()=>{ ownersOverlay.classList.remove('show'); ownersOverlay.setAttribute('aria-hidden','true'); });
    dom('btnOwnersClose2')?.addEventListener('click', ()=>{ ownersOverlay.classList.remove('show'); ownersOverlay.setAttribute('aria-hidden','true'); });

    function renderOwnersEditor(){
      const container = dom('ownersList');
      if(!container) return;
      container.innerHTML = '';
      const currentOwners = loadOwners();

      function updateDeleteStates(){
        const disable = container.children.length <= 1;
        container.querySelectorAll('button[data-action="remove-owner"]').forEach(btn => {
          btn.disabled = disable;
          btn.setAttribute('aria-disabled', disable ? 'true' : 'false');
        });
      }

      function addOwnerRow(name = ''){
        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.gap = '8px';
        row.style.alignItems = 'center';
        row.dataset.ownerRow = 'true';

        const avatar = document.createElement('img');
        avatar.className = 'owner-avatar';
        avatar.src = ownerAvatarSrc;
        avatar.alt = 'owner';

        const input = document.createElement('input');
        input.type = 'text';
        input.value = name;
        input.style.flex = '1';
        input.placeholder = 'Owner name';
        input.dataset.original = name || '';

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn danger';
        removeBtn.textContent = 'Delete';
        removeBtn.dataset.action = 'remove-owner';
        removeBtn.addEventListener('click', ()=>{
          if(container.children.length <= 1){
            alert('At least one owner must remain.');
            return;
          }
          row.remove();
          updateDeleteStates();
        });

        row.append(avatar, input, removeBtn);
        container.appendChild(row);
        updateDeleteStates();
        return { row, input };
      }

      currentOwners.forEach(name => addOwnerRow(name));

      const btnAdd = dom('btnAddOwner');
      if(btnAdd){
        btnAdd.style.display = '';
        btnAdd.removeAttribute('aria-hidden');
        btnAdd.tabIndex = 0;
        btnAdd.onclick = ()=>{
          const inputs = Array.from(container.querySelectorAll('[data-owner-row] input'));
          const used = new Set(inputs.map(inp => inp.value.trim()).filter(Boolean));
          let counter = inputs.length + 1;
          let candidate = `Owner ${counter}`;
          while(used.has(candidate)){
            counter += 1;
            candidate = `Owner ${counter}`;
          }
          const { input } = addOwnerRow(candidate);
          input.dataset.original = '';
          setTimeout(()=> input.focus(), 60);
        };
      }

      const btnSave = dom('btnSaveOwners');
      if(btnSave){
        btnSave.onclick = ()=>{
          const inputs = Array.from(container.querySelectorAll('[data-owner-row] input'));
          if(inputs.length === 0){
            alert('Please keep at least one owner.');
            return;
          }
          const names = [];
          const renames = [];
          inputs.forEach((input, idx)=>{
            let value = String(input.value || '').trim();
            if(!value){
              value = `Owner ${idx+1}`;
              input.value = value;
            }
            const original = input.dataset.original || '';
            names.push(value);
            if(original){
              if(original !== value){
                renames.push({ old: original, next: value });
              }
            }
          });

          const duplicates = names.filter((name, idx) => names.indexOf(name) !== idx);
          if(duplicates.length){
            alert('Owner names must be unique. Please adjust duplicates.');
            return;
          }

          const year = (dom('year')||{value: new Date().getFullYear()}).value;
          renames.forEach(({ old, next })=>{
            migrateOwnerData(old, next, year);
          });

          saveOwners(names);
          const userSync = syncUsersWithOwnerChanges(names, renames);
          populateOwnerSelect();
          refreshUsers();
          if(currentUser){
            const updated = findUser(currentUser.username);
            if(updated){ setCurrentUser(updated); }
          } else if(typeof applyUserPermissions === 'function'){
            applyUserPermissions();
          }
          if(dom('userAdminOverlay')?.classList.contains('show')){
            renderUserAdmin();
          }
          alert('Owners saved');
        };
      }
    }
    
    // Years editor overlay wiring
    const yearsOverlay = dom('yearsOverlay');
    function closeYearsOverlay(){
      if(!yearsOverlay) return;
      yearsOverlay.classList.remove('show');
      yearsOverlay.setAttribute('aria-hidden','true');
    }
    dom('btnEditYears')?.addEventListener('click', ()=>{
      if(!isAdmin()){
        alert('Only admins can manage global years.');
        return;
      }
      renderYearsEditor();
      if(yearsOverlay){
        yearsOverlay.classList.add('show');
        yearsOverlay.setAttribute('aria-hidden','false');
      }
    });
    dom('btnYearsClose')?.addEventListener('click', closeYearsOverlay);
    dom('btnYearsClose2')?.addEventListener('click', closeYearsOverlay);

    function syncYearRemoveButtons(container){
      if(!container) return;
      const disable = container.children.length <= 1;
      container.querySelectorAll('button[data-action="remove-year"]').forEach(btn => {
        btn.disabled = disable;
        btn.setAttribute('aria-disabled', disable ? 'true' : 'false');
      });
    }
    function createYearRow(container, value){
      const row = document.createElement('div');
      row.style.display = 'flex';
      row.style.gap = '8px';
      row.style.alignItems = 'center';
      const label = document.createElement('span');
      label.textContent = 'Year';
      label.style.fontSize = '13px';
      label.style.fontWeight = '600';
      label.style.width = '60px';
      const input = document.createElement('input');
      input.type = 'number';
      input.inputMode = 'numeric';
      input.placeholder = '2025';
      input.value = value || '';
      input.style.flex = '1';
      input.min = '1900';
      input.max = '2200';
      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'btn danger';
      removeBtn.textContent = 'Delete';
      removeBtn.dataset.action = 'remove-year';
      removeBtn.addEventListener('click', ()=>{
        if(!row.parentNode) return;
        if(row.parentNode.children.length <= 1) return;
        row.remove();
        syncYearRemoveButtons(row.parentNode);
      });
      row.append(label, input, removeBtn);
      container.appendChild(row);
      return { row, input };
    }
    function renderYearsEditor(){
      const container = dom('yearsList');
      if(!container) return;
      container.innerHTML = '';
      let years = loadYears();
      if(!years.length){
        years = saveYears([new Date().getFullYear()]);
      }
      years.forEach(year => createYearRow(container, year));
      if(container.children.length === 0){
        createYearRow(container, String(new Date().getFullYear()));
      }
      syncYearRemoveButtons(container);
      const addBtn = dom('btnAddYear');
      if(addBtn){
        addBtn.onclick = ()=>{
          createYearRow(container, '');
          syncYearRemoveButtons(container);
        };
      }
      const saveBtn = dom('btnSaveYears');
      if(saveBtn){
        saveBtn.onclick = ()=>{
          const inputs = Array.from(container.querySelectorAll('input'));
          const values = inputs.map(inp => sanitizeYearValue(inp.value));
          const sanitized = sanitizeYears(values);
          if(!sanitized.length){
            alert('Enter at least one valid year (for example 2025).');
            return;
          }
          saveYears(sanitized);
          const currentSelection = sanitizeYearValue(yearSel && yearSel.value);
          const nextSelection = currentSelection && sanitized.includes(currentSelection) ? currentSelection : sanitized[0];
          populateYearSelect(nextSelection);
          persistContext();
          closeYearsOverlay();
          try{ showToast('Years updated'); }catch(_){ alert('Years updated'); }
        };
      }
      syncYearRemoveButtons(container);
    }
    
  // initialize session-aware owner/year selects
  (async function bootstrapUserSession(){
    try{
      await ensureUsersInitialized();
      const sessionName = getSessionUser();
      let activeUser = null;
      if(sessionName){
        const found = findUser(sessionName);
        if(found){
          activeUser = found;
        } else {
          clearSessionUser();
        }
      }
      setCurrentUser(activeUser);
      const storedYear = localStorage.getItem(getUserScopedKey('lastYear')) || localStorage.getItem('enbd:lastYear');
      if(typeof populateYearSelect === 'function'){
        populateYearSelect(storedYear);
      }
      if(typeof persistContext === 'function'){
        persistContext();
      }
      if(typeof initAll === 'function'){
        await initAll();
      }
      if(!currentUser){
        showLoginOverlay();
      }
    }catch(e){
      console.error('bootstrapUserSession failed', e);
      try{ populateOwnerSelect(); }catch(_){ }
      try{ populateYearSelect(localStorage.getItem('enbd:lastYear')); }catch(_){ }
      if(typeof initAll === 'function'){
        try{ await initAll(); }catch(inner){ console.error('initAll after bootstrap failure', inner); }
      }
      showLoginOverlay();
    }
  })();

  // KPI dock removed per user request.

  // Year target is stored in localStorage under 'yearTarget'. The small input was removed.

    // Opening balance persist
    const openingBalanceInput = dom('openingBalance');
    function persistOpeningBalance(){
      if(getPassword() && !isUnlocked) { showPasswordOverlay(); return; }
      try{ save('openingBalance', Number(openingBalanceInput.value.replace(/,/g,'')||0)); }catch(e){/*ignore*/}
      try{ localStorage.setItem(`${keyPrefix()}:openingBalance`, JSON.stringify(Number(openingBalanceInput.value.replace(/,/g,'')||0))); }catch(e){}
      recompute();
      showToast('Opening balance saved');
    }
    openingBalanceInput.addEventListener('input', persistOpeningBalance);
    openingBalanceInput.addEventListener('change', persistOpeningBalance);
    openingBalanceInput.addEventListener('focus', () => {
      if (openingBalanceInput.value === "Nil") {
        openingBalanceInput.value = "0";
        openingBalanceInput.style.color = "#FFD700";
      }
    });
    openingBalanceInput.addEventListener('blur', () => {
      const num = parseNum(openingBalanceInput.value);
      if (num === 0) {
        openingBalanceInput.value = "Nil";
        openingBalanceInput.style.color = "blue";
      } else {
        openingBalanceInput.value = num.toLocaleString('en-AE');
        openingBalanceInput.style.color = "#FFD700";
      }
    });
  // restore opening balance (raw number for numeric input)
  (function(){ const ob = Number(load('openingBalance', 0)); openingBalanceInput.value = ob === 0 ? "Nil" : String(ob); openingBalanceInput.style.color = ob === 0 ? "blue" : "#FFD700"; })();

    // --- Multi-day detection: mark day inputs that contain multiple numbers (e.g., "2,5") ---
    function isMultiDayValue(v){
      if(!v) return false;
      // Accept commas, spaces or slashes as separators. Consider it multi if two or more numeric tokens are present.
      const tokens = String(v).split(/[ ,\/;|]+/).map(t=>t.trim()).filter(t=>t.length>0);
      let count = 0;
      for(const t of tokens){ if(/^-?\d+$/.test(t)) count++; }
      return count >= 2;
    }

    function updateDayMultiState(el){
      if(!el) return;
      try{
        const v = el.value || '';
        if(isMultiDayValue(v)) el.classList.add('multi-day'); else el.classList.remove('multi-day');
      }catch(e){}
    }

    function attachDayListeners(root=document){
      const inputs = Array.from((root||document).querySelectorAll('input[id^="month-day-"]'));
      inputs.forEach(inp=>{
        // prevent duplicate listeners
        if(inp.__multiAttached) return; inp.__multiAttached = true;
        inp.addEventListener('input', ()=> updateDayMultiState(inp));
        inp.addEventListener('change', ()=> updateDayMultiState(inp));
        // initialize state
        updateDayMultiState(inp);
      });
    }

    // Attach initially and after month table population
    document.addEventListener('DOMContentLoaded', ()=>{ attachDayListeners(); });

    // Enhanced Reset functionality
    async function resetPage(){
      if(getPassword() && !isUnlocked) { showPasswordOverlay(); return; }
      
      // Get current context
      const owner = (dom('owner')||{value:''}).value;
      const year = (dom('year')||{value:''}).value;
      const currentPrefix = `enbd:${owner}:${year}:`;
      
      // Improved confirmation dialog with more specific information
      const confirmMessage = `This will reset data for "${owner}" - "${year}" only:
      
• Month data (targets, inflows, notes)
• Opening balance
• Deposit reminders
• Calendar remarks
• Scenario data

Other owners and years will NOT be affected.

Are you sure you want to continue?`;
      
      if(!confirm(confirmMessage)) return;
      
      try{
        console.log('resetPage: resetting data for', owner, year, 'prefix =', currentPrefix);
        
        // Find keys to remove - only for current owner/year combination
        const keysToRemove = [];
        for(let i=0; i<localStorage.length; i++){
          const key = localStorage.key(i);
          if(key && key.startsWith(currentPrefix)){
            keysToRemove.push(key);
          }
        }
        
        console.log('resetPage: found', keysToRemove.length, 'keys to remove:', keysToRemove);
        
        // Remove the specific keys
        let removedCount = 0;
        keysToRemove.forEach(key => {
          try {
            localStorage.removeItem(key);
            removedCount++;
            console.log('resetPage: removed', key);
          } catch(e) {
            console.warn('resetPage: failed to remove', key, e);
          }
        });
        
        // Clear UI focus issues
        try{ 
          if(dom('passwordInput') && typeof dom('passwordInput').blur === 'function') {
            dom('passwordInput').blur(); 
          }
        } catch(_) {}
        
        // Reset unlock state to avoid accidental edits
        try{ isUnlocked = false; } catch(_) {}
        
        // Clear any form values that might be cached
        try {
          // Reset month table inputs
          const monthInputs = document.querySelectorAll('#monthTable input');
          monthInputs.forEach(input => {
            if(input.type === 'number') input.value = '0';
            else if(input.type === 'text') input.value = '';
          });
          
          // Reset opening balance
          if(dom('openingBalance')) {
            dom('openingBalance').value = 'Nil';
            dom('openingBalance').style.color = 'blue';
          }
        } catch(e) {
          console.warn('resetPage: error clearing UI elements', e);
        }
        
        // Write explicit empty defaults to prevent data leakage from other contexts
        try{
          const yearTargetVal = Number(load('yearTarget', 0)) || 0;
          const defaultMonthData = [];
          for(let mi=0; mi<12; mi++) {
            defaultMonthData.push({ 
              day:'', 
              target: yearTargetVal/12, 
              note:'', 
              outflow:0, 
              variance:0, 
              balance:0 
            });
          }
          
          // Save clean defaults
          save('monthData', defaultMonthData);
          save('openingBalance', 0);
          setRems([]); // Clear reminders
          save('scenarioMultipliers', { mulP:0.75, mulC:0.92, mulB:1, mulO:1.18 });
          save('lastScenario', null);
          setUndoStack([]);
          
          // Clear calendar remarks for this owner/year
          const remarksKey = `enbd:${owner}:${year}:calendarRemarks`;
          localStorage.removeItem(remarksKey);
          
          console.log('resetPage: wrote clean defaults for', currentPrefix);
        } catch(e) { 
          console.warn('resetPage: error writing defaults', e);
        }
        
        // Success feedback
        showToast(`Reset complete: Cleared ${removedCount} items for ${owner} - ${year}`);
        
      } catch(e) { 
        console.error('resetPage: error during reset', e);
        alert('Reset failed: ' + String(e));
      }
      
      // Reload the application to ensure clean state
      try {
        await initAll();
        console.log('resetPage: initAll completed successfully');
      } catch(e) {
        console.error('resetPage: initAll failed', e);
        // Fallback: page reload if initAll fails
        setTimeout(() => window.location.reload(), 100);
      }
    }
    window.resetPage = resetPage; // Make it globally accessible for extensions
    dom('btnReset').addEventListener('click', resetPage);

    // Refresh page button — reload immediately without confirmation
    dom('btnRefresh').addEventListener('click', () => {
      // Temporarily bypass password gating so refresh does not show the password overlay
      const priorUnlocked = isUnlocked;
      try{
        isUnlocked = true;
        // Save any transient edits where possible (best-effort)
        const months = getMonthData();
        try{ saveMonthData(months); }catch(e){}
        try{ save('openingBalance', Number(dom('openingBalance').value.replace(/,/g,'')||0)); }catch(e){}
      }catch(e){}
      finally{
        // restore previous lock state (page will reload immediately)
        try{ isUnlocked = priorUnlocked; }catch(e){}
      }
      window.location.reload();
    });

    // Export/Import Data
    dom('btnExport').addEventListener('click', exportData);
    dom('btnImport').addEventListener('click', () => {
      // Open file picker only when unlocked; otherwise prompt first
      if(getPassword() && !isUnlocked) { showPasswordOverlay(); return; }
      dom('importFile').click();
    });
    dom('importFile').addEventListener('change', importData);

    async function exportData(){
      if(getPassword() && !isUnlocked) { showPasswordOverlay(); return; }
      try {
        const months = getMonthData();
        if(!Array.isArray(months) || months.length === 0){
          throw new Error('No month data available to export.');
        }

        const safeNumber = val => {
          const num = Number(val || 0);
          return Number.isFinite(num) ? num : 0;
        };

        const headerRow = ['Type', 'Category', 'Month', 'Day', 'Target', 'Bank Inflow', 'Variance', 'Balance', 'Note'];
        const sheetRows = [headerRow];

        months.forEach((m, i) => {
          const cleanDay = String(m.day || '').replace(/[\x00-\x1F\x7F-\x9F]/g, '').substring(0, 50);
          const cleanNote = String(m.note || '').replace(/[\x00-\x1F\x7F-\x9F]/g, '').substring(0, 200);
          const monthLabel = monthNames[i] || `Month ${i + 1}`;

          sheetRows.push([
            'Month Data',
            monthLabel,
            monthLabel,
            cleanDay,
            safeNumber(m.target),
            safeNumber(m.outflow),
            safeNumber(m.variance),
            safeNumber(m.balance),
            cleanNote
          ]);
        });

        const kpiDefs = [
          { id: 'kpiTotalTarget', label: 'Total Target' },
          { id: 'kpiInflow', label: 'Total Inflow' },
          { id: 'kpiOpeningBalance', label: 'Opening Balance' },
          { id: 'kpiAvgMoTarget', label: 'Average Monthly Target' },
          { id: 'kpiAvgMonthly', label: 'Average Monthly Inflow' },
          { id: 'kpiMoVariance', label: 'Monthly Variance' },
          { id: 'kpiTotalDeviation', label: 'Total Deviation' },
          { id: 'kpiForecastYearEnd', label: 'Forecast Year End' },
          { id: 'kpiMoNeeded', label: 'Monthly Needed' },
          { id: 'kpiBalance', label: 'Current Balance' }
        ];

        const kpiRows = [];
        kpiDefs.forEach(({ id, label }) => {
          const el = dom(id);
          if(!el) return;
          const numeric = safeNumber(String(el.textContent || '').replace(/[^\d\.,\-+]/g, '').replace(/,/g, ''));
          kpiRows.push([
            'KPI',
            label,
            '',
            '',
            '',
            '',
            '',
            numeric,
            ''
          ]);
        });

        if(kpiRows.length){
          sheetRows.push(...kpiRows);
        }

        const cleanOwner = String(ownerSel.value || 'Owner').trim().replace(/[^\w\-]/g, '_').substring(0, 20);
        const cleanYear = String(yearSel.value || 'Year').trim().replace(/[^\w\-]/g, '_').substring(0, 10);
        const timestamp = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
        const filename = `enbd-${cleanOwner}-${cleanYear}-${timestamp}.xlsx`;

        if(typeof XLSX === 'undefined'){
          if(typeof ensureXLSX === 'function'){
            try {
              await ensureXLSX();
            } catch(loaderErr){
              console.warn('Failed to load XLSX during export attempt', loaderErr);
            }
          }
        }

        if(typeof XLSX === 'undefined'){
          const csvContent = sheetRows
            .map(row => row.map(value => {
              const str = value === null || value === undefined ? '' : String(value);
              if(/[",\n]/.test(str)){
                return '"' + str.replace(/"/g, '""') + '"';
              }
              return str;
            }).join(','))
            .join('\r\n');

          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
          const fallbackName = filename.replace(/\.xlsx$/i, '.csv');
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = fallbackName;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);

          showToast?.(`Exported CSV fallback (XLSX unavailable) — ${months.length} months${kpiRows.length ? `, ${kpiRows.length} KPIs` : ''}`, 'warn');
          return;
        }

        const wb = XLSX.utils.book_new();
        const sheet = XLSX.utils.aoa_to_sheet(sheetRows);
        XLSX.utils.book_append_sheet(wb, sheet, 'ENBD_Data');

        // Hardened export with better error handling
        try {
          const wbout = XLSX.write(wb, { type: 'array', bookType: 'xlsx' });
          const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          showToast(`Data exported: ${months.length} months${kpiRows.length ? `, ${kpiRows.length} KPIs` : ''}`);
        } catch (blobErr) {
          console.warn('Blob export failed, falling back to XLSX.writeFile', blobErr);
          try {
            XLSX.writeFile(wb, filename);
            showToast(`Data exported (fallback): ${months.length} months${kpiRows.length ? `, ${kpiRows.length} KPIs` : ''}`);
          } catch (writeErr) {
            console.error('XLSX.writeFile also failed', writeErr);
            // Final fallback: CSV export
            const csvData = XLSX.utils.sheet_to_csv(sheet);
            const csvBlob = new Blob([csvData], { type: 'text/csv' });
            const csvUrl = URL.createObjectURL(csvBlob);
            const csvA = document.createElement('a');
            csvA.href = csvUrl;
            csvA.download = filename.replace('.xlsx', '.csv');
            document.body.appendChild(csvA);
            csvA.click();
            document.body.removeChild(csvA);
            URL.revokeObjectURL(csvUrl);
            showToast(`Exported as CSV (Excel export failed) — ${months.length} months${kpiRows.length ? `, ${kpiRows.length} KPIs` : ''}`);
          }
        }
      } catch (err) {
        console.error('Export failed completely', err);
        try { localStorage.setItem('enbd:lastExportError', String(err) + ' at ' + new Date().toISOString()); } catch(e) {}
        alert('Export failed: ' + String(err));
      }
    }

  function importData(event){
      if(getPassword() && !isUnlocked) {
        // If locked, prompt for password and clear file input so the same file re-triggers change after unlock
        showPasswordOverlay();
        try { if(event && event.target) event.target.value = ''; } catch(_) {}
        return;
      }
      const file = event.target.files[0];
      if(!file) return;
      
      const reader = new FileReader();
      reader.onload = async function(e){
        try{
          // File validation before processing
          if (!file.name) {
            throw new Error('Invalid file: No filename detected.');
          }
          
          if (file.size === 0) {
            throw new Error('Invalid file: File is empty.');
          }
          
          if (file.size > 10 * 1024 * 1024) { // 10MB limit
            throw new Error('Invalid file: File is too large (over 10MB). Please use a smaller file.');
          }
          
          const fileExtension = file.name.toLowerCase().split('.').pop();
          const validExtensions = ['xlsx', 'xls', 'csv', 'json'];
          if (!validExtensions.includes(fileExtension)) {
            throw new Error(`Invalid file type: .${fileExtension}. Please use .xlsx, .xls, .csv, or .json files only.`);
          }

          let data;
          const fname = String(file.name||'');
          const lower = fname.toLowerCase();

          console.log('Processing file:', file.name, 'Size:', file.size, 'Type:', file.type);

          if(lower.endsWith('.json')){
            // Legacy JSON import
            try {
              data = JSON.parse(e.target.result);
            } catch (parseErr) {
              throw new Error('Invalid JSON file: Unable to parse JSON content. Please ensure the file is valid JSON.');
            }
          } else if(lower.endsWith('.csv')){
            // CSV import - assume it's month data
            try {
              data = parseCSV(e.target.result);
            } catch (parseErr) {
              throw new Error('Invalid CSV file: Unable to parse CSV content. Please ensure the file is properly formatted.');
            }
          } else {
            // Excel import
            if(typeof XLSX === 'undefined'){
                if(typeof ensureXLSX === 'function'){
                  try {
                    await ensureXLSX();
                  } catch(loaderErr){
                    console.warn('Failed to load XLSX during import attempt', loaderErr);
                  }
                }
            }

            if(typeof XLSX === 'undefined'){
                console.error('XLSX library not loaded');
                throw new Error('Excel parser (XLSX) not available. Please check your internet connection and reload the page. If the problem persists, try importing a CSV or JSON file instead.');
            }
            
            try {
              const wb = XLSX.read(e.target.result, {type: 'array'});
              console.log('Available sheets:', wb.SheetNames);

              if(!wb.SheetNames || wb.SheetNames.length === 0) {
                throw new Error('Invalid Excel file: No worksheets found. Please ensure the Excel file is not corrupted.');
              }

              if(wb.SheetNames.includes('ENBD_Data')){
                data = parseEnbdSingleSheet(wb);
              } else {
                data = parseLegacyMultiSheet(wb);
              }
            } catch (xlsxErr) {
              if (xlsxErr.message.includes('Unsupported file')) {
                throw new Error('Invalid Excel file: File format not supported. Please ensure you\'re using a valid .xlsx or .xls file.');
              } else {
                throw new Error('Excel parsing failed: ' + (xlsxErr.message || 'Unknown Excel error. The file may be corrupted.'));
              }
            }
          }
          
          // Enhanced validation and fallback for owner/year
          console.log('Initial data from file:', { owner: data.owner, year: data.year });
          
          // Try to infer missing owner/year from filename pattern enbd-<owner>-<year>-YYYY-MM-DD.xlsx
          if((!data.owner || !data.year) && lower.startsWith('enbd-')){
            const m = lower.match(/^enbd-([a-z0-9_\-\s]+)-(\d{4})-/);
            if(m){
              if(!data.owner) data.owner = m[1].replace(/[_\-]/g,' ').trim();
              if(!data.year) data.year = m[2];
              console.log('Inferred owner/year from filename:', data.owner, data.year);
            }
          }

          // Interactive fallback: prompt user for missing information
          if(!data.owner || !data.year) {
            let needsOwner = !data.owner;
            let needsYear = !data.year;
            
            // Try current UI selection first
            if(needsOwner && ownerSel && ownerSel.value) {
              data.owner = ownerSel.value;
              needsOwner = false;
              console.log('Using current UI owner:', data.owner);
            }
            if(needsYear && yearSel && yearSel.value) {
              data.year = yearSel.value;
              needsYear = false;
              console.log('Using current UI year:', data.year);
            }
            
            // If still missing, try system defaults
            if(needsOwner) {
              try {
                const sel = document.getElementById('owner');
                if(sel && sel.options && sel.options.length > 0) {
                  data.owner = sel.options[0].value || 'Owner 1';
                  needsOwner = false;
                  console.log('Using default owner:', data.owner);
                }
              } catch(_) {}
            }
            
            if(needsYear) {
              data.year = String(new Date().getFullYear());
              needsYear = false;
              console.log('Using current year:', data.year);
            }
            
            // Final validation with user-friendly error
            if(needsOwner || needsYear) {
              let missingInfo = [];
              if(needsOwner) missingInfo.push('Owner');
              if(needsYear) missingInfo.push('Year');
              
              throw new Error(`Missing required information: ${missingInfo.join(' and ')}.\n\nTo fix this:\n• Use a file exported from this application\n• Ensure filename follows pattern: enbd-owner-year-date.xlsx\n• Or select the correct owner/year in the application before importing`);
            }
          }
          
          // Validate data types
          if(data.year && !String(data.year).match(/^\d{4}$/)) {
            throw new Error(`Invalid year format: "${data.year}". Year must be a 4-digit number (e.g., 2025).`);
          }
          
          console.log('Final validated data:', { owner: data.owner, year: data.year });

          // === ENHANCED IMPORT PROCESS WITH LOGGING ===

          console.log('=== IMPORT PROCESS START ===');
          console.log('File info:', { name: file.name, size: file.size, type: file.type });
          console.log('Parsed data summary:', {
            owner: data.owner,
            year: data.year,
            hasMonthData: data.monthData ? data.monthData.length : 0,
            hasReminders: data.reminders ? data.reminders.length : 0,
            hasOpeningBalance: data.openingBalance !== undefined
          });

          // 1. Ensure owner and year exist in selects, then set them
          try {
            console.log('=== STEP 1: Setting Owner and Year ===');
            
            // Owner: add to owners list if missing, then repopulate
            const hasOwnerOption = ownerSel && Array.from(ownerSel.options).some(o => o.value === data.owner);
            console.log('Owner exists in options:', hasOwnerOption);
            
            if(!hasOwnerOption && ownerSel){
              const owners = loadOwners();
              console.log('Current owners list:', owners);
              if(!owners.includes(data.owner)) {
                owners.push(data.owner);
                saveOwners(owners);
                console.log('Added new owner, updated list:', owners);
              }
              if(typeof populateOwnerSelect === 'function') {
                populateOwnerSelect();
                console.log('Repopulated owner select');
              }
            }
            if(ownerSel) ownerSel.value = data.owner;

            // Year: add option if missing
            const importedYear = sanitizeYearValue(data.year);
            console.log('Sanitized year:', importedYear);
            
            if(!importedYear){
              throw new Error('Invalid year value in import: ' + data.year);
            }
            ensureYearAvailable(importedYear);
            if(yearSel) yearSel.value = importedYear;
            
            console.log('Owner and year set successfully');
          } catch(e) { 
            console.warn('Failed to ensure owner/year options', e);
            throw new Error('Failed to set owner/year: ' + e.message);
          }
          persistContext();
          
          // 2. Import core month data with enhanced logging
          console.log('=== STEP 2: Importing Month Data ===');
          if(data.monthData && Array.isArray(data.monthData)) {
            // Normalize to 12 entries
            const months = data.monthData.slice(0,12);
            while(months.length < 12){ months.push({ day:'', target:0, note:'', outflow:0, variance:0, balance:0 }); }
            
            console.log('=== DEBUG: Saving month data ===');
            console.log('Key prefix:', keyPrefix());
            console.log('Full key:', `${keyPrefix()}:monthData`);
            console.log('Month data being saved (first 3 months):', months.slice(0, 3));
            console.log('Data types check:', {
              firstMonth: typeof months[0],
              target: typeof months[0]?.target,
              outflow: typeof months[0]?.outflow
            });
            
            save('monthData', months);
            
            // Verify it was saved
            const verification = load('monthData', []);
            console.log('Verification - loaded back:', verification.length, 'months');
            console.log('Loaded sample (first month):', verification[0]);
            
            if(verification.length !== months.length) {
              throw new Error(`Month data save verification failed: Expected ${months.length} months, got ${verification.length}`);
            }
            
            console.log('✓ Month data imported successfully:', months.length, 'months');
          } else {
            console.log('⚠ No month data found in import; leaving existing unchanged');
          }
          
          // 3. Import opening balance with logging
          console.log('=== STEP 3: Importing Opening Balance ===');
          if(data.openingBalance !== undefined){
            const balanceValue = Number(data.openingBalance || 0);
            const balanceElement = dom('openingBalance');
            if(balanceElement) {
              balanceElement.value = balanceValue === 0 ? 'Nil' : String(balanceValue);
              balanceElement.style.color = balanceValue === 0 ? 'blue' : '#FFD700';
            }
            save('openingBalance', balanceValue);
            console.log('✓ Opening balance imported:', balanceValue);
          } else {
            console.log('⚠ No opening balance found in import');
          }
          
          // 4. Import deposit reminders with logging
          console.log('=== STEP 4: Importing Deposit Reminders ===');
          if(data.reminders && Array.isArray(data.reminders)) {
            try{ 
              setRems(data.reminders);
              console.log('✓ Reminders imported:', data.reminders.length, 'items');
            }catch(e){ 
              console.warn('setRems failed', e);
              throw new Error('Failed to import reminders: ' + e.message);
            }
          } else {
            console.log('⚠ No reminders found in import; leaving existing unchanged');
          }
          
          // 5. Refresh the application with error handling
          console.log('=== STEP 5: Refreshing Application ===');
          try{ 
            await initAll();
            console.log('✓ Application refresh completed');
          }catch(e){ 
            console.warn('initAll after import failed', e);
            // Don't throw here, just warn - data is already imported
          }
          
          // 6. Success message with comprehensive details
          console.log('=== STEP 6: Import Success ===');
          const importSummary = [
            `✅ Data imported successfully for ${data.owner} - ${data.year}!`,
            ``,
            `📊 Import Summary:`,
            data.monthData ? `  • Month Data: ${data.monthData.length} months imported` : '  • Month Data: No changes',
            data.reminders ? `  • Deposit Reminders: ${data.reminders.length} items imported` : '  • Deposit Reminders: No changes',
            data.openingBalance !== undefined ? `  • Opening Balance: AED ${data.openingBalance}` : '  • Opening Balance: No changes',
            ``,
            `🎉 Import completed successfully! The application has been updated with your data.`
          ].filter(Boolean).join('\n');
          
          console.log('=== IMPORT PROCESS COMPLETED SUCCESSFULLY ===');
          alert(importSummary);
          
        }catch(err){
          console.error('Import error:', err);
          console.error('Error details:', {
            fileName: file.name,
            fileSize: file.size,
            fileType: file.type,
            stackTrace: err.stack
          });
          
          // Provide user-friendly error messages based on error type
          let userMessage = 'Error importing data: ';
          
          if (err.message.includes('XLSX') || err.message.includes('Excel parser')) {
            userMessage += 'Excel library not available. Please check your internet connection and reload the page.';
          } else if (err.message.includes('Invalid data format')) {
            userMessage += 'Invalid file format. Please ensure you\'re importing a file that was exported from this application.';
          } else if (err.message.includes('Missing owner or year')) {
            userMessage += 'File is missing required owner or year information. Please export the file again or ensure the filename follows the pattern: enbd-owner-year-date.xlsx';
          } else if (file.size === 0) {
            userMessage += 'The selected file is empty. Please choose a valid Excel file.';
          } else if (file.size > 10 * 1024 * 1024) { // 10MB
            userMessage += 'File is too large. Please use a smaller Excel file (under 10MB).';
          } else if (!file.name.match(/\.(xlsx?|csv|json)$/i)) {
            userMessage += 'Unsupported file type. Please use .xlsx, .xls, .csv, or .json files only.';
          } else {
            userMessage += err.message || 'Unknown error occurred during import.';
          }
          
          userMessage += '\n\nTips for successful import:\n• Use files exported from this application\n• Ensure file isn\'t corrupted\n• Check that you have internet connection (for Excel processing)\n• Try exporting and re-importing if the file is old';
          
          alert(userMessage);
        } finally {
          // Clear the file input for next use
          event.target.value = '';
        }
      };
      
  if((file.name||'').toLowerCase().endsWith('.json') || (file.name||'').toLowerCase().endsWith('.csv')){
        reader.readAsText(file);
      } else {
        reader.readAsArrayBuffer(file);
      }
    }

    function parseEnbdSingleSheet(wb){
      const sheet = wb.Sheets['ENBD_Data'];
      if(!sheet) return {};

      const rows = XLSX.utils.sheet_to_json(sheet, { defval: '' });
      const data = {};
      const monthData = [];
      const reminders = [];

      if(!rows.length){
        return data;
      }

      const hasTypeColumn = rows.some(row => typeof row.Type === 'string' && row.Type.trim() !== '');

      if(!hasTypeColumn){
        rows.forEach(row => {
          const inflow = row['Bank Inflow'] ?? row.Inflow ?? row['Bank'] ?? row['Inflow Amount'];
          monthData.push({
            day: String(row.Day || '').trim(),
            target: parseNum(row.Target || 0),
            note: String(row.Note || ''),
            outflow: parseNum(inflow || 0),
            variance: parseNum(row.Variance || 0),
            balance: parseNum(row.Balance || 0)
          });
        });

        if(monthData.length){
          data.monthData = monthData;
        }
        return data;
      }

      rows.forEach((row, idx) => {
        const type = String(row.Type || '').trim();

        if(type === 'Settings'){
          const category = String(row.Category || '').trim();
          const val = row.Balance ?? row.Value ?? row.value ?? '';
          if(category === 'Owner' && val !== ''){
            data.owner = String(val).trim();
          } else if(category === 'Year' && val !== ''){
            data.year = String(val).trim();
          } else if(category === 'Opening Balance'){
            const num = parseNum(val || 0);
            if(!Number.isNaN(num)){ data.openingBalance = num; }
          }
        } else if(type === 'Month Data'){
          monthData.push({
            day: String(row.Day || '').trim(),
            target: parseNum(row.Target || 0),
            note: String(row.Note || ''),
            outflow: parseNum(row['Bank Inflow'] || 0),
            variance: parseNum(row.Variance || 0),
            balance: parseNum(row.Balance || 0)
          });
        } else if(type === 'Reminder'){
          const rawDate = row['Reminder Date'];
          let isoDate = null;
          if(rawDate){
            try{
              if(typeof rawDate === 'number'){
                const excelDate = new Date((rawDate - 25569) * 86400 * 1000);
                isoDate = excelDate.toISOString();
              } else {
                isoDate = new Date(rawDate).toISOString();
              }
            }catch(_){
              isoDate = null;
            }
          }
          reminders.push({
            id: row.ID || row.Id || `rem-${idx}-${Date.now()}`,
            when: isoDate || new Date().toISOString(),
            amount: parseNum(row['Reminder Amount'] || 0),
            label: String(row['Reminder Label'] || ''),
            done: String(row['Reminder Done'] || '').toLowerCase() === 'yes'
          });
        }
      });

      if(monthData.length){ data.monthData = monthData; }
      if(reminders.length){ data.reminders = reminders; }

      return data;
    }

    function parseLegacyMultiSheet(wb) {
      // Parser for the previous multi-sheet format
      const data = {};
      
      // Settings Sheet
      const wsSettings = wb.Sheets['Settings'];
      if(wsSettings){
        const settings = XLSX.utils.sheet_to_json(wsSettings);
        settings.forEach(s => {
          if(s.Key === 'Owner') data.owner = s.Value;
          else if(s.Key === 'Year') data.year = s.Value;
          else if(s.Key === 'Opening Balance') data.openingBalance = Number(s.Value || 0);
          else if(s.Key === 'Year Target') data.yearTarget = Number(s.Value || 0);
        });
      }
      
      // Month Data Sheet
      const wsMonth = wb.Sheets['MonthData'];
      if(wsMonth){
        const monthData = XLSX.utils.sheet_to_json(wsMonth);
        data.monthData = monthData.map(row => ({
          day: String(row.Day || ''),
          target: Number(row.Target || 0),
          note: String(row.Note || ''),
          outflow: Number(row['Bank Inflow'] || 0),
          variance: Number(row.Variance || 0),
          balance: Number(row.Balance || 0)
        }));
      }
      
      // Reminders Sheet
      const wsRem = wb.Sheets['Reminders'];
      if(wsRem){
        const remData = XLSX.utils.sheet_to_json(wsRem);
        data.reminders = remData.map(row => {
          const dateStr = row.Date;
          let isoDate;
          try {
            if(dateStr && dateStr.includes('-')) {
              isoDate = new Date(dateStr).toISOString();
            } else if(dateStr) {
              const excelDate = new Date((dateStr - 25569) * 86400 * 1000);
              isoDate = excelDate.toISOString();
            } else {
              isoDate = new Date().toISOString();
            }
          } catch(e) {
            isoDate = new Date().toISOString();
          }
          
          return {
            id: row.ID || ('r' + Date.now() + Math.random()),
            when: isoDate,
            amount: Number(row.Amount || 0),
            label: String(row.Label || ''),
            done: (row.Done === 'Yes' || row.Done === true)
          };
        });
      }
      
      return data;
    }
    
    function parseLegacyExcel(wb) {
      // Legacy parser for backward compatibility
      const data = {};
      
      // Try to extract from the old "KPIs_and_MonthData" combined sheet
      const wsCombined = wb.Sheets['KPIs_and_MonthData'];
      if(wsCombined) {
        const allData = XLSX.utils.sheet_to_json(wsCombined);
        
        // Extract month data (rows with Month, Day, Target, etc.)
        const monthRows = allData.filter(row => row.Month && (row.Target !== undefined || row['Bank Inflow'] !== undefined));
        if(monthRows.length > 0) {
          data.monthData = monthRows.map(row => ({
            day: String(row.Day || ''),
            target: Number(row.Target || 0),
            note: String(row.Note || ''),
            outflow: Number(row['Bank Inflow'] || 0),
            variance: Number(row.Variance || 0),
            balance: Number(row.Balance || 0)
          }));
        }
      }
      
      // Try legacy individual sheets
      const wsSettings = wb.Sheets['Settings'];
      if(wsSettings){
        const settings = XLSX.utils.sheet_to_json(wsSettings);
        settings.forEach(s => {
          if(s.Key === 'Owner') data.owner = s.Value;
          else if(s.Key === 'Year') data.year = s.Value;
          else if(s.Key === 'Opening Balance') data.openingBalance = Number(s.Value || 0);
        });
      }
      
      return data;
    }
    
    function parseCSV(csvText) {
      // Simple CSV parser for month data
      const lines = csvText.split('\n').map(line => line.trim()).filter(line => line);
      if(lines.length < 2) throw new Error('CSV file must have at least a header and one data row');
      
      const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
      const data = { monthData: [] };
      
      // Set defaults for validation
      data.owner = ownerSel?.value || 'CSV Import';
      data.year = yearSel?.value || new Date().getFullYear().toString();
      
      for(let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
        const row = {};
        let rowType = '';
        
        // Map CSV columns to our data structure
        headers.forEach((header, index) => {
          const value = values[index] || '';
          const lowerHeader = header.toLowerCase();
          
          if(lowerHeader === 'type') rowType = value.toLowerCase();
          else if(lowerHeader.includes('month')) row.month = value;
          else if(lowerHeader.includes('day')) row.day = value;
          else if(lowerHeader.includes('target')) row.target = Number(value) || 0;
          else if(lowerHeader.includes('inflow') || lowerHeader.includes('bank')) row.outflow = Number(value) || 0;
          else if(lowerHeader.includes('variance')) row.variance = Number(value) || 0;
          else if(lowerHeader.includes('balance')) row.balance = Number(value) || 0;
          else if(lowerHeader.includes('note')) row.note = value;
          else if(lowerHeader.includes('owner') && value) data.owner = value;
          else if(lowerHeader.includes('year') && value) data.year = value;
        });

        if(rowType && rowType !== 'month data') {
          continue;
        }
        
        // Convert to our month data format
        const monthData = {
          day: String(row.day || ''),
          target: Number(row.target || 0),
          note: String(row.note || ''),
          outflow: Number(row.outflow || 0),
          variance: Number(row.variance || 0),
          balance: Number(row.balance || 0)
        };
        
        data.monthData.push(monthData);
      }
      
      // If we didn't get 12 months, fill the rest
      while(data.monthData.length < 12) {
        data.monthData.push({
          day: '', target: 0, note: '', outflow: 0, variance: 0, balance: 0
        });
      }
      
      console.log('CSV parsed:', data);
      return data;
    }

    // Theme toggle removed — app will use default styles only

    // Table (7 columns)
    const tbody = document.querySelector('#monthTable tbody');
    // Data migration helper - older versions stored plain numeric keys m1..m12. New format stores per-month object under key 'monthData' as array.
    function migrateLegacyMonths(){
      const months = [];
      const legacyFound = (()=>{ for(let i=1;i<=12;i++){ if(localStorage.getItem(`${keyPrefix()}:m${i}`)!==null) return true; } return false; })();
      if(legacyFound){
        for(let i=1;i<=12;i++){
          const v = Number(localStorage.getItem(`${keyPrefix()}:m${i}`) || 0);
          months.push({ day:'', target: 0, note:'', outflow: v, variance:0, balance:0 });
          // remove legacy key (keep if you prefer migration only)
          try{ localStorage.removeItem(`${keyPrefix()}:m${i}`); }catch(e){}
        }
        save('monthData', months);
      }
    }

    function getMonthData(){
      // Prefer the helper load for current owner/year
      const pref = load('monthData', null);
      if(Array.isArray(pref)){
        console.debug('getMonthData: loaded via prefixed key', `${keyPrefix()}:monthData`, 'count', pref.length);
        return pref;
      }
      // Fallback: look for any existing monthData under any ':monthData' key
      try{
        for(let i=0;i<localStorage.length;i++){
          const k = localStorage.key(i);
          if(k && k.endsWith(':monthData')){
            try{
              const parsed = JSON.parse(localStorage.getItem(k));
              if(Array.isArray(parsed)){
                // migrate into current prefixed key for current owner/year
                save('monthData', parsed);
                console.debug('getMonthData: migrated from found key', k, 'to', `${keyPrefix()}:monthData`);
                return parsed;
              }
            }catch(e){}
          }
        }
      }catch(e){}
      // default build - create empty template without inherited values
      const def = [];
      for(let i=0;i<12;i++) def.push({ day:'', target: 0, note:'', outflow:0, variance:0, balance:0 });
      save('monthData', def); return def;
    }

    // Harden saving with explicit prefixed key write + debug to avoid silent failures
    function saveMonthData(arr){
      try{
        // prefer existing save helper (keeps behavior consistent)
        save('monthData', arr);
      }catch(e){ console.debug('saveMonthData: save() helper failed', e); }
      try{
        const k = `${keyPrefix()}:monthData`;
        localStorage.setItem(k, JSON.stringify(arr));
        console.debug('saveMonthData: wrote', k, 'items', Array.isArray(arr)?arr.length:0);
        try{
          // maintain an undo stack (persisted per owner/year)
          const stackKey = `${keyPrefix()}:undoStack`;
          const maxSize = 20;
          let stack = [];
          try{ stack = JSON.parse(localStorage.getItem(stackKey)) || []; }catch(e){ stack = []; }
          // push current snapshot (timestamp + monthData)
          stack.push({ t: Date.now(), monthData: arr });
          if(stack.length > maxSize) stack = stack.slice(stack.length - maxSize);
          localStorage.setItem(stackKey, JSON.stringify(stack));
          console.debug('saveMonthData: pushed undo snapshot, stack size', stack.length);
        }catch(e){ console.debug('saveMonthData: undo push failed', e); }
      }catch(e){ console.debug('saveMonthData: direct write failed', e); }
    }

  // Debounce helper to batch rapid input events
  function debounce(fn, wait=300){ let t; return function(...a){ clearTimeout(t); t = setTimeout(()=>fn.apply(this,a), wait); }; }
  // Debounced save + recompute + auxiliary updates used by table inputs
  const debouncedSaveAndRecompute = debounce(async (months)=>{ try{ saveMonthData(months); recompute(); await drawChart(); buildShareText(); }catch(e){ console.debug('debouncedSaveAndRecompute failed', e); } }, 360);

  // Currency input normalizer: on focus show raw digits, on blur format with locale grouping
  function normalizeCurrencyInput(el){
    if(!el) return;
    el.addEventListener('focus', ()=>{
      try{
        const clean = String(el.value||'').replace(/^\s*AED\s*/i,'').replace(/[^0-9.-]/g,'');
        el.value = clean;
      }catch(e){}
    });
    el.addEventListener('blur', ()=>{
      try{
        const clean = String(el.value||'').replace(/^\s*AED\s*/i,'').replace(/[^0-9.-]/g,'');
        const num = Number(clean || 0);
        el.value = (clean && !isNaN(num)) ? num.toLocaleString('en-AE') : '';
      }catch(e){}
    });
  }

  // --- Undo stack helpers ---
  function getUndoStack(){ try{ const k = `${keyPrefix()}:undoStack`; const raw = localStorage.getItem(k); return raw ? JSON.parse(raw) : []; }catch(e){ return []; } }
  function setUndoStack(stack){ try{ const k = `${keyPrefix()}:undoStack`; localStorage.setItem(k, JSON.stringify(stack)); }catch(e){} }
  function undoLast(){ try{
      const stack = getUndoStack(); if(!stack || !stack.length){ showToast && showToast('Nothing to undo'); return; }
      const last = stack.pop(); setUndoStack(stack);
      if(last && last.monthData){ save('monthData', last.monthData); saveMonthData(last.monthData); buildTable(); recompute(); drawChart(); buildShareText(); showToast('Undo applied'); }
    }catch(e){ console.debug('undoLast failed', e); showToast && showToast('Undo failed'); } }

  // Wire Undo button
  const btnUndo = dom('btnUndo'); if(btnUndo){ btnUndo.addEventListener('click', ()=>{ if(!confirm('Undo last change?')) return; undoLast(); }); }

    // === UI Functions ===
    function buildTable(){
      migrateLegacyMonths();
      const months = getMonthData();
      tbody.innerHTML = '';
      for(let m=0;m<12;m++){
  const data = months[m] || { day:'', target:0, note:'', outflow:0, variance:0, balance:0 };
        const tr = document.createElement('tr');
  // Month cell: create an index circle span and the short month text
  const tdM = document.createElement('td'); tdM.className = 'month-cell';
  const idx = document.createElement('span'); idx.className = 'month-index'; idx.textContent = (m+1);
  const lab = document.createElement('span'); lab.className = 'month-label'; lab.textContent = shortMonth[m];
  tdM.appendChild(idx);
  tdM.appendChild(lab);
        // Day
  const tdDay = document.createElement('td');
  // allow manual entry of up to 2 comma-separated days
  const inDay = document.createElement('input'); inDay.type='text'; inDay.value = data.day || ''; inDay.style.fontSize = 'calc(9px * 1.21)'; inDay.id = `month-day-${m}`; inDay.setAttribute('aria-label', `Day for ${shortMonth[m]}`);
  inDay.addEventListener('input', ()=>{ if(getPassword() && !isUnlocked) { showPasswordOverlay(); return; } data.day = String(inDay.value||'').trim(); debouncedSaveAndRecompute(months); });
  inDay.addEventListener('change', ()=>{ if(getPassword() && !isUnlocked) { showPasswordOverlay(); return; } data.day = String(inDay.value||'').trim(); saveMonthData(months); });
  inDay.addEventListener('keydown', handleEnter);
        tdDay.appendChild(inDay);
        // Target
        const tdT = document.createElement('td');
  const inT = document.createElement('input'); inT.type='text'; inT.value = (function(v){ if(typeof v==='string') v = v.replace(/^\s*AED\s*/i,''); const num = Number(v||0); return num ? num.toLocaleString('en-AE') : '' })(data.target); inT.id = `month-target-${m}`; inT.setAttribute('aria-label', `Target for ${shortMonth[m]}`);
  inT.addEventListener('input', ()=>{ const clean = String(inT.value||'').replace(/^\s*AED\s*/i,'').replace(/,/g,''); data.target = Number(clean||0); debouncedSaveAndRecompute(months); });
  inT.addEventListener('change', ()=>{ if(getPassword() && !isUnlocked) { showPasswordOverlay(); return; } const clean = String(inT.value||'').replace(/^\s*AED\s*/i,'').replace(/,/g,''); data.target = Number(clean||0); saveMonthData(months); recompute(); buildShareText(); showToast('Data saved'); });
  inT.addEventListener('keydown', handleEnter);
  normalizeCurrencyInput(inT);
  tdT.appendChild(inT);
  // Note: keep the hidden inline input for programmatic access, but remove preview and note button (popup trigger removed)
    const tdN = document.createElement('td');
  const inN = document.createElement('input'); inN.type='text'; inN.value = data.note || ''; inN.id = `month-note-${m}`; inN.setAttribute('placeholder', 'Note'); inN.setAttribute('aria-label', `Note for ${shortMonth[m]}`);
  // Note: make the inline input visible in the table cell
    // Removed hiding styles to revive the note column
    inN.addEventListener('input', ()=>{ if(getPassword() && !isUnlocked) { showPasswordOverlay(); return; } data.note = inN.value; debouncedSaveAndRecompute(months); });
    inN.addEventListener('input', ()=>{ data.note = inN.value; saveMonthData(months); });
    inN.addEventListener('keydown', handleEnter);
    tdN.appendChild(inN);
  // Bank Inflow (internal key: outflow)
        const tdO = document.createElement('td');
  const inO = document.createElement('input'); inO.type='text'; inO.value = (function(v){ if(typeof v==='string') v = v.replace(/^\s*AED\s*/i,''); const num = Number(v||0); return num ? num.toLocaleString('en-AE') : '' })(data.outflow); inO.id = `month-inflow-${m}`; inO.setAttribute('aria-label', `Bank inflow for ${shortMonth[m]}`);
  inO.addEventListener('input', ()=>{ const clean = String(inO.value||'').replace(/^\s*AED\s*/i,'').replace(/,/g,''); data.outflow = Number(clean||0); debouncedSaveAndRecompute(months); });
  inO.addEventListener('change', ()=>{ if(getPassword() && !isUnlocked) { showPasswordOverlay(); return; } const clean = String(inO.value||'').replace(/^\s*AED\s*/i,'').replace(/,/g,''); data.outflow = Number(clean||0); saveMonthData(months); recompute(); drawChart(); buildShareText(); showToast('Data saved'); });
  inO.addEventListener('keydown', handleEnter);
  normalizeCurrencyInput(inO);
  tdO.appendChild(inO);
  // Variance (computed)
  const tdV = document.createElement('td'); tdV.textContent = data.variance!=null? fmtAcc(data.variance) : fmtAcc(0);
  // Balance (computed)
  const tdB = document.createElement('td'); tdB.textContent = data.balance!=null? fmtAcc(data.balance) : fmtAcc(0);

  tr.appendChild(tdDay);
  tr.appendChild(tdM);
  tr.appendChild(tdT);
  tr.appendChild(tdN);
  tr.appendChild(tdO);
  tr.appendChild(tdV);
  tr.appendChild(tdB);
        tbody.appendChild(tr);
      }
  // totals are handled by the persistent <tfoot> — recompute() will update those cells
    }

          // --- Month Note Popup Overlay ---
          /*
            Usage & notes:
            - Opens when the user clicks any month note input with id `month-note-<N>` (0-11).
            - Overlay element id: `monthNoteOverlay`.
            - Fields inside overlay: date -> `mnoDate`, note -> `mnoNote`.
            - Save button id: `mnoSave`. Close/Cancel: `mnoClose`, `mnoCancel`.
            - On Save: writes back `months[monthIndex].day` (single day-of-month) and `months[monthIndex].note`, then calls
              `saveMonthData(months)`, updates table inputs if present (`month-day-<N>`, `month-note-<N>`), and triggers
              `recompute()`, `drawChart()`, `buildShareText()` so KPIs/charts/share-text refresh.
            - Minimal font sizes used (~11px). No brackets in labels. Respects password lock (calls `showPasswordOverlay()` if locked).
            - Edge: If you used comma-separated multiple days, the overlay will pre-fill using the first value and will overwrite
              the field with a single day if saved. If you want multi-day preservation, I can change this behavior.
          */
          // Minimal popup to edit a month's day and note with a small calendar/date input.
          (function(){
            // inject overlay HTML into document body when DOM is ready
            function createMonthNoteOverlay(){
              if(dom('monthNoteOverlay')) return; // already present
              const html = `\
              <div id="monthNoteOverlay" class="overlay hidden" aria-hidden="true">\
                <div class="overlay-panel">\
                  <div class="overlay-header">\
                    <strong id="mnoTitle" style="font-size:11px;">Month Note</strong>\
                    <button id="mnoClose" class="btn small">Close</button>\
                  </div>\
                  <div class="overlay-body" style="font-size:11px;">\
                    <label style="display:block;margin-bottom:6px;">Date<span style="margin-left:6px;color:var(--accent-amber,#ffb84d)"></span></label>\
                    <input type="date" id="mnoDate" style="width:100%;font-size:12px;padding:6px;margin-bottom:8px;" />\
                    <label style="display:block;margin-bottom:6px;">Note</label>
                    <textarea id="mnoNote" rows="4" style="width:100%;font-size:12px;padding:6px;resize:vertical;" placeholder="Small note..."></textarea>
                    <!-- Recipient input added to month note popup so users can enter recipient without opening the notes drawer -->
                    <label style="display:block;margin-top:8px; font-size:11px;">Recipient (optional): <input id="mnoShareRecipient" placeholder="e.g., John Doe" style="width:60%; padding:6px; margin-left:8px; border-radius:6px; background:#18181b; border:1px solid #2a2a30; color:var(--text); font-size:11px" type="text"/></label>
                    <div style="margin-top:8px;text-align:right; display:flex; gap:8px; justify-content:flex-end; align-items:center">\
                      <button id="mnoClearNote" class="btn small">Clear Note</button>\
                      <button id="mnoReviseDate" class="btn small">Revise Date</button>\
                      <!-- Small WhatsApp arrow share button -->\
                      <button id="mnoWhatsApp" title="Share via WhatsApp" class="btn small" style="background:transparent; border:none; color:#5c9090; font-size:18px; padding:6px 8px;">➔</button>\
                      <button id="mnoSave" class="btn primary small">Save</button>\
                      <button id="mnoCancel" class="btn small">Cancel</button>\
                    </div>\
                  </div>\
                </div>\
              </div>`;
              const wrap = document.createElement('div'); wrap.innerHTML = html;
              document.body.appendChild(wrap.firstElementChild);

              // Auto-expand textarea on input
              const noteTextarea = dom('mnoNote');
              if(noteTextarea){
                noteTextarea.addEventListener('input', function() {
                  this.style.height = 'auto';
                  this.style.height = this.scrollHeight + 'px';
                });
              }

              // minimal styles appended to head (scoped)
              const style = document.createElement('style'); style.id='monthNoteOverlayStyles';
  style.textContent = `\
    #monthNoteOverlay.overlay{ position:fixed; inset:0; background:rgba(0,0,0,0.28); display:flex; align-items:center; justify-content:center; z-index:1200; }\
    #monthNoteOverlay.hidden{ display:none; }\
    /* Use page card background for visual consistency */\
  #monthNoteOverlay .overlay-panel{ background: #000000; padding:14px; border-radius:10px; width:360px; box-shadow:0 12px 40px rgba(0,0,0,0.6); font-family:inherit; border:1px solid rgba(255,255,255,0.06); color: #ffffff; position:relative; }\
  /* subtle left accent using main accent color if available */\
  #monthNoteOverlay .overlay-panel::before{ content:''; position:absolute; left:0; top:0; bottom:0; width:6px; border-top-left-radius:10px; border-bottom-left-radius:10px; background: linear-gradient(180deg, var(--accent,#0b7a8a), var(--accent-amber,#ffb84d)); box-shadow:inset 0 0 8px rgba(0,0,0,0.03); }
  #monthNoteOverlay .overlay-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }\
  #monthNoteOverlay .overlay-body{ font-size:12px; color: #ffffff; }\
  #monthNoteOverlay .btn.small{ font-size:12px; padding:6px 10px; margin-left:8px; background: transparent; color: #ff8c00; border: none; border-radius: 4px; }\
  #monthNoteOverlay .btn.primary.small{ background: transparent; color: #ff8c00; border: none; border-radius: 4px; }\
  #monthNoteOverlay .btn.primary.small:hover{ background: rgba(255,140,0,0.06); }\
  #monthNoteOverlay .btn.small:hover{ background: rgba(255,255,255,0.03); }\
  #monthNoteOverlay label{ color: #ffffff; font-weight:600; font-size:12px; }\
  #monthNoteOverlay input[type=date], #monthNoteOverlay textarea{ border:1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.06); color: #ffffff; padding:6px; border-radius:4px; }\
  #monthNoteOverlay textarea::-webkit-scrollbar { display: none; }\
  #monthNoteOverlay textarea { scrollbar-width: none; }\
    /* Make the note button icon red to improve visibility */\
    .note-btn{ background:transparent;border:1px solid rgba(197,48,48,0.12); border-radius:4px; color:#c53030; }\
    .note-btn:hover{ background:rgba(197,48,48,0.04); }
        `;
              document.head.appendChild(style);

              // wiring
              const ov = dom('monthNoteOverlay');
              const btnClose = dom('mnoClose');
              const btnCancel = dom('mnoCancel');
              const btnSave = dom('mnoSave');
              const btnClearNote = dom('mnoClearNote');
              const btnReviseDate = dom('mnoReviseDate');
              const btnWhats = dom('mnoWhatsApp');
              btnClose && btnClose.addEventListener('click', ()=>{ closeOverlay(); });
              btnCancel && btnCancel.addEventListener('click', ()=>{ closeOverlay(); });
              btnClearNote && btnClearNote.addEventListener('click', ()=>{ dom('mnoNote').value = ''; });
              btnReviseDate && btnReviseDate.addEventListener('click', ()=>{ const today = new Date().toISOString().slice(0,10); dom('mnoDate').value = today; });

              // WhatsApp share from month note overlay
              if(btnWhats){ btnWhats.addEventListener('click', ()=>{
                try{
                  const rec = (dom('mnoShareRecipient')||{value:''}).value.trim() || (dom('noteShareRecipient')||{value:''}).value.trim() || (dom('shareRecipient')||{value:''}).value.trim() || (dom('scShareRecipient')||{value:''}).value.trim();
                  if(!rec){ if(dom('mnoShareRecipient')) dom('mnoShareRecipient').focus(); alert('Please enter a recipient name before sharing.'); return; }
                  const note = dom('mnoNote')?.value || '';
                  const final = `Dear ${rec},\n\n` + note;
                  window.open('https://wa.me/?text='+enc(final), '_blank');
                }catch(e){ console.debug('mnoWhatsApp share failed', e); alert('Share failed'); }
              }); }

              function closeOverlay(){ if(ov) { ov.classList.remove('show'); ov.classList.add('hidden'); ov.setAttribute('aria-hidden','true'); } }

              // save handler will be set dynamically by openOverlay
              btnSave.addEventListener('click', ()=>{
                try{ if(!ov._onSave) return; ov._onSave(); closeOverlay(); }catch(e){ console.debug('monthNote save failed', e); showToast && showToast('Save failed'); }
              });

              // close on Esc and restore focus
              document.addEventListener('keydown', function onDocKey(e){ if(e.key === 'Escape'){ if(dom('monthNoteOverlay') && !dom('monthNoteOverlay').classList.contains('hidden')){ closeOverlay(); } } });
            }

            function openMonthNoteOverlay(monthIndex, months){
              createMonthNoteOverlay();
              const ov = dom('monthNoteOverlay');
              const title = dom('mnoTitle');
              const dateInput = dom('mnoDate');
              const noteInput = dom('mnoNote');
              const saveBtn = dom('mnoSave');
              if(!ov || !dateInput || !noteInput) return;
              // Prefill overlay recipient from general notes drawer recipient if present
              try{ const generalRec = (dom('noteShareRecipient')||{value:''}).value.trim(); if(generalRec){ const mn = dom('mnoShareRecipient'); if(mn) mn.value = generalRec; } }catch(_){ }
              const short = shortMonth[monthIndex] || ('Month '+(monthIndex+1));
              title.textContent = short + ' Note';
              // populate
              const m = months[monthIndex] || { day:'', note:'' };
              // day may contain comma-separated days; pick first for date if present and parseable as day-of-month for current year/month
              const dayStr = String(m.day||'').split(',')[0].trim();
              if(dayStr){
                // try construct a date for the current selected year and this month
                const y = Number(yearSel.value) || new Date().getFullYear();
                const mm = monthIndex; // 0-based
                const dnum = Number(dayStr);
                if(dnum && dnum>=1 && dnum<=31){
                  const dt = new Date(y, mm, dnum);
                  const iso = dt.toISOString().slice(0,10);
                  dateInput.value = iso;
                } else { dateInput.value = ''; }
              } else { dateInput.value = ''; }
        noteInput.value = m.note || '';
              // set onSave callback on overlay element
              ov._onSave = function(){
                try{
                  // push undo snapshot of months (shallow copy) before changes
                  try{ const snap = JSON.parse(JSON.stringify(months)); pushUndoSnapshot(snap); }catch(e){ /*ignore*/ }
                }catch(e){}
                // write back to months array: set day to day-of-month from dateInput (if any) and note
                const iso = dateInput.value;
                // if user changed date, update day; otherwise preserve existing day (including comma-separated)
                if(iso){ try{ const dt = new Date(iso); const d = dt.getDate(); months[monthIndex].day = String(d); }catch(e){} };
                months[monthIndex].note = noteInput.value || '';
                // persist
                saveMonthData(months);
                // update table inputs if present
                const noteEl = dom('month-note-'+monthIndex); if(noteEl) noteEl.value = months[monthIndex].note || '';
                // update preview span
                const td = noteEl ? noteEl.parentElement : null; if(td){ const spans = td.querySelectorAll('span'); if(spans[0]){ spans[0].textContent = (months[monthIndex].note || '').substring(0,20) + ((months[monthIndex].note || '').length > 20 ? '...' : ''); } }
                const dayEl = dom('month-day-'+monthIndex); if(dayEl) dayEl.value = months[monthIndex].day || '';
                // recompute / redraw
                try{ recompute(); drawChart(); buildShareText(); }catch(e){ console.debug('post-save updates failed', e); }
                // restore focus to originating element if available
                try{ const origin = ov._originEl; if(origin && typeof origin.focus === 'function') origin.focus(); }catch(e){}
                showToast && showToast('Month note saved');
              };
              ov.classList.remove('hidden'); ov.classList.add('show'); ov.setAttribute('aria-hidden','false');
              // focus the note input to make the popup immediately usable
              try{ noteInput.focus(); if(noteInput.setSelectionRange) { const len = noteInput.value.length; noteInput.setSelectionRange(len,len); } }catch(e){}
            }

            // attach click handler to each month-note input and note button (delegated)
            function attachMonthNoteClicks(){
              const tbodyEl = tbody; if(!tbodyEl) return;
              tbodyEl.addEventListener('click', function(ev){
                const tgt = ev.target;
                if(!tgt) return;
                // if the clicked element is a month-note input
                const id = tgt.id || '';
                const match = id.match(/^month-note-(\d+)$/);
                if(match){ const idx = Number(match[1]); const origin = tgt; const months = getMonthData(); const ov = dom('monthNoteOverlay'); if(ov) ov._originEl = origin; openMonthNoteOverlay(idx, months); return; }
                // if clicked the note button icon
                const matchBtn = id.match(/^month-note-btn-(\d+)$/);
                if(matchBtn){ const idx = Number(matchBtn[1]); const origin = tgt; const months = getMonthData(); createMonthNoteOverlay(); const ov = dom('monthNoteOverlay'); if(ov) ov._originEl = origin; openMonthNoteOverlay(idx, months); return; }
              });
            }

            // initialize on DOM ready
            try{ attachMonthNoteClicks(); }catch(e){ console.debug('attachMonthNoteClicks failed', e); }
          })();

          // Defensive delegation: ensure month-note overlay controls work even if the overlay
          // is recreated or direct handlers fail to attach. This keeps Close, Cancel, Save
          // and WhatsApp share operational and adds a gentle autosave while typing.
          document.addEventListener('click', function(ev){
            try{
              const tgt = ev.target;
              if(!tgt || !tgt.id) return;
              const id = tgt.id;
              const ov = dom('monthNoteOverlay');

              if(id === 'mnoClose' || id === 'mnoCancel'){
                if(ov){ ov.classList.remove('show'); ov.classList.add('hidden'); ov.setAttribute('aria-hidden','true'); try{ if(ov._originEl && typeof ov._originEl.focus === 'function') ov._originEl.focus(); }catch(_){} }
              }

              if(id === 'mnoSave'){
                try{
                  if(ov && typeof ov._onSave === 'function'){ ov._onSave(); ov.classList.remove('show'); ov.classList.add('hidden'); ov.setAttribute('aria-hidden','true'); }
                }catch(e){ console.debug('delegated mnoSave failed', e); alert('Save failed'); }
              }

              if(id === 'mnoWhatsApp'){
                try{
                  const rec = (dom('mnoShareRecipient')||{value:''}).value.trim() || (dom('noteShareRecipient')||{value:''}).value.trim() || (dom('shareRecipient')||{value:''}).value.trim() || (dom('scShareRecipient')||{value:''}).value.trim();
                  if(!rec){ if(dom('mnoShareRecipient')) dom('mnoShareRecipient').focus(); alert('Please enter a recipient name before sharing.'); return; }
                  const note = dom('mnoNote')?.value || '';
                  const final = `Dear ${rec},\n\n` + note;
                  window.open('https://wa.me/?text='+encodeURIComponent(final), '_blank');
                }catch(e){ console.debug('delegated mnoWhatsApp failed', e); alert('Share failed'); }
              }
            }catch(e){ console.debug('month-note delegation error', e); }
          });

          // Autosave while typing in month-note overlay (DISABLED - user prefers manual save)
          // document.addEventListener('input', function(ev){
          //   try{
          //     const tgt = ev.target;
          //     if(!tgt || tgt.id !== 'mnoNote') return;
          //     const ov = dom('monthNoteOverlay');
          //     if(!ov || typeof ov._onSave !== 'function') return;
          //     // debounce per-overlay
          //     if(ov._saveTimer) clearTimeout(ov._saveTimer);
          //     ov._saveTimer = setTimeout(()=>{
          //       try{ ov._onSave(); }catch(e){ console.debug('month-note autosave failed', e); }
          //     }, 700);
          //   }catch(e){ console.debug('month-note autosave listener error', e); }
          // });

    // KPIs
    // helper to update the three-line year data label
    function updateYearDataLabel(owner, year){
      try{
        if(!yearDataLabel) return;
        const ownerText = String(owner || ownerSel.value || '').trim();
        const yearText = String(year || yearSel.value || '').trim();
        const ownerEl = yearDataLabel.querySelector('.y-owner');
        const yearEl = yearDataLabel.querySelector('.y-year');
        const fullEl = yearDataLabel.querySelector('.y-full');
        if(ownerEl) ownerEl.textContent = ownerText;
        if(yearEl) yearEl.textContent = yearText;
        if(fullEl) fullEl.textContent = `${ownerText} Year Data: ${yearText}`;
        // position tweak for special owner
        yearDataLabel.style.left = (ownerText === 'MADUR_ENBD') ? '0.5cm' : '0';
        // apply colors: owner, year, and full text all use owner color
        const c = ownerColor(ownerText);
        if(ownerEl) ownerEl.style.color = c;
        if(yearEl) yearEl.style.color = c;
        if(fullEl) fullEl.style.color = c;
      }catch(e){ /* ignore */ }
    }

    // Check if the current owner/year has meaningful data (not just empty defaults)
    function hasRealData() {
      const months = getMonthData();
      const yt = parseNum(load('yearTarget', 0));
      
      // Check if there's any real content:
      // 1. Any non-zero targets
      const hasTargets = months.some(m => parseNum(m.target || 0) > 0);
      // 2. Any non-zero inflows 
      const hasInflows = months.some(m => parseNum(m.outflow || 0) > 0);
      // 3. Any notes
      const hasNotes = months.some(m => (m.note || '').trim().length > 0);
      // 4. Any day entries
      const hasDays = months.some(m => (m.day || '').trim().length > 0);
      // 5. Non-zero year target
      const hasYearTarget = yt > 0;
      // 6. Non-zero opening balance
      const openingBal = parseNum(dom('openingBalance')?.value || 0);
      const hasOpeningBalance = openingBal !== 0;
      
      return hasTargets || hasInflows || hasNotes || hasDays || hasYearTarget || hasOpeningBalance;
    }

    function recompute(){
      updateYearDataLabel(ownerSel.value, yearSel.value);
      try{ yearDataLabel.style.color = ownerColor(ownerSel.value); }catch(e){}
    
    // Check if this owner/year has real data
    const hasData = hasRealData();
    
    if (!hasData) {
      // Show empty/zero KPIs for owners with no data
      setKpi('kpiTotalTarget', 0);
      setKpi('kpiInflow', 0);
      // Set opening balance to "Nil" for empty data
      const obEl = dom('kpiOpeningBalance');
      if (obEl) {
        obEl.textContent = 'Nil';
        obEl.style.color = '#0000FF';
      }
      setKpi('kpiAvgMoTarget', 0);
      setKpi('kpiAvgMonthly', 0);
      setKpi('kpiMoVariance', 0);
      setKpi('kpiTotalDeviation', 0);
      setKpi('kpiForecastYearEnd', 0);
      setKpi('kpiMoNeeded', 0);
      setKpi('kpiBalance', 0);
      
      // Update totals to zero as well
      try {
        const totTargetEl = dom('totTarget'); if(totTargetEl) totTargetEl.textContent = fmtAcc(0);
        const totInflowEl = dom('totInflow'); if(totInflowEl) totInflowEl.textContent = fmtAcc(0);
        const totVarEl = dom('totVariance'); if(totVarEl) { totVarEl.textContent = fmtAcc(0); totVarEl.style.color = '#7bd99f'; }
        const totBalEl = dom('totBalance'); if(totBalEl) { totBalEl.textContent = fmtAcc(0); totBalEl.style.color = '#7bd99f'; }
      } catch(e) { console.debug('recompute: error clearing totals', e); }
      
      // Set Total Target to show "No Data" instead of 0
      const ttEl = dom('kpiTotalTarget');
      if (ttEl) {
        ttEl.innerHTML = '<span style="font-size:10px; opacity:0.85; vertical-align:baseline; font-weight:600">AED</span>&nbsp;<span class="kpi-amount" style="color: var(--muted); font-style: italic;">No Data</span>';
        ttEl.classList.add('neutral-muted');
        ttEl.classList.remove('positive','negative');
      }
      
      console.debug('recompute: no real data found, showing zeros/no data');
      return; // Exit early for empty data
    }
    
    // Continue with normal KPI calculations for owners with real data
    // Year target
  const yt = parseNum(load('yearTarget', 0));

    // Monthly data from monthData
    const months = getMonthData();
  const values = months.map(m=> parseNum(m.outflow||0));
  console.debug('recompute: months loaded', months.length, 'values', values);

    // Compute variance and cumulative balance per month
    const monthlyTarget = yt/12;
  const openingBal = parseNum(dom('openingBalance').value || 0);
  let cumBal = openingBal;
      for(let i=0;i<12;i++){
        const v = values[i]||0;
        const varr = v - (months[i].target || monthlyTarget);
        months[i].variance = varr;
        cumBal += varr;
        months[i].balance = cumBal;
      }
      saveMonthData(months);

  // Update KPIs per new rules
  const totalTarget = months.reduce((s,m)=> s + parseNum(m.target||0), 0);
  setKpi('kpiTotalTarget', totalTarget);
  console.debug('recompute: setKpi kpiTotalTarget', totalTarget);
  // Force a neutral muted color for the Total Target KPI (unbiased)
  const tt = dom('kpiTotalTarget'); if(tt){ tt.classList.add('neutral-muted'); tt.classList.remove('positive','negative'); }

  const inflowYTD = values.slice(0, currentMonthIdx).reduce((a,b)=>a+b,0);
  setKpi('kpiInflow', inflowYTD);
  console.debug('recompute: setKpi kpiInflow', inflowYTD);

  setKpi('kpiOpeningBalance', openingBal);
  console.debug('recompute: setKpi kpiOpeningBalance', openingBal);
  if (openingBal === 0) {
    const el = dom('kpiOpeningBalance');
    if (el) {
      el.textContent = 'Nil';
      el.style.color = '#0000FF';
    }
  }

      // Update totals row for Target and Bank Inflow
  try{
    let totTargetEl = dom('totTarget');
    let totInflowEl = dom('totInflow');
    // If totals elements are missing, attempt to build the table (maybe not yet rendered) and re-acquire
    if(!totTargetEl || !totInflowEl){
      console.debug('recompute: totals elements missing, calling buildTable() to (re)create them');
      try{ buildTable(); }catch(be){ console.warn('recompute: buildTable() failed', be); }
      totTargetEl = dom('totTarget');
      totInflowEl = dom('totInflow');
    }
  const totalTargetVal = months.reduce((s,m)=> s + parseNum(m.target||0), 0);
  const totalInflowVal = months.reduce((s,m)=> s + parseNum(m.outflow||0), 0);
  const totalVarianceVal = months.reduce((s,m)=> s + parseNum(m.variance||0), 0);
  const totalBalanceVal = months.length ? parseNum(months[months.length-1].balance||0) : 0;
  console.debug('recompute: totals computed', { totalTargetVal, totalInflowVal, totalVarianceVal, totalBalanceVal, totTargetElExists: !!totTargetEl, totInflowElExists: !!totInflowEl });
  if(totTargetEl) totTargetEl.textContent = fmtAcc(totalTargetVal);
  if(totInflowEl) totInflowEl.textContent = fmtAcc(totalInflowVal);
  const totVarEl = dom('totVariance'); if(totVarEl){ totVarEl.textContent = fmtAcc(totalVarianceVal); totVarEl.style.color = totalVarianceVal>0? '#7bd99f' : totalVarianceVal<0? '#f85149' : '#7bd99f'; }
  const totBalEl = dom('totBalance'); if(totBalEl){ totBalEl.textContent = fmtAcc(totalBalanceVal); totBalEl.style.color = totalBalanceVal>0? '#7bd99f' : totalBalanceVal<0? '#f85149' : '#7bd99f'; }
  // debug banner removed
  }catch(e){ console.error('recompute: error updating totals row', e); }

  // Avg. Mo. Target = total target / 12
  const avgMoTarget = totalTarget / 12;
  setKpi('kpiAvgMoTarget', Math.round(avgMoTarget));
  console.debug('recompute: setKpi kpiAvgMoTarget', Math.round(avgMoTarget));

  // Avg. Mo. Inflow: total bank inflow divided by months that have passed (exclude current month) - ONLY count months with actual inflows
  const monthsPassed = currentMonthIdx; // months before current month
  const inflowBeforeCurrent = values.slice(0, monthsPassed);
  // Filter out zero entries to get accurate average
  const nonZeroInflows = inflowBeforeCurrent.filter(v => v > 0);
  const avgInflow = nonZeroInflows.length > 0 ? nonZeroInflows.reduce((a,b)=>a+b,0) / nonZeroInflows.length : 0;
  setKpi('kpiAvgMonthly', Math.round(avgInflow));
  console.debug('recompute: setKpi kpiAvgMonthly', Math.round(avgInflow), 'from', nonZeroInflows.length, 'non-zero months');

  // Also compute average including the current month (for an alternate projection method)
  const inflowIncludingCurrent = values.slice(0, currentMonthIdx+1).reduce((a,b)=>a+b,0);
  const monthsCountIncludingCurrent = Math.max(1, currentMonthIdx+1);
  const avgInflowIncludingCurrent = Math.round(inflowIncludingCurrent / monthsCountIncludingCurrent);
  console.debug('recompute: avgInflowIncludingCurrent', avgInflowIncludingCurrent, 'inflowIncludingCurrent', inflowIncludingCurrent, 'monthsCount', monthsCountIncludingCurrent);

  // Mo. Variance = average inflow - average monthly target
  const moVariance = Math.round(avgInflow - avgMoTarget);
  setKpi('kpiMoVariance', moVariance);
  console.debug('recompute: setKpi kpiMoVariance', moVariance);

  // Total Deviation: monthly variance multiplied by months passed (exclude current month)
  // Use the Mo. Variance computed above (signed) and multiply by monthsPassed
  const monthsPassedForDeviation = monthsPassed; // already excludes current month
  const totalDeviation = Math.round(moVariance * monthsPassedForDeviation);
  setKpi('kpiTotalDeviation', totalDeviation);
  console.debug('recompute: setKpi kpiTotalDeviation', totalDeviation);
  // If Owner 2 is selected, tint the Total Deviation KPI with a soft violet; otherwise let CSS rules control it.
  try{
    const tdEl = dom('kpiTotalDeviation');
    if(tdEl){
      const ownerName = String(ownerSel.value || '').trim();
      const isTamad = /tamad/i.test(ownerName) || ownerName === 'Owner 2';
      if(isTamad){
        // use ownerColor so TAMADUR_ENBD maps to the project's canonical color
        try{ tdEl.style.color = ownerColor(ownerName) || '#3bbf7d'; }catch(e){ tdEl.style.color = '#3bbf7d'; }
      } else {
        // clear inline color to fall back to stylesheet (.negative => var(--danger) or theme)
        tdEl.style.removeProperty('color');
      }
    }
  }catch(e){ console.debug('recompute: could not apply Owner 2 color override', e); }

  // Forecasted year-end per user: include current month in the projection window.
  // monthsToYearEndIncludingCurrent = total months from current month to Dec inclusive
  // NOTE: we'll compute a day-aware fractional `months_left` below and derive
  // an integer months-to-year-end where needed using `Math.ceil(months_left)`.
  // Day-level time awareness: compute days elapsed/left and fractional months remaining
  const now = new Date();
  const startOfYear = new Date(Number(yearSel.value||now.getFullYear()), 0, 1, 0,0,0);
  const endOfYear = new Date(Number(yearSel.value||now.getFullYear()), 11, 31, 23,59,59);
  const msInDay = 1000*60*60*24;
  const days_elapsed = Math.max(0, Math.floor((now - startOfYear)/msInDay));
  const days_left = Math.max(0, Math.ceil((endOfYear - now)/msInDay));
  
  // Enhanced calculation: accurate month counting with fractional behavior
  const currentMonth = now.getMonth(); // 0-11 (0=Jan, 9=Oct)
  const currentYear = now.getFullYear();
  const selectedYear = Number(yearSel.value || currentYear);
  
  let months_left;
  if (selectedYear === currentYear) {
    // For current year, calculate more precisely
    const dayOfMonth = now.getDate();
    const daysInCurrentMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    const remainingDaysInCurrentMonth = daysInCurrentMonth - dayOfMonth + 1;
    const fractionOfCurrentMonth = remainingDaysInCurrentMonth / daysInCurrentMonth;
    
    // Count remaining full months after current month
    const remainingFullMonths = 11 - currentMonth; // Nov, Dec for October
    
    // Total = fraction of current month + remaining full months
    months_left = Math.max(0.01, fractionOfCurrentMonth + remainingFullMonths);
  } else {
    // For other years, use the original average calculation
    months_left = Math.max(0.01, days_left / 30.44);
  }
  // derive an integer months-to-year-end (inclusive) for places that need whole months
  const monthsToYearEndIncludingCurrent = Math.max(1, Math.ceil(months_left));
  const schedule_index = (days_elapsed + days_left) > 0 ? (days_elapsed / (days_elapsed + days_left)) : 0;
  // Use fractional months_left for forecast; keep an integer label for readability
  const monthsLabelReadable = months_left >= 1 ? `${months_left.toFixed(2)} months` : `${months_left.toFixed(2)} months`;
  
  // Enhanced forecast calculation: account for missing past months
  // Current YTD is missing some months - we need to add projected inflows for those missing months
  const inflowBeforeCurrentForForecast = values.slice(0, currentMonthIdx);
  const nonZeroInflowsForForecast = inflowBeforeCurrentForForecast.filter(v => v > 0);
  const missingPastMonths = currentMonthIdx - nonZeroInflowsForForecast.length; // Missing months before current
  
  // Forecast = YTD + projected missing past months + projected future months
  const projectedMissingInflows = Math.round(avgInflow * missingPastMonths);
  const remainingWholeMonthsAfterCurrent = monthsToYearEndIncludingCurrent;
  const projectedFutureInflows = Math.round(avgInflow * remainingWholeMonthsAfterCurrent);
  
  const forecastYearEnd = inflowYTD + projectedMissingInflows + projectedFutureInflows;
  setKpi('kpiForecastYearEnd', forecastYearEnd);
  console.debug('recompute: Enhanced forecast calculation:', {
    inflowYTD,
    avgInflow,
    missingPastMonths,
    projectedMissingInflows,
    remainingMonths: remainingWholeMonthsAfterCurrent,
    projectedFutureInflows,
    forecastYearEnd
  });

  // Add a small breakdown tooltip element under the Forecast KPI to explain calculation
  try{
    const kpiFyEl = dom('kpiForecastYearEnd');
    if(kpiFyEl){
      let hint = dom('kpiForecastYearEndHint');
      if(!hint){
        hint = document.createElement('div');
        hint.id = 'kpiForecastYearEndHint';
        hint.className = 'small';
        hint.style.fontSize = '8px';
        hint.style.fontWeight = 'lighter';
        hint.style.color = 'var(--muted)';
        hint.style.marginTop = '6px';
        kpiFyEl.appendChild(hint);
      }
  // Removed verbose calculation hint as per user request
  hint.textContent = '';
    }
  }catch(e){ console.debug('recompute: could not set forecast hint', e); }

  // Predictive Modeling: Confidence Intervals using Monte Carlo
  const historicalVariances = months.slice(0, currentMonthIdx).map(m => parseNum(m.variance || 0)).filter(v => !isNaN(v));
  // Monte Carlo expects an integer remaining-months; use a rounded-up value but keep months_left for rate math
  const mcRemainingMonths = Math.max(1, Math.ceil(months_left));
  const predictive = monteCarloSimulation(historicalVariances, mcRemainingMonths, inflowYTD);
  const forecastRangeEl = dom('forecastRange');
  if(forecastRangeEl){
    // Show only the 80% confidence interval as a simple range
    const low80 = Math.round(predictive.ci80[0]);
    const high80 = Math.round(predictive.ci80[1]);
    forecastRangeEl.textContent = `Range: ${fmtAcc(low80)} - ${fmtAcc(high80)} (80% CI)`;
  }

  // Mo. Needed Inflow to End of Year: evenly distribute remaining target across remaining months (including current)
  const monthsLabelEl = dom('kpiMonthsLabel');
  if(monthsLabelEl) monthsLabelEl.textContent = monthsLabelReadable;
  const titleMonthsEl = dom('kpiTitleMonths');
  if(titleMonthsEl) titleMonthsEl.textContent = monthsLabelReadable;
  // Guardrail: if no total target set, avoid misleading forecasts and risk numbers
  const remainingToTarget = totalTarget > 0 ? Math.max(0, totalTarget - inflowYTD) : 0;
  // Calculate Mo. Needed as Remaining to Active Target divided by remaining whole months
  // (include the current month). Use the integer monthsToYearEndIncludingCurrent computed above.
  const moNeededGross = totalTarget > 0 ? Math.ceil(remainingToTarget / Math.max(1, monthsToYearEndIncludingCurrent)) : 0;
  // expected natural inflow for remaining months (based on avgInflow and whole months remaining)
  const expectedRemaining = Math.round(avgInflow * monthsToYearEndIncludingCurrent);
  // remaining after accounting for expected remaining inflows (net requirement)
  const remainingAfterExpected = totalTarget > 0 ? Math.max(0, totalTarget - (inflowYTD + expectedRemaining)) : 0;
  const moNeededNet = totalTarget > 0 ? Math.ceil(remainingAfterExpected / Math.max(1, monthsToYearEndIncludingCurrent)) : 0;
  const moNeededEl = dom('kpiMoNeeded');
  if(moNeededEl){
    // display gross value in KPI (Mo. Needed gross, since anticipated current month inflow is 0)
    if(totalTarget > 0){
      const v = parseNum(moNeededGross);
      const absText = fmtAcc(Math.abs(v));
      const currencyLabel = `<span style="font-size:10px; opacity:0.85; vertical-align:baseline; font-weight:600">AED</span>&nbsp;`;
      if(v < 0){
        moNeededEl.innerHTML = `<span class="kpi-neg-wrap">( ${currencyLabel}<span style="margin-right:4px">-</span><span class="kpi-amount">${absText}</span> )</span>`;
      } else {
        moNeededEl.innerHTML = `${currencyLabel}<span class="kpi-amount">${absText}</span>`;
      }
      moNeededEl.setAttribute('title', `Gross: AED ${fmtAcc(moNeededGross)} (before expected inflows). Net/mo: AED ${fmtAcc(moNeededNet)}. Avg. Mo. Inflow: AED ${fmtAcc(Math.round(avgInflow))}`);
    } else {
      moNeededEl.textContent = '—';
    }
    moNeededEl.dataset.gross = String(moNeededGross);
    moNeededEl.dataset.net = String(moNeededNet);
    moNeededEl.dataset.avg = String(Math.round(avgInflow));
    moNeededEl.classList.remove('positive','negative');
    if(totalTarget > 0) moNeededEl.classList.add('attention'); else moNeededEl.classList.remove('attention');
  }
  // Insert or update KPI icon next to the months title to visualise risk band
  try{
    // small helper: compute composite and band
    const cmp = getCompositeScore();
    const titleMonths = dom('kpiTitleMonths');
    if(titleMonths){
      let icon = dom('kpiTitleMonthsIcon');
      if(!icon){
        icon = document.createElement('span');
        icon.id = 'kpiTitleMonthsIcon';
        icon.className = 'kpi-icon hidden';
        // use an inline SVG <use> to reference symbols defined in the header
        icon.innerHTML = `<svg aria-hidden="true"><use xlink:href="#icon-check"></use></svg>`;
        titleMonths.parentNode.insertBefore(icon, titleMonths.nextSibling);
      }
      if(!cmp || cmp.score === null || cmp.score === undefined || cmp.score === 0 && parseNum(load('yearTarget',0))===0){
        icon.classList.add('hidden');
        icon.setAttribute('title','No target set');
      } else {
        icon.classList.remove('hidden');
        // set appropriate band class and tooltip
        icon.classList.remove('comfort','warning','high','extreme');
        icon.classList.add(cmp.className || 'comfort');
        icon.setAttribute('title', `Risk: ${cmp.score}/100 — ${cmp.label}`);
        // change the glyph for more severe states
        const use = icon.querySelector('use');
        if(use){
          if(cmp.label === 'Comfort') use.setAttribute('xlink:href','#icon-check');
          else if(cmp.label === 'Warning') use.setAttribute('xlink:href','#icon-clock');
          else use.setAttribute('xlink:href','#icon-alert');
        }
      }
    }
  }catch(e){ console.debug('recompute: KPI icon wiring failed', e); }
  // Expose gross vs net details in a small helper element under the Mo. Needed card
  try{
    let meta = dom('kpiMoNeededMeta');
    if(!meta){
      meta = document.createElement('div');
      meta.id = 'kpiMoNeededMeta';
      meta.className = 'small';
      const card = dom('moNeededCard');
      if(card) card.appendChild(meta);
    }
    if(meta){
      meta.textContent = `Gross/mo: AED ${fmtAcc(moNeededGross)} · Expected remaining inflow: AED ${fmtAcc(expectedRemaining)}`;
      meta.style.marginTop = '52px';
      // Match the color used by the Total Deviation KPI for visual consistency.
      try{
        const totalDevEl = dom('kpiTotalDeviation');
        let col = null;
        if(totalDevEl){
          const cs = window.getComputedStyle(totalDevEl);
          col = cs && cs.color ? cs.color : null;
        }
        if(!col){
          // fallback to CSS variable --danger
          col = getComputedStyle(document.documentElement).getPropertyValue('--danger') || '#f85149';
          col = col.trim() || '#f85149';
        }
        meta.style.color = col;
      }catch(e){ meta.style.color = 'var(--danger)'; }
      meta.style.fontSize = '12px';
      meta.style.textAlign = 'center';
    }
  }catch(e){ console.debug('recompute: could not set MoNeeded meta', e); }
  console.debug('recompute: moNeededGross', moNeededGross, 'moNeededNet', moNeededNet, 'expectedRemaining', expectedRemaining);

  // Surplus (positive means we've met/exceeded the target)
  const surplus = inflowYTD - totalTarget;
  const kBalEl = dom('kpiBalance');
  setKpi('kpiBalance', surplus);
  console.debug('recompute: setKpi kpiBalance', surplus);

      // Update variance & balance cells in-place to preserve input focus while typing
      const rows = tbody && tbody.rows ? Array.from(tbody.rows) : [];
      for(let i=0; i<rows.length && i<12; i++){
        const r = rows[i];
        // cells: 0=Day,1=Month,2=Target,3=Note,4=Outflow,5=Variance,6=Balance
        if(r.cells[5]){
          const vVal = Number(months[i].variance || 0);
          r.cells[5].textContent = fmtAcc(vVal);
          r.cells[5].classList.remove('positive','negative');
          if(vVal > 0) r.cells[5].classList.add('positive');
          else if(vVal < 0) r.cells[5].classList.add('negative');
        }
        if(r.cells[6]){
          const bal = Number(months[i].balance||0);
          r.cells[6].textContent = fmtAcc(bal);
          r.cells[6].classList.remove('positive','negative');
          if(bal>0) r.cells[6].classList.add('positive');
          else if(bal<0) r.cells[6].classList.add('negative');
        }
      }

      // Color totals balance if present
      try{
        const totBalEl = dom('totBalance');
        if(totBalEl){
          // months[11].balance already includes opening balance as we accumulated from openingBal
          const tb = parseNum(months.length ? months[months.length-1].balance || 0 : 0);
          totBalEl.textContent = fmtAcc(tb);
          totBalEl.style.color = tb > 0 ? '#7bd99f' : tb < 0 ? '#f85149' : '#7bd99f';
        }
      }catch(e){}

      // Update totals variance color/text
      try{
        const totVarEl = dom('totVariance');
        if(totVarEl){
          const totalVariance = months.reduce((s,m)=> s + parseNum(m.variance||0), 0);
          totVarEl.textContent = fmtAcc(totalVariance);
          totVarEl.style.color = totalVariance > 0 ? '#7bd99f' : totalVariance < 0 ? '#f85149' : '#7bd99f';
        }
      }catch(e){}

    }

  // Ensure any dock copies pull data from the main KPIs
      function updateUI(){
            try{
              console.debug('updateUI: entered');
              const s = computeScenarios();
              console.debug('updateUI: scenarios', s);
          // guardrail: if no Total Target set (0), show a gentle message but still show numbers
          const hasTarget = (s.totalTarget && Number(s.totalTarget) > 0);

          // Update cards (projected numbers)
          const setCardNum = (id, val) => { const el = document.getElementById(id); if(el) el.textContent = format(val); };
          const setCardNote = (id, txt) => { const el = document.getElementById(id); if(el) el.textContent = txt; };

          setCardNum('scBaseProjected', s.baseYE);
          setCardNum('scConservativeProjected', s.conservativeYE);
          setCardNum('scOptimisticProjected', s.optimisticYE);
          setCardNum('scPessimisticProjected', s.pessimisticYE);
          console.debug('updateUI: updated card DOM for expanded scenario cards');

          const tiltLabel = (mult) => {
            const pct = Math.round((mult - 1) * 100);
            if(pct === 0) return '↔ 0%';
            const arrow = pct > 0 ? '↑' : '↓';
            return `${arrow} ${Math.abs(pct)}%`;
          };

          const gapBase = s.totalTarget - s.baseYE;
          const gapConservative = s.totalTarget - s.conservativeYE;
          const gapOptimistic = s.totalTarget - s.optimisticYE;
          const gapPessimistic = s.totalTarget - s.pessimisticYE;

          const baseNote = !hasTarget ? 'Set a Total Target to enable comparisons' : (gapBase<=0 ? `Meets/Exceeds target by AED ${format(Math.abs(gapBase))}` : `Short by AED ${format(gapBase)} • Mo. Needed ≈ AED ${format(s.moNeeded)}`);
          const conservativeNote = !hasTarget ? 'Set a Total Target to enable comparisons' : (gapConservative<=0 ? `Meets by AED ${format(Math.abs(gapConservative))}` : `Short by AED ${format(gapConservative)}`);
          const optimisticNote = !hasTarget ? 'Set a Total Target to enable comparisons' : (gapOptimistic<=0 ? `Exceeds by AED ${format(Math.abs(gapOptimistic))}` : `Short by AED ${format(gapOptimistic)}`);
          const pessimisticNote = !hasTarget ? 'Set a Total Target to enable comparisons' : (gapPessimistic<=0 ? `Exceeds by AED ${format(Math.abs(gapPessimistic))}` : `Short by AED ${format(gapPessimistic)}`);

          const muls = getScenarioMultipliers();
          setCardNote('scBaseNote', baseNote);
          setCardNote('scConservativeNote', `Avg inflow ${tiltLabel(muls.mulC)} — ${conservativeNote}`);
          setCardNote('scOptimisticNote', `Avg inflow ${tiltLabel(muls.mulO)} — ${optimisticNote}`);
          setCardNote('scPessimisticNote', `Avg inflow ${tiltLabel(muls.mulP)} — ${pessimisticNote}`);

          // update textual summary
          if(outputEl){ outputEl.textContent = buildOutputText(s); }

          // populate simple actions (used by Populate schedule select)
          const actions = [
            { label: `Deposit AED ${format(Math.max(0, s.moNeeded))} per month`, value: Math.max(0, s.moNeeded) },
            { label: `One-off deposit: AED ${format(Math.max(0, s.totalTarget - (s.YTD + s.OB)))}`, value: Math.max(0, s.totalTarget - (s.YTD + s.OB)) }
          ];
          try{ populateActionSelect(actions); }catch(e){}
        }catch(e){ console.debug('updateUI failed', e); }
      }

  // ensure dock mirrors the fresh KPI values
  try{ if(typeof updateDock === 'function') updateDock(); }catch(e){}
  try{ updateDock(); }catch(e){}

  // Observe KPI container for any DOM changes to immediately update dock copies
  try{
    const kpisContainer = document.querySelector('.kpis');
    if(kpisContainer && typeof MutationObserver !== 'undefined'){
      const mo = new MutationObserver(() => { try{ updateDock(); }catch(e){} });
      mo.observe(kpisContainer, { childList:true, subtree:true, characterData:true, attributes:true });
    }
  }catch(e){}

  // Mini chart using Chart.js: reads balances from #monthTable and draws a sparkline-like line
  let __miniChartInstance = null;

  // === Predictive Modeling ===
  // Monte Carlo simulation for year-end balance confidence intervals
  function monteCarloSimulation(historicalVariances, remainingMonths, currentBalance, simulations = 1000) {
    if (!historicalVariances || historicalVariances.length === 0) return { mean: currentBalance, ci80: [currentBalance, currentBalance], ci95: [currentBalance, currentBalance] };

    // Calculate mean and std dev from historical variances
    const mean = historicalVariances.reduce((a, b) => a + b, 0) / historicalVariances.length;
    const variance = historicalVariances.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / historicalVariances.length;
    const stdDev = Math.sqrt(variance);

    const outcomes = [];
    for (let sim = 0; sim < simulations; sim++) {
      let balance = currentBalance;
      for (let month = 0; month < remainingMonths; month++) {
        // Random variance from normal distribution
        const randomVariance = mean + stdDev * (Math.sqrt(-2 * Math.log(Math.random())) * Math.cos(2 * Math.PI * Math.random()));
        balance += randomVariance;
      }
      outcomes.push(balance);
    }

    outcomes.sort((a, b) => a - b);
    const meanOutcome = outcomes.reduce((a, b) => a + b, 0) / outcomes.length;
    const ci80Low = outcomes[Math.floor(outcomes.length * 0.1)];
    const ci80High = outcomes[Math.floor(outcomes.length * 0.9)];
    const ci95Low = outcomes[Math.floor(outcomes.length * 0.025)];
    const ci95High = outcomes[Math.floor(outcomes.length * 0.975)];

    return {
      mean: meanOutcome,
      ci80: [ci80Low, ci80High],
      ci95: [ci95Low, ci95High]
    };
  }

  async function drawChart(){
    try{
      // Chart.js should already be loaded directly
      if (typeof Chart === 'undefined') {
        console.error('Chart.js library not loaded');
        throw new Error('Chart.js not available. Please check your internet connection and reload the page.');
      }
      const canvas = dom('miniChart');
      if(!canvas) return;
      // extract balances from table rows (assumes balance is in last cell)
      const tbody = document.querySelector('#monthTable tbody');
      const labels = [];
      const balanceData = [];
      const targetData = [];
      const inflowData = [];
      if(tbody){
        const rows = Array.from(tbody.querySelectorAll('tr'));
        rows.forEach((r, idx)=>{
          const monthName = (r.cells && r.cells[1]) ? r.cells[1].textContent.trim() : ('M'+(idx+1));
          labels.push(monthName);
          // Balance (last cell)
          const balCell = r.cells && r.cells[r.cells.length-1];
          let balVal = 0;
          if(balCell) {
            balVal = parseNum(balCell.textContent || '');
          }
          balanceData.push(balVal);
          // Target (assume 3rd column index 2)
          const targetCell = r.cells && r.cells[2];
          let tVal = 0;
          if(targetCell){ const inp = targetCell.querySelector('input'); tVal = parseNum(inp ? inp.value : targetCell.textContent || ''); }
          targetData.push(tVal);
          // Bank Inflow (assume 5th column index 4)
          const inflowCell = r.cells && r.cells[4];
          let iVal = 0;
          if(inflowCell){ const inp = inflowCell.querySelector('input'); iVal = parseNum(inp ? inp.value : inflowCell.textContent || ''); }
          inflowData.push(iVal);
        });
      }

      // if chart exists, update data
      if(__miniChartInstance){
        __miniChartInstance.data.labels = labels;
        __miniChartInstance.data.datasets[0].data = balanceData;
        __miniChartInstance.data.datasets[1].data = targetData;
        __miniChartInstance.data.datasets[2].data = inflowData;
        __miniChartInstance.update();
        return;
      }

      // create chart
      const ctx = canvas.getContext('2d');
      __miniChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Balance',
              data: balanceData,
              borderColor: '#7bd99f',
              backgroundColor: 'rgba(123,217,159,0.12)',
              fill: true,
              tension: 0.3,
              pointRadius: 3,
              borderWidth: 3,
            },
            {
              label: 'Target',
              data: targetData,
              borderColor: '#ff0000',
              borderDash: [6,4],
              backgroundColor: 'transparent',
              tension: 0.2,
              pointRadius: 2,
              borderWidth: 2,
            },
            {
              label: 'Bank Inflow',
              data: inflowData,
              borderColor: '#66a6ff',
              backgroundColor: 'transparent',
              tension: 0.25,
              pointRadius: 2,
              borderWidth: 2,
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { 
              display: true,
              title: { display: true, text: 'Month', color: 'green', align: 'end' },
              ticks: { color: 'red' }
            },
            y: { 
              display: true,
              title: { display: true, text: 'Amount (AED)' },
              ticks: { color: 'green', callback: function(value) { return 'AED ' + fmt(value); } }
            }
          },
          plugins: {
            legend: { display: true, position: 'bottom' },
            tooltip: { 
              enabled: true,
              callbacks: {
                label: function(context) {
                  return context.dataset.label + ': AED ' + fmt(context.parsed.y);
                }
              }
            }
          },
          elements: { line: { capBezierPoints: true } },
        }
      });
      // give canvas a fixed height for layout
      canvas.style.height = '160px';
    }catch(e){ console.error('drawChart error', e); }
  }

  // === Event Handlers and Features ===
  // Reminders
  let remCollapsed = false; // collapse state for reminders list
  // small UI debug helper to show which storage key produced reminders (visible on page)
  function setRemDebug(src, count){ try{ const dbg = dom('remDebug'); if(!dbg) return; dbg.textContent = src + (count!==undefined?(' ('+String(count)+')'):''); }catch(e){} }
  const remDrawer = dom('reminderDrawer');
  const btnOpenRem = dom('btnOpenRem');
  const btnCloseRemDrawer = dom('btnCloseRemDrawer');
  if(btnOpenRem) btnOpenRem.onclick = ()=>{ console.log('btnOpenRem clicked, opening drawer'); if(remDrawer) { remDrawer.classList.add('open'); console.log('remDrawer.classList.add(open)'); } renderRems(); };
  // Defensive delegated handler: also open drawer if any descendant of #btnOpenRem is clicked
  document.addEventListener('click', (e)=>{
    try{
      if(!e.target) return;
      const hit = e.target.closest ? e.target.closest('#btnOpenRem') : null;
      if(hit){ console.log('delegated click on btnOpenRem descendant'); if(remDrawer) remDrawer.classList.add('open'); renderRems(); }
    }catch(err){}
  });
  if(btnCloseRemDrawer) btnCloseRemDrawer.onclick = ()=>{ if(remDrawer) remDrawer.classList.remove('open'); };
  // Close drawer on outside click
  // Temporarily disabled to prevent closing on button clicks
  // Close drawer on outside click — re-enabled with robust checks.
  // If the reminders drawer is open and the user clicks anywhere outside the drawer
  // and outside the reminders open button, close the drawer. We use a capturing
  // listener and guard against clicks originating from within the drawer or the
  // open button (including descendants) to avoid interfering with internal controls.
  document.addEventListener('click', (e) => {
    try{
      if(!remDrawer) return;
      // only act when drawer is open
      if(!remDrawer.classList.contains('open')) return;
      const clickTarget = e.target;
      // if click is inside the drawer, do nothing
      if(remDrawer.contains(clickTarget)) return;
      // if click is the open button or inside it, do nothing
      if(btnOpenRem && (btnOpenRem === clickTarget || btnOpenRem.contains(clickTarget))) return;
      // otherwise close the drawer
      remDrawer.classList.remove('open');
    }catch(err){ console.debug('outside-click handler error', err); }
  });
  // Close notes drawer on outside click
  document.addEventListener('click', (e) => {
    try{
      const notesDrawer = dom('notesDrawer');
      const btnToggleNotes = dom('btnToggleNotes');
      if(!notesDrawer) return;
      // only act when drawer is open
      if(!notesDrawer.classList.contains('open')) return;
      const clickTarget = e.target;
      // if click is inside the drawer, do nothing
      if(notesDrawer.contains(clickTarget)) return;
      // if click is the open button or inside it, do nothing
      if(btnToggleNotes && (btnToggleNotes === clickTarget || btnToggleNotes.contains(clickTarget))) return;
      // otherwise close the drawer
      notesDrawer.classList.remove('open');
      notesDrawer.setAttribute('aria-hidden','true');
    }catch(err){ console.debug('notes outside-click handler error', err); }
  });
    const remBadge = dom('remBadge');
    const btnToggleRem = dom('btnToggleRem');
    if(btnToggleRem){
      btnToggleRem.addEventListener('click', ()=>{
        remCollapsed = !remCollapsed;
        btnToggleRem.textContent = remCollapsed ? 'Expand' : 'Collapse';
        btnToggleRem.setAttribute('aria-pressed', String(remCollapsed));
        renderRems();
      });
    }
    function remKey(){ return 'reminders'; }
    function getRems(){
      const key = `enbd:${dom('owner').value}:reminders`;
      try{
        const raw = localStorage.getItem(key);
        if(raw){
          const p = JSON.parse(raw);
          if(Array.isArray(p)){
            console.debug('getRems: loaded via per-owner key', key);
            try{ setRemDebug(`load:${key}`, p.length); }catch(e){}
            return p;
          }
        }
      }catch(e){}

      // Legacy migration
      const legacy = ['reminders', 'enbd:reminders'];
      for(const k of legacy){
        try{
          const raw = localStorage.getItem(k);
          if(raw){
            const p = JSON.parse(raw);
            if(Array.isArray(p) && p.length){
              localStorage.setItem(key, raw);
              localStorage.removeItem(k);
              console.debug('getRems: migrated from legacy', k, 'to', key);
              try{ setRemDebug(`migrated:${k}`, p.length); }catch(e){}
              return p;
            }
          }
        }catch(e){}
      }

      return [];
    }
    function setRems(arr){
      const key = `enbd:${dom('owner').value}:reminders`;
      localStorage.setItem(key, JSON.stringify(arr));
    }
    function addReminder(obj){
  const arr = getRems();
      arr.push(obj);
      setRems(arr);
      renderRems();
    }
    function appendRemDebug(msg){ try{ const dbg = dom('remDebug'); if(!dbg) return; const t = new Date().toLocaleTimeString(); dbg.textContent = `[${t}] ${msg}\n` + dbg.textContent; }catch(e){} }
    function defaultRemLabel(r){
      try{
        const ownerEl = dom('owner');
        const owner = ownerEl ? ownerEl.value : 'Owner';
        // use displayed moNeeded and months if available
        const moNeeded = (dom('kpiMoNeeded') && dom('kpiMoNeeded').textContent) ? dom('kpiMoNeeded').textContent : null;
        const months = (dom('kpiTitleMonths') && dom('kpiTitleMonths').textContent) ? dom('kpiTitleMonths').textContent : '';
        if(moNeeded) return `Deposit needed for ${owner} to meet target (${moNeeded}${months? ' • '+months : ''})`;
        return `Deposit needed for ${owner} to meet target`;
      }catch(e){ return 'Deposit needed'; }
    }
    function displayedLabel(r){
      try{
        const raw = r && r.label ? String(r.label).trim() : '';
        if(!raw) return defaultRemLabel(r);
        // treat legacy placeholder 'Owner Deposit' as empty
        if(raw === 'Owner Deposit') return defaultRemLabel(r);
        return raw;
      }catch(e){ return defaultRemLabel(r); }
    }
    function deleteReminder(id){
      appendRemDebug('click: delete ' + id);
      try{
        // keep UI visible while we delete
        if(remDrawer) remDrawer.classList.add('open');
        const original = getRems();
        const arr = original.filter(r=>r.id!==id);
        setRems(arr);
        renderRems();
        appendRemDebug('handler: delete completed ' + id);
      }catch(e){ appendRemDebug('error: deleteReminder ' + String(e)); console.debug(e); }
    }
    function toggleDone(id, done){
      appendRemDebug('click: toggleDone ' + id + ' -> ' + done);
      try{
        if(remDrawer) remDrawer.classList.add('open');
        const arr = getRems().map(r=> r.id===id ? {...r, done} : r);
        setRems(arr);
        renderRems();
        appendRemDebug('handler: toggleDone completed ' + id + ' -> ' + done);
      }catch(e){ appendRemDebug('error: toggleDone ' + String(e)); console.debug(e); }
    }
    function editReminder(id){
      appendRemDebug('click: edit ' + id);
      try{
        if(remDrawer) remDrawer.classList.add('open');
        const arr = getRems();
        const r = arr.find(x=>x.id===id);
        if(!r){ appendRemDebug('handler: edit not found ' + id); return; }
        // Replace prompt flow with inline modal form to avoid browser blocking
        let modal = dom('editReminderModal');
        if(!modal){
          modal = document.createElement('div');
          modal.id = 'editReminderModal';
          modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; display:flex; align-items:center; justify-content:center;';
          modal.innerHTML = `
            <div style="background:var(--card); padding:30px; border-radius:8px; border:1px solid var(--line); max-width:800px; width:90%;">
              <h3 style="margin:0 0 20px 0;">Edit Reminder</h3>
              <label>Date (YYYY-MM-DD): <input type="date" id="editDate" style="width:100%; margin-bottom:10px;"></label><br>
              <label>Time (HH:MM): <input type="time" id="editTime" style="width:100%; margin-bottom:10px;"></label><br>
              <label>Amount: <input type="number" id="editAmount" step="0.01" style="width:100%; margin-bottom:10px;"></label><br>
              <label>Label: <input type="text" id="editLabel" style="width:100%; margin-bottom:20px;"></label><br>
              <button id="editSave" class="btn" style="margin-right:10px;">Save</button>
              <button id="editCancel" class="btn">Cancel</button>
            </div>
          `;
          document.body.appendChild(modal);
        }
        // Pre-fill values
        const dt = new Date(r.when);
        dom('editDate').value = dt.toISOString().split('T')[0];
        dom('editTime').value = dt.toTimeString().slice(0,5);
        dom('editAmount').value = r.amount;
        dom('editLabel').value = r.label;
        modal.style.display = 'flex';
        // Focus first input
        setTimeout(() => dom('editDate').focus(), 100);
        // Event listeners
        const saveBtn = dom('editSave');
        const cancelBtn = dom('editCancel');
        const saveHandler = () => {
          const newDate = dom('editDate').value;
          const newTime = dom('editTime').value;
          const newAmount = Number(dom('editAmount').value) || 0;
          const newLabel = dom('editLabel').value || r.label;
          const newWhen = new Date(`${newDate}T${newTime}:00`);
          if(isNaN(newWhen)) { alert('Invalid date/time'); appendRemDebug('handler: edit invalid date ' + id); return; }
          r.when = newWhen.toISOString(); r.amount = newAmount; r.label = newLabel;
          setRems(arr); renderRems(); appendRemDebug('handler: edit completed ' + id);
          modal.style.display = 'none';
        };
        const cancelHandler = () => {
          appendRemDebug('handler: edit cancelled by user ' + id);
          modal.style.display = 'none';
        };
        saveBtn.onclick = saveHandler;
        cancelBtn.onclick = cancelHandler;
        // Allow Enter to save
        modal.addEventListener('keydown', (e) => { if(e.key === 'Enter') saveHandler(); if(e.key === 'Escape') cancelHandler(); });
      }catch(e){ appendRemDebug('error: editReminder outer ' + String(e)); console.debug(e); }
    }
    function renderRems(){
      console.log('renderRems: starting');
      appendRemDebug('renderRems starting');
      const remList = dom('remList');
      // debug: ensure remList exists and we can render into it
      if(!remList){ console.log('renderRems: remList element not found'); return; }
      remList.innerHTML = '';
    const arr = getRems();
    console.log('renderRems: loaded', arr.length, 'reminders');
    // update badge (inside drawer/pill)
    const remBadge = dom('remBadge');
  if(remBadge) remBadge.textContent = String(arr.length);
  const key = `enbd:${dom('owner').value}:reminders`;
  // compute if any reminder is done and get icon span
  const anyDone = Array.isArray(arr) && arr.some(x => x && x.done);
  const pillGlobal = dom('btnOpenRem');
  const iconSpanGlobal = pillGlobal ? pillGlobal.querySelector('.rem-icon') : null;
  console.log('renderRems: key', key);
      // respect collapse state
  if(remCollapsed){ remList.style.display = 'none'; return; }
  remList.style.display = 'block';
      if(!arr.length){
        // No reminders: ensure the floating pill shows the Mo. Needed KPI (or 0) instead of any static sample text.
        try{
          const pill = dom('btnOpenRem'); const badge = dom('remBadge');
          if(pill){
            pill.setAttribute('title','No upcoming reminders');
            const labelSpan = pill.querySelector('.rem-label');
              if(labelSpan){
                  const moNeededEl = dom('kpiMoNeeded');
                  const moNeededVal = moNeededEl ? parseNum(moNeededEl.textContent) : 0;
                  const avgVal = moNeededEl ? parseNum(moNeededEl.dataset.avg || 0) : 0;
                  
                  // Calculate total natural deduction (same logic as buildShareText)
                  const months = getMonthData();
                  const vals = months.map(m=> Number(m.outflow||0));
                  const monthsPassed = currentMonthIdx;
                  const inflowBeforeCurrent = vals.slice(0, monthsPassed);
                  const nonZeroInflows = inflowBeforeCurrent.filter(v => v > 0);
                  const avgInflow = nonZeroInflows.length > 0 ? Math.round(nonZeroInflows.reduce((a,b)=>a+b,0) / nonZeroInflows.length) : 0;
                  
                  // Count missing months and add current month
                  const monthsWithMissingRecords = monthsPassed - nonZeroInflows.length;
                  const totalMonthsToDeduct = monthsWithMissingRecords + 1; // missing months + current month
                  const totalNaturalDeduction = avgInflow * totalMonthsToDeduct;
                  
                  // Updated calculation: moNeeded - totalNaturalDeduction (not just avgInflow)
                  const rawGap = Math.round((moNeededVal || 0) - totalNaturalDeduction);
                  
                  if(rawGap < 0){
                    labelSpan.textContent = `Dep. Reminder • Expected surplus: ${fmtAcc(Math.abs(rawGap))}`;
                    if(iconSpanGlobal) iconSpanGlobal.textContent = '🎉';
                  } else if(rawGap === 0 || Number(moNeededVal) <= 0){
                    labelSpan.textContent = 'Target achieved 🎉';
                    if(iconSpanGlobal) iconSpanGlobal.textContent = '🎉';
                  } else {
                    labelSpan.textContent = `Dep. Reminder • AED ${fmtAcc(rawGap)}`;
                    if(iconSpanGlobal) iconSpanGlobal.textContent = '🔔';
                  }
                }
          }
          if(badge) badge.textContent = String(arr.length);
          // ensure normal state
          if(pill) { pill.classList.remove('state-soon','state-urgent','pulse'); pill.classList.add('state-normal'); }
          if(badge) { badge.classList.remove('state-soon','state-urgent'); badge.classList.add('state-normal'); }
        }catch(e){ console.debug('renderRems: empty-reminder pill update failed', e); }
        // nothing to render inside the drawer
        return;
      }
      arr.sort((a,b)=> new Date(a.when) - new Date(b.when));
      console.log('renderRems: sorted reminders, rendering', arr.length);
      for(const r of arr){
        console.log('rendering reminder', r.id);
        const row = document.createElement('div');
        row.className = 'rem-row';
        // checkbox
        const cb = document.createElement('input');
        cb.type='checkbox'; cb.className='tiny'; cb.checked = !!r.done;
        cb.addEventListener('change', (e) => { e.stopPropagation(); toggleDone(r.id, cb.checked); });
        // date
  let dateStr = '(No date)';
  try{ const dt = new Date(r.when); if(!isNaN(dt)) dateStr = dt.toLocaleDateString('en-GB'); }catch(e){}
  const dateAmount = document.createElement('div'); dateAmount.className='date-amount' + (r.done?' strike':'');
  dateAmount.textContent = `🔔 ${dateStr}`;
        // label + amount
  const label = document.createElement('div'); label.className = 'rem-label' + (r.done?' faded':'');
  const safeLabel = String(displayedLabel(r));
  const rawAmt = Number(r.amount || 0);
  let friendlyAmountHtml;
  if(rawAmt > 0){
    friendlyAmountHtml = `AED ${fmtAcc(rawAmt)}`;
  } else if(rawAmt < 0){
    friendlyAmountHtml = `<span class="surplus-text">Expected surplus: AED ${fmtAcc(Math.abs(rawAmt))}</span>`;
  } else {
    friendlyAmountHtml = 'AED 0';
  }
  label.innerHTML = `${safeLabel}<div style="font-weight:700; margin-top:2px">${friendlyAmountHtml}</div>`;
        // actions
        const actions = document.createElement('div'); actions.className='rem-actions';
  const btnCal = document.createElement('button'); btnCal.type='button'; btnCal.className='iconbtn'; btnCal.textContent='📅';
  btnCal.title='Add to calendar'; btnCal.onclick = () => { appendRemDebug('click: calendar ' + r.id); downloadICS(r); if(remDrawer) remDrawer.classList.add('open'); };
  const btnEdit = document.createElement('button'); btnEdit.type='button'; btnEdit.className='iconbtn'; btnEdit.textContent='✏️';
  btnEdit.title='Edit'; btnEdit.onclick = () => { appendRemDebug('click: edit ' + r.id); editReminder(r.id); if(remDrawer) remDrawer.classList.add('open'); };
  const btnShare = document.createElement('button'); btnShare.type='button'; btnShare.className='iconbtn'; btnShare.textContent='🔗';
  btnShare.title='Share'; btnShare.onclick = () => { appendRemDebug('click: share ' + r.id); shareReminder(r); if(remDrawer) remDrawer.classList.add('open'); };
  const btnDel = document.createElement('button'); btnDel.type='button'; btnDel.className='iconbtn danger'; btnDel.textContent='✖';
  btnDel.title='Delete'; btnDel.onclick = () => { appendRemDebug('click: delete ' + r.id); deleteReminder(r.id); if(remDrawer) remDrawer.classList.add('open'); };
  const btnEmail = document.createElement('button'); btnEmail.type='button'; btnEmail.className='iconbtn'; btnEmail.textContent='📧';
  btnEmail.title='Send Email'; btnEmail.onclick = () => { appendRemDebug('click: email ' + r.id); sendReminderEmail(r); if(remDrawer) remDrawer.classList.add('open'); };
        actions.append(btnCal, btnEdit, btnShare, btnEmail, btnDel);
        row.append(cb, dateAmount, label, actions);
        remList.appendChild(row);
        console.log('appended row for reminder', r.id);
      }
      // Scroll to top to show buttons
      if(remDrawer) remDrawer.scrollTop = 0;
      // compute and surface next upcoming reminder (soonest date >= now and not done)
      try{
        const now = new Date();
        const upcomingList = arr.filter(x=>!x.done).map(x=> ({...x, dt: new Date(x.when)})).filter(x=>!isNaN(x.dt)).sort((a,b)=>a.dt - b.dt).slice(0,3);
        const pill = dom('btnOpenRem'); const badge = dom('remBadge');
        if(pill && badge){
          if(upcomingList && upcomingList.length){
            // aggregate amount of next up to 3 reminders
            const totalAmt = upcomingList.reduce((s,it)=> s + Number(it.amount||0), 0);
            const friendlyTotal = totalAmt > 0 ? `AED ${fmtAcc(totalAmt)}` : (totalAmt < 0 ? `Expected surplus: AED ${fmtAcc(Math.abs(totalAmt))}` : 'AED 0');
            // tooltip: list each upcoming item with friendly amount wording
            const lines = upcomingList.map(it => {
              const a = Number(it.amount || 0);
              const amtTextItem = a > 0 ? `AED ${fmtAcc(a)}` : (a < 0 ? `Expected surplus: AED ${fmtAcc(Math.abs(a))}` : 'AED 0');
              return `${it.dt.toLocaleDateString('en-GB')}: ${amtTextItem} — ${displayedLabel(it)}`;
            });
            pill.setAttribute('title', `Upcoming (${upcomingList.length}):\n` + lines.join('\n'));
            // show aggregated amount inline on pill when space allows
            const labelSpan = pill.querySelector('.rem-label');
            if(labelSpan){
              // use numeric totalAmt to decide display (avoid negative/zero showing)
              if(Number(totalAmt) < 0){
                labelSpan.innerHTML = `Dep. Reminder • <span class="surplus-text">Expected surplus: AED ${fmtAcc(Math.abs(totalAmt))}</span>`;
                if(iconSpanGlobal) iconSpanGlobal.textContent = '🎉';
              } else if(Number(totalAmt) === 0){
                labelSpan.textContent = 'Target achieved 🎉';
                if(iconSpanGlobal) iconSpanGlobal.textContent = '🎉';
              } else {
                labelSpan.textContent = `Dep. Reminder • ${friendlyTotal}`;
                // if any reminder is already done, prefer the check icon
                if(anyDone && iconSpanGlobal) iconSpanGlobal.textContent = '✅';
                else if(iconSpanGlobal) iconSpanGlobal.textContent = '🔔';
              }
            }
            badge.textContent = anyDone ? '✅' : String(arr.length);
            if(anyDone) badge.classList.add('check'); else badge.classList.remove('check');
            // state logic based on soonest reminder
            const days = Math.ceil((upcomingList[0].dt - now)/(1000*60*60*24));
            pill.classList.remove('state-normal','state-soon','state-urgent','pulse'); badge.classList.remove('state-normal','state-soon','state-urgent');
            if(days <= 3) { pill.classList.add('state-urgent','pulse'); badge.classList.add('state-urgent'); }
            else if(days <= 14) { pill.classList.add('state-soon'); badge.classList.add('state-soon'); }
            else { pill.classList.add('state-normal'); badge.classList.add('state-normal'); }
          } else {
            pill.setAttribute('title','No upcoming reminders');
            const labelSpan = pill.querySelector('.rem-label');
            if(labelSpan){
              const moNeededEl = dom('kpiMoNeeded');
              const grossVal = moNeededEl ? parseNum(moNeededEl.dataset.gross || '0') : 0;
              const avgVal = moNeededEl ? parseNum(moNeededEl.dataset.avg || '0') : 0;
              
              // Calculate total natural deduction (same logic as buildShareText)
              const months = getMonthData();
              const vals = months.map(m=> Number(m.outflow||0));
              const monthsPassed = currentMonthIdx;
              const inflowBeforeCurrent = vals.slice(0, monthsPassed);
              const nonZeroInflows = inflowBeforeCurrent.filter(v => v > 0);
              const avgInflow = nonZeroInflows.length > 0 ? Math.round(nonZeroInflows.reduce((a,b)=>a+b,0) / nonZeroInflows.length) : 0;
              
              // Count missing months and add current month
              const monthsWithMissingRecords = monthsPassed - nonZeroInflows.length;
              const totalMonthsToDeduct = monthsWithMissingRecords + 1; // missing months + current month
              const totalNaturalDeduction = avgInflow * totalMonthsToDeduct;
              
              // Updated calculation: grossVal - totalNaturalDeduction (not just avgVal)
              const rawGap = Math.round((grossVal || 0) - totalNaturalDeduction);
              
              if(rawGap < 0){
                labelSpan.innerHTML = `Dep. Reminder • <span class="surplus-text">Expected surplus: AED ${fmtAcc(Math.abs(rawGap))}</span>`;
                if(iconSpanGlobal) iconSpanGlobal.textContent = '🎉';
              } else if(rawGap === 0 || Number(grossVal) <= 0){
                labelSpan.textContent = 'Target achieved 🎉';
                if(iconSpanGlobal) iconSpanGlobal.textContent = '🎉';
              } else {
                labelSpan.textContent = `Dep. Reminder • AED ${fmtAcc(rawGap)}`;
                if(anyDone && iconSpanGlobal) iconSpanGlobal.textContent = '✅';
                else if(iconSpanGlobal) iconSpanGlobal.textContent = '🔔';
              }
            }
            badge.textContent = anyDone ? '✅' : String(arr.length);
            if(anyDone) badge.classList.add('check'); else badge.classList.remove('check');
            pill.classList.remove('state-soon','state-urgent','pulse'); pill.classList.add('state-normal'); badge.classList.remove('state-soon','state-urgent'); badge.classList.add('state-normal');
          }
        }
      }catch(e){ console.debug('renderRems: compute upcoming failed', e); }
    }
    function downloadICS(r){
  appendRemDebug('handler: downloadICS start ' + (r && r.id));
  // keep user informed and avoid silent failures
  try{
        const dtStart = new Date(r.when);
        if(isNaN(dtStart)) throw new Error('Invalid date');
        const dtEnd = new Date(dtStart.getTime() + 60*60*1000);
        function asUTC(dt){
          const pad = n => String(n).padStart(2,'0');
          return dt.getUTCFullYear()+pad(dt.getUTCMonth()+1)+pad(dt.getUTCDate())+'T'+pad(dt.getUTCHours())+pad(dt.getUTCMinutes())+'00Z';
        }
        const rawAmtICS = Number(r.amount || 0);
        const friendlyAmtText = rawAmtICS > 0 ? (' — AED ' + fmtAcc(rawAmtICS)) : (rawAmtICS < 0 ? (' — Expected surplus: AED ' + fmtAcc(Math.abs(rawAmtICS))) : '');

        const uid = `${r.id}@enbd-tracker`;
        const ics = [
          'BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//ENBD Tracker//ENBD//EN',
          'BEGIN:VEVENT',
          'UID:'+uid,
          'DTSTAMP:'+asUTC(new Date()),
          'DTSTART:'+asUTC(dtStart),
          'DTEND:'+asUTC(dtEnd),
          'SUMMARY:'+ (displayedLabel(r) + friendlyAmtText) ,
    'DESCRIPTION:'+ (r.label || defaultRemLabel(r)),
          'END:VEVENT',
          'END:VCALENDAR'
        ].join('\r\n');
        const blob = new Blob([ics], {type:'text/calendar'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'cheque-deposit.ics';
        document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();}, 0);
      }catch(err){
        appendRemDebug('error: downloadICS ' + String(err));
        console.debug('downloadICS failed', err);
        alert('Could not create calendar event — please check the reminder date/time.');
      }
    }
    function shareReminder(r){
      appendRemDebug('handler: shareReminder start ' + (r && r.id));
      try{
        const dt = new Date(r.when);
        const rawAmtShare = Number(r.amount || 0);
        const friendlyAmountShare = rawAmtShare > 0 ? `AED ${fmtAcc(rawAmtShare)}` : (rawAmtShare < 0 ? `Expected surplus: AED ${fmtAcc(Math.abs(rawAmtShare))}` : 'AED 0');
  const text = `Cheque Reminder\nDate: ${isNaN(dt)?'(no date)':dt.toLocaleDateString('en-GB')}\nAmount: ${friendlyAmountShare}\nLabel: ${displayedLabel(r)}`;
        // Try Web Share API first (mobile/modern browsers)
        if(navigator.share){
          navigator.share({ title: 'Cheque Reminder', text }).catch(()=>{
            // fallback to WhatsApp link
            window.open('https://wa.me/?text='+encodeURIComponent(text), '_blank');
          });
          return;
        }
        // Fallback to WhatsApp web link
        window.open('https://wa.me/?text='+encodeURIComponent(text), '_blank');
      }catch(e){ console.debug('shareReminder error', e); alert('Could not share reminder.'); }
    }

    // Send reminder by opening default mail client (fallback). If EmailJS is configured, later we can wire a richer send.
    function sendReminderEmail(r){
      appendRemDebug('handler: sendReminderEmail start ' + (r && r.id));
      try{
        const dt = new Date(r.when);
        const subject = 'Cheque Reminder';
    const rawAmtEmail = Number(r.amount || 0);
    const friendlyAmountEmail = rawAmtEmail > 0 ? `AED ${fmtAcc(rawAmtEmail)}` : (rawAmtEmail < 0 ? `Expected surplus: AED ${fmtAcc(Math.abs(rawAmtEmail))}` : 'AED 0');
  const bodyBase = `Cheque Reminder\n\nDate: ${isNaN(dt)?'(no date)':dt.toLocaleString('en-GB')}\nAmount: ${friendlyAmountEmail}\nLabel: ${displayedLabel(r)}\n\nPlease arrange deposit as required.`;
        // Ask for recipient - if provided, download the .ics and open mailto to that recipient so they can attach it
        const recipient = prompt('Enter recipient email to send this reminder (leave blank to open your mail client):', '');
        if(recipient){
          // prepare and download .ics so it's ready to attach
          try{ downloadICS(r); }catch(e){ console.debug('downloadICS fallback failed', e); }
          const body = bodyBase + '\n\n(An .ics file has been downloaded. Please attach it to this email so the recipient can add the event to their calendar.)';
          const mailto = `mailto:${encodeURIComponent(recipient)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
          window.open(mailto, '_blank');
          return;
        }
        // no recipient provided: open default mail client (original behavior)
        const mailto = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(bodyBase)}`;
        window.open(mailto, '_blank');
      }catch(e){ console.debug('sendReminderEmail error', e); alert('Could not prepare email.'); }
    }

    function addCustomReminder(){
      const date = prompt('Enter date (YYYY-MM-DD):', `${yearSel.value}-${String(currentMonthIdx+1).padStart(2,'0')}-21`);
      if(!date) return;
      const time = prompt('Enter time (HH:MM):', '10:00');
  const amount = Number(prompt('Amount:', '0')||0);
  const label = prompt('Label:', defaultRemLabel()) || defaultRemLabel();
      const when = new Date(`${date}T${time}:00`);
      if(isNaN(when)) { alert('Invalid date/time'); return; }
      addReminder({ id:'r'+Date.now(), when: when.toISOString(), amount, label, done:false });
    }
    dom('btnAddCustom').addEventListener('click', addCustomReminder);

    // Test helpers (quick in-browser checks)
    function remFirst(){ const a = getRems(); return (a && a.length)? a[0] : null; }
  // test buttons removed
    const overlay = dom('shareOverlay');
    function openShare(){
      // require user to fill recipient manually; do not auto-prefill
      buildShareText(); overlay.classList.add('show'); overlay.setAttribute('aria-hidden','false');
      // focus recipient to encourage filling it
      setTimeout(()=> dom('shareRecipient')?.focus(), 120);
    }
    function closeShare(){ overlay.classList.remove('show'); overlay.setAttribute('aria-hidden','true'); }
    dom('btnTopShare').addEventListener('click', openShare);
    dom('btnShareClose').addEventListener('click', closeShare);
    dom('btnShareClose2').addEventListener('click', closeShare);

    // AI Analysis handlers
  function openAi(){ dom('aiOverlay').classList.add('show'); dom('aiOverlay').setAttribute('aria-hidden','false'); setTimeout(()=>{ try{ dom('aiText').value = computeAnalysis(); }catch(e){} },120); }
    function closeAi(){ dom('aiOverlay').classList.remove('show'); dom('aiOverlay').setAttribute('aria-hidden','true'); }
    dom('btnAiAnalysis').addEventListener('click', openAi);
    dom('btnAiClose').addEventListener('click', closeAi);
    dom('btnAiClose2').addEventListener('click', closeAi);
    dom('btnRunAi').addEventListener('click', ()=>{ dom('btnRunAi').textContent='Running…'; setTimeout(()=>{ dom('aiText').value = computeAnalysis(); dom('btnRunAi').textContent='Run Analysis'; },120); });
    // AI breakdown toggle: saved per Owner & Year using key 'aiShowBreakdown'
    function aiBreakdownKey(){ return 'aiShowBreakdown'; }
    function getAiBreakdownPref(){ try{ return !!load(aiBreakdownKey(), true); }catch(e){ return true; } }
    function setAiBreakdownPref(v){ try{ save(aiBreakdownKey(), !!v); }catch(e){} }
    const btnToggleBreakdown = dom('btnToggleBreakdown');
    if(btnToggleBreakdown){
      // initialize label
      const show = getAiBreakdownPref();
      btnToggleBreakdown.textContent = show ? 'Hide breakdown' : 'Show breakdown';
      btnToggleBreakdown.addEventListener('click', ()=>{
        const cur = getAiBreakdownPref();
        setAiBreakdownPref(!cur);
        btnToggleBreakdown.textContent = !cur ? 'Hide breakdown' : 'Show breakdown';
        // refresh analysis if overlay is open
        if(dom('aiOverlay') && dom('aiOverlay').classList.contains('show')){ dom('aiText').value = computeAnalysis(); }
      });
    }
    // Scenario helpers
    function applyIfDepositToCopy(ifAmt){
      const months = getMonthData().map(m=> ({...m}));
      const idx = currentMonthIdx;
      if(!months[idx]) months[idx] = { day:'', target:0, note:'', outflow:0 };
      months[idx].outflow = Number(months[idx].outflow||0) + Number(ifAmt||0);
      return months;
    }

    function getScenarioMultipliers(){
      const raw = load('scenarioMultipliers', null) || {};
      const hasOptimistic = typeof raw.mulO === 'number';

      const rawMulP = Number(raw.mulP);
      const rawMulB = Number(raw.mulB);
      let rawMulC = Number(raw.mulC);
      let rawMulO = Number(raw.mulO);

      if(!hasOptimistic){
        const legacyConservative = (isFinite(rawMulC) && rawMulC > 0) ? rawMulC : 1.12;
        rawMulO = legacyConservative || 1.18;
        rawMulC = 0.92;
      }

      const muls = {
        mulP: (isFinite(rawMulP) && rawMulP > 0) ? rawMulP : 0.75,
        mulC: (isFinite(rawMulC) && rawMulC > 0) ? rawMulC : 0.92,
        mulB: (isFinite(rawMulB) && rawMulB > 0) ? rawMulB : 1,
        mulO: (isFinite(rawMulO) && rawMulO > 0) ? rawMulO : 1.18
      };

      if(muls.mulC > muls.mulB){
        const fallback = muls.mulB > 0 ? muls.mulB * 0.9 : 0.9;
        muls.mulC = Math.max(0.5, fallback);
      }
      if(muls.mulO <= muls.mulB){
        muls.mulO = Math.max(muls.mulB + 0.05, muls.mulB * 1.1);
      }

      if(!hasOptimistic){
        try{ save('scenarioMultipliers', muls); }catch(e){}
      }
      return muls;
    }

    function canonicalScenario(kind){
      const label = (kind || '').toString().trim().toLowerCase();
      if(label === 'pessimistic' || label === 'worst' || label === 'stress'){ return 'Pessimistic'; }
      if(label === 'conservative' || label === 'guarded' || label === 'cautious'){ return 'Conservative'; }
      if(label === 'optimistic' || label === 'best' || label === 'stretch'){ return 'Optimistic'; }
      if(label === 'no change' || label === 'baseline' || label === 'hold' || label === 'base'){ return 'Base'; }
      return 'Base';
    }

    function computeScenarioProjection(kind, ifDeposit){
      const scenario = canonicalScenario(kind);
      const months = getMonthData();
      const vals = months.map(m=> Number(m.outflow||0));
      const targets = months.map(m=> Number(m.target||0));
      const storedTarget = Number(load('yearTarget', 0)) || 0;
      const totalTarget = storedTarget > 0 ? storedTarget : targets.reduce((a,b)=>a+b,0);
      const current = currentMonthIdx;
      const monthsPassed = current;
      const inflowBeforeCurrent = vals.slice(0, monthsPassed).reduce((a,b)=>a+b,0);
      const baseAvg = monthsPassed>0 ? inflowBeforeCurrent / monthsPassed : 0;
  const muls = getScenarioMultipliers();
  let factor = muls.mulB;
  if(scenario === 'Pessimistic') factor = muls.mulP;
  else if(scenario === 'Conservative') factor = muls.mulC;
  else if(scenario === 'Optimistic') factor = muls.mulO;
      const projAvg = Math.round(baseAvg * factor);
      const now = new Date();
      const endOfYear = new Date(Number(yearSel.value||now.getFullYear()), 11, 31, 23,59,59);
      const msInDay = 1000*60*60*24;
      const days_left = Math.max(0, Math.ceil((endOfYear - now)/msInDay));
      const months_left = Math.max(0.01, days_left / 30.44);
      const monthsToYearEnd = Math.max(1, Math.ceil(months_left));
      const inflowYTD = vals.slice(0, current+1).reduce((a,b)=>a+b,0);
      const expectedRemaining = Math.round(projAvg * monthsToYearEnd);
      let expectedYearEnd = inflowYTD + expectedRemaining;
      if(ifDeposit && Number(ifDeposit)>0){ expectedYearEnd += Number(ifDeposit); }
      const shortfall = Math.max(0, totalTarget - expectedYearEnd);
      return { kind: scenario, projAvg, monthsToYearEnd, inflowYTD, expectedRemaining, expectedYearEnd, shortfall };
    }

    dom('btnApplyIf')?.addEventListener('click', ()=>{
      const ifAmt = Number((dom('aiIfDeposit')||{value:0}).value||0);
  const sel = (dom('aiScenarioSelect')||{value:'All'}).value;
  const kinds = sel==='All' ? ['Pessimistic','Conservative','Base','Optimistic'] : [sel];
      const lines = [];
      lines.push(`Scenario results — ${new Date().toLocaleString()}`);
      lines.push('');
      for(const k of kinds){
        const r = computeScenarioProjection(k, ifAmt);
        lines.push(`--- ${r.kind} ---`);
        lines.push(`Projected avg monthly (used): AED ${fmtAcc(r.projAvg)}`);
        lines.push(`Expected year-end inflow: AED ${fmtAcc(r.expectedYearEnd)}`);
        lines.push(`Forecast shortfall: AED ${fmtAcc(r.shortfall)}`);
        lines.push('');
      }
      lines.push('Full analysis:');
      lines.push('');
      lines.push(computeAnalysis());
      const muls = getScenarioMultipliers();
      save('lastScenario', { sel, ifAmt, mulP: muls.mulP, mulB: muls.mulB, mulC: muls.mulC, mulO: muls.mulO });
      dom('aiText').value = lines.join('\n');
      renderScenarioTable();
      try{ if(typeof updateUI === 'function') updateUI(); }catch(e){}
    });

    dom('btnSaveScenario')?.addEventListener('click', ()=>{
      const mulP = Number((dom('mulPessimistic')||{value:0.75}).value) || 0.75;
      const mulB = Number((dom('mulBase')||{value:1}).value) || 1;
      const mulC = Number((dom('mulConservative')||{value:0.92}).value) || 0.92;
      const mulO = Number((dom('mulOptimistic')||{value:1.18}).value) || 1.18;
      save('scenarioMultipliers', { mulP, mulB, mulC, mulO });
      alert('Scenario multipliers saved for this Owner & Year');
      renderScenarioTable();
      try{ if(typeof updateUI === 'function') updateUI(); }catch(e){}
    });

    function renderScenarioTable(){
      const muls = getScenarioMultipliers();
      if(dom('mulPessimistic')) dom('mulPessimistic').value = muls.mulP;
      if(dom('mulBase')) dom('mulBase').value = muls.mulB;
      if(dom('mulConservative')) dom('mulConservative').value = muls.mulC;
      if(dom('mulOptimistic')) dom('mulOptimistic').value = muls.mulO;
      const ifAmt = Number((dom('aiIfDeposit')||{value:0}).value||0);
      const kinds = ['Pessimistic','Conservative','Base','Optimistic'];
      const rows = [];
      rows.push('Kind            | Avg/mo       | Exp Year-End   | Shortfall    ');
      rows.push('--------------------------------------------------------------');
      for(const k of kinds){
        const r = computeScenarioProjection(k, ifAmt);
        rows.push(`${k.padEnd(14)}| ${fmtAcc(r.projAvg).padStart(13)} | ${fmtAcc(r.expectedYearEnd).padStart(15)} | ${fmtAcc(r.shortfall).padStart(13)}`);
      }
      const tbl = dom('aiScenarioTable'); if(tbl) tbl.textContent = rows.join('\n');
    }

    (function(){
      const last = load('lastScenario', null);
      if(last){
        try{
          if(dom('aiScenarioSelect')) dom('aiScenarioSelect').value = last.sel || 'All';
          if(dom('aiIfDeposit')) dom('aiIfDeposit').value = last.ifAmt || 0;
          if(typeof last.mulP === 'number' && dom('mulPessimistic')) dom('mulPessimistic').value = last.mulP;
          if(typeof last.mulB === 'number' && dom('mulBase')) dom('mulBase').value = last.mulB;
          if(typeof last.mulC === 'number' && dom('mulConservative')) dom('mulConservative').value = last.mulC;
          if(typeof last.mulO === 'number' && dom('mulOptimistic')) dom('mulOptimistic').value = last.mulO;
        }catch(e){}
        if(typeof last.mulO !== 'number' && typeof last.mulC === 'number'){
          const migrated = {
            sel: last.sel,
            ifAmt: last.ifAmt,
            mulP: Number(last.mulP) || 0.75,
            mulB: Number(last.mulB) || 1,
            mulC: 0.92,
            mulO: Number(last.mulC) || 1.18
          };
          try{ save('lastScenario', migrated); }catch(e){}
          try{
            if(dom('mulConservative')) dom('mulConservative').value = migrated.mulC;
            if(dom('mulOptimistic')) dom('mulOptimistic').value = migrated.mulO;
          }catch(e){}
        }
      }
      renderScenarioTable();
      dom('aiScenarioSelect')?.addEventListener('change', ()=>{
        renderScenarioTable();
        try{ dom('aiText').value = computeAnalysis(); }catch(e){}
      });
    })();

    // AI share handlers (require recipient)
    dom('sWhatsAppAi')?.addEventListener('click', ()=>{
      const rec = (dom('aiShareRecipient')||{value:''}).value.trim();
      if(!rec){ alert('Please enter recipient name before sharing.'); dom('aiShareRecipient')?.focus(); return; }
      // ensure analysis is current
      const text = computeAnalysis().replace(/^/m, '');
      const t = text.replace(/^/m, '');
      const out = t.replace(/^Owner:/m, ''); // keep full but inject Dear line at top
      const final = (`Dear ${rec},\n\n` + text);
      window.open('https://wa.me/?text='+enc(final), '_blank');
    });
    dom('sEmailAi')?.addEventListener('click', ()=>{
      const rec = (dom('aiShareRecipient')||{value:''}).value.trim();
      if(!rec){ alert('Please enter recipient name before sharing.'); dom('aiShareRecipient')?.focus(); return; }
      const text = computeAnalysis();
      const body = (`Dear ${rec},\n\n` + text);
      const subject = `Analysis — ${ownerSel.value || ''}`;
      window.location.href = `mailto:?subject=${enc(subject)}&body=${enc(body)}`;
    });
    dom('sCopyAi')?.addEventListener('click', ()=>{
      const rec = (dom('aiShareRecipient')||{value:''}).value.trim();
      if(!rec){ alert('Please enter recipient name before copying.'); dom('aiShareRecipient')?.focus(); return; }
      const text = computeAnalysis();
      const final = (`Dear ${rec},\n\n` + text);
      if(navigator.clipboard){ navigator.clipboard.writeText(final).then(()=> alert('Copied!')); }
      else { prompt('Copy the analysis:', final); }
    });
    dom('sPrintAi')?.addEventListener('click', ()=>{
      const rec = (dom('aiShareRecipient')||{value:''}).value.trim();
      if(!rec){ alert('Please enter recipient name before printing.'); dom('aiShareRecipient')?.focus(); return; }
      const text = computeAnalysis();
      const final = (`Dear ${rec},\n\n` + text);
      const w = window.open('', '_blank', 'width=720,height=900');
      w.document.write(`<pre style="font:14px/1.6 monospace; white-space:pre-wrap; padding:20px">${final.replace(/[<>&]/g,c=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[c]))}</pre>`);
      w.document.close(); w.focus(); setTimeout(()=>{w.print(); w.close();}, 200);
    });

    // Email Settings handlers
    dom('btnEmailSettings').addEventListener('click', openEmailSettings);

    function openEmailSettings(){
      const config = load('emailjsConfig', {serviceId:'', templateId:'', publicKey:'', recipient:''});
      dom('emailServiceId').value = config.serviceId || '';
      dom('emailTemplateId').value = config.templateId || '';
      dom('emailPublicKey').value = config.publicKey || '';
      dom('emailRecipient').value = config.recipient || '';
      dom('emailOverlay').classList.add('show');
      dom('emailOverlay').setAttribute('aria-hidden','false');
    }

    dom('btnEmailClose').addEventListener('click', closeEmailSettings);
    dom('btnEmailClose2').addEventListener('click', closeEmailSettings);

    function closeEmailSettings(){
      dom('emailOverlay').classList.remove('show');
      dom('emailOverlay').setAttribute('aria-hidden','true');
    }

    dom('btnSaveEmailConfig').addEventListener('click', saveEmailConfig);

    function saveEmailConfig(){
      const config = {
        serviceId: dom('emailServiceId').value.trim(),
        templateId: dom('emailTemplateId').value.trim(),
        publicKey: dom('emailPublicKey').value.trim(),
        recipient: dom('emailRecipient').value.trim()
      };
      if(!config.serviceId || !config.templateId || !config.publicKey || !config.recipient){
        alert('All fields are required.');
        return;
      }
      save('emailjsConfig', config);
      if(config.publicKey){
        emailjs.init(config.publicKey);
      }
      alert('Email settings saved.');
      closeEmailSettings();
    }

    dom('btnTestEmail').addEventListener('click', testEmail);

    function testEmail(){
      const config = {
        serviceId: dom('emailServiceId').value.trim(),
        templateId: dom('emailTemplateId').value.trim(),
        publicKey: dom('emailPublicKey').value.trim(),
        recipient: dom('emailRecipient').value.trim()
      };
      if(!config.serviceId || !config.templateId || !config.publicKey || !config.recipient){
        alert('All fields are required for testing.');
        return;
      }
      emailjs.send(config.serviceId, config.templateId, {
        to_email: config.recipient,
        subject: 'Test Email from ENBD Tracker',
        message: 'This is a test email from the ENBD Performance Tracker.'
      }).then(() => {
        alert('Test email sent successfully!');
      }).catch((error) => {
        alert('Failed to send test email: ' + error.text);
      });
    }

    // Duplicate Owner handlers
    dom('btnDuplicateOwner').addEventListener('click', openDuplicateOwner);

    function openDuplicateOwner(){
      dom('duplicateOwnerOverlay').classList.add('show');
      dom('duplicateOwnerOverlay').setAttribute('aria-hidden','false');
    }

    dom('btnDuplicateClose').addEventListener('click', closeDuplicateOwner);
    dom('btnDuplicateClose2').addEventListener('click', closeDuplicateOwner);

    function closeDuplicateOwner(){
      dom('duplicateOwnerOverlay').classList.remove('show');
      dom('duplicateOwnerOverlay').setAttribute('aria-hidden','true');
    }

    dom('btnDuplicateData').addEventListener('click', duplicateOwnerData);

    function duplicateOwnerData(){
      const sourceOwner = dom('sourceOwner').value.trim();
      const sourceYear = dom('sourceYear').value.trim();
      const targetOwner = dom('targetOwner').value.trim();
      const targetYear = dom('targetYear').value.trim();

      if(!sourceOwner || !sourceYear || !targetOwner || !targetYear){
        alert('All fields are required.');
        return;
      }

      if(sourceOwner === targetOwner && sourceYear === targetYear){
        alert('Source and target cannot be the same.');
        return;
      }

      // Confirm duplication
      if(!confirm(`Duplicate all data from ${sourceOwner} ${sourceYear} to ${targetOwner} ${targetYear}? This will overwrite any existing data for the target.`)){
        return;
      }

      // Keys to duplicate
      const keysToDuplicate = ['monthData', 'reminders', 'openingBalance', 'scenarioMultipliers', 'lastScenario', 'notes'];

      let duplicatedCount = 0;
      for(const key of keysToDuplicate){
        const sourceKey = `enbd:${sourceOwner}:${sourceYear}:${key}`;
        const targetKey = `enbd:${targetOwner}:${targetYear}:${key}`;
        const value = localStorage.getItem(sourceKey);
        if(value !== null){
          localStorage.setItem(targetKey, value);
          duplicatedCount++;
        }
      }

      alert(`Duplicated ${duplicatedCount} data items from ${sourceOwner} ${sourceYear} to ${targetOwner} ${targetYear}.`);
      closeDuplicateOwner();
    }

    function computeAnalysis(){
      try{
        const months = getMonthData();
        const owner = ownerSel.value || 'Owner';
        const now = new Date();
        const yearNum = Number(yearSel.value || now.getFullYear());
        const msInDay = 1000 * 60 * 60 * 24;
        const yearStart = new Date(yearNum, 0, 1);
        const yearEnd = new Date(yearNum, 11, 31, 23, 59, 59);
        const daysElapsed = Math.max(0, Math.floor((now - yearStart) / msInDay));
        const daysToYearEnd = Math.max(0, Math.ceil((yearEnd - now) / msInDay));
        const calendarProgress = (daysElapsed + daysToYearEnd) > 0 ? (daysElapsed / (daysElapsed + daysToYearEnd)) : 0;

        const current = currentMonthIdx;
        const monthsPassed = Math.max(0, current);
        const monthsRemaining = Math.max(1, 12 - monthsPassed);
        const vals = months.map(m => Number(m.outflow||0) || 0);
        const inflowYTD = vals.slice(0, monthsPassed).reduce((a,b)=>a+b,0);
        // Filter out zero entries to get accurate average
        const nonZeroInflowsAI = vals.slice(0, monthsPassed).filter(v => v > 0);
        const avgMonthlyInflow = nonZeroInflowsAI.length > 0 ? nonZeroInflowsAI.reduce((a,b)=>a+b,0) / nonZeroInflowsAI.length : 0;
        const dataProgress = monthsPassed / 12;

        const storedTarget = Number(load('yearTarget', 0)) || 0;
        const derivedTarget = months.reduce((acc, m)=> acc + Number(m.target || 0), 0);
        const annualTarget = storedTarget > 0 ? storedTarget : derivedTarget;
        const targetSet = annualTarget > 0;
        const remainingNeeded = targetSet ? Math.max(0, annualTarget - inflowYTD) : 0;
        const requiredMonthlyRate = targetSet ? remainingNeeded / monthsRemaining : 0;

        const paceReference = targetSet ? annualTarget * Math.max(dataProgress, calendarProgress * 0.85) : 0;
        const paceDeficit = paceReference > 0 ? Math.max(0, (paceReference - inflowYTD) / paceReference) : 0;

        const defaults = getScenarioMultipliers();
        const mulP = Number((dom('mulPessimistic')||{value:defaults.mulP}).value) || defaults.mulP;
        const mulC = Number((dom('mulConservative')||{value:defaults.mulC}).value) || defaults.mulC;
        const mulB = Number((dom('mulBase')||{value:defaults.mulB}).value) || defaults.mulB;
        const mulO = Number((dom('mulOptimistic')||{value:defaults.mulO}).value) || defaults.mulO;
        const dropPct = Math.round((1 - mulP) * 100);
        const conservativePct = Math.round((mulC - 1) * 100);
        const liftPct = Math.round((mulO - 1) * 100);
        const scenarioSelect = (dom('aiScenarioSelect')||{value:'All'}).value || 'All';
        const scenarioMeta = {
          Pessimistic: { multiplier: mulP, label: 'Pessimistic', descriptor: `stress case (≈${dropPct}% pullback)` },
          Conservative: { multiplier: mulC, label: 'Conservative', descriptor: `guarded adjustment (≈${conservativePct >= 0 ? '+' : ''}${conservativePct}%)` },
          Base: { multiplier: mulB, label: 'Base', descriptor: 'current pace' },
          Optimistic: { multiplier: mulO, label: 'Optimistic', descriptor: `accelerated plan (≈${liftPct >= 0 ? '+' : ''}${liftPct}% uplift)` }
        };
        const scenarioKey = scenarioSelect === 'All' ? 'Base' : scenarioSelect;
        const activeScenario = scenarioMeta[scenarioKey] || scenarioMeta.Base;
        const projectedMonthly = avgMonthlyInflow * activeScenario.multiplier;
        const projectedRemaining = projectedMonthly * monthsRemaining;
        const expectedYearEnd = inflowYTD + projectedRemaining;
        const scenarioShortfall = targetSet ? Math.max(0, annualTarget - expectedYearEnd) : 0;
        const monthlyGap = targetSet ? Math.max(0, requiredMonthlyRate - projectedMonthly) : 0;

        const catchUpRatio = projectedMonthly > 0 ? requiredMonthlyRate / projectedMonthly : (targetSet && remainingNeeded > 0 ? 2.2 : 0);
        let catchUpPressure;
        if(catchUpRatio <= 1){
          catchUpPressure = Math.max(0, (catchUpRatio - 0.9) * 90);
        }else{
          catchUpPressure = Math.min(100, Math.pow(catchUpRatio - 1, 1.4) * 95);
        }

        const timePressure = Math.min(100, Math.pow(calendarProgress, 2.1) * 115);
        const pacePenalty = Math.min(100, paceDeficit * 120);

        const pastValues = vals.slice(0, monthsPassed).filter(v => v > 0);
        let volatilityRatio = 0;
        let volatilityStd = 0;
        if(pastValues.length > 1){
          const mean = pastValues.reduce((a,b)=>a+b,0) / pastValues.length;
          const variance = pastValues.reduce((a,b)=> a + Math.pow(b - mean, 2), 0) / pastValues.length;
          volatilityStd = Math.sqrt(variance);
          volatilityRatio = mean > 0 ? volatilityStd / mean : 0;
        }
        const volatilityPressure = Math.min(100, volatilityRatio * 120);

        let riskScore = Math.round(
          timePressure * 0.25 +
          pacePenalty * 0.35 +
          catchUpPressure * 0.30 +
          volatilityPressure * 0.10
        );

        if(targetSet){
          if(daysToYearEnd <= 120 && paceDeficit > 0.25){ riskScore = Math.max(riskScore, 60); }
          if(daysToYearEnd <= 90 && scenarioShortfall > requiredMonthlyRate * 1.5){ riskScore = Math.max(riskScore, 72); }
          if(daysToYearEnd <= 60 && catchUpRatio > 1.25){ riskScore = Math.max(riskScore, 82); }
          if(daysToYearEnd <= 30 && scenarioShortfall > projectedMonthly){ riskScore = Math.max(riskScore, 90); }
          if(daysToYearEnd <= 14 && scenarioShortfall > 0){ riskScore = Math.max(riskScore, 95); }
        }

        if(activeScenario.multiplier > 1 && riskScore > 0){
          riskScore = Math.max(0, riskScore - Math.min(10, (activeScenario.multiplier - 1) * 12));
        }

        riskScore = Math.max(0, Math.min(100, riskScore));

        function riskLabel(score){
          if(score < 15) return 'Very Low';
          if(score < 35) return 'Low';
          if(score < 55) return 'Moderate';
          if(score < 75) return 'High';
          if(score < 90) return 'Very High';
          return 'Critical';
        }
        function riskEmoji(score){
          if(score < 15) return '✅';
          if(score < 35) return '🟢';
          if(score < 55) return '⏰';
          if(score < 75) return '⚠️';
          if(score < 90) return '🔴';
          return '🚨';
        }

  const scenarioKeys = ['Pessimistic','Conservative','Base','Optimistic'];
        const depositIf = Number((dom('aiIfDeposit')||{value:0}).value || 0);
        const scenarioLines = scenarioKeys.map(key => {
          const res = computeScenarioProjection(key, depositIf);
          return `${key.padEnd(13)} • Avg AED ${fmtAcc(res.projAvg)} • Year-end ${fmtAcc(res.expectedYearEnd)} • Gap ${fmtAcc(res.shortfall)}`;
        });

        const lines = [];
        lines.push(`Owner: ${owner}`);
        lines.push(`Year: ${yearNum} · target deadline 31 Dec ${yearNum}`);
        lines.push(`Scenario focus: ${activeScenario.label} — ${activeScenario.descriptor} (×${activeScenario.multiplier.toFixed(2)})`);
        lines.push(`Analysis generated: ${now.toLocaleString()}`);
        lines.push('');

        lines.push('📊 PERFORMANCE SNAPSHOT');
        lines.push(`• Year-to-date inflow: ${fmtAcc(inflowYTD)}`);
        lines.push(`• Average monthly inflow: ${fmtAcc(Math.round(avgMonthlyInflow))}`);
        lines.push(`• Annual target: ${targetSet ? fmtAcc(annualTarget) : 'Not set — update Total Target to enable pacing'}`);
        if(targetSet){
          lines.push(`• Remaining target to collect: ${fmtAcc(remainingNeeded)}`);
          lines.push(`• Required pace for remaining ${monthsRemaining} month${monthsRemaining>1?'s':''}: ${fmtAcc(Math.round(requiredMonthlyRate))}/month`);
          lines.push(`• Scenario pace (${activeScenario.label}): ${fmtAcc(Math.round(projectedMonthly))}/month`);
          if(monthlyGap > 0){
            lines.push(`• Shortfall per month to close: ${fmtAcc(Math.round(monthlyGap))}`);
          }else{
            lines.push('• Shortfall per month to close: None under this scenario — stay vigilant');
          }
        }
        lines.push(`• Recorded months: ${monthsPassed} of 12 (current month inflow posts when next month’s bank statement arrives)`);
        lines.push('');

        lines.push('⏰ TIME PRESSURE');
        lines.push(`• Calendar progress: ${Math.round(calendarProgress * 100)}% of the year elapsed`);
        lines.push(`• Months remaining (including current): ${monthsRemaining}`);
        lines.push(`• Days to year-end: ${daysToYearEnd}`);
        if(targetSet){
          lines.push(`• Catch-up ratio: ${catchUpRatio.toFixed(2)}× of scenario inflow needed monthly`);
        }
        lines.push('');

        lines.push('📈 SCENARIO FORECAST (AED)');
        scenarioLines.forEach(line => lines.push(`• ${line}`));
        if(targetSet){
          const outcome = scenarioShortfall > 0 ? `shortfall ${fmtAcc(scenarioShortfall)}` : 'meets target';
          lines.push(`• Focus scenario year-end balance: ${fmtAcc(Math.round(expectedYearEnd))} (${outcome})`);
        }
        lines.push('');

        lines.push(`🚨 RISK ASSESSMENT: ${riskScore}/100 — ${riskLabel(riskScore)} ${riskEmoji(riskScore)}`);
        if(targetSet){
          if(riskScore < 15){
            lines.push('• Status: Strong position — maintain current discipline.');
          }else if(riskScore < 35){
            lines.push('• Status: On track with a buffer — monitor cash collections.');
          }else if(riskScore < 55){
            lines.push('• Status: Moderate pressure — arrange top-ups or accelerate receivables.');
          }else if(riskScore < 75){
            lines.push('• Status: High pressure — execute deposit actions within the next cycle.');
          }else if(riskScore < 90){
            lines.push('• Status: Severe pressure — immediate corrective action required this month.');
          }else{
            lines.push('• Status: Critical — trigger emergency funding and escalate collections now.');
          }
        }else{
          lines.push('• Status: Unable to quantify risk because a yearly target is not defined.');
        }
        lines.push('');

        if(targetSet){
          lines.push('💡 RECOMMENDED ACTIONS');
          if(monthlyGap > 0){
            lines.push(`• Arrange at least ${fmtAcc(Math.round(monthlyGap))} this month to stay aligned with the ${activeScenario.label.toLowerCase()} plan.`);
          }else{
            lines.push('• Maintain current inflow levels; reassess if two consecutive months fall below average.');
          }
          if(scenarioShortfall > 0){
            lines.push(`• Plan cumulative deposits of ${fmtAcc(Math.round(scenarioShortfall))} across the remaining months to close the projected gap.`);
          }
          if(volatilityRatio > 0.35){
            lines.push('• Smooth collections: volatility is elevated versus the monthly average.');
          }
          if(pastValues.length === 0){
            lines.push('• Log at least one historical month to anchor forecasts.');
          }
          lines.push('');
        }

        lines.push('ℹ️ DATA NOTES');
        lines.push('• Bank inflows for the current month are recorded in the following month once statements are available.');
        lines.push('• Risk model weighs time remaining more heavily as December approaches, so slow inflows in November trigger sharper alerts than in January.');
        if(!targetSet){
          lines.push('• Set a Total Target to unlock pacing guidance and accurate risk scoring.');
        }
        // Use the new helper function for missing bank inflow analysis
        const missingInflowInfo = getMissingBankInflowAnalysis();
        if(missingInflowInfo.hasMissing){
          lines.push(`• ⚠️ MISSING BANK INFLOWS: ${missingInflowInfo.missingMonths.join(', ')} show zero inflows - verify if accurate or update data.`);
        } else {
          lines.push('• ✅ All submitted months have recorded bank inflows.');
        }
        if(missingInflowInfo.currentMonthNote){
          lines.push(`• 📅 Current month (${missingInflowInfo.currentMonthNote.split('(')[0].trim()}): Inflow typically recorded early next month upon bank statement receipt.`);
        }
        if(pastValues.length > 1){
          lines.push(`• Monthly volatility (σ): ${fmtAcc(Math.round(volatilityStd))} (CV ${(volatilityRatio * 100).toFixed(0)}%)`);
        }else{
          lines.push('• Volatility: need at least two months of history to benchmark stability.');
        }

        return lines.join('\n');
      }catch(e){
        return 'Analysis failed: ' + String(e);
      }
    }

      // Reusable helper: returns composite risk score, label and classname for UI
      function getCompositeScore(){
        try{
          const months = getMonthData();
          const vals = months.map(m=> Number(m.outflow||0));
          const current = currentMonthIdx;
          const monthsPassed = current; // Only count months before current (current month has no data yet)
          const inflowYTD = vals.slice(0, monthsPassed).reduce((a,b)=>a+b,0);
          const totalTarget = Number(load('yearTarget', 0));

          const now = new Date();
          const yearNum = Number(yearSel.value || now.getFullYear());
          const yearEnd = new Date(yearNum, 11, 31, 23, 59, 59);
          
          const daysToYearEnd = Math.max(0, Math.ceil((yearEnd - now) / (1000 * 60 * 60 * 24)));
          const monthsRemainingForAchievement = 12 - current;
          const effectiveMonthsLeft = Math.max(1, monthsRemainingForAchievement);
          
          const yearProgress = current / 12;
          const avgMonthlyInflow = monthsPassed > 0 ? (inflowYTD / monthsPassed) : 0;
          const remainingNeeded = Math.max(0, totalTarget - inflowYTD);
          const requiredMonthlyRate = remainingNeeded / effectiveMonthsLeft;
          const performanceGap = avgMonthlyInflow > 0 ? (requiredMonthlyRate / avgMonthlyInflow) : (remainingNeeded > 0 ? 10 : 1);

          let riskScore = 0;
          
          if (totalTarget > 0) {
            // Factor 1: Time Pressure (35% weight) - more conservative early warnings
            const timePressure = Math.min(100, Math.pow(yearProgress, 1.8) * 110);
            
            // Factor 2: Money Pressure (40% weight) - enhanced sensitivity
            let moneyPressure = 0;
            if (performanceGap > 1) {
              moneyPressure = Math.min(100, Math.pow(performanceGap - 1, 1.2) * 65);
            } else {
              moneyPressure = Math.max(0, (performanceGap - 0.8) * 40);
            }
            
            // Factor 3: Achievement Difficulty (25% weight) - more conservative
            let difficultyFactor = 0;
            if (avgMonthlyInflow > 0) {
              const monthsNeededAtCurrentRate = remainingNeeded / avgMonthlyInflow;
              const difficultyRatio = monthsNeededAtCurrentRate / effectiveMonthsLeft;
              
              if (difficultyRatio > 1) {
                difficultyFactor = Math.min(100, Math.pow(difficultyRatio, 1.3) * 75);
              } else {
                difficultyFactor = Math.max(0, (difficultyRatio - 0.7) * 60);
              }
            } else if (remainingNeeded > 0) {
              difficultyFactor = 85;
            }
            
            riskScore = Math.round(
              (timePressure * 0.35) + 
              (moneyPressure * 0.40) + 
              (difficultyFactor * 0.25)
            );
            
            // Enhanced special cases
            if (daysToYearEnd <= 60 && performanceGap > 1.5) {
              riskScore = Math.max(riskScore, 75);
            }
            if (daysToYearEnd <= 30 && remainingNeeded > avgMonthlyInflow * 1.5) {
              riskScore = Math.max(riskScore, 85);
            }
            if (daysToYearEnd <= 14 && remainingNeeded > 0) {
              riskScore = Math.max(riskScore, 90);
            }
            if (daysToYearEnd <= 7 && remainingNeeded > 0) {
              riskScore = Math.max(riskScore, 95);
            }
            
            // Optimistic adjustment
            if (performanceGap < 0.8 && yearProgress < 0.8) {
              riskScore = Math.max(0, riskScore - 15);
            }
          }
          
          riskScore = Math.max(0, Math.min(100, riskScore));
          
          function label(s) {
            if (s < 15) return 'Very Low';
            if (s < 35) return 'Low';  
            if (s < 55) return 'Moderate';
            if (s < 75) return 'High';
            if (s < 90) return 'Very High';
            return 'Critical';
          }
          
          function className(s) {
            if (s < 15) return 'very-low';
            if (s < 35) return 'low';
            if (s < 55) return 'moderate';
            if (s < 75) return 'high';
            if (s < 90) return 'very-high';
            return 'critical';
          }

          return { score: riskScore, label: label(riskScore), className: className(riskScore) };
        }catch(e){
          return { score: null, label: 'Error', className: 'error' };
        }
      }

    // Return a short one-line risk summary derived from the analysis risk score
    function shortRiskLine(){
      try{
        const months = getMonthData();
        const vals = months.map(m=> Number(m.outflow||0));
        const targets = months.map(m=> Number(m.target||0));
        const current = currentMonthIdx;
        const monthsPassed = current;
        const inflowYTD = vals.slice(0, current+1).reduce((a,b)=>a+b,0);
        const totalTarget = Number(load('yearTarget', 0)) || targets.reduce((a,b)=>a+b,0);

        // day-aware
        const now = new Date();
        const startOfYear = new Date(Number(yearSel.value||now.getFullYear()), 0, 1, 0,0,0);
        const endOfYear = new Date(Number(yearSel.value||now.getFullYear()), 11, 31, 23,59,59);
        const msInDay = 1000*60*60*24;
        const days_elapsed = Math.max(0, Math.floor((now - startOfYear)/msInDay));
        const days_left = Math.max(0, Math.ceil((endOfYear - now)/msInDay));
        const months_left = Math.max(0.01, days_left / 30.44);
        const schedule_index = (days_elapsed + days_left) > 0 ? (days_elapsed / (days_elapsed + days_left)) : 0;

        const avgInflow = monthsPassed>0 ? (vals.slice(0, monthsPassed).reduce((a,b)=>a+b,0)/monthsPassed) : 0;
        const expectedRemaining = Math.round(avgInflow * months_left);
        const expectedYearEnd = inflowYTD + expectedRemaining;
        const shortfall = totalTarget > 0 ? Math.max(0, totalTarget - expectedYearEnd) : 0;
        const remaining = totalTarget > 0 ? Math.max(0, totalTarget - inflowYTD) : 0;
        const moNeeded = totalTarget > 0 ? Math.ceil(remaining / months_left) : 0;

        const past = vals.slice(0, monthsPassed).filter(v=> v!=null);
        const mean = past.length ? past.reduce((a,b)=>a+b,0)/past.length : 0;
        const variance = past.length ? past.reduce((a,b)=> a + Math.pow(b-mean,2), 0)/past.length : 0;
        const stddev = Math.sqrt(variance);
        const volRatio = mean>0 ? stddev/Math.abs(mean) : (stddev>0?1:0);

        // composite 0-100 (same weights as computeAnalysis)
        const scheduleFactor = schedule_index;
        const burdenFactor = remaining > 0 ? Math.min(1, shortfall / Math.max(1, remaining)) : 0;
        const volFactorNorm = Math.min(1, volRatio);
        const composite = Math.round((scheduleFactor * 0.45 + burdenFactor * 0.35 + volFactorNorm * 0.20) * 100);
        const compScore = Math.max(0, Math.min(100, composite));

        const label = compScore < 30 ? 'Comfort' : compScore < 60 ? 'Warning' : compScore < 80 ? 'High' : 'Extreme';
        return `Risk: ${compScore}/100 — ${label}`;
      }catch(e){ return ''; }
    }

    // Helper function to generate missing bank inflow analysis
    function getMissingBankInflowAnalysis(){
      const months = getMonthData();
      const vals = months.map(m=> Number(m.outflow||0));
      const currentMonth = new Date().getMonth(); // 0-11
      
      // Find months with missing bank inflows (before current month)
      const missingMonths = [];
      const currentMonthNote = [];
      
      for(let i = 0; i < 12; i++){
        if(i < currentMonth && vals[i] === 0){
          missingMonths.push(monthNames[i]);
        } else if(i === currentMonth){
          currentMonthNote.push(`${monthNames[i]} (current month - inflow typically recorded early next month)`);
        }
      }
      
      let analysis = '';
      if(missingMonths.length > 0){
        analysis += `⚠️ MISSING BANK INFLOWS: ${missingMonths.join(', ')}. `;
        analysis += `These months show zero bank inflow which may indicate unrecorded transactions or actual zero collections. `;
      } else {
        analysis += `✅ BANK INFLOWS: All past months have recorded inflows. `;
      }
      
      if(currentMonthNote.length > 0){
        analysis += `Note: ${currentMonthNote[0]}. `;
      }
      
      analysis += `Bank inflow entries are typically entered at the beginning of the following month upon receipt of complete bank statements.`;
      
      return {
        missingMonths,
        currentMonthNote: currentMonthNote.length > 0 ? currentMonthNote[0] : '',
        analysis,
        hasMissing: missingMonths.length > 0
      };
    }

    function buildShareText(){
  // Build the exact template the user requested, with AED-formatted numbers
  const owner = ownerSel.value || 'Owner';
  const y = Number(yearSel.value) || new Date().getFullYear();
  const yt = Number(load('yearTarget', 0)) || 0;
  const monthlyTarget = Math.round(yt/12);
  const months = getMonthData();
  const vals = months.map(m=> Number(m.outflow||0));

  // Avg. Mo. Inflow: use months before current month (exclude current month) - ONLY count months with actual inflows
  const monthsPassed = currentMonthIdx;
  const inflowBeforeCurrent = vals.slice(0, monthsPassed);
  // Filter out zero entries to get accurate average
  const nonZeroInflows = inflowBeforeCurrent.filter(v => v > 0);
  const avgInflow = nonZeroInflows.length > 0 ? Math.round(nonZeroInflows.reduce((a,b)=>a+b,0) / nonZeroInflows.length) : 0;

  // Mo. Needed Inflow To End of Year (evenly distribute remaining target over remaining months incl. current)
  const inflowYTD = vals.slice(0, currentMonthIdx+1).reduce((a,b)=>a+b,0);
  const totalTarget = months.reduce((s,m)=> s + Number(m.target||0), 0);
  // Use the same enhanced calculation as the main page
  const now = new Date();
  const startOfYear = new Date(Number(yearSel.value||now.getFullYear()), 0, 1, 0,0,0);
  const endOfYear = new Date(Number(yearSel.value||now.getFullYear()), 11, 31, 23,59,59);
  const msInDay = 1000*60*60*24;
  const days_elapsed = Math.max(0, Math.floor((now - startOfYear)/msInDay));
  const days_left = Math.max(0, Math.ceil((endOfYear - now)/msInDay));
  
  // Enhanced calculation: accurate month counting with fractional behavior
  const currentMonth = now.getMonth(); // 0-11 (0=Jan, 9=Oct)
  const currentYear = now.getFullYear();
  const selectedYear = Number(yearSel.value || currentYear);
  
  let months_left;
  if (selectedYear === currentYear) {
    // For current year, calculate more precisely
    const dayOfMonth = now.getDate();
    const daysInCurrentMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    const remainingDaysInCurrentMonth = daysInCurrentMonth - dayOfMonth + 1;
    const fractionOfCurrentMonth = remainingDaysInCurrentMonth / daysInCurrentMonth;
    
    // Count remaining full months after current month
    const remainingFullMonths = 11 - currentMonth; // Nov, Dec for October
    
    // Total = fraction of current month + remaining full months
    months_left = Math.max(0.01, fractionOfCurrentMonth + remainingFullMonths);
  } else {
    // For other years, use the original average calculation
    months_left = Math.max(0.01, days_left / 30.44);
  }
  const monthsToYearEndIncludingCurrent = Math.max(1, Math.ceil(months_left));
  const remainingToTarget = Math.max(0, totalTarget - inflowYTD);
  const moNeeded = monthsToYearEndIncludingCurrent > 0 ? Math.ceil(remainingToTarget / monthsToYearEndIncludingCurrent) : remainingToTarget;

  // Get breakdown for explicit calculation display
  const nonZeroInflowsShare = vals.slice(0, currentMonthIdx).filter(v => v > 0);
  const totalRecordedInflows = nonZeroInflowsShare.reduce((a,b)=>a+b,0);
  const monthsWithRecords = nonZeroInflowsShare.length;
  const monthsWithMissingRecords = currentMonthIdx - monthsWithRecords;
  
  // Required deposit calculation: Account for missing months AND current month natural inflows
  // Mo. Needed is the gross requirement per month, but we need to subtract:
  // 1. Expected natural inflow for missing months (already excluded from average)  
  // 2. Expected natural inflow for current month (will come naturally)
  const totalMonthsToDeduct = monthsWithMissingRecords + 1; // missing months + current month
  const totalNaturalDeduction = avgInflow * totalMonthsToDeduct;
  const rawRequiredDeposit = Math.round(moNeeded - totalNaturalDeduction);
  const requiredDeposit = Math.max(0, rawRequiredDeposit);
  const expectedSurplus = Math.max(0, Math.round(totalNaturalDeduction - moNeeded));

  const monthName = monthNames[currentMonthIdx];

  // Get missing bank inflow analysis
  const missingInflowInfo = getMissingBankInflowAnalysis();
  const disclaimerText = missingInflowInfo.analysis;

  const lines = [];
  // leave Dear blank for manual entry
  lines.push('Dear ,');
  lines.push('');
  // Include optional share flags (if user ticked any checkbox in the share overlay)
  try{
    const f = [];
    if(document.getElementById('shareFlagGreen') && document.getElementById('shareFlagGreen').checked) f.push('🟢 GREEN');
    if(document.getElementById('shareFlagYellow') && document.getElementById('shareFlagYellow').checked) f.push('🟡 YELLOW');
    if(document.getElementById('shareFlagRed') && document.getElementById('shareFlagRed').checked) f.push('🔴 RED');
    if(f.length){ lines.push(`Flags: ${f.join(' | ')}`); lines.push(''); }
  }catch(_){ /* ignore if overlay not present */ }
  lines.push(`• Deposit Req. — ${monthName} ${y}`);
  lines.push(`Account Name : ${owner}`);
  lines.push('');
  if(requiredDeposit > 0){
    lines.push(`🏦 DEPOSIT REQUIRED: AED ${fmtAcc(requiredDeposit)}`);
  } else if(expectedSurplus > 0){
    lines.push(`✅ NO DEPOSIT REQUIRED - Surplus: AED ${fmtAcc(expectedSurplus)}`);
  } else {
    lines.push(`✅ NO DEPOSIT REQUIRED`);
  }
  lines.push('');
  lines.push('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
  lines.push('');
  lines.push(`•\u2060  \u2060Required to stay on target: AED ${fmtAcc(moNeeded)}`);
  
  // Build explicit expected natural inflow explanation
  let expectedInflowExplanation = `•\u2060  \u2060Expected natural inflow (rents/cheques — approximate): AED ${fmtAcc(avgInflow)}`;
  if(monthsWithRecords > 0){
    expectedInflowExplanation += ` (avg of ${monthsWithRecords} recorded month${monthsWithRecords > 1 ? 's' : ''}: AED ${fmtAcc(totalRecordedInflows)} ÷ ${monthsWithRecords})`;
    if(monthsWithMissingRecords > 0){
      // Get names of months with missing records
      const missingMonthNames = [];
      for(let i = 0; i < currentMonthIdx; i++){
        if(vals[i] === 0){
          missingMonthNames.push(monthNames[i]);
        }
      }
      expectedInflowExplanation += ` [${missingMonthNames.join(', ')} month${missingMonthNames.length > 1 ? 's' : ''} with missing records excluded]`;
    }
  }
  lines.push(expectedInflowExplanation);
  
  if(requiredDeposit > 0){
    // Build explanation of what months are being deducted
    const missingMonthNames = [];
    for(let i = 0; i < currentMonthIdx; i++){
      if(vals[i] === 0){
        missingMonthNames.push(monthNames[i]);
      }
    }
    const currentMonthName = monthNames[currentMonthIdx];
    let deductionExplanation = `${missingMonthNames.length > 0 ? missingMonthNames.join(', ') + ' (missing)' : ''}`;
    if(missingMonthNames.length > 0){
      deductionExplanation += ` + ${currentMonthName} (current)`;
    } else {
      deductionExplanation = `${currentMonthName} (current)`;
    }
    
    lines.push(`•\u2060  \u2060Cheque deposit required: AED ${fmtAcc(requiredDeposit)} (= AED ${fmtAcc(moNeeded)} "required" − AED ${fmtAcc(totalNaturalDeduction)} "total natural deduction" for ${deductionExplanation})`);
  } else if(expectedSurplus > 0){
    lines.push(`•\u2060  \u2060Expected surplus: AED ${fmtAcc(expectedSurplus)} (natural inflows exceed required)`);
  } else {
    // Build explanation of what months are being deducted
    const missingMonthNames = [];
    for(let i = 0; i < currentMonthIdx; i++){
      if(vals[i] === 0){
        missingMonthNames.push(monthNames[i]);
      }
    }
    const currentMonthName = monthNames[currentMonthIdx];
    let deductionExplanation = `${missingMonthNames.length > 0 ? missingMonthNames.join(', ') + ' (missing)' : ''}`;
    if(missingMonthNames.length > 0){
      deductionExplanation += ` + ${currentMonthName} (current)`;
    } else {
      deductionExplanation = `${currentMonthName} (current)`;
    }
    
    lines.push(`•\u2060  \u2060Cheque deposit required: AED 0 (= AED ${fmtAcc(moNeeded)} "required" − AED ${fmtAcc(totalNaturalDeduction)} "total natural deduction" for ${deductionExplanation})`);
  }
  lines.push('');
  if(requiredDeposit > 0){
    lines.push(`• Action: please arrange depositing AED ${fmtAcc(requiredDeposit)} this month to keep us on target.`);
  } else if(expectedSurplus > 0){
    lines.push(`• Action: No additional deposit required — natural inflows are projected to exceed the monthly requirement by AED ${fmtAcc(expectedSurplus)}.`);
  } else {
    lines.push(`• Action: No additional deposit required this month to stay on target.`);
  }
  lines.push('');
  lines.push('• Note: Expected natural inflow is an approximate estimate based on the • Avg. Mo. Inflow (past months\' average).');
  lines.push(`• ${disclaimerText}`);
  if(missingInflowInfo.hasMissing){
    lines.push(`• ACTION REQUIRED: Review and update bank inflows for: ${missingInflowInfo.missingMonths.join(', ')}.`);
  }
  lines.push('');
  lines.push('—');
  lines.push('Thanks,');
  lines.push('Fuad Al-Taher');
  lines.push('');
  lines.push('Powered by Ayat');
  dom('shareText').value = lines.join('\n');
    }

    // Share handlers
    function enc(s){ return encodeURIComponent(s); }
    dom('sWhatsApp').addEventListener('click', ()=>{
      const rec = (dom('shareRecipient')||{value:''}).value.trim();
      if(!rec){ alert('Please enter recipient name before sharing.'); dom('shareRecipient')?.focus(); return; }
      // inject recipient into the Dear line before sharing
      buildShareText();
      const text = dom('shareText').value.replace(/^Dear\s*,/m, `Dear ${rec},`);
      window.open('https://wa.me/?text='+enc(text), '_blank');
    });
    dom('sEmail').addEventListener('click', ()=>{
      const rec = (dom('shareRecipient')||{value:''}).value.trim();
      if(!rec){ alert('Please enter recipient name before sharing.'); dom('shareRecipient')?.focus(); return; }
      buildShareText();
  const subject = `Deposit Req. — ${monthNames[currentMonthIdx]}`;
      const body = dom('shareText').value.replace(/^Dear\s*,/m, `Dear ${rec},`);
      window.location.href = `mailto:?subject=${enc(subject)}&body=${enc(body)}`;
    });
    dom('sCopy').addEventListener('click', ()=>{
      const rec = (dom('shareRecipient')||{value:''}).value.trim();
      if(!rec){ alert('Please enter recipient name before copying.'); dom('shareRecipient')?.focus(); return; }
      buildShareText();
      const t = dom('shareText').value.replace(/^Dear\s*,/m, `Dear ${rec},`);
      if(navigator.clipboard){ navigator.clipboard.writeText(t).then(()=> alert('Copied!')); }
      else { prompt('Copy the text:', t); }
    });
    dom('sPrint').addEventListener('click', ()=>{
      const rec = (dom('shareRecipient')||{value:''}).value.trim();
      if(!rec){ alert('Please enter recipient name before printing.'); dom('shareRecipient')?.focus(); return; }
      buildShareText();
      const t = dom('shareText').value.replace(/^Dear\s*,/m, `Dear ${rec},`);
      const w = window.open('', '_blank', 'width=720,height=900');
      w.document.write(`<pre style="font:14px/1.6 monospace; white-space:pre-wrap; padding:20px">${t.replace(/[<>&]/g,c=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[c]))}</pre>`);
      w.document.close(); w.focus(); setTimeout(()=>{w.print(); w.close();}, 200);
    });

    // Owner report overlay wiring
    const ownerReportOverlay = dom('ownerReportOverlay');
    const ownerReportContent = ownerReportOverlay ? ownerReportOverlay.querySelector('#ownerReportContent') : null;
    if(dom('btnOwnerReport')){
      dom('btnOwnerReport').addEventListener('click', ()=> openOwnerReport(true));
    }
    ['btnOwnerReportClose','btnOwnerReportClose2'].forEach(id=>{
      const el = dom(id);
      if(el) el.addEventListener('click', closeOwnerReport);
    });
    [
      ['ownerReportWhatsApp', ()=> shareOwnerReport('whatsapp')],
      ['ownerReportEmail', ()=> shareOwnerReport('email')],
      ['ownerReportCopy', ()=> shareOwnerReport('copy')],
      ['ownerReportPrint', ()=> shareOwnerReport('print')]
    ].forEach(([id, handler])=>{
      const el = dom(id);
      if(el) el.addEventListener('click', handler);
    });

    function getOwnerReportRecipient(){
      return (dom('ownerReportRecipient')||{value:''}).value.trim();
    }

    function prepareOwnerReport(force = false){
      if(!ownerReportOverlay) return null;
      if(force || !ownerReportOverlay.dataset.reportStamp){
        const data = buildOwnerReport();
        if(ownerReportContent) ownerReportContent.innerHTML = data.html;
        ownerReportOverlay.dataset.reportText = data.text || '';
        ownerReportOverlay.dataset.reportOwner = data.owner || '';
        ownerReportOverlay.dataset.reportYear = data.year || '';
        ownerReportOverlay.dataset.reportStamp = String(Date.now());
      }
      return {
        text: ownerReportOverlay.dataset.reportText || '',
        owner: ownerReportOverlay.dataset.reportOwner || (ownerSel ? ownerSel.value : ''),
        year: ownerReportOverlay.dataset.reportYear || (yearSel ? yearSel.value : ''),
        html: ownerReportContent ? ownerReportContent.innerHTML : ''
      };
    }

    function openOwnerReport(force = false){
      try{
        prepareOwnerReport(force);
        if(ownerReportOverlay){
          ownerReportOverlay.classList.add('show');
          ownerReportOverlay.setAttribute('aria-hidden','false');
          if(!ownerReportOverlay.dataset.reportStamp || force){
            ownerReportOverlay.dataset.reportStamp = String(Date.now());
          }
        }
        const input = dom('ownerReportRecipient');
        if(input && !input.value.trim()){
          const fallback = (dom('shareRecipient')||{value:''}).value.trim() || (dom('aiShareRecipient')||{value:''}).value.trim();
          if(fallback) input.value = fallback;
          setTimeout(()=> input.focus(), 80);
        }
      }catch(err){
        console.error('openOwnerReport failed', err);
        alert('Could not prepare owner report: ' + String(err));
      }
    }

    function closeOwnerReport(){
      if(ownerReportOverlay){
        ownerReportOverlay.classList.remove('show');
        ownerReportOverlay.setAttribute('aria-hidden','true');
      }
    }

    function legacyCopyOwnerReport(text){
      try{
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed';
        ta.style.opacity = '0';
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        if(typeof showToast === 'function') showToast('Report copied to clipboard');
      }catch(err){
        console.error('legacyCopyOwnerReport failed', err);
        alert('Copy failed: ' + String(err));
      }
    }

    function buildOwnerReportShareBody(recipient, data){
      const greeting = recipient ? `Dear ${recipient},\n\n` : '';
      const closing = '\n\nThanks,\nFuad Al-Taher\nPowered by Ayat';
      return `${greeting}${data.text}${closing}`;
    }

    function shareOwnerReport(mode){
      try{
        const recipient = getOwnerReportRecipient();
        if(!recipient){
          alert('Please enter recipient name before sharing.');
          dom('ownerReportRecipient')?.focus();
          return;
        }
  const data = prepareOwnerReport(true);
        if(!data || !data.text){
          alert('Report is not ready yet.');
          return;
        }
        const message = buildOwnerReportShareBody(recipient, data);
        const subject = `Owner Report — ${data.owner || 'Owner'} ${data.year || ''}`.trim();
        if(mode === 'whatsapp'){
          window.open('https://wa.me/?text='+enc(message), '_blank');
          return;
        }
        if(mode === 'email'){
          window.location.href = `mailto:?subject=${enc(subject)}&body=${enc(message)}`;
          return;
        }
        if(mode === 'copy'){
          if(navigator.clipboard && navigator.clipboard.writeText){
            navigator.clipboard.writeText(message).then(()=>{ if(typeof showToast === 'function') showToast('Report copied to clipboard'); }).catch(err=>{
              console.debug('shareOwnerReport: clipboard API failed', err);
              legacyCopyOwnerReport(message);
            });
          } else {
            legacyCopyOwnerReport(message);
          }
          return;
        }
        if(mode === 'print'){
          printOwnerReport(recipient, message, subject);
        }
      }catch(err){
        console.error('shareOwnerReport failed', err);
        alert('Unable to share report: ' + String(err));
      }
    }

    function printOwnerReport(recipient, message, subject){
      try{
        const prepared = prepareOwnerReport();
        if(!prepared || !prepared.html){
          alert('Report content is empty.');
          return;
        }
        const w = window.open('', '_blank', 'width=900,height=1020');
        if(!w){
          alert('Popup blocked. Please allow popups to print the report.');
          return;
        }
        const docStyles = `
          body{font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,sans-serif;background:#090b10;color:#f0f6fc;margin:0;padding:28px;}
          h1,h2,h3,h4{margin:0;color:#33cccc;}
          .owner-report-letter{margin-bottom:18px;font-size:14px;line-height:1.7;white-space:pre-wrap;}
          .owner-report-letter strong{color:#58a6ff;}
          .owner-report-grid{display:flex;flex-direction:column;gap:18px;}
          .owner-report-summary{display:flex;flex-wrap:wrap;gap:18px;justify-content:space-between;align-items:flex-start;}
          .owner-report-summary .meta{font-size:13px;color:#8b949e;}
          .owner-report-chip{display:inline-flex;align-items:center;gap:6px;padding:4px 12px;border-radius:999px;font-size:12px;font-weight:600;background:rgba(88,166,255,0.16);color:#58a6ff;}
          .owner-report-metrics{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;}
          .owner-report-card{background:linear-gradient(160deg,rgba(51,204,204,0.08),rgba(10,16,24,0.4));border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:12px 14px;display:flex;flex-direction:column;gap:6px;}
          .owner-report-card .label{font-size:11px;text-transform:uppercase;color:#8b949e;letter-spacing:0.6px;}
          .owner-report-card .value{font-size:18px;font-weight:700;color:#f0f6fc;}
          .owner-report-card .sub{font-size:12px;color:#8b949e;}
          .owner-report-section{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.05);border-radius:14px;padding:16px 18px;display:flex;flex-direction:column;gap:10px;}
          .owner-report-section h4{margin:0;font-size:15px;color:#58a6ff;font-weight:700;letter-spacing:0.3px;}
          .owner-report-section p{margin:0;color:#f0f6fc;font-size:13px;line-height:1.6;}
          .owner-report-section ul{margin:0;padding-left:20px;color:#f0f6fc;font-size:13px;line-height:1.55;}
          .owner-report-section ul li + li{margin-top:6px;}
          .owner-report-table{width:100%;border-collapse:collapse;font-size:12.5px;background:rgba(0,0,0,0.2);border-radius:12px;overflow:hidden;}
          .owner-report-table th,.owner-report-table td{padding:8px 10px;border:1px solid rgba(255,255,255,0.04);text-align:left;}
          .owner-report-table th{background:rgba(255,255,255,0.05);font-weight:600;color:#33cccc;text-transform:uppercase;letter-spacing:0.4px;font-size:11px;}
          .owner-report-table td.numeric{text-align:right;font-family:'JetBrains Mono','Fira Code',monospace;}
          .owner-report-analysis{background:rgba(8,12,18,0.7);border:1px solid rgba(255,255,255,0.05);border-radius:12px;padding:14px;font-size:12.5px;color:#8b949e;white-space:pre-wrap;line-height:1.6;font-family:'Fira Code','JetBrains Mono',Consolas,monospace;}
        `;
  const safeMessage = message.replace(/[<>&]/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[c]));
        w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>${subject}</title><style>${docStyles}</style></head><body><div class="owner-report-letter">${safeMessage.replace(/\n/g,'<br>')}</div>${prepared.html}</body></html>`);
        w.document.close();
        setTimeout(()=>{ try{ w.focus(); w.print(); }catch(_){ } }, 300);
      }catch(err){
        console.error('printOwnerReport failed', err);
        alert('Could not open printable report: ' + String(err));
      }
    }

    function buildOwnerReport(){
      const escapeHtml = (str) => String(str ?? '').replace(/[&<>\"]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[ch]));
      const truncate = (str, len=80) => {
        const s = String(str || '').trim();
        if(s.length <= len) return s;
        return s.slice(0, len-1).trim() + '…';
      };
      const card = (label, value, sub='') => `<div class="owner-report-card"><span class="label">${escapeHtml(label)}</span><span class="value">${escapeHtml(value)}</span>${sub ? `<span class="sub">${escapeHtml(sub)}</span>` : ''}</div>`;

      const owner = ownerSel ? ownerSel.value || 'Owner' : 'Owner';
      const year = yearSel ? yearSel.value || String(new Date().getFullYear()) : String(new Date().getFullYear());
      const now = new Date();
      const scenario = computeScenarios();
      const months = getMonthData();
      const composite = getCompositeScore();
      const analysisText = computeAnalysis();
      const analysisLines = typeof analysisText === 'string' ? analysisText.split('\n') : [String(analysisText || 'Analysis unavailable')];

      const totalTarget = parseNum(scenario.totalTarget || months.reduce((s,m)=> s + parseNum(m.target||0), 0));
      const ytd = parseNum(scenario.YTD || 0);
      const openingBalance = parseNum(scenario.OB || 0);
      const cumulative = ytd + openingBalance;
      const progress = totalTarget > 0 ? Math.max(0, Math.min(999, (cumulative / Math.max(1,totalTarget)) * 100)) : null;
      const forecastBase = parseNum(scenario.baseYE || 0);
      const forecastCon = parseNum(scenario.conservativeYE || 0);
      const forecastOpt = parseNum(scenario.optimisticYE || 0);
      const forecastPes = parseNum(scenario.pessimisticYE || 0);
      const shortfallBase = totalTarget > 0 ? totalTarget - forecastBase : null;

      const monthsPassed = Math.max(0, currentMonthIdx);
      const inflowsBeforeCurrent = months.slice(0, monthsPassed).map(m=> parseNum(m.outflow||0));
      // Filter out zero entries to get accurate average
      const nonZeroInflowsOwner = inflowsBeforeCurrent.filter(v => v > 0);
      const avgInflow = nonZeroInflowsOwner.length > 0 ? nonZeroInflowsOwner.reduce((a,b)=>a+b,0) / nonZeroInflowsOwner.length : 0;
      const nowYear = Number(year) || now.getFullYear();
      const endOfYear = new Date(nowYear, 11, 31, 23, 59, 59);
      const daysLeft = Math.max(0, Math.ceil((endOfYear - now) / (1000*60*60*24)));
      const monthsLeftFractional = Math.max(0.01, daysLeft / 30.44);
      const monthsLeftRounded = Math.max(1, Math.ceil(monthsLeftFractional));
      const remainingToTarget = totalTarget > 0 ? Math.max(0, totalTarget - ytd) : 0;
      const moNeeded = totalTarget > 0 ? Math.ceil(remainingToTarget / monthsLeftRounded) : 0;
      const monthlyGap = totalTarget > 0 ? Math.max(0, moNeeded - avgInflow) : 0;
      const expectedSurplus = totalTarget > 0 ? Math.max(0, avgInflow - moNeeded) : 0;

      // Ensure authoritative per-row variance/balance are present (recompute writes these into month objects)
      const needRecompute = months.some(m => m.balance === undefined || m.variance === undefined);
      if(needRecompute){
        try{ recompute(); }catch(e){ console.debug('buildOwnerReport: recompute failed', e); }
        // reload months after recompute (it saves month data)
        months = getMonthData();
      }

      // Build monthStats using the same data model as the main month table (day, target, note, outflow, variance, balance)
      const monthStats = months.map((m, idx) => {
        const inflow = parseNum(m.outflow || 0); // Bank Inflow on main page
        const target = parseNum(m.target || 0);
        const variance = m.variance !== undefined ? parseNum(m.variance) : inflow - target;
        const balance = m.balance !== undefined ? parseNum(m.balance) : (openingBalance + inflow); // fallback
        return {
          index: idx,
          day: m.day || '',
          name: shortMonth[idx],
          fullName: monthNames[idx],
          target,
          note: m.note || '',
          inflow,
          variance,
          cumulativeInflow: 0,
          balance
        };
      });
      const recordedMonths = monthStats.filter(m => (m.inflow !== 0) || (m.target !== 0) || (m.note && m.note.trim()) || (m.day && m.day.trim()));
      const bestMonth = recordedMonths.length ? recordedMonths.reduce((a,b)=> (b.inflow > a.inflow ? b : a), recordedMonths[0]) : null;
      const strongestVariance = recordedMonths.length ? recordedMonths.reduce((a,b)=> (b.variance > a.variance ? b : a), recordedMonths[0]) : null;
      const weakestVariance = recordedMonths.length ? recordedMonths.reduce((a,b)=> (b.variance < a.variance ? b : a), recordedMonths[0]) : null;
      const latestNote = recordedMonths.slice().reverse().find(m => (m.note || '').trim());

      const reminders = getRems();
      const upcoming = reminders.filter(r=> !r.done).map(r => {
        const dt = new Date(r.when);
        return {
          date: dt,
          valid: !isNaN(dt),
          amount: Number(r.amount || 0),
          label: displayedLabel(r)
        };
      }).filter(r => r.valid).sort((a,b)=> a.date - b.date).slice(0,3);

      const summaryBits = [];
      if(totalTarget > 0){
        summaryBits.push(`Progress stands at ${progress !== null ? progress.toFixed(1) : '0.0'}% (AED ${fmtAcc(cumulative)} of AED ${fmtAcc(totalTarget)} collected).`);
        if(shortfallBase !== null){
          if(shortfallBase > 0){
            summaryBits.push(`Base scenario projects a shortfall of AED ${fmtAcc(shortfallBase)} by year-end.`);
          } else if(shortfallBase < 0){
            summaryBits.push(`Base scenario projects a surplus of AED ${fmtAcc(Math.abs(shortfallBase))} by year-end.`);
          } else {
            summaryBits.push('Base scenario is exactly on target for year-end.');
          }
        }
        if(monthlyGap > 0){
          summaryBits.push(`Arrange approximately AED ${fmtAcc(Math.round(monthlyGap))} this month to align with the requirement (Mo. Needed AED ${fmtAcc(moNeeded)} vs average inflow AED ${fmtAcc(Math.round(avgInflow))}).`);
        } else if(expectedSurplus > 0){
          summaryBits.push(`Natural inflows are expected to exceed the monthly requirement by roughly AED ${fmtAcc(Math.round(expectedSurplus))}.`);
        } else {
          summaryBits.push('Monthly requirement matches the current run-rate — continue monitoring collections closely.');
        }
      } else {
        summaryBits.push('No annual target has been defined yet. Set a Total Target to unlock pacing and risk guidance.');
      }
      summaryBits.push(`${daysLeft} day${daysLeft === 1 ? '' : 's'} remain until 31 Dec ${nowYear}.`);

      const highlights = [];
      if(bestMonth){
        highlights.push(`Strongest inflow: ${bestMonth.fullName} at AED ${fmtAcc(bestMonth.inflow)}.`);
      }
      if(strongestVariance && strongestVariance.variance > 0){
        highlights.push(`Outperformance: ${strongestVariance.fullName} exceeded target by AED ${fmtAcc(strongestVariance.variance)}.`);
      }
      if(weakestVariance && weakestVariance.variance < 0){
        highlights.push(`Under-target: ${weakestVariance.fullName} lagged by AED ${fmtAcc(Math.abs(weakestVariance.variance))}.`);
      }
      if(latestNote){
        highlights.push(`Latest field note (${latestNote.fullName}): ${truncate(latestNote.note, 120)}`);
      }
      if(upcoming.length){
        const first = upcoming[0];
        highlights.push(`Next reminder on ${first.date.toLocaleDateString('en-GB')} for AED ${fmtAcc(first.amount)} — ${first.label}.`);
      } else if(totalTarget > 0 && monthlyGap > 0){
        highlights.push(`No reminder scheduled — consider adding one for AED ${fmtAcc(Math.round(monthlyGap))}.`);
      }
      
      // Add missing bank inflow analysis to highlights
      const missingInflowInfo = getMissingBankInflowAnalysis();
      if(missingInflowInfo.hasMissing){
        highlights.push(`⚠️ Missing bank inflows detected: ${missingInflowInfo.missingMonths.join(', ')} — requires data review.`);
      } else {
        highlights.push(`✅ Bank inflow data complete for all past months.`);
      }

      const metricsHtml = [
        card('Total Target', totalTarget > 0 ? `AED ${fmtAcc(totalTarget)}` : 'Not set', totalTarget > 0 ? `Avg target AED ${fmtAcc(Math.round(totalTarget/12))}/mo` : 'Define via Total Target KPI'),
        card('YTD Inflow', `AED ${fmtAcc(ytd)}`, `Opening balance AED ${fmtAcc(openingBalance)}`),
        card('Progress', totalTarget > 0 && progress !== null ? `${progress.toFixed(1)}%` : 'Not available', totalTarget > 0 ? `Collected AED ${fmtAcc(cumulative)}` : 'Requires total target'),
        card('Mo. Needed', totalTarget > 0 ? `AED ${fmtAcc(moNeeded)}` : '—', totalTarget > 0 ? (monthlyGap > 0 ? `Gap vs avg inflow AED ${fmtAcc(Math.round(monthlyGap))}` : `Projected surplus AED ${fmtAcc(Math.round(expectedSurplus))}`) : 'Set target to compute'),
        card('Base Forecast', `AED ${fmtAcc(forecastBase)}`, shortfallBase !== null ? (shortfallBase > 0 ? `Shortfall AED ${fmtAcc(shortfallBase)}` : `Surplus AED ${fmtAcc(Math.abs(shortfallBase))}`) : ''),
        card('Scenario Band', `P ${fmtAcc(forecastPes)} · C ${fmtAcc(forecastCon)} · O ${fmtAcc(forecastOpt)}`, 'Pess / Cons / Opt projections')
      ].join('');

      const monthRows = monthStats.map(m => {
        const noteText = truncate(m.note, 80);
        const varianceColor = m.variance < 0 ? '#f85149' : m.variance > 0 ? '#7bd99f' : '#f0f6fc';
        const balanceColor = m.balance < 0 ? '#f85149' : m.balance > 0 ? '#7bd99f' : '#f0f6fc';
        return `<tr>` +
          `<td>${escapeHtml(m.day)}</td>` +
          `<td>${escapeHtml(m.fullName)}</td>` +
          `<td class="numeric">${fmtAcc(m.target)}</td>` +
          `<td>${escapeHtml(noteText)}</td>` +
          `<td class="numeric">${fmtAcc(m.inflow)}</td>` +
          `<td class="numeric" style="color:${varianceColor}">${fmtAcc(m.variance)}</td>` +
          `<td class="numeric" style="color:${balanceColor}">${fmtAcc(m.balance)}</td>` +
        `</tr>`;
      }).join('');

      const reminderHtml = upcoming.length ? `<ul>${upcoming.map(u => `<li>${u.date.toLocaleDateString('en-GB')} · AED ${fmtAcc(u.amount)} — ${escapeHtml(u.label)}</li>`).join('')}</ul>` : '<p>No upcoming reminders scheduled.</p>';

      const html = `
        <div class="owner-report-summary">
          <div>
            <div class="owner-report-chip">Owner Report</div>
            <h2 style="margin:6px 0 4px; font-size:22px; color:var(--text);">${escapeHtml(owner)} — ${escapeHtml(year)}</h2>
            <div class="meta">Generated ${escapeHtml(now.toLocaleString())}${composite && composite.score !== null ? ` · Risk ${composite.score}/100 — ${escapeHtml(composite.label)}` : ''}</div>
            ${typeof shortRiskLine === 'function' ? `<div class="meta">${escapeHtml(shortRiskLine())}</div>` : ''}
          </div>
          <div style="display:flex; flex-direction:column; gap:6px; align-items:flex-end; text-align:right;">
            ${totalTarget > 0 && progress !== null ? `<div class="owner-report-chip" style="background:rgba(255,153,51,0.12); color:#ffb84d;">Progress ${progress.toFixed(1)}%</div>` : `<div class="owner-report-chip" style="background:rgba(255,92,92,0.14); color:#ff9f80;">Target not set</div>`}
            <div class="meta">Days to year-end: ${daysLeft}</div>
          </div>
        </div>
        <div class="owner-report-metrics">${metricsHtml}</div>
        <div class="owner-report-section">
          <h4>Executive Summary</h4>
          <p>${escapeHtml(summaryBits.join(' '))}</p>
          ${highlights.length ? `<ul>${highlights.map(h => `<li>${escapeHtml(h)}</li>`).join('')}</ul>` : ''}
        </div>
        <div class="owner-report-section">
          <h4>Monthly Performance</h4>
          <div style="overflow:auto; border-radius:12px;">
            <table class="owner-report-table">
              <thead><tr><th>Day</th><th>Month</th><th>Target</th><th>Note</th><th>Bank Inflow</th><th>Variance</th><th>Balance</th></tr></thead>
              <tbody>${monthRows}</tbody>
            </table>
          </div>
        </div>
        <div class="owner-report-section">
          <h4>Reminder Radar</h4>
          ${reminderHtml}
        </div>
        <div class="owner-report-section">
          <h4>Bank Inflow Status</h4>
          <p>${escapeHtml(missingInflowInfo.analysis)}</p>
          ${missingInflowInfo.hasMissing ? `<p style="color:#ff9f80;"><strong>Action Required:</strong> Review and update missing bank inflows for: ${escapeHtml(missingInflowInfo.missingMonths.join(', '))}.</p>` : ''}
        </div>
        <div class="owner-report-section">
          <h4>Detailed Analysis</h4>
          <div class="owner-report-analysis">${escapeHtml(analysisText)}</div>
        </div>
      `;

      const textLines = [];
      textLines.push(`${owner} — ${year} | Owner Situation Report`);
      textLines.push(`Generated: ${now.toLocaleString()}`);
      if(composite && composite.score !== null){
        textLines.push(`Composite risk: ${composite.score}/100 — ${composite.label}`);
      }
      if(totalTarget > 0 && progress !== null){
        textLines.push(`Progress: ${progress.toFixed(1)}% (AED ${fmtAcc(cumulative)} of AED ${fmtAcc(totalTarget)})`);
        textLines.push(`Mo. Needed: AED ${fmtAcc(moNeeded)} | Avg inflow: AED ${fmtAcc(Math.round(avgInflow))}`);
        if(shortfallBase !== null){
          textLines.push(`Base forecast: AED ${fmtAcc(forecastBase)} (${shortfallBase > 0 ? 'Shortfall' : shortfallBase < 0 ? 'Surplus' : 'On target'} ${fmtAcc(Math.abs(shortfallBase))})`);
        }
      } else {
        textLines.push('Total target not set — update to unlock pacing guidance.');
      }
      textLines.push(`Days to year-end: ${daysLeft}`);
      textLines.push('');
      textLines.push('Executive summary:');
      summaryBits.forEach(bit => textLines.push(`- ${bit}`));
      if(highlights.length){
        textLines.push('');
        textLines.push('Highlights:');
        highlights.forEach(h => textLines.push(`- ${h}`));
      }
      textLines.push('');
      textLines.push('Monthly performance:');
      monthStats.forEach(m => {
        const dayPart = m.day ? `Day ${m.day} ` : '';
        textLines.push(`${dayPart}${m.fullName}: Target ${fmtAcc(m.target)} | Note ${truncate(m.note,80)} | Bank Inflow ${fmtAcc(m.inflow)} | Variance ${fmtAcc(m.variance)} | Balance ${fmtAcc(m.balance)}`);
      });
      textLines.push('');
      if(upcoming.length){
        textLines.push('Upcoming reminders:');
        upcoming.forEach(u => textLines.push(`- ${u.date.toLocaleDateString('en-GB')}: AED ${fmtAcc(u.amount)} — ${u.label}`));
      } else {
        textLines.push('Upcoming reminders: None scheduled.');
      }
      textLines.push('');
      textLines.push('Bank inflow status:');
      textLines.push(`- ${missingInflowInfo.analysis}`);
      if(missingInflowInfo.hasMissing){
        textLines.push(`- ACTION REQUIRED: Review and update missing bank inflows for: ${missingInflowInfo.missingMonths.join(', ')}.`);
      }
      textLines.push('');
      textLines.push('Detailed analysis:');
      analysisLines.forEach(line => textLines.push(line));

  return { html, text: textLines.join('\n'), owner, year };
    }

    // Notes drawer sharing buttons
    dom('noteWhatsApp')?.addEventListener('click', ()=>{
      // prefer recipient from month-note overlay, then notes drawer, then share overlay, then scenario share
      const rec = (dom('mnoShareRecipient')||{value:''}).value.trim() || (dom('noteShareRecipient')||{value:''}).value.trim() || (dom('shareRecipient')||{value:''}).value.trim() || (dom('scShareRecipient')||{value:''}).value.trim();
      if(!rec){
        // focus the overlay recipient if present to help the user
        if(dom('mnoShareRecipient')){ dom('mnoShareRecipient').focus(); }
        alert('Please enter a recipient name before sharing.');
        return;
      }
      const text = dom('notesArea').value || '';
      const final = `Dear ${rec},\n\n` + text;
      window.open('https://wa.me/?text='+enc(final), '_blank');
    });
    dom('noteEmail')?.addEventListener('click', ()=>{
      const rec = (dom('mnoShareRecipient')||{value:''}).value.trim() || (dom('noteShareRecipient')||{value:''}).value.trim() || (dom('shareRecipient')||{value:''}).value.trim() || (dom('scShareRecipient')||{value:''}).value.trim();
      if(!rec){ if(dom('mnoShareRecipient')) dom('mnoShareRecipient').focus(); alert('Please enter a recipient name before sharing.'); return; }
      const subject = `Notes — ${ownerSel.value} ${yearSel.value}`;
      const body = dom('notesArea').value || '';
      const final = `Dear ${rec},\n\n` + body;
      window.location.href = `mailto:?subject=${enc(subject)}&body=${enc(final)}`;
    });
    dom('noteCopy')?.addEventListener('click', ()=>{
      const rec = (dom('mnoShareRecipient')||{value:''}).value.trim() || (dom('noteShareRecipient')||{value:''}).value.trim() || (dom('shareRecipient')||{value:''}).value.trim() || (dom('scShareRecipient')||{value:''}).value.trim();
      if(!rec){ if(dom('mnoShareRecipient')) dom('mnoShareRecipient').focus(); alert('Please enter a recipient name before sharing.'); return; }
      const t = dom('notesArea').value || '';
      const final = `Dear ${rec},\n\n` + t;
      if(navigator.clipboard) navigator.clipboard.writeText(final).then(()=> alert('Copied!')); else prompt('Copy the note:', final);
    });
    dom('notePrint')?.addEventListener('click', ()=>{
      const rec = (dom('mnoShareRecipient')||{value:''}).value.trim() || (dom('noteShareRecipient')||{value:''}).value.trim() || (dom('shareRecipient')||{value:''}).value.trim() || (dom('scShareRecipient')||{value:''}).value.trim();
      if(!rec){ if(dom('mnoShareRecipient')) dom('mnoShareRecipient').focus(); alert('Please enter a recipient name before sharing.'); return; }
      const t = dom('notesArea').value || '';
      const final = `Dear ${rec},\n\n` + t;
      const w = window.open('', '_blank', 'width=720,height=900');
      w.document.write(`<pre style="font:14px/1.6 monospace; white-space:pre-wrap; padding:20px">${final.replace(/[<>&]/g,c=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[c]))}</pre>`);
      w.document.close(); w.focus(); setTimeout(()=>{w.print(); w.close();}, 200);
    });

    // Quick badge update: compute reminders count from storage immediately to avoid initial 0 flicker
    function updateRemBadgeImmediate(){
      try{
        const badge = dom('remBadge');
        if(!badge) return;
        const key = `enbd:${dom('owner').value}:reminders`;
        try{ const raw = localStorage.getItem(key); if(raw){ const p = JSON.parse(raw); if(Array.isArray(p)){ badge.textContent = String(p.length); console.debug('updateRemBadgeImmediate: used', key); try{ setRemDebug(`badge:${key}`, p.length); }catch(e){} return; } } }catch(e){}
        // Legacy
        const legacy = ['reminders','enbd:reminders'];
        for(const k of legacy){ try{ const raw = localStorage.getItem(k); if(raw){ const p = JSON.parse(raw); if(Array.isArray(p)){ badge.textContent = String(p.length); console.debug('updateRemBadgeImmediate: used legacy', k); try{ setRemDebug(`badge:legacy:${k}`, p.length); }catch(e){} return; } } }catch(e){} }
      }catch(e){/* ignore */}
    }

    // --- Hidden Notes (per Owner & Year) ---
    function renderNotes(){
      try{
        const drawer = dom('notesDrawer'); const area = dom('notesArea'); if(!area) return;
        const val = load('notes', '');
        area.value = typeof val === 'string' ? val : (val || '');
      }catch(e){ console.debug('renderNotes failed', e); }
    }
    dom('btnToggleNotes')?.addEventListener('click', ()=>{ try{ const d = dom('notesDrawer'); if(!d) return; d.classList.add('open'); d.setAttribute('aria-hidden','false'); renderNotes();
      // sync recipient from month-note overlay into general notes drawer if present
      try{ const mn = dom('mnoShareRecipient'); const nn = dom('noteShareRecipient'); if(mn && mn.value && nn) nn.value = mn.value; }catch(_){ }
      setTimeout(()=> dom('notesArea')?.focus(), 120); }catch(e){} });
    dom('btnCloseNotes')?.addEventListener('click', ()=>{ try{ const d = dom('notesDrawer'); if(!d) return; d.classList.remove('open'); d.setAttribute('aria-hidden','true'); }catch(e){} });
  // Additional Close button under notes controls (mirrors btnCloseNotes)
  dom('noteCloseBtn')?.addEventListener('click', ()=>{ try{ const d = dom('notesDrawer'); if(!d) return; d.classList.remove('open'); d.setAttribute('aria-hidden','true'); }catch(e){} });
    dom('btnSaveNotes')?.addEventListener('click', ()=>{ try{ const txt = dom('notesArea')?.value || ''; save('notes', txt); showToast('Notes saved'); }catch(e){} });
    // Auto-save notes disabled to stop retaining info
    // dom('notesArea')?.addEventListener('input', ()=>{ try{ if(getPassword() && !isUnlocked){ return; } const txt = dom('notesArea')?.value || ''; save('notes', txt); }catch(e){} });
    dom('btnClearNotes')?.addEventListener('click', ()=>{ try{ if(!confirm('Clear notes for this Owner & Year?')) return; dom('notesArea').value = ''; save('notes', ''); showToast('Notes cleared'); }catch(e){} });


    function storageDiagnostics(){
      console.log('=== Storage Diagnostics: monthData keys ===');
      for(let i=0; i<localStorage.length; i++){
        const key = localStorage.key(i);
        if(key && key.endsWith(':monthData')){
          const val = localStorage.getItem(key);
          const len = val ? val.length : 0;
          const preview = val ? val.substring(0, 100) + (val.length > 100 ? '...' : '') : 'null';
          console.log(`Key: ${key}, Length: ${len}, Preview: ${preview}`);
        }
      }
      console.log('=== End Diagnostics ===');
    }

    // === Initialization ===
    async function initAll(){
  storageDiagnostics();
  updateYearDataLabel(ownerSel && ownerSel.value, yearSel.value);
  // Ensure label offset respects owner (default to 0)
  try{ yearDataLabel.style.left = (ownerSel && ownerSel.value === 'MADUR_ENBD') ? '0.5cm' : '0'; }catch(e){}
      try{
        console.debug('initAll: current prefixed monthData:', localStorage.getItem(`${keyPrefix()}:monthData`));
        for(let i=0;i<localStorage.length;i++){ const k = localStorage.key(i); if(k && k.endsWith(':monthData')) console.debug('initAll: found monthData key', k); }
      }catch(e){}
  buildTable();
  recompute();
  try{ await drawChart(); }catch(e){}
  renderRems();
  buildShareText();
  updatePasswordFields();
  applyPasswordStorageAvailability();
  try{ if(typeof updateUI === 'function') updateUI(); }catch(e){}
    }
  // update badge as early as possible
  updateRemBadgeImmediate();
    // Defensive: re-run renderRems shortly after load in case storage/migration finished slightly later
    setTimeout(()=>{
      try{ renderRems(); }catch(e){}
    }, 250);
    // Update reminders when the page regains focus (covers some browser reload/restore cases)
    window.addEventListener('focus', ()=>{ try{ renderRems(); }catch(e){} });
    // Respond to storage events from other tabs/windows (migrate/update badge when reminders updated elsewhere)
    window.addEventListener('storage', (ev)=>{
      try{
        if(!ev.key) return;
        if(ev.key.startsWith('enbd:') && ev.key.endsWith(':reminders')) renderRems();
      }catch(e){}
    });

    // Password protection
    function safeLocalGet(key){
      if(!storageAvailable()){
        return { ok: false, value: null, error: STORAGE_STATUS.error || new Error('Local storage unavailable') };
      }
      try{
        return { ok: true, value: localStorage.getItem(key) };
      }catch(error){
        console.error('localStorage get failed for', key, error);
        return { ok: false, value: null, error };
      }
    }
    function safeLocalSet(key, value){
      if(!storageAvailable()){
        return { ok: false, error: STORAGE_STATUS.error || new Error('Local storage unavailable') };
      }
      try{
        if(value === null || value === undefined){
          localStorage.removeItem(key);
        } else {
          localStorage.setItem(key, value);
        }
        return { ok: true };
      }catch(error){
        console.error('localStorage set failed for', key, error);
        return { ok: false, error };
      }
    }
    function getPassword(){
      // Password protection disabled - always return empty
      return '';
    }
    function setPassword(p){
      const value = p ? String(p) : null;
      return safeLocalSet('enbd:password', value);
    }
    function updatePasswordFields(){
      const existing = getPassword();
      const currentInput = dom('currentPassword');
      if(existing){
        currentInput.style.display = 'block';
      } else {
        currentInput.style.display = 'none';
      }
    }
    const PASSWORD_STORAGE_DISABLED_MSG = 'Password protection is unavailable because this browser is blocking local storage. In Microsoft Edge, enable “Allow sites to save and read cookie data” (Settings → Cookies and site permissions) or open the tracker in a trusted site context.';
    function applyPasswordStorageAvailability(){
      const controls = ['currentPassword','newPassword','btnSavePassword','btnRemovePassword'];
      const notice = dom('passwordStorageNotice');
      if(storageAvailable()){
        controls.forEach(id => {
          const el = dom(id);
          if(el){ el.disabled = false; el.classList.remove('disabled-password'); }
        });
        if(notice){ notice.style.display = 'none'; notice.textContent = ''; }
      } else {
        controls.forEach(id => {
          const el = dom(id);
          if(el){ el.disabled = true; el.classList.add('disabled-password'); }
        });
        if(notice){ notice.style.display = 'block'; notice.textContent = PASSWORD_STORAGE_DISABLED_MSG; }
      }
    }
    function checkPasswordOnLoad(){
      // Password check disabled - always allow access
      return;
    }
    applyPasswordStorageAvailability();
    dom('btnSavePassword').addEventListener('click', () => {
      if(!storageAvailable()){
        alert(PASSWORD_STORAGE_DISABLED_MSG);
        return;
      }
      const current = dom('currentPassword').value;
      const newP = dom('newPassword').value.trim();
      const existing = getPassword();
      if(existing && current !== existing){
        alert('Current password is incorrect.');
        return;
      }
      if(!newP){
        alert('Please enter a new password.');
        return;
      }
      const saveResult = setPassword(newP);
      if(!saveResult.ok){
        alert('Unable to save the password in this browser. Please enable “Allow sites to save and read data (cookies)” or run the tracker from a trusted folder/HTTPS. Error: ' + String(saveResult.error?.message || saveResult.error || 'unknown'));
        return;
      }
      alert('Password updated successfully.');
      // Clear fields
      dom('currentPassword').value = '';
      dom('newPassword').value = '';
      updatePasswordFields();
    });
    dom('btnRemovePassword').addEventListener('click', () => {
      if(!storageAvailable()){
        alert(PASSWORD_STORAGE_DISABLED_MSG);
        return;
      }
      const current = dom('currentPassword').value;
      const existing = getPassword();
      if(existing && current !== existing){
        alert('Current password is incorrect.');
        return;
      }
      const clearResult = setPassword('');
      if(!clearResult.ok){
        alert('Unable to remove the password in this browser. Please adjust Edge privacy settings to allow local data. Error: ' + String(clearResult.error?.message || clearResult.error || 'unknown'));
        return;
      }
      alert('Password removed.');
      dom('currentPassword').value = '';
      updatePasswordFields();
    });
    dom('passwordForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const p = dom('passwordInput').value;
      if(p === getPassword()){
        isUnlocked = true;
        dom('passwordOverlay').classList.remove('show');
        dom('passwordOverlay').setAttribute('aria-hidden','true');
        dom('passwordInput').blur();
      } else {
        alert('Incorrect password');
      }
    });
    dom('btnClosePassword').addEventListener('click', () => {
      dom('passwordOverlay').classList.remove('show');
      dom('passwordOverlay').setAttribute('aria-hidden','true');
      dom('passwordInput').blur();
    });
    // Check on load
    // checkPasswordOnLoad(); // Removed to not prompt on refresh

    // Global error handlers to capture uncaught exceptions and unhandled rejections
    window.onerror = function(msg, url, line, col, error) {
      appendRemDebug('global error: ' + msg + ' at ' + url + ':' + line + ':' + col + ' ' + String(error));
    };
    window.onunhandledrejection = function(event) {
      appendRemDebug('unhandled promise rejection: ' + String(event.reason));
    };

    // Global key handlers: close overlays/drawers on Escape
    document.addEventListener('keydown', (ev) => {
      try{
        if(ev.key !== 'Escape') return;
        // Close reminders drawer
        const rem = dom('reminderDrawer'); if(rem && rem.classList.contains('open')) rem.classList.remove('open');
        // Close notes drawer
        const notes = dom('notesDrawer'); if(notes && notes.classList.contains('open')) { notes.classList.remove('open'); notes.setAttribute('aria-hidden','true'); }
        // Close common overlays
        const overlays = ['aiOverlay','scenarioOverlay','shareOverlay','emailOverlay','ownersOverlay','passwordOverlay','duplicateOwnerOverlay'];
        overlays.forEach(id=>{ const o = dom(id); if(o && o.classList.contains('show')) { o.classList.remove('show'); o.setAttribute('aria-hidden','true'); if(id === 'passwordOverlay') dom('passwordInput').blur(); } });
        // Close right icon set if open
        const rightSet = dom('rightIconSet'); if(rightSet && rightSet.classList.contains('open')) rightSet.classList.remove('open');
      }catch(e){ console.debug('global Escape handler failed', e); }
    });

    // === Scenario Planner JS ===
    // Open/close handlers
    dom('btnScenarioClose')?.addEventListener('click', ()=>{ dom('scenarioOverlay').classList.remove('show'); dom('scenarioOverlay').setAttribute('aria-hidden','true'); });
    dom('btnScenarioClose2')?.addEventListener('click', ()=>{ dom('scenarioOverlay').classList.remove('show'); dom('scenarioOverlay').setAttribute('aria-hidden','true'); });
    // add a toolbar button to open planner (re-use existing right icon set)
    (function(){
      // ensure the Scenario button exists and is wired; attach listener even if the button is static in HTML
      let btn = document.getElementById('btnScenario');
  const ensureInsert = () => { const set = dom('rightIconSet'); if(set && !btn){ btn = document.createElement('button'); btn.className='btn'; btn.id='btnScenario'; btn.textContent='Scenarios'; btn.title='Open Scenarios'; set.insertBefore(btn, set.firstChild); } };
      ensureInsert();
      if(!btn) return;
      if(!btn.dataset.scenarioWired){ btn.addEventListener('click', ()=>{
        dom('scenarioOverlay').classList.add('show'); dom('scenarioOverlay').setAttribute('aria-hidden','false');
        // pre-warm Chart.js in background to reduce delay when creating charts
        try{
            if(typeof Chart === 'undefined' && !btn.dataset.chartPrewarm){
            btn.dataset.chartPrewarm = '1';
            console.debug('Chart.js should already be loaded directly');
          }
        }catch(e){ console.debug('prewarm Chart.js failed', e); }
        setTimeout(()=> dom('scMonthlyIncrease')?.focus(), 120);
      }); btn.dataset.scenarioWired = '1'; }
    })();

    // add a print button
    (function(){
      // ensure the Print button exists and is wired; attach listener even if the button is static in HTML
      let btn = document.getElementById('btnPrint');
      const ensureInsert = () => { const set = dom('rightIconSet'); if(set && !btn){ btn = document.createElement('button'); btn.className='btn'; btn.id='btnPrint'; btn.textContent='Print'; btn.title='Print the page'; set.insertBefore(btn, set.firstChild); } };
      ensureInsert();
      if(!btn) return;
      if(!btn.dataset.wired){ btn.addEventListener('click', ()=>{
        // Save current data before printing
        const months = getMonthData();
        const tbody = document.querySelector('#monthTable tbody');
        if(tbody){
          const rows = Array.from(tbody.querySelectorAll('tr'));
          rows.forEach((r, idx) => {
            if(months[idx]){
              const dayInp = r.cells[0].querySelector('input');
              if(dayInp) months[idx].day = dayInp.value;
              const targetInp = r.cells[2].querySelector('input');
              if(targetInp) months[idx].target = parseNum(targetInp.value);
              const noteInp = r.cells[3].querySelector('input');
              if(noteInp) months[idx].note = noteInp.value;
              const inflowInp = r.cells[4].querySelector('input');
              if(inflowInp) months[idx].outflow = parseNum(inflowInp.value);
            }
          });
        }
        // Save opening balance
        const obInp = dom('openingBalance');
        if(obInp) save('openingBalance', Number(obInp.value.replace(/,/g,'')||0));
        saveMonthData(months);
        recompute();
        
        // ===== FORCE PRINT STYLES VIA JAVASCRIPT =====
        // Create a print-friendly version
        const printWin = window.open('', '_blank');
        const title = document.querySelector('h1')?.textContent || 'ENBD Performance Tracker';
        const owner = document.getElementById('owner')?.value || document.querySelector('.y-owner')?.textContent?.trim() || '';
        const year = document.getElementById('year')?.value || document.querySelector('.y-year')?.textContent?.trim() || '';
        
        // Gather KPI data
        const kpis = [];
        document.querySelectorAll('.kpi').forEach(kpi => {
          const label = kpi.querySelector('h3')?.textContent || '';
          const val = kpi.querySelector('.val')?.textContent || '';
          if(label && val) kpis.push({label, val});
        });
        
        // Gather table data
        const tableRows = [];
        const headerCells = [];
        document.querySelectorAll('#monthTable thead th').forEach(th => {
          headerCells.push(th.textContent.trim());
        });
        document.querySelectorAll('#monthTable tbody tr').forEach(tr => {
          const row = [];
          tr.querySelectorAll('td').forEach(td => {
            const inp = td.querySelector('input');
            row.push(inp ? inp.value : td.textContent.trim());
          });
          tableRows.push(row);
        });
        
        // Build print HTML
        let html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Print - ${title}</title>
        <style>
          * { margin: 0; padding: 0; box-sizing: border-box; }
          body { font-family: Arial, sans-serif; padding: 8mm; background: white; color: black; }
          .owner-header { font-size: 9pt; text-align: left; margin-bottom: 4mm; color: #000; font-weight: 700; border-bottom: 1px solid #ccc; padding-bottom: 2mm; }
          h1 { font-size: 15pt; text-align: center; margin-bottom: 3mm; font-weight: 900; }
          .kpis { display: flex; flex-wrap: wrap; gap: 2mm; justify-content: center; margin-bottom: 6mm; }
          .kpi { flex: 0 0 22%; border: 1px solid black; padding: 3mm; text-align: center; }
          .kpi-label { font-size: 6pt; font-weight: 700; text-transform: uppercase; margin-bottom: 1mm; }
          .kpi-val { font-size: 12pt; font-weight: 900; }
          table { width: 100%; border-collapse: collapse; margin-top: 5mm; }
          th, td { border: 1px solid black; padding: 2mm; font-size: 8pt; text-align: center; }
          th { background: #eee; font-weight: 900; font-size: 7pt; }
          td { font-weight: 600; font-size: 8pt; }
          @page { margin: 6mm; size: A4; }
        </style></head><body>`;
        
        // Owner header FIRST
        if(owner || year) html += `<div class="owner-header">${owner} Year Data: ${year}</div>`;
        html += `<h1>${title}</h1>`;
        
        // KPIs
        html += '<div class="kpis">';
        kpis.forEach(k => {
          html += `<div class="kpi"><div class="kpi-label">${k.label}</div><div class="kpi-val">${k.val}</div></div>`;
        });
        html += '</div>';
        
        // Table
        if(headerCells.length && tableRows.length) {
          html += '<table><thead><tr>';
          headerCells.forEach(h => html += `<th>${h}</th>`);
          html += '</tr></thead><tbody>';
          tableRows.forEach(row => {
            html += '<tr>';
            row.forEach(cell => html += `<td>${cell}</td>`);
            html += '</tr>';
          });
          html += '</tbody></table>';
        }
        
        html += `<script>window.onload = function(){ window.print(); }<\/script></body></html>`;
        
        printWin.document.write(html);
        printWin.document.close();
      }); }
    })();

    // add a Save as PDF button (uses html2canvas + jsPDF). Avoid adding if already exists.
    (function(){
      // ensure Save PDF button exists and is wired
      let btn = document.getElementById('btnSavePDF');
      const ensureInsert = () => { const set = dom('rightIconSet'); if(set && !btn){ btn = document.createElement('button'); btn.className='btn'; btn.id='btnSavePDF'; btn.textContent='Save PDF'; btn.title='Save page as PDF'; set.insertBefore(btn, set.firstChild); } };
      ensureInsert();
      if(!btn) return;
      // Always attach the click listener idempotently. Some builds include data-wired in markup which prevented wiring earlier.
      const attach = () => {
        if(btn._pdfHandlerAttached) return; // already attached in this session
        // Pre-warm PDF libraries in background to reduce chance of failure on click
        try{
          console.debug('html2canvas should already be loaded directly');
        }catch(e){ console.debug('skip prewarm check', e); }
        try{
          console.debug('jsPDF should already be loaded directly');
        }catch(e){ console.debug('prewarm jsPDF error', e); }

        btn.addEventListener('click', async () => {
          try{
            // Save current form data to storage before capturing
            const months = getMonthData();
            const tbody = document.querySelector('#monthTable tbody');
            if(tbody){
              const rows = Array.from(tbody.querySelectorAll('tr'));
              rows.forEach((r, idx) => {
                if(months[idx]){
                  const dayInp = r.cells[0].querySelector('input'); if(dayInp) months[idx].day = dayInp.value;
                  const targetInp = r.cells[2].querySelector('input'); if(targetInp) months[idx].target = parseNum(targetInp.value);
                  const noteInp = r.cells[3].querySelector('input'); if(noteInp) months[idx].note = noteInp.value;
                  const inflowInp = r.cells[4].querySelector('input'); if(inflowInp) months[idx].outflow = parseNum(inflowInp.value);
                }
              });
            }
            const obInp = dom('openingBalance'); if(obInp) save('openingBalance', Number(obInp.value.replace(/,/g,'')||0));
            saveMonthData(months);
            recompute();
            
            // ===== CREATE PDF DIRECTLY USING jsPDF =====
            const title = document.querySelector('h1')?.textContent || 'ENBD Performance Tracker';
            const owner = document.getElementById('owner')?.value || document.querySelector('.y-owner')?.textContent?.trim() || '';
            const year = document.getElementById('year')?.value || document.querySelector('.y-year')?.textContent?.trim() || '';
            
            // Gather KPI data
            const kpis = [];
            document.querySelectorAll('.kpi').forEach(kpi => {
              const label = kpi.querySelector('h3')?.textContent || '';
              const val = kpi.querySelector('.val')?.textContent || '';
              if(label && val) kpis.push({label, val});
            });
            
            // Gather table data
            const tableRows = [];
            const headerCells = [];
            document.querySelectorAll('#monthTable thead th').forEach(th => {
              headerCells.push(th.textContent.trim());
            });
            document.querySelectorAll('#monthTable tbody tr').forEach(tr => {
              const row = [];
              tr.querySelectorAll('td').forEach(td => {
                const inp = td.querySelector('input');
                row.push(inp ? inp.value : td.textContent.trim());
              });
              tableRows.push(row);
            });
            
            // Use jsPDF to create PDF
            const jsPDF = window.jspdf?.jsPDF || window.jsPDF;
            if(!jsPDF) {
              alert('PDF library not loaded. Please refresh the page.');
              return;
            }
            
            const doc = new jsPDF('p', 'mm', 'a4');
            const pageWidth = doc.internal.pageSize.getWidth();
            let y = 15;
            
            // Owner header
            if(owner || year) {
              doc.setFontSize(9);
              doc.setFont('helvetica', 'bold');
              doc.text(`${owner} Year Data: ${year}`, 10, y);
              doc.setDrawColor(200);
              doc.line(10, y + 2, pageWidth - 10, y + 2);
              y += 8;
            }
            
            // Title
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text(title, pageWidth / 2, y, { align: 'center' });
            y += 10;
            
            // KPIs - 4 per row
            doc.setFontSize(6);
            const kpiWidth = 45;
            const kpiHeight = 18;
            const kpiGap = 3;
            const startX = 10;
            let kpiX = startX;
            let kpiY = y;
            
            kpis.forEach((k, i) => {
              if(i > 0 && i % 4 === 0) {
                kpiX = startX;
                kpiY += kpiHeight + kpiGap;
              }
              
              // KPI box
              doc.setDrawColor(0);
              doc.rect(kpiX, kpiY, kpiWidth, kpiHeight);
              
              // Label
              doc.setFontSize(5);
              doc.setFont('helvetica', 'bold');
              doc.text(k.label.toUpperCase(), kpiX + kpiWidth/2, kpiY + 4, { align: 'center' });
              
              // Value
              doc.setFontSize(10);
              doc.text(k.val, kpiX + kpiWidth/2, kpiY + 12, { align: 'center' });
              
              kpiX += kpiWidth + kpiGap;
            });
            
            y = kpiY + kpiHeight + 10;
            
            // Table
            if(headerCells.length && tableRows.length) {
              const colWidth = (pageWidth - 20) / headerCells.length;
              const rowHeight = 7;
              
              // Header
              doc.setFillColor(230, 230, 230);
              doc.rect(10, y, pageWidth - 20, rowHeight, 'F');
              doc.setFontSize(6);
              doc.setFont('helvetica', 'bold');
              headerCells.forEach((h, i) => {
                doc.text(h, 10 + i * colWidth + colWidth/2, y + 5, { align: 'center' });
              });
              doc.rect(10, y, pageWidth - 20, rowHeight);
              y += rowHeight;
              
              // Data rows
              doc.setFont('helvetica', 'normal');
              doc.setFontSize(7);
              tableRows.forEach(row => {
                if(y > 270) { // New page if needed
                  doc.addPage();
                  y = 15;
                }
                row.forEach((cell, i) => {
                  doc.text(String(cell).substring(0, 15), 10 + i * colWidth + colWidth/2, y + 5, { align: 'center' });
                });
                doc.rect(10, y, pageWidth - 20, rowHeight);
                // Column lines
                for(let i = 1; i < headerCells.length; i++) {
                  doc.line(10 + i * colWidth, y, 10 + i * colWidth, y + rowHeight);
                }
                y += rowHeight;
              });
            }
            
            // Save the PDF
            const filename = `ENBD_${owner || 'Report'}_${year || 'Data'}.pdf`;
            doc.save(filename);
            showToast && showToast('PDF saved: ' + filename);
          }catch(err){ console.error('Save PDF failed', err); alert('Save as PDF failed: ' + String(err)); }
        });
        btn._pdfHandlerAttached = true;
      };
      attach();
      btn.dataset.wired = '1';
    })();

    async function runScenario(){
      try{
        // Minimal debug function - only log errors
        const dbg = (msg) => { 
          // Only log to console, not to UI debug area to avoid leaks
          console.debug('[Scenario]', msg); 
        };
        
        const monthsAhead = Number(dom('scMonthsAhead').value||4);
        const monthlyInc = Number(dom('scMonthlyIncrease').value||0);
        const oneOff = Number(dom('scOneOff').value||0);
        const newTargetRaw = Number(dom('scNewTarget').value||0) || 0;
        const growthPct = Number(dom('scGrowthRate').value||0)/100;
        const sims = Math.max(100, Number(dom('scSims').value||1000));
        
        const months = (typeof getMonthData === 'function') ? getMonthData() : [];
        const vals = months.map(m=> Number(m.outflow||0));
        const current = currentMonthIdx;
        
        // CRITICAL: Current month data is NEVER available - it's entered in first few days of NEXT month
        const monthsPassed = current; // Only count months before current (exclude current month - no data yet)
        const inflowYTD = vals.slice(0, monthsPassed).reduce((a,b)=>a+b,0);
        const annualTarget = Number(load('yearTarget', 0));
        const totalTarget = newTargetRaw || annualTarget;
        
        // ACCURATE TIME CALCULATIONS for Dec 31st deadline
        const now = new Date();
        const yearNum = Number(yearSel.value || now.getFullYear());
        const yearEnd = new Date(yearNum, 11, 31, 23, 59, 59); // Dec 31 end of year
        
        const daysToYearEnd = Math.max(0, Math.ceil((yearEnd - now) / (1000 * 60 * 60 * 24)));
        const monthsRemainingForAchievement = 12 - current; // months from current to December inclusive
        const effectiveMonthsLeft = Math.max(1, monthsRemainingForAchievement);
        
        // Base performance calculations - exclude zero months from average
        const valsScenario = months.map(m => Number(m.outflow||0) || 0);
        const nonZeroInflowsScenario = valsScenario.slice(0, monthsPassed).filter(v => v > 0);
        const avgMonthlyInflow = nonZeroInflowsScenario.length > 0 ? (nonZeroInflowsScenario.reduce((a,b)=>a+b,0) / nonZeroInflowsScenario.length) : 0;
        const remainingNeeded = Math.max(0, totalTarget - inflowYTD);
        const requiredMonthlyRate = remainingNeeded / effectiveMonthsLeft;

        // SCENARIO PROJECTIONS with accurate time handling
        const muls = getScenarioMultipliers();
        const variants = [
          { name: 'Pessimistic', multiplier: muls.mulP },
          { name: 'Conservative', multiplier: muls.mulC },
          { name: 'Base', multiplier: muls.mulB },
          { name: 'Optimistic', multiplier: muls.mulO },
          { name: 'Stretch', multiplier: muls.mulO * 1.25 }
        ];

        function calculateScenarioProjection(variant) {
          const multiplier = variant.multiplier;
          let projectedInflow = 0;
          let monthlyData = [];
          
          // Apply changes for the monthsAhead period
          for(let m = 0; m < Math.min(monthsAhead, effectiveMonthsLeft); m++) {
            const growthFactor = Math.pow(1 + growthPct, m);
            let monthlyAmount = avgMonthlyInflow * multiplier;
            monthlyAmount += monthlyInc * growthFactor;
            if (m === 0) monthlyAmount += oneOff;
            
            monthlyData.push(Math.round(monthlyAmount));
            projectedInflow += monthlyAmount;
          }
          
          // For remaining months beyond monthsAhead, use base average
          const remainingMonths = Math.max(0, effectiveMonthsLeft - monthsAhead);
          projectedInflow += (avgMonthlyInflow * multiplier) * remainingMonths;
          
          const totalProjectedYearEnd = inflowYTD + projectedInflow;
          const shortfall = Math.max(0, totalTarget - totalProjectedYearEnd);
          const avgMonthlyForPeriod = effectiveMonthsLeft > 0 ? (projectedInflow / effectiveMonthsLeft) : 0;
          
          return {
            multiplier,
            projectedYearEnd: totalProjectedYearEnd,
            shortfall: shortfall,
            avgMonthly: avgMonthlyForPeriod,
            monthlyData: monthlyData
          };
        }

        const scenarioResults = variants.map(v => {
          const result = calculateScenarioProjection(v);
          return {
            name: v.name,
            multiplier: v.multiplier,
            avg: Math.round(result.avgMonthly),
            exp: Math.round(result.projectedYearEnd),
            short: Math.round(result.shortfall),
            monthlyData: result.monthlyData
          };
        });

        // Build scenario comparison table
        const out = [];
        const col1 = 14, col2 = 12, col3 = 16, col4 = 14;
        const pad = (s, w, right=false) => {
          const str = String(s);
          if(right) return str.padStart(w, ' ');
          return str.padEnd(w, ' ');
        };
        
        const tbl = [];
        tbl.push(pad('Kind', col1) + '|' + pad('Avg/mo', col2, true) + ' | ' + pad('Exp Year-End', col3, true) + ' | ' + pad('Shortfall', col4, true));
        tbl.push('-'.repeat(col1) + '+' + '-'.repeat(col2+2) + '+' + '-'.repeat(col3+2) + '+' + '-'.repeat(col4+1));
        scenarioResults.forEach(r => {
          tbl.push(pad(r.name, col1) + '|' + pad(fmtAcc(r.avg), col2, true) + ' | ' + pad(fmtAcc(r.exp), col3, true) + ' | ' + pad(fmtAcc(r.short), col4, true));
        });

        out.unshift('');
        out.unshift(tbl.join('\n'));
        out.unshift('Scenario comparison (to Dec 31st):');
        out.unshift('');

        // MONTE CARLO SIMULATION with accurate variance handling
        const baseScenario = scenarioResults.find(s => s.name === 'Base');
        const histVars = months.slice(0, monthsPassed).map(m => parseNum(m.variance || 0)).filter(v => !isNaN(v) && v !== 0);
        let meetCount = 0;
        
        if (histVars.length > 0 && totalTarget > 0) {
          const mean = histVars.reduce((a,b) => a+b, 0) / histVars.length;
          const variance = histVars.reduce((a,b) => a + Math.pow(b-mean, 2), 0) / histVars.length;
          const stdDev = Math.sqrt(variance);
          
          for(let sim = 0; sim < sims; sim++) {
            let totalInflow = inflowYTD;
            
            for(let m = 0; m < effectiveMonthsLeft; m++) {
              let monthlyInflow = avgMonthlyInflow;
              
              // Apply scenario changes for first monthsAhead months
              if (m < monthsAhead) {
                const growthFactor = Math.pow(1 + growthPct, m);
                monthlyInflow += monthlyInc * growthFactor;
                if (m === 0) monthlyInflow += oneOff;
              }
              
              // Add random variance based on historical pattern
              const randomVariance = mean + stdDev * (Math.sqrt(-2 * Math.log(Math.random())) * Math.cos(2 * Math.PI * Math.random()));
              monthlyInflow += randomVariance;
              
              totalInflow += Math.max(0, monthlyInflow); // Don't allow negative months
            }
            
            if (totalInflow >= totalTarget) meetCount++;
          }
        }
        
        const meetProb = (histVars.length > 0 && totalTarget > 0) ? Math.round(1000 * meetCount / sims) / 10 : 'insufficient history';
        
        // GENERATE COMPREHENSIVE ACTION OPTIONS 
        const actualShortfall = baseScenario ? baseScenario.short : remainingNeeded;
        const actions = [];
        
        if (actualShortfall > 0) {
          // Basic catch-up strategies
          const flatPerMonth = Math.ceil(actualShortfall / effectiveMonthsLeft);
          actions.push({ 
            label: `Flat: +${fmtAcc(flatPerMonth)} AED/month for ${effectiveMonthsLeft} months (${Math.round((flatPerMonth/(avgMonthlyInflow||1))*100)}% above avg)`, 
            value: flatPerMonth 
          });
          
          actions.push({ 
            label: `One-off: ${fmtAcc(actualShortfall)} AED as single deposit`, 
            value: actualShortfall 
          });
          
          // Split approaches
          const frontOneOff = Math.ceil(actualShortfall * 0.6);
          const frontMonthly = Math.ceil((actualShortfall - frontOneOff) / Math.max(1, effectiveMonthsLeft - 1));
          actions.push({ 
            label: `Front-loaded: ${fmtAcc(frontOneOff)} AED next month + ${fmtAcc(frontMonthly)} AED/month after`, 
            value: null 
          });
          
          const backOneOff = Math.ceil(actualShortfall * 0.4);
          const backMonthly = Math.ceil((actualShortfall - backOneOff) / Math.max(1, effectiveMonthsLeft - 1));
          actions.push({ 
            label: `Back-loaded: ${fmtAcc(backMonthly)} AED/month then ${fmtAcc(backOneOff)} AED final month`, 
            value: null 
          });
          
          // Conservative vs Aggressive
          const conservativeMonthly = Math.ceil(actualShortfall / Math.max(1, effectiveMonthsLeft - 1));
          actions.push({ 
            label: `Conservative: ${fmtAcc(conservativeMonthly)} AED/month (1-month buffer)`, 
            value: null 
          });
          
          const urgentMonths = Math.min(2, effectiveMonthsLeft);
          const urgentMonthly = Math.ceil(actualShortfall / urgentMonths);
          actions.push({ 
            label: `Aggressive: ${fmtAcc(urgentMonthly)} AED/month for next ${urgentMonths} months only`, 
            value: null 
          });
          
          // Step approaches
          const stepAmount = Math.ceil(flatPerMonth / Math.max(1, effectiveMonthsLeft - 1));
          actions.push({ 
            label: `Stepped: Start ${fmtAcc(stepAmount)} then increase ${fmtAcc(stepAmount)} each month`, 
            value: null 
          });
          
          // Efficiency boost
          const efficiencyBoost = Math.round(avgMonthlyInflow * 0.15);
          const efficiencyMonths = Math.ceil(actualShortfall / efficiencyBoost);
          actions.push({ 
            label: `Efficiency: +15% performance boost (${fmtAcc(efficiencyBoost)}/month) for ${Math.min(efficiencyMonths, effectiveMonthsLeft)} months`, 
            value: null 
          });
          
        } else {
          // Even when on track, provide optimization and buffer strategies
          const bufferAmount = Math.round(totalTarget * 0.1); // 10% buffer
          actions.push({ 
            label: `On Track: Current pace achieves target (no action needed)`, 
            value: 0 
          });
          
          actions.push({ 
            label: `Safety Buffer: Add ${fmtAcc(bufferAmount)} AED total for 10% cushion`, 
            value: Math.ceil(bufferAmount / effectiveMonthsLeft) 
          });
          
          actions.push({ 
            label: `Early Completion: +20% effort to finish ${Math.round(effectiveMonthsLeft * 0.2)} months early`, 
            value: Math.ceil(avgMonthlyInflow * 0.2) 
          });
          
          actions.push({ 
            label: `Maintenance: Continue ${fmtAcc(Math.round(avgMonthlyInflow))}/month current pace`, 
            value: null 
          });
          
          // Optimization strategies even when ahead
          const optimizeAmount = Math.round(avgMonthlyInflow * 0.1);
          actions.push({ 
            label: `Optimize: Small +10% improvement (${fmtAcc(optimizeAmount)}/month) for stronger finish`, 
            value: optimizeAmount 
          });
          
          actions.push({ 
            label: `Stretch Goal: Aim for ${fmtAcc(Math.round(totalTarget * 1.15))} (15% above target)`, 
            value: Math.ceil((totalTarget * 0.15) / effectiveMonthsLeft) 
          });
        }

        // GENERATE COMPREHENSIVE SCENARIO REPORT
        out.push('🎯 COMPREHENSIVE SCENARIO ANALYSIS');
        out.push('');
        
        // Current Performance Summary
        out.push('📊 CURRENT PERFORMANCE:');
        out.push(`• YTD Inflow (${monthsPassed} months): ${fmtAcc(inflowYTD)}`);
        out.push(`• Monthly Average: ${fmtAcc(Math.round(avgMonthlyInflow))}`);
        out.push(`• Total Target: ${totalTarget > 0 ? fmtAcc(totalTarget) : 'Not Set'}`);
        out.push(`• Remaining Needed: ${fmtAcc(remainingNeeded)}`);
        out.push(`• Required Monthly Rate: ${totalTarget > 0 ? fmtAcc(Math.round(requiredMonthlyRate)) : 'N/A'}`);
        if (totalTarget > 0) {
          const performanceGap = avgMonthlyInflow > 0 ? (requiredMonthlyRate / avgMonthlyInflow) : 1;
          out.push(`• Performance Gap: ${performanceGap > 1 ? '+' : ''}${Math.round((performanceGap - 1) * 100)}% ${performanceGap > 1 ? 'increase needed' : 'ahead of pace'}`);
        }
        out.push('');
        
        // Time Analysis
        out.push('⏰ TIME ANALYSIS:');
        out.push(`• Current Date: ${new Date().toLocaleDateString()}`);
        out.push(`• Days to Dec 31st: ${daysToYearEnd} days`);
        out.push(`• Months Remaining: ${effectiveMonthsLeft} (including current)`);
        out.push(`• Year Progress: ${Math.round((current/12)*100)}% complete`);
        const urgencyLevel = daysToYearEnd <= 30 ? 'URGENT' : daysToYearEnd <= 90 ? 'HIGH' : 'MODERATE';
        out.push(`• Time Urgency: ${urgencyLevel}`);
        out.push('');
        
        // Scenario Changes Applied
        out.push('🔧 YOUR SCENARIO INPUTS:');
        out.push(`• Monthly Increase: ${monthlyInc >= 0 ? '+' : ''}${fmtAcc(monthlyInc)} AED`);
        out.push(`• One-off Addition: ${fmtAcc(oneOff)} AED (first month)`);
        out.push(`• Growth Rate: ${(growthPct*100).toFixed(1)}% per month`);
        out.push(`• Analysis Period: ${monthsAhead} months ahead`);
        out.push(`• Simulations Run: ${fmtAcc(sims)}`);
        if (newTargetRaw > 0) out.push(`• Override Target: ${fmtAcc(newTargetRaw)} AED`);
        out.push('');
        
        // Detailed Scenario Results
        out.push('📈 SCENARIO PROJECTIONS:');
        scenarioResults.forEach(r => {
          const status = r.short <= 0 ? '✅ Target Met' : `⚠️ ${fmtAcc(r.short)} short`;
          out.push(`• ${r.name}: ${fmtAcc(r.exp)} projected (${status})`);
        });
        out.push('');
        
        if (totalTarget > 0) {
          // Monte Carlo Results
          out.push('🎲 PROBABILITY ANALYSIS:');
          out.push(`• Success Probability: ${meetProb}%`);
          if (typeof meetProb === 'number') {
            if (meetProb >= 80) out.push('  📊 Assessment: Very Likely - Strong Position ✅');
            else if (meetProb >= 60) out.push('  📊 Assessment: Likely - Good Trajectory 🟢');
            else if (meetProb >= 40) out.push('  📊 Assessment: Uncertain - Monitor Closely ⏰');
            else if (meetProb >= 20) out.push('  📊 Assessment: Unlikely - Action Required ⚠️');
            else out.push('  📊 Assessment: Very Unlikely - Urgent Intervention 🚨');
            
            // Risk factors
            if (meetProb < 60) {
              out.push('  Risk Factors:');
              if (daysToYearEnd <= 90) out.push('    - Limited time remaining');
              if (requiredMonthlyRate > avgMonthlyInflow * 1.5) out.push('    - Significant performance increase needed');
              if (histVars.length < 3) out.push('    - Limited historical data for prediction');
            }
          } else {
            out.push('  📊 Assessment: Insufficient variance data for Monte Carlo analysis');
            out.push('  � Tip: Need 2+ months with variance data for probability calculations');
          }
          out.push('');
          
          // Strategic Recommendations
          out.push('💡 STRATEGIC RECOMMENDATIONS:');
          if (actualShortfall <= 0) {
            out.push('• Status: ON TRACK - Current performance sufficient');
            out.push('• Strategy: Monitor monthly progress and maintain consistency');
            out.push('• Opportunity: Consider stretch goals or early completion');
          } else if (actualShortfall < avgMonthlyInflow) {
            out.push('• Status: MINOR GAP - Small adjustment needed');
            out.push('• Strategy: Slight performance increase or single deposit');
            out.push('• Priority: LOW - manageable with minimal effort');
          } else if (actualShortfall < avgMonthlyInflow * 2) {
            out.push('• Status: MODERATE GAP - Focused effort required');
            out.push('• Strategy: Sustained increase or split approach');
            out.push('• Priority: MEDIUM - requires planning and execution');
          } else {
            out.push('• Status: SIGNIFICANT GAP - Major intervention needed');
            out.push('• Strategy: Aggressive deposits or fundamental change');
            out.push('• Priority: HIGH - immediate action critical');
          }
          out.push('');
          
          // Action Options
          out.push('⚡ ACTION OPTIONS:');
          actions.forEach((a, i) => out.push(`${i+1}. ${a.label}`));
          
        } else {
          out.push('⚠️  SET TOTAL TARGET to unlock:');
          out.push('   • Probability analysis');
          out.push('   • Strategic recommendations');
          out.push('   • Action options');
          out.push('   • Performance gap assessment');
        }
        
        out.push('');
        out.push('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
        out.push('📋 TECHNICAL NOTES:');
        
        // Add missing bank inflow analysis
        const missingInflowInfo = getMissingBankInflowAnalysis();
        out.push(`• ${missingInflowInfo.analysis}`);
        if(missingInflowInfo.hasMissing){
          out.push(`• ⚠️ ACTION REQUIRED: Update missing bank inflows for: ${missingInflowInfo.missingMonths.join(', ')}`);
        }
        
        out.push('• Current month data is entered in first few days of next month');
        out.push('• Target deadline: December 31st (firm date)');
        out.push('• Projections based on historical performance patterns');
        out.push('• Monte Carlo uses variance data from past months');
        out.push('• Base performance continues beyond scenario analysis period');
        out.push('• All amounts in AED currency');
        out.push(`• Analysis generated: ${new Date().toLocaleString()}`);

        // Store actions for UI
        window.__scActions = actions;
        populateActionSelect(actions);
        
        dom('scenarioOutput').textContent = out.join('\n');

        // CREATE CHART with accurate monthly projections
        const canvas = dom('scenarioChart');
        if(canvas && baseScenario && baseScenario.monthlyData){
          try{
            if(typeof Chart === 'undefined'){
              console.error('Chart.js library not loaded');
              throw new Error('Chart.js not available for scenario chart.');
            }
          }catch(loadErr){
            console.warn('Chart.js load failed', loadErr);
          }
          
          if(typeof Chart !== 'undefined'){
            try{
              if(window.scenarioChartInstance) window.scenarioChartInstance.destroy();
              
              const labels = [];
              for(let m = 0; m < Math.min(monthsAhead, 6); m++){
                const mi = (current + m) % 12;
                labels.push(shortMonth[mi]);
              }
              
              window.scenarioChartInstance = new Chart(canvas.getContext('2d'), {
                type: 'line',
                data: {
                  labels: labels,
                  datasets: [{
                    label: 'Projected Monthly Inflow',
                    data: baseScenario.monthlyData.slice(0, 6),
                    borderColor: '#7bd99f',
                    backgroundColor: 'rgba(123,217,159,0.1)',
                    tension: 0.3,
                    pointRadius: 4,
                    borderWidth: 2
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  scales: {
                    x: { title: { display: true, text: 'Month' } },
                    y: { title: { display: true, text: 'Inflow (AED)' }, ticks: { callback: function(value) { return 'AED ' + fmt(value); } } }
                  },
                  plugins: { 
                    legend: { display: true },
                    title: { display: true, text: 'Scenario Projection (Base Case)' }
                  }
                }
              });
            }catch(chartErr){
              console.error('Chart creation failed', chartErr);
            }
          }
        }
        
      }catch(err){
        const msg = 'Scenario analysis failed: ' + String(err);
        console.error(err);
        try{ dom('scenarioOutput').textContent = msg; }catch(_){ }
      }
    }

    // Wire run/reset/share handlers
    dom('btnRunScenario')?.addEventListener('click', async ()=>{
      const btn = dom('btnRunScenario'); if(btn) btn.textContent = 'Running…';
      try{
        // small delay to allow UI update, then await the async run
        await new Promise(r => setTimeout(r,60));
        await runScenario();
      }catch(e){ console.error('btnRunScenario handler error', e); try{ dom('scenarioOutput').textContent += '\n\n(Error running scenario: '+String(e)+')'; }catch(_){ } }
      finally{ if(btn) btn.textContent = 'Run Projection'; }
    });
    dom('btnResetScenario')?.addEventListener('click', ()=>{ dom('scMonthlyIncrease').value = 0; dom('scOneOff').value = 0; dom('scNewTarget').value=''; dom('scGrowthRate').value=0; dom('scMonthsAhead').value=4; dom('scSims').value=1000; dom('scenarioOutput').textContent=''; if(window.scenarioChartInstance) window.scenarioChartInstance.destroy(); window.scenarioChartInstance = null; });
    dom('btnScCopy')?.addEventListener('click', ()=>{ const rec = (dom('scShareRecipient')||{value:''}).value.trim(); const text = dom('scenarioOutput').textContent || ''; if(!text) { alert('Run a projection first'); return; } const final = rec ? (`Dear ${rec},\n\n` + text) : text; if(navigator.clipboard) navigator.clipboard.writeText(final).then(()=> alert('Scenario copied to clipboard')); else prompt('Copy scenario text:', final); });
    dom('btnScWhatsApp')?.addEventListener('click', ()=>{ const rec = (dom('scShareRecipient')||{value:''}).value.trim(); const text = dom('scenarioOutput').textContent || ''; if(!text) { alert('Run a projection first'); return; } const final = rec ? (`Dear ${rec},\n\n` + text) : text; window.open('https://wa.me/?text='+enc(final), '_blank'); });
    dom('btnScEmail')?.addEventListener('click', ()=>{ const rec = (dom('scShareRecipient')||{value:''}).value.trim(); const text = dom('scenarioOutput').textContent || ''; if(!text) { alert('Run a projection first'); return; } const subject = `Scenario Projection — ${ownerSel.value || ''} ${yearSel.value || ''}`; const body = rec ? (`Dear ${rec},\n\n` + text) : text; window.location.href = `mailto:?subject=${enc(subject)}&body=${enc(body)}`; });
    dom('btnScPrint')?.addEventListener('click', ()=>{ const rec = (dom('scShareRecipient')||{value:''}).value.trim(); const text = dom('scenarioOutput').textContent || ''; if(!text) { alert('Run a projection first'); return; } const final = rec ? (`Dear ${rec},\n\n` + text) : text; const w = window.open('', '_blank', 'width=720,height=900'); w.document.write(`<pre style="font:14px/1.6 monospace; white-space:pre-wrap; padding:20px">${final.replace(/[<>&]/g,c=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[c]))}</pre>`); w.document.close(); w.focus(); setTimeout(()=>{w.print(); w.close();}, 200); });

    // Populate action select dropdown
    function populateActionSelect(actions){
      const sel = dom('scActionSelect'); if(!sel) return;
      sel.innerHTML = '';
      const placeholder = document.createElement('option'); placeholder.value=''; placeholder.textContent='(Select an action to populate schedule)'; sel.appendChild(placeholder);
      actions.forEach((a, idx)=>{
        const opt = document.createElement('option'); opt.value = String(idx); opt.textContent = a.label; sel.appendChild(opt);
      });
    }

    // Build a month-by-month schedule for a selected action
    function buildScheduleForAction(actionIdx){
      const actions = window.__scActions || [];
      const a = actions[Number(actionIdx)];
      if(!a) return [];
      const monthsAhead = Math.max(1, Number(dom('scMonthsAhead').value||4));
      const months = [];
      const start = currentMonthIdx + 1; // start next month for schedule population
      // if action.value contains a numeric monthly amount, use it; otherwise attempt to parse label heuristically
      let monthly = null; let oneOff = 0;
      if(a.value && typeof a.value === 'number') monthly = a.value;
      else {
        // look for patterns like "+{number} AED / month" or "one-off {number}"
        const m1 = a.label.match(/\+?([0-9,]+) AED \/ month/);
        if(m1) monthly = parseNum(m1[1]);
        const m2 = a.label.match(/one-off[^0-9]*([0-9,]+)/i);
        if(m2) oneOff = parseNum(m2[1]);
      }
      // Distribute amounts across monthsAhead
      for(let i=0;i<monthsAhead;i++){
        const mi = (start + i) % 12;
        const name = monthNames[mi];
        let amt = 0;
        if(i===0 && oneOff) amt += oneOff;
        if(monthly !== null) amt += monthly;
        // fallback: if no monthly found but action label mentions a total, try splitting total evenly
        if(monthly === null && a.value === null){
          const totalMatch = a.label.match(/([0-9,]+) AED/);
          if(totalMatch){ const total = parseNum(totalMatch[1]); amt = Math.ceil(total / monthsAhead); }
        }
        months.push({ month: name, amount: amt });
      }
      return months;
    }

    function renderScheduleTable(schedule){
      const tbody = dom('scScheduleTable') && dom('scScheduleTable').querySelector('tbody'); if(!tbody) return;
      tbody.innerHTML = '';
      schedule.forEach(s=>{
        const tr = document.createElement('tr');
        const td1 = document.createElement('td'); td1.style.padding='6px'; td1.textContent = s.month;
        const td2 = document.createElement('td'); td2.style.padding='6px'; td2.style.textAlign='right'; td2.textContent = fmtAcc(s.amount);
        tr.appendChild(td1); tr.appendChild(td2); tbody.appendChild(tr);
      });
    }

    dom('btnPopulateSchedule')?.addEventListener('click', ()=>{
      const sel = dom('scActionSelect'); if(!sel) { alert('No actions available. Run projection first.'); return; }
      const idx = sel.value; if(!idx){ alert('Select an action first.'); sel.focus(); return; }
      const sched = buildScheduleForAction(idx);
      renderScheduleTable(sched);
    });

    dom('btnCopySchedule')?.addEventListener('click', ()=>{
      const tbody = dom('scScheduleTable') && dom('scScheduleTable').querySelector('tbody'); if(!tbody) return; const rows = Array.from(tbody.querySelectorAll('tr'));
      if(!rows.length){ alert('No schedule to copy. Populate schedule first.'); return; }
      const lines = rows.map(r=> `${r.cells[0].textContent.trim()}: AED ${r.cells[1].textContent.trim()}`);
      const txt = ['Schedule:', ...lines].join('\n');
      if(navigator.clipboard){ navigator.clipboard.writeText(txt).then(()=> alert('Schedule copied to clipboard')); }
      else { prompt('Copy schedule:', txt); }
    });

  });
</script>
<!-- Toast notification -->
<div class="toast" id="toast">Reset complete: Cleared 5 items for TAMADUR - 2025</div>
<!-- Yearly Calendar — Remarks (Popup) -->
<style>
  /* Yearly remarks month header colors */
  .mr-month-0{ color: #e63946; }   /* Jan - red */
  .mr-month-1{ color: #f77f00; }   /* Feb - orange */
  .mr-month-2{ color: #ffd166; }   /* Mar - yellow */
  .mr-month-3{ color: #06d6a0; }   /* Apr - green */
  .mr-month-4{ color: #118ab2; }   /* May - blue */
  .mr-month-5{ color: #073b4c; }   /* Jun - dark teal */
  .mr-month-6{ color: #9b5de5; }   /* Jul - purple */
  .mr-month-7{ color: #f15bb5; }   /* Aug - pink */
  .mr-month-8{ color: #00b4d8; }   /* Sep - cyan */
  .mr-month-9{ color: #ffa69e; }   /* Oct - coral */
  .mr-month-10{ color: #8ac926; }  /* Nov - lime */
  .mr-month-11{ color: #6a4c93; }  /* Dec - indigo */
</style>
<div aria-hidden="true" class="overlay" id="yearlyRemarksOverlayLite" style="display: none;">
<div aria-labelledby="yearlyRemarksTitleLite" aria-modal="true" class="pop" role="dialog">
<header>
<h3 id="yearlyRemarksTitleLite">Yearly Calendar — Remarks</h3>
<button class="btn" id="btnYearlyRemarksCloseLite">Close</button>
</header>
<div class="content">
<div style="margin-bottom:8px; display:flex; align-items:center; gap:8px;">
<label style="font-size:13px; color:var(--muted);">Recipient (optional):</label>
<input id="yrRemarksRecipient" placeholder="e.g., John Doe" style="flex:1; padding:6px 8px; border-radius:6px; border:1px solid #2a2a30; background:var(--panel-bg, #0b0b0c); color:var(--text);" type="text">
</div>
<div class="calendar-remarks-lite" id="calendarRemarksGridLite"><div class="month-card-lite"><h4 class="mr-month-0">January 2025</h4><button class="share-month-btn" title="Share this month&#39;s remarks" style="float: right; font-size: 18px; border: none; background: none; cursor: pointer; color: rgb(0, 123, 255); margin-left: 10px;">→</button><textarea id="remarkLite-0" placeholder="Remarks for January 2025"></textarea></div><div class="month-card-lite"><h4 class="mr-month-1">February 2025</h4><button class="share-month-btn" title="Share this month&#39;s remarks" style="float: right; font-size: 18px; border: none; background: none; cursor: pointer; color: rgb(0, 123, 255); margin-left: 10px;">→</button><textarea id="remarkLite-1" placeholder="Remarks for February 2025"></textarea></div><div class="month-card-lite"><h4 class="mr-month-2">March 2025</h4><button class="share-month-btn" title="Share this month&#39;s remarks" style="float: right; font-size: 18px; border: none; background: none; cursor: pointer; color: rgb(0, 123, 255); margin-left: 10px;">→</button><textarea id="remarkLite-2" placeholder="Remarks for March 2025"></textarea></div><div class="month-card-lite"><h4 class="mr-month-3">April 2025</h4><button class="share-month-btn" title="Share this month&#39;s remarks" style="float: right; font-size: 18px; border: none; background: none; cursor: pointer; color: rgb(0, 123, 255); margin-left: 10px;">→</button><textarea id="remarkLite-3" placeholder="Remarks for April 2025"></textarea></div><div class="month-card-lite"><h4 class="mr-month-4">May 2025</h4><button class="share-month-btn" title="Share this month&#39;s remarks" style="float: right; font-size: 18px; border: none; background: none; cursor: pointer; color: rgb(0, 123, 255); margin-left: 10px;">→</button><textarea id="remarkLite-4" placeholder="Remarks for May 2025"></textarea></div><div class="month-card-lite"><h4 class="mr-month-5">June 2025</h4><button class="share-month-btn" title="Share this month&#39;s remarks" style="float: right; font-size: 18px; border: none; background: none; cursor: pointer; color: rgb(0, 123, 255); margin-left: 10px;">→</button><textarea id="remarkLite-5" placeholder="Remarks for June 2025"></textarea></div><div class="month-card-lite"><h4 class="mr-month-6">July 2025</h4><button class="share-month-btn" title="Share this month&#39;s remarks" style="float: right; font-size: 18px; border: none; background: none; cursor: pointer; color: rgb(0, 123, 255); margin-left: 10px;">→</button><textarea id="remarkLite-6" placeholder="Remarks for July 2025"></textarea></div><div class="month-card-lite"><h4 class="mr-month-7">August 2025</h4><button class="share-month-btn" title="Share this month&#39;s remarks" style="float: right; font-size: 18px; border: none; background: none; cursor: pointer; color: rgb(0, 123, 255); margin-left: 10px;">→</button><textarea id="remarkLite-7" placeholder="Remarks for August 2025"></textarea></div><div class="month-card-lite"><h4 class="mr-month-8">September 2025</h4><button class="share-month-btn" title="Share this month&#39;s remarks" style="float: right; font-size: 18px; border: none; background: none; cursor: pointer; color: rgb(0, 123, 255); margin-left: 10px;">→</button><textarea id="remarkLite-8" placeholder="Remarks for September 2025"></textarea></div><div class="month-card-lite"><h4 class="mr-month-9">October 2025</h4><button class="share-month-btn" title="Share this month&#39;s remarks" style="float: right; font-size: 18px; border: none; background: none; cursor: pointer; color: rgb(0, 123, 255); margin-left: 10px;">→</button><textarea id="remarkLite-9" placeholder="Remarks for October 2025"></textarea></div><div class="month-card-lite"><h4 class="mr-month-10">November 2025</h4><button class="share-month-btn" title="Share this month&#39;s remarks" style="float: right; font-size: 18px; border: none; background: none; cursor: pointer; color: rgb(0, 123, 255); margin-left: 10px;">→</button><textarea id="remarkLite-10" placeholder="Remarks for November 2025"></textarea></div><div class="month-card-lite"><h4 class="mr-month-11">December 2025</h4><button class="share-month-btn" title="Share this month&#39;s remarks" style="float: right; font-size: 18px; border: none; background: none; cursor: pointer; color: rgb(0, 123, 255); margin-left: 10px;">→</button><textarea id="remarkLite-11" placeholder="Remarks for December 2025"></textarea></div></div>
</div>
<footer>
<button class="btn" id="btnSaveYearlyRemarksLite" title="Save all calendar remarks">💾 Save</button>
<button class="btn" id="btnYearlyRemarksCloseLite2">Close</button>
</footer>
</div>
</div>
<script id="fuad-remarks-and-notes-js">
(function(){
  // Notes enhancer
  function enhanceNotes(){
    var tds = document.querySelectorAll('#monthTable td:nth-child(4)');
    tds.forEach(function(td){
      var inp = td.querySelector('input[id^="month-note-"]');
      if(!inp) return;
      if(td.querySelector('textarea.note2')) return;
      inp.classList.add('note-hidden');
      var ta = document.createElement('textarea');
      ta.className = 'note2'; ta.rows = 2;
      ta.placeholder = inp.getAttribute('placeholder') || 'Note';
      ta.value = inp.value || '';
      td.appendChild(ta);
      function sync(type){
        if(inp.value !== ta.value){
          inp.value = ta.value;
          try{ inp.dispatchEvent(new Event(type || 'input', { bubbles:true })); }catch(_){}
        }
      }
      ta.addEventListener('input', function(){ sync('input'); });
      ta.addEventListener('change', function(){ sync('change'); });
      // Auto-expand textarea
      ta.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';
      });
      try{
        var mo = new MutationObserver(function(){ if(ta.value !== inp.value){ ta.value = inp.value || ''; } });
        mo.observe(inp, { attributes:true, attributeFilter:['value'] });
      }catch(_){}
    });
  }

  // Yearly Remarks popup
  function safeKeyPrefix(){
    try{ 
      // Directly access DOM elements to get current owner and year
      const ownerEl = document.getElementById('owner');
      const yearEl = document.getElementById('year');
      if(ownerEl && yearEl){
        const owner = (ownerEl.value || '').trim();
        const year = (yearEl.value || '').trim();
        return `enbd:${owner}:${year}`;
      }
      return 'global'; 
    }
    catch(_){ return 'global'; }
  }
  var MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  var fullMonths = ['January','February','March','April','May','June','July','August','September','October','November','December'];

  function getCurrentRemarksKey(){
    return safeKeyPrefix() + ':calendarRemarks';
  }

  function cleanupLegacyCalendarRemarks(){
    // Clean up any non-prefixed calendar remarks that might be causing conflicts
    try {
      const legacyKeys = ['calendarRemarks', 'global:calendarRemarks'];
      legacyKeys.forEach(key => {
        if(localStorage.getItem(key)){
          localStorage.removeItem(key);
        }
      });
    } catch(e) {
      // Silent cleanup
    }
  }

  function loadRemarks(){
    try{
      var currentKey = getCurrentRemarksKey();
      var raw = localStorage.getItem(currentKey);
      var arr = raw ? JSON.parse(raw) : null;
      if(Array.isArray(arr) && arr.length === 12) {
        return arr;
      }
    }catch(e){
      // Error loading remarks
    }
    return new Array(12).fill('');
  }
  function saveRemarks(arr){ 
    try{ 
      const key = getCurrentRemarksKey();
      localStorage.setItem(key, JSON.stringify(arr)); 
    }catch(e){ 
      // Error saving remarks
    } 
  }
  function debounce(fn, ms){ var t; return function(){ var a=arguments,s=this; clearTimeout(t); t=setTimeout(function(){ fn.apply(s,a); }, ms); }; }

  function renderGridLite(){
    var grid = document.getElementById('calendarRemarksGridLite');
    if(!grid) return;
    grid.innerHTML = '';
    var vals = loadRemarks();
    // month color classes applied to each month header (one color per month)
    var monthColorClasses = [
      'mr-month-0','mr-month-1','mr-month-2','mr-month-3','mr-month-4','mr-month-5',
      'mr-month-6','mr-month-7','mr-month-8','mr-month-9','mr-month-10','mr-month-11'
    ];
    for(var i=0;i<12;i++){
      var card = document.createElement('div');
      card.className = 'month-card-lite';
      var h = document.createElement('h4');
      h.textContent = fullMonths[i] + ' ' + (document.getElementById('year') ? document.getElementById('year').value : new Date().getFullYear());
      // apply class for month-specific color
      h.classList.add(monthColorClasses[i]);
      var ta = document.createElement('textarea');
      ta.id = 'remarkLite-' + i;
  ta.placeholder = 'Remarks for ' + fullMonths[i] + ' ' + (document.getElementById('year') ? document.getElementById('year').value : new Date().getFullYear());
      ta.value = vals[i] || '';
      // Auto-expand
      ta.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';
      });
      // Share button
      var shareBtn = document.createElement('button');
      shareBtn.className = 'share-month-btn';
      shareBtn.innerHTML = '→';
      shareBtn.title = 'Share this month\'s remarks';
      shareBtn.style.cssText = 'float:right; font-size:18px; border:none; background:none; cursor:pointer; color:#007bff; margin-left:10px;';
      shareBtn.addEventListener('click', (function(monthIndex, textarea) {
        return function() {
          var content = textarea.value.trim();
          if (!content) {
            alert('No remarks to share for ' + MONTHS[monthIndex]);
            return;
          }
          // Prefer recipient inputs in this order: yearly remarks overlay, month-note overlay, notes drawer, share overlay, scenario share
          var rec = (document.getElementById('yrRemarksRecipient') || {value: ''}).value.trim() ||
                    (document.getElementById('mnoShareRecipient') || {value: ''}).value.trim() ||
                    (document.getElementById('noteShareRecipient') || {value: ''}).value.trim() ||
                    (document.getElementById('shareRecipient') || {value: ''}).value.trim() ||
                    (document.getElementById('scShareRecipient') || {value: ''}).value.trim();
          // If we have a recipient, open WhatsApp with a greeting; otherwise fallback to copying to clipboard
          var yearVal = (document.getElementById('year') ? document.getElementById('year').value : new Date().getFullYear());
          var baseText = fullMonths[monthIndex] + ' ' + yearVal + ' Remarks:\n' + content;
          if(rec){
            var final = 'Dear ' + rec + ',\n\n' + baseText;
            try{
              window.open('https://wa.me/?text=' + encodeURIComponent(final), '_blank');
            }catch(e){
              // fallback to clipboard if window.open fails
              if(navigator.clipboard){ navigator.clipboard.writeText(final).then(()=> alert('Remarks copied to clipboard')); }
              else { prompt('Copy remarks:', final); }
            }
          } else {
            // If month-note overlay recipient exists, focus it to help user; else focus notes recipient
            if(document.getElementById('mnoShareRecipient')){ document.getElementById('mnoShareRecipient').focus(); }
            else if(document.getElementById('noteShareRecipient')){ document.getElementById('noteShareRecipient').focus(); }
            // Inform user and fallback to clipboard
            var t = baseText;
            if(navigator.clipboard){ navigator.clipboard.writeText(t).then(()=> alert('No recipient provided — remarks copied to clipboard')); }
            else { alert('No recipient provided. Copying remarks instead.'); prompt('Copy remarks:', t); }
          }
        };
      })(i, ta));
      card.appendChild(h); card.appendChild(shareBtn); card.appendChild(ta); grid.appendChild(card);
    }
    var saveDebounced = debounce(function(){
      var arr = new Array(12).fill('');
      for(var j=0;j<12;j++){ var el = document.getElementById('remarkLite-' + j); arr[j] = el ? el.value : ''; }
      saveRemarks(arr);
    }, 250);
    // Autosave disabled - user prefers manual save
    // grid.addEventListener('input', saveDebounced);
    // grid.addEventListener('change', saveDebounced);
  }

  function openOverlayLite(){
    cleanupLegacyCalendarRemarks();
    renderGridLite();
    var ov = document.getElementById('yearlyRemarksOverlayLite');
    // Prefill recipient field from other known recipient inputs for convenience
    try{
      var pref = (document.getElementById('mnoShareRecipient') || {value:''}).value.trim() || (document.getElementById('noteShareRecipient') || {value:''}).value.trim() || (document.getElementById('shareRecipient') || {value:''}).value.trim() || (document.getElementById('scShareRecipient') || {value:''}).value.trim();
      var yr = document.getElementById('yrRemarksRecipient');
      if(yr && pref) yr.value = pref;
    }catch(_){ }
    if(ov) { ov.setAttribute('aria-hidden','false'); ov.style.display = 'flex'; setTimeout(function(){ try{ document.getElementById('yrRemarksRecipient')?.focus(); }catch(_){ } }, 120); }
  }
  function closeOverlayLite(){
    var ov = document.getElementById('yearlyRemarksOverlayLite');
    if(ov) { ov.setAttribute('aria-hidden','true'); ov.style.display = 'none'; }
  }

  function wire(){
    // One toolbar button with id=btnYearlyRemarksLite (we'll inject it after Export)
    document.addEventListener('click', function(e){
      var el = e.target;
      while(el && el !== document){
        if(el.id === 'btnYearlyRemarksLite'){ e.preventDefault(); openOverlayLite(); return; }
        if(el.id === 'btnYearlyRemarksCloseLite' || el.id === 'btnYearlyRemarksCloseLite2'){ e.preventDefault(); closeOverlayLite(); return; }
        if(el.id === 'btnSaveYearlyRemarksLite'){ 
          e.preventDefault(); 
          // Save all remarks
          var arr = new Array(12).fill('');
          for(var j=0; j<12; j++){ 
            var el = document.getElementById('remarkLite-' + j); 
            arr[j] = el ? el.value : ''; 
          }
          saveRemarks(arr);
          // Show confirmation
          if(typeof showToast === 'function'){
            showToast('Calendar remarks saved successfully!');
          } else {
            alert('Calendar remarks saved!');
          }
          return; 
        }
        el = el.parentNode;
      }
      // Backdrop close
      var ov = document.getElementById('yearlyRemarksOverlayLite');
      if(ov && e.target === ov){ closeOverlayLite(); }
    }, true);
    document.addEventListener('keydown', function(e){ if(e.key === 'Escape') closeOverlayLite(); });
    // Update remarks when owner or year changes if overlay is open
    document.getElementById('owner').addEventListener('change', function(){
      var overlay = document.getElementById('yearlyRemarksOverlayLite');
      if(overlay && overlay.getAttribute('aria-hidden') === 'false'){
        cleanupLegacyCalendarRemarks();
        renderGridLite();
      }
    });
    document.getElementById('year').addEventListener('change', function(){
      var overlay = document.getElementById('yearlyRemarksOverlayLite');
      if(overlay && overlay.getAttribute('aria-hidden') === 'false'){
        cleanupLegacyCalendarRemarks();
        renderGridLite();
      }
    });
  }

  // Hide Undo & Storage UI defensively (without touching other logic)
  function purgeUndoStorage(){
    var ids = ['btnUndo','btnStorageDiag','storageDiagOverlay','btnStorageDiagClose','btnStorageDiagClose2'];
    ids.forEach(function(id){
      var el = document.getElementById(id);
      if(el && el.parentNode) try{ el.parentNode.removeChild(el); }catch(_){}
    });
    try{
      document.querySelectorAll('.storage-diag,[data-role="storage-diag"],.storage-panel')
        .forEach(function(el){ if(el && el.parentNode) el.parentNode.removeChild(el); });
    }catch(_){}
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', function(){
      enhanceNotes(); wire(); purgeUndoStorage();
    }, { once:true });
  } else {
    enhanceNotes(); wire(); purgeUndoStorage();
  }

  try{
    var mo = new MutationObserver(function(){ purgeUndoStorage(); });
    mo.observe(document.body, { childList:true, subtree:true });
  }catch(_){}
})();
</script>
<!-- Tiny emoji chevron for owner/year selects -->
<style>
  .owner-year .select-wrap .chev {
    font-family: 'Segoe UI Emoji', 'Apple Color Emoji', 'Noto Color Emoji', system-ui, sans-serif;
    font-size: 12px !important;
    line-height: 1 !important;
    transform: translateY(-50%) scale(0.92) !important;
    opacity: 0.85;
    color: var(--muted, #8b949e);
    pointer-events: none;
    display: inline-block;
    width: 14px !important;
    text-align: center;
  }
</style>
<script>
// === Injected: wrap selects and add tiny emoji chevron ===
(function(){
  try{
    document.querySelectorAll('.owner-year select').forEach(function(sel){
      if(sel.parentElement && sel.parentElement.classList && sel.parentElement.classList.contains('select-wrap')) return;
      var wrap = document.createElement('span');
      wrap.className = 'select-wrap';
      sel.parentElement.insertBefore(wrap, sel);
      wrap.appendChild(sel);
      var chev = document.createElement('span');
      chev.className = 'chev';
      // use a compact emoji so it reads clearly on all platforms
      chev.textContent = '🔽';
      wrap.appendChild(chev);
    });
  }catch(e){ console.error('chevron wrap error', e); }
})();
</script>
<script>
(function(){
  if (window.__wiredExcelExport) return;
  window.__wiredExcelExport = true;

  const byId = (id) => document.getElementById(id);
  const txt = (el) => (el ? (('value' in el && el.value!==undefined) ? el.value : el.textContent || '').trim() : '');
  const norm = (s) => (s || '').replace(/\s+/g, ' ').trim();
  const parseMoney = (s) => {
    if (s == null) return null;
    const str = String(s).replace(/[, ]+/g, '').replace(/AED/gi,'').trim();
    if (/^\(.*\)$/.test(str)) return -Number(str.slice(1,-1));
    const n = Number(str);
    return isFinite(n) ? n : null;
  };
  const fmtAED = (n) => n == null ? '' : n;

  const nowDubai = () => {
    try {
      return new Intl.DateTimeFormat('en-GB', {
        timeZone: 'Asia/Dubai', year:'numeric', month:'2-digit', day:'2-digit',
        hour:'2-digit', minute:'2-digit', hour12:false
      }).format(new Date());
    } catch { return new Date().toLocaleString(); }
  };

  function collectOwnerYear(){
    const owner = txt(byId('owner')) || (document.querySelector('#yearDataLabel .y-owner')?.textContent || '').trim();
    const year  = txt(byId('year'))  || (document.querySelector('#yearDataLabel .y-year')?.textContent || '').trim();
    return { owner: owner || '', year: year || '' };
  }

  function collectKPIs(){
    const arr = [];
    document.querySelectorAll('.kpis .kpi').forEach(k => {
      const name = (k.querySelector('h3')?.textContent || '').trim();
      const val  = (k.querySelector('.val')?.textContent || '').trim();
      if (name) arr.push({ KPI: name, Value: val });
    });
    [
      ['Forecasted Year-End', '#kpiForecastYearEnd'],
      ['Mo. Needed',          '#kpiMoNeeded'],
      ['Avg. Mo. Target',     '#kpiAvgMoTarget'],
      ['YTD Inflow',          '#kpiInflow']
    ].forEach(([label,sel])=>{
      const el = document.querySelector(sel);
      if (el) arr.push({ KPI: label, Value: (el.textContent || '').trim() });
    });
    return arr;
  }

  function getCellValue(td){
    if (!td) return '';
    const input = td.querySelector('input, textarea');
    return input ? (input.value || '').trim() : (td.textContent || '').trim();
  }

  function collectMonthlyTable(){
    const table = document.getElementById('monthTable');
    const rows = [];
    if (!table) return { rows, totals:null };

    const bodyRows = table.querySelectorAll('tbody tr');
    bodyRows.forEach(tr => {
      if (tr.classList.contains('totals-row')) return;
      const tds = tr.children;
      if (!tds || tds.length < 7) return;

      const Day        = getCellValue(tds[0]);
      const Month      = getCellValue(tds[1]);
      const Target     = parseMoney(getCellValue(tds[2]));
      const Note       = getCellValue(tds[3]);
      const BankInflow = parseMoney(getCellValue(tds[4]));
      const Variance   = parseMoney(getCellValue(tds[5]));
      const Balance    = parseMoney(getCellValue(tds[6]));

      rows.push({ Day, Month, Note, Target, BankInflow, Variance, Balance });
    });

    const sum = (key) => rows.reduce((a,r)=> a + (Number.isFinite(r[key]) ? r[key] : 0), 0);
    const totals = {
      Day: 'Totals',
      Month: '',
      Note: '',
      Target: sum('Target'),
      BankInflow: sum('BankInflow'),
      Variance: sum('Variance'),
      Balance: sum('Balance')
    };
    return { rows, totals };
  }

  function collectReminders(){
    const list = [];
    const scope = document.getElementById('remList') || document.getElementById('reminderDrawer') || document;
    scope.querySelectorAll('.rem-row').forEach(r=>{
      const doneEl = r.querySelector('input[type="checkbox"], .tiny');
      const done = !!(doneEl && doneEl.checked);
      const dateAmount = (r.querySelector('.date-amount')?.textContent || '').trim();
      const label = (r.querySelector('.rem-label')?.textContent || '').trim();
      let date = '', amount = null;
      if (dateAmount) {
        const m = dateAmount.match(/(\d{2}\/\d{2}\/\d{4}).*?AED\s*([0-9,()]+)/i);
        if (m) { date = m[1]; amount = parseMoney(m[2]); }
      }
      list.push({ Done: done ? 'Yes' : 'No', Date: date || dateAmount || '', Amount: amount, Label: label });
    });
    return list;
  }

  function collectNotes(){
    const notes = (document.getElementById('notesArea')?.value || document.getElementById('notesArea')?.textContent || '').trim();
    const monthly = [];
    document.querySelectorAll('.calendar-remarks-lite .month-card-lite').forEach(card=>{
      const m = (card.querySelector('h4')?.textContent || '').trim();
      const v = (card.querySelector('textarea')?.value || '').trim();
      if (m || v) monthly.push({ Month: m, Remark: v });
    });
    return { notes, monthly };
  }

  function aoaToSheetWithWidths(aoa, widths){
    const ws = XLSX.utils.aoa_to_sheet(aoa);
    if (widths && widths.length){
      ws['!cols'] = widths.map(w => ({ wch: w }));
    }
    return ws;
  }

  /* buildWorkbook function removed for simplicity */

  /* wire function removed for simplicity */

  /* DOMContentLoaded listener removed for simplicity */
})();
</script>
<script>
(function(){
  if (window.__wiredOneSheetExport) return;
  window.__wiredOneSheetExport = true;

  const byId = (id) => document.getElementById(id);
  const txt = (el) => (el ? (('value' in el && el.value!==undefined) ? el.value : el.textContent || '').trim() : '');
  const parseMoney = (s) => {
    if (s == null) return null;
    const str = String(s).replace(/[, ]+/g, '').replace(/AED/gi,'').trim();
    if (/^\(.*\)$/.test(str)) return -Number(str.slice(1,-1));
    const n = Number(str);
    return isFinite(n) ? n : null;
  };

  const nowDubai = () => {
    try {
      return new Intl.DateTimeFormat('en-GB', {
        timeZone: 'Asia/Dubai', year:'numeric', month:'2-digit', day:'2-digit',
        hour:'2-digit', minute:'2-digit', hour12:false
      }).format(new Date());
    } catch { return new Date().toLocaleString(); }
  };

  function collectOwnerYear(){
    const owner = txt(byId('owner')) || (document.querySelector('#yearDataLabel .y-owner')?.textContent || '').trim();
    const year  = txt(byId('year'))  || (document.querySelector('#yearDataLabel .y-year')?.textContent || '').trim();
    return { owner: owner || '', year: year || '' };
  }

  function collectKPIsAOA(){
    const rows = [];
    document.querySelectorAll('.kpis .kpi').forEach(k => {
      const name = (k.querySelector('h3')?.textContent || '').trim();
      const val  = (k.querySelector('.val')?.textContent || '').trim();
      if (name) rows.push([name, val]);
    });
    [
      ['Forecasted Year-End', '#kpiForecastYearEnd'],
      ['Mo. Needed',          '#kpiMoNeeded'],
      ['Avg. Mo. Target',     '#kpiAvgMoTarget'],
      ['YTD Inflow',          '#kpiInflow']
    ].forEach(([label,sel])=>{
      const el = document.querySelector(sel);
      if (el) rows.push([label, (el.textContent || '').trim()]);
    });
    return rows.length ? rows : [['—','—']];
  }

  function getCellValue(td){
    if (!td) return '';
    const input = td.querySelector('input, textarea');
    return input ? (input.value || '').trim() : (td.textContent || '').trim();
  }

  function collectMonthlyAOA(){
    const table = document.getElementById('monthTable');
    const rows = [];
    if (!table) return { header:['Day','Month','Note','Target (AED)','Bank Inflow (AED)','Variance (AED)','Balance (AED)'], rows, totals:null };
    const header = ['Day','Month','Note','Target (AED)','Bank Inflow (AED)','Variance (AED)','Balance (AED)'];
    const bodyRows = table.querySelectorAll('tbody tr');
    bodyRows.forEach(tr => {
      if (tr.classList.contains('totals-row')) return;
      const tds = tr.children;
      if (!tds || tds.length < 7) return;
      const Day        = getCellValue(tds[0]);
      const Month      = getCellValue(tds[1]);
      const Target     = parseMoney(getCellValue(tds[2]));
      const Note       = getCellValue(tds[3]);
      const BankInflow = parseMoney(getCellValue(tds[4]));
      const Variance   = parseMoney(getCellValue(tds[5]));
      const Balance    = parseMoney(getCellValue(tds[6]));
      rows.push([Day, Month, Note, Target, BankInflow, Variance, Balance]);
    });
    const sum = (idx) => rows.reduce((a,r)=> a + (Number.isFinite(r[idx]) ? r[idx] : 0), 0);
    const totals = rows.length ? ['Totals','', '', sum(3), sum(4), sum(5), sum(6)] : null;
    return { header, rows, totals };
  }

  function collectRemindersAOA(){
    const list = [];
    const scope = document.getElementById('remList') || document.getElementById('reminderDrawer') || document;
    scope.querySelectorAll('.rem-row').forEach(r=>{
      const doneEl = r.querySelector('input[type="checkbox"], .tiny');
      const done = !!(doneEl && doneEl.checked);
      const dateAmount = (r.querySelector('.date-amount')?.textContent || '').trim();
      const label = (r.querySelector('.rem-label')?.textContent || '').trim();
      let date = '', amount = null;
      if (dateAmount) {
        const m = dateAmount.match(/(\d{2}\/\d{2}\/\d{4}).*?AED\s*([0-9,()]+)/i);
        if (m) { date = m[1]; amount = parseMoney(m[2]); }
      }
      list.push([done ? 'Yes' : 'No', date || dateAmount || '', amount, label]);
    });
    return list;
  }

  function collectNotesAOA(){
    const notes = (document.getElementById('notesArea')?.value || document.getElementById('notesArea')?.textContent || '').trim();
    const monthly = [];
    document.querySelectorAll('.calendar-remarks-lite .month-card-lite').forEach(card=>{
      const m = (card.querySelector('h4')?.textContent || '').trim();
      const v = (card.querySelector('textarea')?.value || '').trim();
      if (m || v) monthly.push([m, v]);
    });
    return { notes, monthly };
  }

  function autoWidthsFromAOA(aoa, min=8, max=64){
    const widths = [];
    for (let c = 0; c < Math.max(...aoa.map(row => row.length)); c++){
      let w = min;
      for (let r = 0; r < aoa.length; r++){
        const val = aoa[r][c];
        const s = (val==null) ? '' : String(val);
        if (s.length + 2 > w) w = Math.min(max, s.length + 2);
      }
      widths.push({ wch: w });
    }
    return widths;
  }

  function buildSingleSheet(){
    const { owner, year } = collectOwnerYear();
    const when = nowDubai();
    const kpis = collectKPIsAOA();
    const { header:mh, rows:mr, totals:mt } = collectMonthlyAOA();
    const reminders = collectRemindersAOA();
    const { notes, monthly } = collectNotesAOA();

    const AOA = [];
    AOA.push(['ENBD Performance Tracker — Export (One Sheet)']);
    AOA.push(['Exported On', when]);
    AOA.push(['Owner', owner]);
    AOA.push(['Year', year]);
    AOA.push([]);

    AOA.push(['KPI', 'Value']);
    kpis.forEach(k => AOA.push(k));
    AOA.push([]);

    const monthlyStart = AOA.length;
    AOA.push(mh);
    mr.forEach(r => AOA.push(r));
    const totalsRow = (mt ? (AOA.push(mt), AOA.length-1) : null);
    AOA.push([]);

    const remStart = AOA.length;
    AOA.push(['Done','Date','Amount (AED)','Label']);
    reminders.forEach(r => AOA.push(r));
    AOA.push([]);

    AOA.push(['General Notes']);
    const notesRow = AOA.length;
    AOA.push([notes || '']);
    AOA.push([]);
  AOA.push(['Cal. Remarks (per Month)']);
    AOA.push(['Month','Remark']);
    monthly.forEach(m => AOA.push(m));

    const ws = XLSX.utils.aoa_to_sheet(AOA);

    // Col widths auto from AOA with caps
    ws['!cols'] = autoWidthsFromAOA(AOA, 10, 60);

    // Merges for nicer layout
    ws['!merges'] = ws['!merges'] || [];
    ws['!merges'].push({s:{r:0,c:0}, e:{r:0,c:Math.max(6, (ws['!cols']||[]).length-1)}}); // title
    ws['!merges'].push({s:{r:notesRow, c:0}, e:{r:notesRow, c:Math.max(6, (ws['!cols']||[]).length-1)}}); // notes line

    // Number formats for Monthly money cols (D,E,F,G) and Reminders Amount (C)
    function setMoneyFormat(rangeRows, colIdx){
      rangeRows.forEach(R=>{
        const cell = ws[XLSX.utils.encode_cell({r:R,c:colIdx})];
        if (cell && typeof cell.v === 'number'){ cell.z = '#,##0'; }
      });
    }
    if (mr.length){
      const firstData = monthlyStart + 1;
      const lastData  = firstData + mr.length - 1;
      for (const c of [3,4,5,6]){
        const rowsIdx = Array.from({length: lastData-firstData+1}, (_,i)=> firstData+i);
        setMoneyFormat(rowsIdx, c);
      }
      if (totalsRow !== null){
        for (const c of [3,4,5,6]) setMoneyFormat([totalsRow], c);
      }
    }
    if (reminders.length){
      const firstR = remStart + 1;
      const lastR  = firstR + reminders.length - 1;
      const rowsIdx = Array.from({length: lastR-firstR+1}, (_,i)=> firstR+i);
      setMoneyFormat(rowsIdx, 2);
    }

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'All Data');
    return { wb, owner, year };
  }

  // One-sheet export wiring removed as the UI button was deleted.
})();
</script>
<!-- Cross‑platform image loading (relative paths + fallbacks) -->
<script>
(function(){ 
  var DEFAULT_AVATAR = "data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%27http%3A//www.w3.org/2000/svg%27%20viewBox%3D%270%200%2064%2064%27%3E%0A%3Ccircle%20cx%3D%2732%27%20cy%3D%2732%27%20r%3D%2731%27%20fill%3D%27%232d333b%27/%3E%0A%3Ccircle%20cx%3D%2732%27%20cy%3D%2724%27%20r%3D%2712%27%20fill%3D%27%237ee787%27/%3E%0A%3Cpath%20d%3D%27M12%2056c4-12%2016-18%2020-18s16%206%2020%2018%27%20fill%3D%27%237ee787%27/%3E%0A%3C/svg%3E";
  var DEFAULT_AYAT   = "data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%27http%3A//www.w3.org/2000/svg%27%20viewBox%3D%270%200%2064%2064%27%3E%0A%3Cdefs%3E%3ClinearGradient%20id%3D%27g%27%20x1%3D%270%27%20y1%3D%270%27%20x2%3D%271%27%20y2%3D%271%27%3E%0A%3Cstop%20offset%3D%270%27%20stop-color%3D%27%237ee787%27/%3E%3Cstop%20offset%3D%271%27%20stop-color%3D%27%2358a6ff%27/%3E%3C/linearGradient%3E%3C/defs%3E%0A%3Crect%20x%3D%272%27%20y%3D%272%27%20width%3D%2760%27%20height%3D%2760%27%20rx%3D%2712%27%20fill%3D%27url%28%23g%29%27/%3E%0A%3Ctext%20x%3D%2750%25%27%20y%3D%2754%25%27%20dominant-baseline%3D%27middle%27%20text-anchor%3D%27middle%27%20font-size%3D%2728%27%20font-family%3D%27Arial%27%20fill%3D%27%230d1117%27%3EA%3C/text%3E%0A%3C/svg%3E";

  function setSrcWithFallback(img, src, fallback){ 
    if(!img) return;
    img.onerror = function(){ if(img.src!==fallback) img.src = fallback; };
    if(src) img.src = src; else img.src = fallback;
  }

  // 1) Ayat brand logo — prefer workspace photo if present, otherwise use relative asset or fallback
  // Try the user's provided photo first (copied into the same folder).
  setSrcWithFallback(document.getElementById('ayatLogo'), './PHOTO-2025-09-22-16-52-04.jpg', './assets/Ayat_colored.png');

  // 2) Owner avatar/logo — derived from current owner value/text
  function getCurrentOwner(){ 
    var sel = document.getElementById('owner');
    if(sel && sel.value) return sel.value.trim();
    var txt = document.querySelector('.y-owner');
    return txt ? txt.textContent.trim() : 'Owner';
  }
  function updateOwnerLogo(){
    var owner = getCurrentOwner();
    var img = document.getElementById('ownerLogo') || document.querySelector('.owner-avatar');
    // Convention: ./assets/<OWNER>.png — user can drop real logos there
    var candidate = './assets/' + owner + '.png';
    setSrcWithFallback(img, candidate, DEFAULT_AVATAR);
  }
  updateOwnerLogo();
  var sel = document.getElementById('owner');
  if(sel) sel.addEventListener('change', updateOwnerLogo);
})();
</script>
<div aria-hidden="true" class="overlay hidden" id="monthNoteOverlay"> <div class="overlay-panel"> <div class="overlay-header"> <strong id="mnoTitle" style="font-size:11px;">Apr Note</strong> <button class="btn small" id="mnoClose">Close</button> </div> <div class="overlay-body" style="font-size:11px;"> <label style="display:block;margin-bottom:6px;">Date<span style="margin-left:6px;color:var(--accent-amber,#ffb84d)"></span></label> <input id="mnoDate" style="width:100%;font-size:12px;padding:6px;margin-bottom:8px;" type="date"> <label style="display:block;margin-bottom:6px;">Note</label>
<textarea id="mnoNote" placeholder="Small note..." rows="4" style="width:100%;font-size:12px;padding:6px;resize:vertical;"></textarea>
<!-- Recipient input added to month note popup so users can enter recipient without opening the notes drawer -->
<label style="display:block;margin-top:8px; font-size:11px;">Recipient (optional): <input id="mnoShareRecipient" placeholder="e.g., John Doe" style="width:60%; padding:6px; margin-left:8px; border-radius:6px; background:#18181b; border:1px solid #2a2a30; color:var(--text); font-size:11px" type="text"></label>
<div style="margin-top:8px;text-align:right; display:flex; gap:8px; justify-content:flex-end; align-items:center"> <button class="btn small" id="mnoClearNote">Clear Note</button> <button class="btn small" id="mnoReviseDate">Revise Date</button> <!-- Small WhatsApp arrow share button --> <button class="btn small" id="mnoWhatsApp" style="background:transparent; border:none; color:#5c9090; font-size:18px; padding:6px 8px;" title="Share via WhatsApp">➔</button> <button class="btn primary small" id="mnoSave">Save</button> <button class="btn small" id="mnoCancel">Cancel</button> </div> </div> </div> </div><div aria-hidden="true" class="overlay" id="passwordOverlay">
<div class="overlay-panel">
<div class="overlay-header">
<strong>Enter Password</strong>
<button id="btnClosePassword">Close</button>
</div>
<div class="overlay-body">
<form id="passwordForm">
<label for="passwordInput">Password:</label>
<input id="passwordInput" type="password" required="">
<button type="submit" id="btnEnterPassword">Enter</button>
</form>
</div>
</div>
</div></body></html>
    
  </body>
  
</html>
    
  </body>
  
</html>
    
  </body>
  
</html>
